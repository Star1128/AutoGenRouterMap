"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReportServiceImpl=void 0;const fs_1=__importDefault(require("fs")),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),local_file_writer_js_1=require("../../../common/util/local-file-writer.js"),path_util_js_1=require("../../../common/util/path-util.js"),global_core_parameters_1=require("../../internal/data/global-core-parameters");class ReportServiceImpl{constructor(){this.reportListeners=[]}report(){const e=this.getReport(),t=path_util_js_1.PathUtil.getReportDirPath();fs_1.default.existsSync(t)||fs_1.default.mkdirSync(t,{recursive:!0}),this.deleteUnusableFiles(t),this.storage(e,t)}getReport(){const e={version:"2.0",ppid:process.ppid};for(const t of this.reportListeners){const r=t.queryReport();e[r.getName()]=r.getValue()}return e}storage(e,t){const r=fs_1.default.readdirSync(t).filter((e=>e.startsWith("report-")&&e.endsWith("json"))).sort(((e,r)=>{const s=path_1.default.resolve(t,e),l=path_1.default.resolve(t,r),a=fs_1.default.statSync(s);return fs_1.default.statSync(l).birthtimeMs-a.birthtimeMs}));for(let e=0;e<r.length;e++)if(e>=9){const s=path_1.default.resolve(t,r[e]);fs_1.default.existsSync(s)&&fs_1.default.unlinkSync(s)}const s=require("../../internal/data/global-data.js");if(void 0===s.globalData.buildId)return;let l=s.globalData.buildId;const a=path_1.default.resolve(t,`report-${l}.json`);local_file_writer_js_1.LocalFileWriter.getInstance().write(a,e),enableHtmlGenerate()&&this.generateHtmlResource(t,`report-${l}`,e)}deleteUnusableFiles(e){fs_1.default.readdirSync(e).forEach((t=>{if(!ReportServiceImpl.REPORT_REG.test(t)&&(!ReportServiceImpl.HTML_REG.test(t)||enableHtmlGenerate())&&t!==ReportServiceImpl.HTML_RESOURCE_NAME){const r=path_1.default.resolve(e,t);fs_1.default.existsSync(r)&&fs_1.default.unlinkSync(r)}}))}addListener(e){this.reportListeners.push(e)}removeListener(e){const t=this.reportListeners.indexOf(e);-1!==t&&this.reportListeners.splice(t,1)}generateHtmlResource(e,t,r){const s=path_1.default.resolve(e,"htmlResource"),l=path_1.default.resolve(__filename,"../../../../../res/staticHtmlResource/htmlResource");if(fs_1.default.existsSync(s)){const e=fs_1.default.readdirSync(l),t=fs_1.default.readdirSync(s);e.every((e=>{if(!t.includes(e))return!1;return fs_1.default.statSync(path_1.default.resolve(l,e)).size===fs_1.default.statSync(path_1.default.resolve(s,e)).size}))||fs_extra_1.default.copySync(l,s)}else fs_extra_1.default.copySync(l,s);const a=path_1.default.resolve(__filename,"../../../../../res/staticHtmlResource/index.html"),i=fs_1.default.readFileSync(a,"utf8"),o=`<script>window.__HVIGOR_REPORT__ = ${JSON.stringify(JSON.stringify(r))};<\/script>`,n=i.indexOf("</body>"),c=i.slice(0,n)+o+i.slice(n),_=path_1.default.resolve(e,`${t}.html`);fs_1.default.writeFileSync(_,c)}static getInstance(){return ReportServiceImpl.instance||(ReportServiceImpl.instance=new ReportServiceImpl),ReportServiceImpl.instance}}function enableHtmlGenerate(){return"boolean"==typeof global_core_parameters_1.coreParameter.properties["hvigor.analyzeHtml"]&&global_core_parameters_1.coreParameter.properties["hvigor.analyzeHtml"]}exports.ReportServiceImpl=ReportServiceImpl,ReportServiceImpl.MAX_REPEAT_TIMES=10,ReportServiceImpl.REPORT_REG=/^report-?[0-9]*.json$/,ReportServiceImpl.HTML_REG=/^report-?[0-9]*.html$/,ReportServiceImpl.HTML_RESOURCE_NAME="htmlResource";