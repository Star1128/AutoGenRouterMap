"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenericFsSnapshotBuilder=void 0;const crypto_1=__importDefault(require("crypto")),directory_snapshot_js_1=require("../core/directory-snapshot.js"),file_snapshot_js_1=require("../core/file-snapshot.js"),file_metadata_js_1=require("../util/file-metadata.js"),file_type_js_1=require("../util/file-type.js"),hash_js_1=require("../util/hash.js");class GenericFsSnapshotBuilder{constructor(){this.directoryStack=[]}enterDirectory(e){const t=this.assembleSnapshot(e,!0);this.directoryStack.push(t)}visitEntry(e){const t=this.assembleSnapshot(e,!1);this.hashItem(t),this.handleEntry(t)}leaveDirectory(e){const t=this.directoryStack.pop();t&&(this.completeDirectory(t),this.handleEntry(t))}handleEntry(e){const t=this.peekLast();t?t.children.push(e):this.directorySnapshot=e}completeDirectory(e){const t=crypto_1.default.createHash(hash_js_1.HashAlgorithm.MD5).update(e.name);e.children.sort().forEach((e=>t.update(e.hashValue).update(e.name))),e.hashValue=t.digest("hex")}hashItem(e){return hash_js_1.Hash.hash(`${e.name}${e.type}${e.fileMetaData.lastModifiedTime}${e.fileMetaData.size}`)}getResult(){return this.directorySnapshot}assembleSnapshot(e,t){if(t)return new directory_snapshot_js_1.DirectorySnapshot(e.getName(),e.getFile(),file_type_js_1.FileType.DIRECTORY,e.getStats().isSymbolicLink());const s=new file_metadata_js_1.FileMetaData(e.getStats().size,e.getStats().mtimeMs);return new file_snapshot_js_1.FileSnapshot(e.getName(),e.getFile(),file_type_js_1.FileType.FILE,e.getStats().isSymbolicLink(),s)}peekLast(){const e=this.directoryStack.length;if(!(e<1))return this.directoryStack[e-1]}}exports.GenericFsSnapshotBuilder=GenericFsSnapshotBuilder;