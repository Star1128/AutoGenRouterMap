"use strict";var _a,_b;Object.defineProperty(exports,"__esModule",{value:!0}),exports.resetStartData=exports.initStartData=exports.startEnvironment=exports.defaultStartEnvironment=exports.globalData=void 0;const log4js_1=require("log4js"),const_js_1=require("../../../common/const/const.js"),hvigor_config_loader_1=require("../../../common/util/hvigor-config-loader"),hvigor_trace_js_1=require("../../common/trace/hvigor-trace.js"),default_configuration_js_1=require("../../log/default-configuration.js"),hvigor_config_reader_js_1=require("../../util/hvigor-config-reader.js"),global_core_parameters_js_1=require("./global-core-parameters.js");class GlobalData{init(e,r){this.cliEnv=e,this.cliOpts=r,this.buildId=createBuildId()}clean(){this.buildId=void 0}}exports.globalData=new GlobalData;const defaultTestProps={pageType:"page",product:"default",buildRoot:".test",unitTestMode:"true","ohos-test-coverage":"true","unit.test.replace.page":"../../../.test/testability/pages/Index"},defaultDeviceTestProps={product:"default",buildMode:"test","ohos-test-coverage":"true"};function initStartData(e){hvigor_config_loader_1.HvigorConfigLoader.init(e),initExtParam(e),initParamProperties(),mergeHvigorConfig(),setTestDefaultParameters(e),setDeviceTestDefaultParameters(e),mergeCliConfig(e),initParamProperties()}function initExtParam(e){if(!e)return;const r=new Map;void 0!==e.prop&&[e.prop].flat(2).forEach((e=>{var a;const t=e.split("=");r.set(t[0],null===(a=null==t?void 0:t.splice(1))||void 0===a?void 0:a.join("="))})),global_core_parameters_js_1.coreParameter.extParams=Object.fromEntries(r.entries()),global_core_parameters_js_1.coreParameter.workspaceDir=exports.startEnvironment.workspaceDir}function initParamProperties(){const e=hvigor_config_loader_1.HvigorConfigLoader.getInstance();global_core_parameters_js_1.coreParameter.properties.hvigorPoolMaxSize=regularizeNumber(e.getPropertiesConfigValue(const_js_1.HVIGOR_POOL_MAX_SIZE)),global_core_parameters_js_1.coreParameter.properties.hvigorPoolMaxCoreSize=regularizeNumber(e.getPropertiesConfigValue(const_js_1.HVIGOR_POOL_MAX_CORE_SIZE)),global_core_parameters_js_1.coreParameter.properties.hvigorPoolCacheCapacity=regularizeNumber(e.getPropertiesConfigValue(const_js_1.HVIGOR_POOL_CACHE_CAPACITY)),global_core_parameters_js_1.coreParameter.properties.hvigorPoolCacheTtl=regularizeNumber(e.getPropertiesConfigValue(const_js_1.HVIGOR_POOL_CACHE_TTL)),global_core_parameters_js_1.coreParameter.properties.ohosArkCompileMaxSize=regularizeNumber(e.getPropertiesConfigValue(const_js_1.OHOS_ARK_COMPILE_MAX_SIZE))}function regularizeNumber(e){if(!("string"==typeof e||void 0===e||e<0))return Math.floor(e)}function getPropMap(e){const r=new Map;if(!e)return r;return("string"==typeof e?[e]:e).forEach((e=>{const[a,t]=e.split("="),o="coverage"===a?"ohos-test-coverage":a;r.set(o,t)})),r}function setTestDefaultParameters(e){if(!e)return;if(!e._.includes("test"))return;e.mode||(e.mode="module");const r=getPropMap(e.prop);Object.keys(defaultTestProps).forEach((e=>{r.has(e)||r.set(e,defaultTestProps[e])}));const a=[];r.forEach(((e,r)=>{a.push(`${r}=${e}`)})),e.prop=a}function setDeviceTestDefaultParameters(e){if(!e)return;if(!e._.includes("onDeviceTest"))return;e.mode||(e.mode="module");const r=getPropMap(e.prop);Object.keys(defaultDeviceTestProps).forEach((e=>{r.has(e)||r.set(e,defaultDeviceTestProps[e])}));const a=[];r.forEach(((e,r)=>{a.push(`${r}=${e}`)})),e.prop=a}function resetStartData(){exports.startEnvironment={...exports.defaultStartEnvironment},global_core_parameters_js_1.coreParameter.clean()}function mergeHvigorConfig(){const e=hvigor_config_reader_js_1.HvigorConfigReader.getHvigorConfig();e?(exports.startEnvironment={...exports.startEnvironment,...e.environment},global_core_parameters_js_1.coreParameter.properties={...global_core_parameters_js_1.defaultProperties,...e.properties,...global_core_parameters_js_1.coreParameter.properties},setStartParameters(e)):global_core_parameters_js_1.coreParameter.properties={...global_core_parameters_js_1.defaultProperties,...global_core_parameters_js_1.coreParameter.properties}}function setStartParameters(e){var r,a,t,o,s,l,i,_,c,n;global_core_parameters_js_1.coreParameter.startParams.incrementalExecution=null!==(a=null===(r=e.execution)||void 0===r?void 0:r.incremental)&&void 0!==a?a:global_core_parameters_js_1.coreParameter.startParams.incrementalExecution,global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck=null!==(o=null===(t=e.execution)||void 0===t?void 0:t.typeCheck)&&void 0!==o?o:global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck,global_core_parameters_js_1.coreParameter.startParams.parallelExecution=null!==(l=null===(s=e.execution)||void 0===s?void 0:s.parallel)&&void 0!==l?l:global_core_parameters_js_1.coreParameter.startParams.parallelExecution,global_core_parameters_js_1.coreParameter.startParams.daemon=null!==(_=null===(i=e.execution)||void 0===i?void 0:i.daemon)&&void 0!==_?_:global_core_parameters_js_1.coreParameter.startParams.daemon,global_core_parameters_js_1.coreParameter.startParams.printStackTrace=null!==(n=null===(c=e.debugging)||void 0===c?void 0:c.stacktrace)&&void 0!==n?n:global_core_parameters_js_1.coreParameter.startParams.printStackTrace,fillLoggingParameters(e)}function fillLoggingParameters(e){var r,a,t;(null===(r=e.logging)||void 0===r?void 0:r.level)&&(global_core_parameters_js_1.coreParameter.startParams.logLevel=null!==(t=default_configuration_js_1.levelMap.get(null===(a=e.logging)||void 0===a?void 0:a.level))&&void 0!==t?t:global_core_parameters_js_1.coreParameter.startParams.logLevel)}function mergeCliConfig(e){var r,a,t,o,s,l,i;const _=null!=e?e:exports.globalData.cliOpts;exports.startEnvironment.nodeHome=null!==(r=_.nodeHome)&&void 0!==r?r:exports.startEnvironment.nodeHome,global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck=null!==(a=_.enableBuildScriptTypeCheck)&&void 0!==a?a:global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck,global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck=null!==(t=_.typeCheck)&&void 0!==t?t:global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck,global_core_parameters_js_1.coreParameter.startParams.daemon=null!==(o=_.daemon)&&void 0!==o?o:global_core_parameters_js_1.coreParameter.startParams.daemon,global_core_parameters_js_1.coreParameter.startParams.printStackTrace=null!==(s=_.stacktrace)&&void 0!==s?s:global_core_parameters_js_1.coreParameter.startParams.printStackTrace,global_core_parameters_js_1.coreParameter.startParams.logLevel=_.debug?log4js_1.levels.DEBUG:_.warn?log4js_1.levels.WARN:_.error?log4js_1.levels.ERROR:_.info?log4js_1.levels.INFO:global_core_parameters_js_1.coreParameter.startParams.logLevel,hvigor_trace_js_1.hvigorTrace.isParallel=global_core_parameters_js_1.coreParameter.startParams.parallelExecution=null!==(l=_.parallel)&&void 0!==l?l:global_core_parameters_js_1.coreParameter.startParams.parallelExecution,hvigor_trace_js_1.hvigorTrace.isIncremental=global_core_parameters_js_1.coreParameter.startParams.incrementalExecution=null!==(i=_.incremental)&&void 0!==i?i:global_core_parameters_js_1.coreParameter.startParams.incrementalExecution,hvigor_trace_js_1.hvigorTrace.IS_DAEMON=global_core_parameters_js_1.coreParameter.startParams.daemon,hvigor_trace_js_1.hvigorTrace.LOG_LEVEL=global_core_parameters_js_1.coreParameter.startParams.logLevel.levelStr,hvigor_trace_js_1.hvigorTrace.IS_HVIGORFILE_TYPE_CHECK=global_core_parameters_js_1.coreParameter.startParams.hvigorfileTypeCheck}exports.defaultStartEnvironment={nodeHome:null!==(_a=process.env.NODE_HOME)&&void 0!==_a?_a:"",workspaceDir:null!==(_b=process.env.WORKSPACE_DIR)&&void 0!==_b?_b:""},exports.startEnvironment={...exports.defaultStartEnvironment},exports.initStartData=initStartData,exports.resetStartData=resetStartData;let lastTimestamp="",counter=0;function createBuildId(){const e=new Date,r=`${e.getFullYear()}${`0${e.getMonth()+1}`.slice(-2)}${`0${e.getDate()}`.slice(-2)}${`0${e.getHours()}`.slice(-2)}${`0${e.getMinutes()}`.slice(-2)}${`0${e.getSeconds()}`.slice(-2)}${`00${e.getMilliseconds()}`.slice(-3)}`;return r!==lastTimestamp?(lastTimestamp=r,counter=0):counter++,`${r}${counter}`}