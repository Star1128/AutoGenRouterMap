"use strict";var _a,__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,a)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const log4js_1=__importStar(require("log4js")),path_1=__importDefault(require("path")),worker_threads_1=require("worker_threads"),default_configuration_js_1=require("../../../log/default-configuration.js"),constant_js_1=require("../constant/constant.js"),cache_store_js_1=require("../store/cache-store.js");let workerCacheManager;function unmountTscCommonCache(){null==workerCacheManager||workerCacheManager.unmount(constant_js_1.PoolConstant.TSC_COMMON_CACHE_KEY)}function getReturnMessage(e,t){const r=null==workerCacheManager?void 0:workerCacheManager.cacheItemSize();return e instanceof Error?{event:constant_js_1.PoolConstant.WORK_ERROR,id:t,returnVal:{name:e.name,message:e.message,stack:e.stack},cacheSize:r}:{event:constant_js_1.PoolConstant.WORK_DONE,id:t,returnVal:e,cacheSize:r}}(0,default_configuration_js_1.setCategoriesLevel)(null!==(_a=default_configuration_js_1.levelMap.get(worker_threads_1.workerData.logLevel))&&void 0!==_a?_a:log4js_1.levels.INFO),log4js_1.default.shutdown(),log4js_1.default.configure((0,default_configuration_js_1.getConfiguration)()),worker_threads_1.workerData.shouldResident&&(workerCacheManager=new cache_store_js_1.CacheStoreManager({capacity:worker_threads_1.workerData.cacheCapacity,ttl:worker_threads_1.workerData.cacheTtl})),worker_threads_1.parentPort.on("message",(async e=>{var t;if(e.event===constant_js_1.PoolConstant.UNMOUNT_TSC_COMMON_CACHE_EVENT)return void unmountTscCommonCache();const r=e=>{if(0!==e)throw new Error(`A process.exit was called in worker thread with exit code ${e}`)};let o;process.on("exit",r);const a=e.workPath,n=e.inputData;if(a.indexOf(constant_js_1.PoolConstant.FILE_SUFFIX)>0){const r=a.indexOf(constant_js_1.PoolConstant.FILE_SUFFIX)+constant_js_1.PoolConstant.FILE_SUFFIX.length,n=a.slice(0,r),s=a.slice(r+1).split(path_1.default.sep);let _=await(t=n,Promise.resolve().then((()=>__importStar(require(t)))));if(s.length&&""!==s[0]){for(let t=0;t<s.length;t++){const r=s[t];if(""===r){if(t===s.length-1){_=_.default;break}return void worker_threads_1.parentPort.postMessage({event:constant_js_1.PoolConstant.WORK_ERROR,id:e.id})}_=_[r]}o=_}else o=_.default}const s=await o(n,workerCacheManager);worker_threads_1.parentPort.postMessage(getReturnMessage(s,e.id)),process.off("exit",r),e.exitAfterDone&&process.exit(0)}));for(const e of worker_threads_1.workerData.preludeDeps)require(e);