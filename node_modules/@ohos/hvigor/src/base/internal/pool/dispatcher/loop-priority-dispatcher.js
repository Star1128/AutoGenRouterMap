"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LoopPriorityDispatcher=void 0;const hvigor_log_js_1=require("../../../log/hvigor-log.js"),cpu_js_1=require("../../../util/cpu.js"),constant_js_1=require("../constant/constant.js"),log_js_1=require("../log-collection/log.js"),tcb_store_js_1=require("../store/tcb-store.js"),log=hvigor_log_js_1.HvigorLogger.getLogger("workerDispatcher");class LoopPriorityDispatcher{constructor(){this.failedAttempts=0}dispatch(e,t,o,r){if(t.empty())return!1;if(cpu_js_1.cpuUsage>=constant_js_1.PoolConstant.CPU_LIMIT&&this.failedAttempts<constant_js_1.PoolConstant.MAX_FAIL_ATTEMPTS)return this.failedAttempts++,setTimeout((()=>{this.dispatch(e,t,o,r)}),constant_js_1.PoolConstant.FAIL_DISPATCH_INTERVAL),!1;this.failedAttempts=0;const s=t;if(void 0!==r)return this.dispatchWithGivenWorker(e,s,o,r);for(let t=o.getMaxPoolNum();t>=0;t--)if(this.dispatchWithGivenWorker(e,s,o,t))return!0;return!1}dispatchWithGivenWorker(e,t,o,r){if(o.isBusyWorker(r))return log.debug(`A work dispatched to worker[${r}] failed because of worker busy.`),!1;const s=t.getFirstWaitingWork(r);if(!s)return log.debug(`A work dispatched to worker[${r}] failed because unable to get work from ready queue.`),!1;const i=tcb_store_js_1.TcbStore.getTCB(s.getId()),a=null==i?void 0:i.getTaskName();return o.isIdleWorker(r)||o.createWorker(r,s.getPreludeDeps())?o.doWork(s,i.getCallback(),i.getCallbackInput(),r)?(log.debug(`${a} work[${s.getId()}] has been dispatched to worker[${r}].`),tcb_store_js_1.TcbStore.getTCB(s.getId()).isWarmUp()||e.addLog((0,log_js_1.generateScheduleLog)(`${Date.now()}`,s.getId(),r)),!0):(log.debug(`${a} work[${s.getId()}] dispatched to worker[${r}] failed: doWork failed.`),t.pushWork(s,r),!1):(log.debug(`${a} work[${s.getId()}] dispatched to worker[${r}] failed: create worker failed.`),t.pushWork(s,r),!1)}}exports.LoopPriorityDispatcher=LoopPriorityDispatcher;