"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.taskControlCenter=exports.TaskControlCenter=void 0;const events_1=__importDefault(require("events")),parse_json_util_js_1=require("../../../../common/util/parse-json/parse-json-util.js"),ts_check_js_1=require("../../util/ts_check.js"),task_module_util_js_1=require("../util/task-module-util.js"),task_path_util_js_1=require("../util/task-path-util.js"),task_directed_acyclic_graph_js_1=require("./task-directed-acyclic-graph.js"),task_queue_js_1=require("./task-queue.js");class TaskControlCenter extends events_1.default{constructor(){super(),this.blockedTaskMap=new Map,this.runnableTaskQueue=new task_queue_js_1.TaskQueue,this.runningTaskList=new Map}clear(){this.clearRunnableTaskQueue(),this.clearBlockedTaskMap(),this.clearInterval(),this.runningTaskList.clear()}initTaskQueueBeforeRun(e){e.forEach((e=>this.initTaskQueueForOneTaskNew(e)))}initTaskQueueForOneTaskNew(e){this.updateTargetRoots(e);const t=[...task_directed_acyclic_graph_js_1.projectTaskDag.getChildren(e).values()];this.blockedTaskMap.set(e,t.length),0===t.length?this.runnableTaskQueue.push(e):t.forEach((e=>{this.blockedTaskMap.has(e)||this.initTaskQueueForOneTaskNew(e)}))}updateTargetRoots(e){const{moduleName:t}=(0,task_path_util_js_1.parseTaskPath)(e);if(ts_check_js_1.targetModules.has(t))return;const s=(0,task_module_util_js_1.getModuleFromTaskPath)(e);if(!s)throw new Error(`Can not find node ${t} with task ${e}`);ts_check_js_1.hvigorConfigFileTsRoot&&ts_check_js_1.targetRoots.add(ts_check_js_1.hvigorConfigFileTsRoot);const a=`${s.getBuildFilePath()}.ts`;if(!ts_check_js_1.hvigorfileTSRoots.has(a))return;ts_check_js_1.targetRoots.add(a),ts_check_js_1.targetModules.add(t);const r=(0,parse_json_util_js_1.parseJsonFile)(s.getBuildProfilePath()).entryModules;if(!r)return;const n=s.getProject();for(const e of r){const s=n.findModuleByName(e);if(!s)throw new Error(`Invalid related node ${e} from node ${t} `);const a=`${s.getBuildFilePath()}.ts`;ts_check_js_1.hvigorfileTSRoots.has(a)&&(ts_check_js_1.targetRoots.add(a),ts_check_js_1.targetModules.add(e))}}clearRunnableTaskQueue(){this.runnableTaskQueue.clear()}clearBlockedTaskMap(){this.blockedTaskMap.clear()}allTasksHasExecuted(){return 0===this.blockedTaskMap.size}popRunnableTask(){return this.runnableTaskQueue.pop()}getRunnableTaskSize(){return this.runnableTaskQueue.size()}setTaskExecuted(e){this.blockedTaskMap.delete(e);task_directed_acyclic_graph_js_1.projectTaskDag.getParent(e).forEach((e=>{if(!this.blockedTaskMap.has(e))return;const t=this.blockedTaskMap.get(e)-1;this.blockedTaskMap.set(e,t),0===t&&this.runnableTaskQueue.push(e)}))}pushRunningTask(e){this.runningTaskList.set(e.getPath(),e)}getRunningTask(e){return this.runningTaskList.get(e)}setIntervalId(e){this.intervalId=e}clearInterval(){clearInterval(this.intervalId)}}exports.TaskControlCenter=TaskControlCenter,exports.taskControlCenter=new TaskControlCenter;