"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.startJavaDaemon=void 0;const child_process_1=require("child_process"),cluster_1=__importDefault(require("cluster")),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),ws_1=__importDefault(require("ws")),index_js_1=require("../../../common/util/iconv/index.js"),system_util_js_1=require("../../../common/util/system-util.js"),hvigor_log_js_1=require("../../log/hvigor-log.js"),java_daemon_util_js_1=require("./java-daemon-util.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("JavaDaemon"),DEFAULT_START_PORT=45050,charSet=(0,system_util_js_1.isWindows)()?"GBK":"UTF-8",HVIGOR_JAVA_DAEMON_JAR="hvigor-java-daemon.jar",HVIGOR_JAVA_DAEMON_JAR_PATH=path_1.default.resolve(__dirname,"../../../../lib",HVIGOR_JAVA_DAEMON_JAR);function tryStartDaemonAtPort(e,t,o){const r=(0,child_process_1.spawn)("java",["-jar",e,t.toString()],{windowsHide:!0});r.on("spawn",(()=>{_log.debug(`java daemon started at port ${t} pid ${r.pid}`);try{(0,java_daemon_util_js_1.writeJavaDaemonInfo2CacheFile)({port:t,pid:r.pid})}catch(e){_log.error(`java daemon writeJavaDaemonInfo2CacheFile failed ${e}`)}})),r.on("error",(e=>{_log.debug(`on error: ${e}`)})),r.stdout.on("data",(e=>{_log.debug(`on stdout: ${index_js_1.iconv.decode(e,charSet)}`)})),r.stderr.on("data",(r=>{_log.debug(`on stderr: ${index_js_1.iconv.decode(r,charSet)}`),-1!==r.toString().indexOf("java.net.BindException: Address already in use")&&(t++,++o<10&&tryStartDaemonAtPort(e,t,o))})),r.on("exit",((e,t)=>{_log.debug(`java daemon exit code:${e} signal:${t}`)})),process.on("exit",(()=>{if(_log.debug(`master process exit pid ${process.pid}`),r.pid)try{process.kill(r.pid),_log.debug(`kill java process pid ${r.pid}`)}catch(e){_log.error(`kill java process failed ${e}`)}}))}function tryConnect(e){return new Promise(((t,o)=>{const r=new ws_1.default(`ws://localhost:${e}`);r.on("error",(function(e){o(e)})),r.on("open",(function(){r.close(),t("")}))}))}function execSystemCommand(e){try{const t=(0,child_process_1.execSync)(e,{windowsHide:!0,encoding:"buffer",stdio:"pipe"});return index_js_1.iconv.decode(t,charSet)}catch(e){if(e.stderr){const t=index_js_1.iconv.decode(e.stderr,charSet);_log.warn(t)}else _log.warn(e)}}function killByPid(e){const t=execSystemCommand(`ps -fp ${e}`);if(t&&t.includes("java -jar")&&t.includes(HVIGOR_JAVA_DAEMON_JAR)&&!t.includes(HVIGOR_JAVA_DAEMON_JAR_PATH))try{process.kill(Number(e),"SIGKILL")}catch(e){_log.warn(e)}}function killByGrep(){const e=execSystemCommand(`ps -ef | grep ${HVIGOR_JAVA_DAEMON_JAR}`);if(!e)return;const t=e.split("\n");for(const e of t)if(e.includes("java -jar")&&!e.includes(HVIGOR_JAVA_DAEMON_JAR_PATH)){const t=e.trim().split(/\s+/);if(t.length<2)continue;const o=t[1];try{process.kill(Number(o),"SIGKILL")}catch(e){_log.warn(e)}}}function startJavaDaemon(){if(cluster_1.default.isMaster){if(!fs_1.default.existsSync(HVIGOR_JAVA_DAEMON_JAR_PATH))return void _log.error(`${HVIGOR_JAVA_DAEMON_JAR} not exist at path ${HVIGOR_JAVA_DAEMON_JAR_PATH}`);const e=(0,java_daemon_util_js_1.readJavaDaemonInfoFromCacheFile)();((0,system_util_js_1.isLinux)()||(0,system_util_js_1.isMac)())&&((null==e?void 0:e.pid)?killByPid(e.pid):killByGrep()),(null==e?void 0:e.port)?tryConnect(e.port).then((()=>{_log.debug("java daemon tryConnect success")}),(e=>{_log.debug(`java daemon tryConnect failed ${e}`),tryStartDaemonAtPort(HVIGOR_JAVA_DAEMON_JAR_PATH,45050,0)})):tryStartDaemonAtPort(HVIGOR_JAVA_DAEMON_JAR_PATH,45050,0)}}exports.startJavaDaemon=startJavaDaemon;