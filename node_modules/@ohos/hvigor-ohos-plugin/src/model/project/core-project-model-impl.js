"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,r)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CoreProjectModelImpl=void 0;const hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),find_target_product_js_1=require("../../common/find-target-product.js"),trace_js_1=require("../../common/trace.js"),common_const_js_1=require("../../const/common-const.js"),version_const_js_1=require("../../const/version-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),build_mode_manager_js_1=require("../../project/build-option/build-mode-manager.js"),sdk_util_js_1=require("../../sdk/sdk-util.js"),array_util_js_1=require("../../utils/array-util.js"),command_line_util_js_1=require("../../utils/command-line-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),crossplatform_const_js_1=require("../../const/crossplatform-const.js"),inject_util_js_1=require("../../utils/inject-util.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),project_build_profile_loader_js_1=require("../../utils/loader/file/project-build-profile-loader.js");class CoreProjectModelImpl{constructor(e){this._moduleSpecificTargets=new Map,this.subModels=new Map,this._log=ohos_logger_js_1.OhosLogger.getLogger(CoreProjectModelImpl.name),this.productApiMetaMap=new Map,this.targetRuntimeOS=[],this._moduleTargets=new Map,this.paramWhiteList=["version","devDependencies","dynamicDependencies","dependencies"],this.project=e,this.projectPath=e.getNodeDir(),this.name=e.getName(),this._profilePath=path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.PROFILE_JSON5),this.projectBuildProfileCheck(this._profilePath),this._profileOptions=project_build_profile_loader_js_1.projectBuildProfileLoader.getBuildProfile(),this._productNames=this._profileOptions.app.products.map((e=>e.name)),this.projectStatusCheck(),this.initializeApiMetadata(),this.parseConfiguredTargetsInHvigorCommand(),this.initArkUIXConfigJsonObj();const t=this.isOhpmProject()?this.getOhPackageJson5Path():this.getPackageJsonPath();if(this.packageJsonObj=hvigor_1.Json5Reader.getJson5Obj(t),!this.isOhpmProject())return void this.trace();const i=hvigor_1.hvigorCore.getParameter().getExtParam(common_const_js_1.CommonConst.PARAMETER_FILE);i&&!this.packageJsonObj.parameterFile&&this._log._buildError('missing or invalid config of "parameterFile" in the project-level oh-package.json5 file.')._file(t)._printErrorAndExit();const o=null!=i?i:this.packageJsonObj.parameterFile;o&&(this.parameterFileAbsolutePath=path_1.default.resolve(this.getProjectDir(),o),fse.existsSync(this.parameterFileAbsolutePath)||this._log._buildError(`The parameterFile file ${o} configured at the project level does not exist.`)._file(t)._printErrorAndExit(),fse.statSync(this.parameterFileAbsolutePath).isFile()||this._log._buildError(`parameterFile:${o} is not a file`)._file(t)._printErrorAndExit(),this.parameterFileObj=hvigor_1.Json5Reader.getJson5Obj(this.parameterFileAbsolutePath)),this.trace()}refreshData(){this._profileOptions=project_build_profile_loader_js_1.projectBuildProfileLoader.getBuildProfile(),this._productNames=this._profileOptions.app.products.map((e=>e.name)),this.projectStatusCheck(),this.initializeApiMetadata()}trace(){var e,t,i,o;const r=project_build_profile_loader_js_1.projectBuildProfileLoader.getBuildProfile(),s={},a=null===(e=null==r?void 0:r.app)||void 0===e?void 0:e.products;a&&(s.PRODUCTS=a.map((e=>({NAME:e.name,COMPILE_SDK_VERSION:e.compileSdkVersion,COMPATIBLE_SDK_VERSION:e.compatibleSdkVersion,RUNTIMEOS:e.runtimeOS}))));const l=null===(t=null==r?void 0:r.app)||void 0===t?void 0:t.buildModeSet;l&&(s.BUILD_MODE_SET=l.map((e=>({NAME:e.name}))));const n=null==r?void 0:r.modules;n&&(s.MODULES=n.map((e=>{var t,i;return{TARGETS:null!==(i=null===(t=e.targets)||void 0===t?void 0:t.map((e=>({NAME:e.name}))))&&void 0!==i?i:[]}})));const _=null===(i=hvigor_1.globalData.cliEnv.configProps)||void 0===i?void 0:i.get("prop");_&&(s.BUILD_MODE=null!==(o=_.get("buildMode"))&&void 0!==o?o:build_mode_manager_js_1.BuildModeManager.getBuildMode()),trace_js_1.ohosTrace.setProjectConfig(s)}registryTarget(e){var t;const i=e.getModuleService().getModuleModel().getName(),o=null!==(t=this._moduleTargets.get(i))&&void 0!==t?t:[];this._moduleTargets.set(i,[...o,e])}getTarget(e,t){var i,o;return t?null===(o=this._moduleTargets.get(e))||void 0===o?void 0:o.find((e=>e.getTargetData().getTargetName()===t)):null===(i=this._moduleTargets.get(e))||void 0===i?void 0:i.find((()=>!0))}getTargetRuntimeOSs(){return this.targetRuntimeOS}parseConfiguredTargetsInHvigorCommand(){const e=hvigor_1.hvigorCore.getExtraConfig().get("module");this._moduleSpecificTargets=(0,command_line_util_js_1.parseTargets)(e)}projectStatusCheck(){validate_util_js_1.ValidateUtil.validateContainsDefault(this._profileOptions.app.products,this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.app.products,"products",this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.app.signingConfigs,"signingConfigs",this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.modules,"modules",this._profilePath),this._profileOptions.modules.forEach((e=>validate_util_js_1.ValidateUtil.validateDuplicatedName(e.targets,"targets",this._profilePath))),validate_util_js_1.ValidateUtil.apiConfigurationCheck(this),validate_util_js_1.ValidateUtil.modelVersionCheck()}initializeApiMetadata(){var e;const t=(0,find_target_product_js_1.findTargetProduct)(this);this.productApiMetaMap.set(t.name,{compileSdkVersion:(0,sdk_util_js_1.parseApiVersion)(null!==(e=t.compileSdkVersion)&&void 0!==e?e:version_const_js_1.VersionConst.SUPPORT_COMPILE_VERSION),compatibleSdkVersion:(0,sdk_util_js_1.parseApiVersion)(t.compatibleSdkVersion),targetSdkVersion:t.targetSdkVersion?(0,sdk_util_js_1.parseApiVersion)(t.targetSdkVersion):void 0})}getBuildProfileName(){return common_const_js_1.CommonConst.PROFILE_JSON5}getName(){return this.name}getProject(){return this.project}getPackageJsonPath(){return path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.PACKAGE_JSON)}getOhPackageJson5Path(){return oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.OH_PACKAGE_JSON5))}getArkUIXConfigJsonPath(){return path_1.default.resolve(this.projectPath,crossplatform_const_js_1.ARKUIX_ROOT,crossplatform_const_js_1.ARKUIX_CONFIG_JSON5)}getProfilePath(){return this._profilePath}getProjectDir(){return this.projectPath}getProductNames(){return this._productNames}getProfileOpt(){return this._profileOptions}getSubModuleModels(){return this.subModels}getModuleModelByName(e){return this.subModels.get(e)}getCompileApiMetaByProduct(e){const t=this.getProductApiMeta(e);if(!t)throw new Error(`Can not find product ${e}.`);return t.compileSdkVersion}getCompatibleApiMetaByProduct(e){const t=this.getProductApiMeta(e);if(!t)throw new Error(`Can not find product ${e}.`);return t.compatibleSdkVersion}getProductApiMeta(e){var t;return null===(t=this.productApiMetaMap)||void 0===t?void 0:t.get(e)}getTargetApiMetaByProduct(e){var t;return null===(t=this.getProductApiMeta(e))||void 0===t?void 0:t.targetSdkVersion}getAllModules(){return[...this.subModels.values()]}getAllEntryModules(){const e=new Set;return this.subModels.forEach(((t,i)=>{t.getModuleType()===module_type_enum_js_1.ModuleType.Entry&&e.add(i)})),e}getTargetApplyProducts(e,t){const i=(0,array_util_js_1.getElementFromArr)(this._profileOptions.modules,e);if(void 0===i)return;const o=(0,array_util_js_1.getElementFromArr)(i.targets,t);return void 0!==o?o.applyToProducts:void 0}getModuleProfileOpt(e){return(0,array_util_js_1.getElementFromArr)(this._profileOptions.modules,e)}getModuleSpecificTargets(){return this._moduleSpecificTargets}getParameterFileAbsolutePath(){return this.parameterFileAbsolutePath}getParameterFileObj(){return this.parameterFileObj}projectBuildProfileCheck(e){const t=common_const_js_1.BuildProfileSchemaFileConst.PROJECT_BUILD_PROFILE_SCHEMA_PATH,i=common_const_js_1.BuildProfileSchemaFileConst.HAP_MODULE_BUILD_PROFILE_SCHEMA_PATH;fse.existsSync(e)||this._log._buildError("Can not find build config file build-profile.json5.")._file(e)._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.name,filePath:e,schemaPath:i,checkOnly:!0})&&this._log._buildError("The project-level build-profile.json5 file does not comply with the schema. This may occur when the build-profile.json5 file is directly copied from another module, or when the module's hvigorfile requires appTasks instead of hapTasks/hspTasks/harTasks.")._solution("Make sure build-profile.json5 and hvigorfile are configured correctly.")._file(path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.BUILD_FILE_NAME))._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.name,filePath:e,schemaPath:t}),void 0===project_build_profile_loader_js_1.projectBuildProfileLoader.getBuildProfile().app.products&&this._log._buildError("No products found in the build-profile.json5 file.")._solution("Add the products field to the build-profile.json5 file.")._file(this._profilePath)._printErrorAndExit()}isOhpmProject(){return this.getCompileApiMetaByProduct((0,find_target_product_js_1.findTargetProduct)(this).name).version>=9&&(fse.existsSync(this.getOhPackageJson5Path())||!fse.existsSync(this.getPackageJsonPath()))}isCrossplatformProject(){return!!this._arkUIXConfigJsonObj&&this._arkUIXConfigJsonObj.crossplatform}initArkUIXConfigJsonObj(){const e=this.getArkUIXConfigJsonPath();fse.existsSync(e)&&(validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.name,filePath:e,schemaPath:common_const_js_1.BuildProfileSchemaFileConst.ARKUI_X_CONFIG_SCHEMA_PATH}),this._arkUIXConfigJsonObj=(0,json_util_js_1.getJson5Obj)(e),this.arkUIXModuleCheck())}getArkUIXConfigJsonObj(){return this._arkUIXConfigJsonObj}arkUIXModuleCheck(){var e;const t=null===(e=this._arkUIXConfigJsonObj)||void 0===e?void 0:e.modules.reduce(((e,t)=>(this._profileOptions.modules.some((e=>e.name===t))||e.push(t),e)),[]);t&&t.length&&this._log._buildError(`Invalid module name settings in these "modules": "${t.join('","')}". Check whether the module is valid.`)._file(this.getArkUIXConfigJsonPath())._printErrorAndExit()}getRemoteHspPath(){return path_1.default.resolve(this.getProjectDir(),common_const_js_1.CommonConst.OH_MODULES,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP)}getCacheRemoteHspPath(e){const t=path_1.default.resolve(inject_util_js_1.InjectUtil.getBuildCacheParentDir(this.getProjectDir(),hvigor_1.hvigorCore.getProject().getName()),build_directory_const_js_1.BuildDirConst.BUILD_ROOT);return path_1.default.resolve(t,common_const_js_1.CommonConst.CACHE,e,common_const_js_1.CommonConst.REMOTE_HSP)}getCacheIntegratedHspPath(e){const t=path_1.default.resolve(inject_util_js_1.InjectUtil.getBuildCacheParentDir(this.getProjectDir(),hvigor_1.hvigorCore.getProject().getName()),build_directory_const_js_1.BuildDirConst.BUILD_ROOT);return path_1.default.resolve(t,common_const_js_1.CommonConst.CACHE,e,build_directory_const_js_1.BuildDirConst.INTEGRATED_HSP)}isFaMode(){return!1}}exports.CoreProjectModelImpl=CoreProjectModelImpl;