"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosSdkLoader=void 0;const sdkmanager_common_1=require("@ohos/sdkmanager-common"),path_and_api_map_js_1=require("@ohos/sdkmanager-common/build/src/core/util/path-and-api-map.js"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),default_progress_js_1=require("./lib/default-progress.js"),property_get_js_1=require("./lib/property-get.js"),sdk_util_js_1=require("./sdk-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("SdkLoader");class OhosSdkLoader{constructor(){this.sdkMap=new path_and_api_map_js_1.PathAndApiMap,this.property=new property_get_js_1.Property(!1)}static getInstance(){return OhosSdkLoader.container||(OhosSdkLoader.container=new OhosSdkLoader),OhosSdkLoader.container}async getOhosSdkComponents(e,s){this.validateCache();const r=[];s.forEach((s=>r.push(new sdkmanager_common_1.PathAndApiVersion(s,e.version))));const t=this.pickRequired(this.sdkMap,r),o=[...t.values()].filter((e=>{var s;return!fs_extra_1.default.existsSync(path_1.default.resolve(null!==(s=e.getLocation())&&void 0!==s?s:"",common_const_js_1.CommonConst.OHOS_SDK_COMPONENT_DEFINITION))}));if(s.length===t.size&&0===o.length)return t;const a=(0,sdk_util_js_1.ohosPredict)(this.property.getSdkDir(),e.api,s);0===a.size&&this.sdkMap.clear();for(const[e,s]of a.entries())this.sdkMap.has(e)||this.sdkMap.set(e,s);const i=this.pickRequired(this.sdkMap,r);if(s.length===i.size)return i;this.sdkInfoHandler||this.initHandler();return(await this.sdkInfoHandler.getOrDownload(r)).forEach(((e,s)=>{this.sdkMap.has(s)||this.sdkMap.set(s,e)})),this.pickRequired(this.sdkMap,r)}pickRequired(e,s){const r=new Map;return s.forEach((s=>{const t=e.get(s);t&&r.set(s,t)})),r}initHandler(){const e=sdkmanager_common_1.OhPrjSdkConfig.builder(this.property.getSdkDir()).sdkProxy(sdk_util_js_1.proxyFun),s=new sdkmanager_common_1.SimpleOhPrjSdkHandler(e,new default_progress_js_1.DefaultProgress);this.sdkInfoHandler=s.getSdkHandler(sdkmanager_common_1.OhPrjSdkType.OPENHARMONY)}validateCache(){const e=new property_get_js_1.Property(!1);e.getSdkDir()!==this.property.getSdkDir()&&(_log.debug("HarmonyOS sdk dir changed."),this.property=e,this.sdkMap.clear(),this.initHandler())}}exports.OhosSdkLoader=OhosSdkLoader;