"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HmosSdkLoader=void 0;const hos_sdkmanager_common_1=require("@ohos/hos-sdkmanager-common"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),default_progress_js_1=require("./lib/default-progress.js"),property_get_js_1=require("./lib/property-get.js"),sdk_util_js_1=require("./sdk-util.js"),hvigor_2=require("@ohos/hvigor"),hos_sdkmanager_common_2=require("@ohos/hos-sdkmanager-common"),meta_util_js_1=require("../utils/meta-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("SdkLoader");class HmosSdkLoader{constructor(){this.hmsSdkMap=new Map,this.sdkMap=new Map,this.property=new property_get_js_1.Property,this.setHosMetaCompileSdkVersion()}static getInstance(){return HmosSdkLoader.container||(HmosSdkLoader.container=new HmosSdkLoader),HmosSdkLoader.container}setHosMetaCompileSdkVersion(){const e=hos_sdkmanager_common_2.HosVersionMapper.INSTANCE,o=e.getLatestSupportVersion(),s=`${e.getHosVersion(o.getBaseApi())}(${o.getBaseApi()})`;(0,meta_util_js_1.updateMetaCompileSdkVersion)(s)}async getHmosSdkComponents(e,o){var s;this.validateCache();const t=null!==(s=this.sdkMap.get(e.version))&&void 0!==s?s:new Map;if(this.checkComponentExistence(o,t,!1)){const e=new Map;return o.forEach((o=>e.set(o,t.get(o)))),e}this.ohosSdkInfoHandler||this.initHandler();const r=hvigor_1.MetricFactory.createDurationEvent("harmonyOS sdk scan","HarmonyOS sdk scan",hvigor_2.HvigorTaskGroupType.OTHER_TASK_GROUP);r.log.debug(`Local scan or download HarmonyOS sdk components ${o.join(",")}`);const n=this.ohosSdkInfoHandler.getLocalSdks(`${e.version}`);this.checkComponentExistence(o,n,!1)||_log.errorMessageExit("SDK component missing. Please verify the integrity of your SDK.");for(const[e,o]of n.entries())t.set(e,o);this.sdkMap.set(e.version,t),r.stop();const a=new Map;return o.forEach((e=>a.set(e,t.get(e)))),a}checkComponentExistence(e,o,s){var t;for(const r of e){const e=o.get(r);if(!e)return!1;const n=s?common_const_js_1.CommonConst.HMS_SDK_COMPONENT_DEFINITION:common_const_js_1.CommonConst.OHOS_SDK_COMPONENT_DEFINITION,a=path_1.default.resolve(null!==(t=e.getLocation())&&void 0!==t?t:"",n);if(!fs_extra_1.default.existsSync(a))return!1}return!0}async getHmsSdkComponents(e,o){var s;this.validateCache();const t=null!==(s=this.hmsSdkMap.get(e.api))&&void 0!==s?s:new Map;if(this.checkComponentExistence(o,t,!0)){const e=new Map;return o.forEach((o=>e.set(o,t.get(o)))),e}this.hmosSdkInfoHandler||this.initHandler();const r=hvigor_1.MetricFactory.createDurationEvent("hmscore sdk scan","Hmscore sdk scan",hvigor_2.HvigorTaskGroupType.OTHER_TASK_GROUP);r.log.debug(`Local scan or download hmscore sdk components ${o.join(",")}`);const n=this.hmosSdkInfoHandler.getLocalSdks(e.api);this.checkComponentExistence(o,n,!0)||_log.errorMessageExit("SDK component missing. Please verify the integrity of your SDK.");for(const[e,o]of n.entries())t.set(e,o);this.hmsSdkMap.set(e.api,t),r.stop();const a=new Map;return o.forEach((e=>a.set(e,t.get(e)))),a}initHandler(){const e=hos_sdkmanager_common_1.HosPrjSdkConfig.builder(this.property.getHosSdkDir()).sdkProxy(sdk_util_js_1.proxyFun),o=new hos_sdkmanager_common_1.SimpleHosPrjSdkHandler(e,new default_progress_js_1.DefaultProgress);this.hmosSdkInfoHandler=o.getSdkHandler(hos_sdkmanager_common_1.HosPrjSdkType.HARMONYOS),this.ohosSdkInfoHandler=o.getSdkHandler(hos_sdkmanager_common_1.HosPrjSdkType.OPENHARMONY)}validateCache(){const e=new property_get_js_1.Property;e.getHosSdkDir()!==this.property.getHosSdkDir()&&(_log.debug("HarmonyOS sdk dir changed."),this.property=e,this.sdkMap.clear(),this.hmsSdkMap.clear(),this.initHandler())}}exports.HmosSdkLoader=HmosSdkLoader;