"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HarTargetUtil=void 0;const task_util_1=require("@ohos/hvigor/src/base/util/task-util"),common_const_js_1=require("../const/common-const.js"),ohos_plugin_id_1=require("../plugin/common/ohos-plugin-id"),ohos_logger_js_1=require("./log/ohos-logger.js");class HarTargetUtil{static getHarTargetName(e,t){const o=e.getModuleService().getProjectModel().getModuleSpecificTargets().get(t);if((null==o?void 0:o.length)&&o[0]!==common_const_js_1.DefaultTargetConst.ALL_TARGET)return o[0];const a=e.getTargetData().getTargetName();if(a===common_const_js_1.CommonConst.OHOS_TEST)return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET;const r=e.getModuleService().getProjectModel().getModuleModelByName(t);if(!r)return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET;const g=r.getTargetOptions().map((e=>e.name)),s=(0,task_util_1.getAlignTarget)();return s&&g.includes(s)?(0,task_util_1.getAlignTarget)():g.includes(a)?a:common_const_js_1.DefaultTargetConst.DEFAULT_TARGET}static calDepHarTargets(e){const t=new Map,o=e.getModuleService(),a=o.getModuleModel(),r=a.getName(),g=e.getTargetData().getTargetName();return o.getHarModuleDependencies().forEach((o=>{const s=this.getHarTargetData(o,a,g,r,e);if(s)t.set(o[0],s);else{const r=o[1].getLastDependencyName();if(r){const g=t.get(r);if(g){const s=this.getHarTargetData(o,a,g,r,e);s&&t.set(o[0],s)}}}})),t}static getHarTargetData(e,t,o,a,r){var g;const s=e[0];if(e[1].getLastDependencyName()&&e[1].getLastDependencyName()!==a)return"";o=null!==(g=(0,task_util_1.getAlignTarget)())&&void 0!==g?g:o;const n=t.getModule().findModuleByName(s);if(!n)return this._log._buildError(`Unable to find target '${o}' in module '${s}'. Make sure module '${s}' has the same target as module '${s}'.`)._printErrorAndExit(a),"";if(r.getModuleService().isFaMode())return this.getHarTargetName(r,s);const i=n.getPluginById(ohos_plugin_id_1.OhosPluginId.OHOS_HAR_PLUGIN).getNeedExecTargetServiceList();i&&0!==i.length||this._log._buildError(`Unable to find target '${o}' in module '${s}'. Make sure module '${s}' has the same target as module '${s}'.`)._printErrorAndExit(a);const l=r.getModuleService().getProjectModel().getModuleSpecificTargets().get(s);if((null==l?void 0:l.length)&&l[0]!==common_const_js_1.DefaultTargetConst.ALL_TARGET)return l[0];if(o===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return common_const_js_1.DefaultTargetConst.DEFAULT_TARGET;const c=i.find((e=>e.getTargetData().getTargetName()===o));return c?c.getTargetData().getTargetName():common_const_js_1.DefaultTargetConst.DEFAULT_TARGET}static getHarDependencyTargetName(e,t){const o=new Map;e.getModuleService().getHarModuleDependencies().forEach((e=>{o.set(e[0],e[1])}));const a=[];a.push(t);let r=t[0],g=t[1];for(;g&&(a.push([r,g]),r=g.getLastDependencyName(),r);)g=o.get(r);const s=e.getModuleService().getModuleModel();let n=s.getName(),i=e.getTargetData().getTargetName();for(;a.length>0;){const t=a.pop();if(t){if(i=this.getHarTargetData(t,s,i,n,e),i===common_const_js_1.DefaultTargetConst.DEFAULT_TARGET)break;n=t[0]}}return i}}exports.HarTargetUtil=HarTargetUtil,HarTargetUtil._log=ohos_logger_js_1.OhosLogger.getLogger("HarTargetUtil");