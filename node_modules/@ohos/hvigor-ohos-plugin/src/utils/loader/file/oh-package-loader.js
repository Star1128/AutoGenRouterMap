"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ohPackageLoader=void 0;const hvigor_1=require("@ohos/hvigor"),crypto_1=__importDefault(require("crypto")),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_1=require("../../../const/build-directory-const"),common_const_1=require("../../../const/common-const"),json_util_1=require("../../json-util"),ohos_logger_1=require("../../log/ohos-logger"),config_file_loader_1=require("../config-file-loader"),_log=ohos_logger_1.OhosLogger.getLogger("OhPackageLoader");class OhPackageLoader{constructor(){this.isUpdateOhPackageInfo=!1,this.isLoaded=!1,this.ohModulesExistMap=new Map,this.OhPackagePathMap=new Map,this.isChangeOhPackageJsonFile=!1,this.UpdatePathToOriginMap=new Map}getDependenciesOpt(e){return this.saveOhPackagePathInfoToLoader(),config_file_loader_1.configFileLoader.getConfigFileJson(e).dependencies}clean(){this.isUpdateOhPackageInfo=!1,this.isLoaded=!1,this.OhPackagePathMap=new Map,this.UpdatePathToOriginMap=new Map}getDevDependenciesOpt(e){return this.saveOhPackagePathInfoToLoader(),config_file_loader_1.configFileLoader.getConfigFileJson(e).devDependencies}getDynamicDependenciesOpt(e){return this.saveOhPackagePathInfoToLoader(),config_file_loader_1.configFileLoader.getConfigFileJson(e).dynamicDependencies}setDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.dependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdateOhPackageInfo=!0}setDevDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.devDependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdateOhPackageInfo=!0}setDynamicDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.dynamicDependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdateOhPackageInfo=!0}getVersion(e){return this.saveOhPackagePathInfoToLoader(),config_file_loader_1.configFileLoader.getConfigFileJson(e).version}setVersion(e,o){"string"!=typeof o&&_log.errorMessageExit(`Invalid dependency: Version "${o}" is not a string.`),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.version=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdateOhPackageInfo=!0}checkIfNeedOhpmInstall(){if(!1===hvigor_1.hvigor.getParameter().getProperty("hvigor.sync.cache"))return!0;if(this.isChangeOhPackageJsonFile=!1,(hvigor_1.globalData.cliOpts.sync||(0,hvigor_1.getAlignTarget)())&&(this.isChangeOhPackageJsonFile=!0),this.isUpdateOhPackageInfo)return!0;const e=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),build_directory_const_1.BuildDirConst.BUILD_OUTPUTS,"sync");let o=(0,json_util_1.getJson5Obj)(path_1.default.resolve(e,"fileCache.json"));return o||(fs_extra_1.default.mkdirSync(e,{recursive:!0}),o={OHPM_FILE_HASH:{}},this.isChangeOhPackageJsonFile=!0),o.OHPM_FILE_HASH||(o.OHPM_FILE_HASH={},this.isChangeOhPackageJsonFile=!0),hvigor_1.hvigor.getAllNodes().forEach((e=>{const t=path_1.default.resolve(e.getNodePath(),common_const_1.CommonConst.OH_PACKAGE_JSON5),a=path_1.default.resolve(e.getNodePath(),"oh_modules"),i=fs_extra_1.default.existsSync(a);this.ohModulesExistMap.get(a)&&this.ohModulesExistMap.get(a)!==i&&(this.isChangeOhPackageJsonFile=!0);const n=o.OHPM_FILE_HASH[t],s=this.getHashFromOhPackagePath(t);s!==n&&(this.isChangeOhPackageJsonFile=!0),o.OHPM_FILE_HASH[t]=s})),this.isChangeOhPackageJsonFile&&fs_extra_1.default.writeJSONSync(path_1.default.resolve(e,"fileCache.json"),o),this.isChangeOhPackageJsonFile}getHashFromOhPackagePath(e){const o=fs_extra_1.default.statSync(e),t=`${o.size}-${o.mtime.getTime()}`,a=crypto_1.default.createHash("sha256");return a.update(t),a.digest("hex")}validOhModulesExistMap(){hvigor_1.hvigor.getAllNodes().forEach((e=>{const o=path_1.default.resolve(e.getNodePath(),"oh_modules");this.ohModulesExistMap.set(o,fs_extra_1.default.existsSync(o))}))}loadUpdatedOhPackageToDisk(e){_log.debug("start to load updatedOhPackageInfo to the disk"),this.saveOhPackagePathInfoToLoader();const o=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP,e);fs_extra_1.default.removeSync(path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP)),fs_extra_1.default.mkdirSync(o,{recursive:!0});const t={targetName:e||void 0,rootDependency:`./${common_const_1.CommonConst.OH_PACKAGE_JSON5}`,dependencyMap:{}};hvigor_1.hvigor.getAllNodes().forEach((e=>{const a=path_1.default.resolve(e.getNodePath(),common_const_1.CommonConst.OH_PACKAGE_JSON5);if(e.getNodeName()===hvigor_1.hvigor.getRootNode().getNodeName())return fs_extra_1.default.writeFileSync(path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5),JSON.stringify(config_file_loader_1.configFileLoader.getConfigFileJson(a))),this.OhPackagePathMap.set(a,path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5)),void this.UpdatePathToOriginMap.set(path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5),a);fs_extra_1.default.existsSync(path_1.default.resolve(o,e.getNodeName()))||fs_extra_1.default.mkdirSync(path_1.default.resolve(o,e.getNodeName())),fs_extra_1.default.writeFileSync(path_1.default.resolve(o,e.getNodeName(),common_const_1.CommonConst.OH_PACKAGE_JSON5),JSON.stringify(config_file_loader_1.configFileLoader.getConfigFileJson(a))),this.OhPackagePathMap.set(a,path_1.default.resolve(o,e.getNodeName(),common_const_1.CommonConst.OH_PACKAGE_JSON5)),this.UpdatePathToOriginMap.set(path_1.default.resolve(o,e.getNodeName(),common_const_1.CommonConst.OH_PACKAGE_JSON5),a),t.dependencyMap[e.getNodeName()]=`./${e.getNodeName()}/${common_const_1.CommonConst.OH_PACKAGE_JSON5}`})),fs_extra_1.default.writeFileSync(path_1.default.resolve(o,`${common_const_1.CommonConst.DEPENDENCYMAP}.json5`),JSON.stringify(t)),_log.debug("load to the disk finished")}getNodeOhPackagePath(e){var o;return this.isUpdateOhPackageInfo&&(null===(o=this.OhPackagePathMap)||void 0===o?void 0:o.get(e))||e}saveOhPackagePathInfoToLoader(){this.isLoaded||(hvigor_1.hvigor.getAllNodes().forEach((e=>{const o=path_1.default.resolve(e.getNodePath(),common_const_1.CommonConst.OH_PACKAGE_JSON5);config_file_loader_1.configFileLoader.setConfigFileJson(o,(0,json_util_1.getJson5Obj)(o))})),this.isLoaded=!0)}validateDependency(e){for(const o in e)"string"!=typeof e[o]&&_log.errorMessageExit(`Invalid dependency: DependencyVersion "${e[o]}" is not a string.`)}getOriginPathFromUpdatePath(e){return this.isUpdateOhPackageInfo?(e.forEach(((o,t)=>{o=o.includes(common_const_1.CommonConst.OH_PACKAGE_JSON5)?o:path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5);const a=exports.ohPackageLoader.UpdatePathToOriginMap.get(o);e[t]=a?path_1.default.dirname(a):path_1.default.dirname(o)})),e):e=e.map((e=>path_1.default.dirname(e)))}}exports.ohPackageLoader=new OhPackageLoader;