"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,r){void 0===r&&(r=t);var s=Object.getOwnPropertyDescriptor(o,t);s&&!("get"in s?!o.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,r,s)}:function(e,o,t,r){void 0===r&&(r=t),e[r]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessUtils=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),child_process_1=require("child_process"),fs_1=__importDefault(require("fs")),os=__importStar(require("os")),path_1=__importDefault(require("path")),error_code_map_js_1=require("../error/error-code-map.js"),task_names_js_1=require("../tasks/common/task-names.js"),log_combine_type_1=require("./log/log-combine-type"),ohos_logger_js_1=require("./log/ohos-logger.js");class ProcessUtils{constructor(e="root",o="defaultTask",t="",r="Tools execution failed.",s="Please check the message from tools.",i=((0,hvigor_2.isWindows)()?"GBK":"utf-8")){this._defaultOptions={encoding:null,windowsHide:!0},this._moduleName=e,this._taskName=o,this._errLog=r,this._solution=s,this._ohosCharset=i,this._log=ohos_logger_js_1.OhosLogger.getLogger(`${e}:${o}`),t&&this._log.setLevel(t)}async submitExecutionWithoutReturn(e,o,t,r,s,i,n,a=log_combine_type_1.LogCombineType.WARN){const _={workInput:t={...t,logLevel:hvigor_1.hvigorTrace.LOG_LEVEL},callback:r,callbackInput:s,targetWorkers:n},l=path_1.default.resolve(__dirname,"../tasks/worker/worker-process-script.js/generalExecute");if(o.submit(e,l,_).getState()===hvigor_1.TaskState.REJECT){const e="execute the command",o=i.createSubEvent(e,"");o.start(),await this.execute(t.commandLine,t.commandOptions,a),t.integratedHspCommand&&await this.execute(t.integratedHspCommand),await r(...s),o.stop(),o.setLog(e,hvigor_1.MetricLogType.INFO)}}submitSyncExecutionWithReturn(e,o,t,r,s,i){const n={workInput:r={...r,logLevel:hvigor_1.hvigorTrace.LOG_LEVEL},callback:s,targetWorkers:i,useReturnVal:!0};return o.submit(e,path_1.default.resolve(__dirname,"../tasks/worker/worker-process-script.js",t),n).getState()!==hvigor_1.TaskState.REJECT}async execute(e,o,t=log_combine_type_1.LogCombineType.WARN,r){var s,i;const n=this.processOptionsFactory(o),a={stdout:"",stderr:""};try{this.validateExecuteFile(e[0]),this._log.debug("current process  memoryUsage:",process.memoryUsage(),"os memoryUsage :"+(os.totalmem()-os.freemem())/1024/1024/1024);const o=(0,child_process_1.spawn)(e[0],e.slice(1),n);null===(s=o.stdout)||void 0===s||s.on("data",(e=>{const o=hvigor_1.iconv.decode(e,this._ohosCharset);this._log.debug(o),this.needPrintWarnWhenNoReturnValue()&&this.nativeNoReturnValueWarningHandler(o,t),a.stdout+=o})),null===(i=o.stderr)||void 0===i||i.on("data",(e=>{const o=hvigor_1.iconv.decode(e,this._ohosCharset);a.stderr+=o})),await new Promise(((s,i)=>{o.once("close",(o=>{if(0===o){if(r&&r(a,this._ohosCharset))return void s();t===log_combine_type_1.LogCombineType.DEBUG&&this._log.debug(a.stderr),t===log_combine_type_1.LogCombineType.WARN&&this._log.warn(a.stderr),s()}else i(this.makeError(a.stdout.trim(),a.stderr.trim(),"",o,e.join(" "),e.join(" ")))}))}))}catch(e){throw this.handleException(e,t),e}return a}executeSync(e,o,t=log_combine_type_1.LogCombineType.WARN){var r,s;const i=this.processOptionsFactory(o);let n;try{this.validateExecuteFile(e[0]),n=(0,child_process_1.spawnSync)(e[0],e.slice(1),i);const o=hvigor_1.iconv.decode(n.stdout,this._ohosCharset),a=hvigor_1.iconv.decode(n.stderr,this._ohosCharset);if(n.error||0!==n.status){const r=this.makeError(o.trim(),a.trim(),n.error,n.status,e.join(" "),e.join(" "));this.handleException(r,t)}(null===(r=n.stdout)||void 0===r?void 0:r.length)>0&&this._log.debug(o),(null===(s=n.stderr)||void 0===s?void 0:s.length)>0&&(t===log_combine_type_1.LogCombineType.DEBUG&&this._log.debug(a),t===log_combine_type_1.LogCombineType.WARN&&this._log.warn(a))}catch(o){const r=this.makeError("","",o,o.status,e.join(" "),e.join(" "));this.handleException(r,t)}return n}handleOutput(e,o){var t;if((null===(t=e.stderr)||void 0===t?void 0:t.length)>0){const t=hvigor_1.iconv.decode(e.stderr,this._ohosCharset);o===log_combine_type_1.LogCombineType.DEBUG&&this._log.debug(t),o===log_combine_type_1.LogCombineType.WARN&&this._log.warn(t)}0!==e.status&&this._log._buildError(this._errLog)._solution(hvigor_1.iconv.decode(e.stderr,this._ohosCharset))._printError(this._moduleName)}handleException(e,o){var t;if(e.stderr&&e.stderr.length>0){const r=/(-keystorePwd|-keyPwd) \S+/g,s=null===(t=e.command)||void 0===t?void 0:t.replace(r,"$1 ***");this._log.debug(`ERROR: command = ${s}`),this._log._buildError(o===log_combine_type_1.LogCombineType.IGNORE?`${this._errLog}${os.EOL}${e.message}`:`${this._errLog}${os.EOL}${e.stderr}`),this._log._solution(this._solution)}else this._log._buildError(`${this._errLog}${os.EOL}${e.message}`);this._log._errorCode(error_code_map_js_1.ECM.DECE.PROCESS_UTILS_HANDLE_EXCEPTION),this._log._printErrorAndExit(this._moduleName)}execaCommandSync(e,o){const t=(0,child_process_1.spawnSync)(e,o);return this.printExecaResultLog(t),t}async execaCommand(e,o){const t=this.processOptionsFactory(o);await new Promise(((o,r)=>{var s,i;const n=(0,child_process_1.spawn)(e,t);let a="",_="";null===(s=n.stdout)||void 0===s||s.on("data",(e=>{a+=hvigor_1.iconv.decode(e,this._ohosCharset)})),null===(i=n.stderr)||void 0===i||i.on("data",(e=>{_+=hvigor_1.iconv.decode(e,this._ohosCharset)})),n.on("close",(e=>{if(0!==e){r(a+_)}else o(a)}))})).then((e=>{this._log.info(e)})).catch((e=>{this._log._buildError(this._errLog)._solution(e)._printErrorAndExit()}))}printExecaResultLog(e){var o,t;(null===(o=e.stdout)||void 0===o?void 0:o.length)>0&&this._log.info(hvigor_1.iconv.decode(e.stdout,this._ohosCharset)),(null===(t=e.stderr)||void 0===t?void 0:t.length)>0&&this._log.warn(hvigor_1.iconv.decode(e.stderr,this._ohosCharset)),0!==e.status&&this._log._buildError(this._errLog)._solution(hvigor_1.iconv.decode(e.stderr,this._ohosCharset))._printErrorAndExit()}needPrintWarnWhenNoReturnValue(){return this._taskName.endsWith(task_names_js_1.TaskNames.Task.BUILD_NATIVE_WITH_NINJA.name)||this._taskName.endsWith(task_names_js_1.TaskNames.Task.BUILD_NATIVE_WITH_CMAKE.name)}processOptionsFactory(e){var o;const t=process.env.PATH;return e&&(e.windowsHide=!0),(null==e?void 0:e.env)&&(e.env={...process.env,...e.env}),(null===(o=null==e?void 0:e.env)||void 0===o?void 0:o.path)&&t&&(e.env.path=t+((0,hvigor_2.isWindows)()?";":":")+e.env.path),{...this._defaultOptions,...e}}validateExecuteFile(e){"java"!==e&&"javac"!==e&&(fs_1.default.existsSync(path_1.default.normalize(e))||this._log._buildError("Not an internal or external command, operable program, or batch file.")._file(e)._errorCode(error_code_map_js_1.ECM.DECE.COMMON_UTILS)._printErrorAndExit(this._moduleName))}makeError(e,o,t,r,s,i){const n=void 0!==r?`Command failed with exit code ${r}: ${s}`:`failed: ${s}`,a="[object Error]"===Object.prototype.toString.call(t),_=a?`${n}\n${t.message}`:n,l=[_,o,e].filter(Boolean).join("\n");return a?(t.originalMessage=t.message,t.message=l):t=new Error(l),t.shortMessage=_,t.command=s,t.escapedCommand=i,t.exitCode=r,t.stdout=e,t.stderr=o,"bufferedData"in t&&delete t.bufferedData,t.failed=!0,t}nativeNoReturnValueWarningHandler(e,o){/warning: non-void function does not return a value/.test(e)&&o===log_combine_type_1.LogCombineType.WARN&&this._log.warn(e)}}exports.ProcessUtils=ProcessUtils;