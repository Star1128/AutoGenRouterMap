"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,i,t,o){void 0===o&&(o=t);var r=Object.getOwnPropertyDescriptor(i,t);r&&!("get"in r?!i.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return i[t]}}),Object.defineProperty(e,o,r)}:function(e,i,t,o){void 0===o&&(o=t),e[o]=i[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,i){Object.defineProperty(e,"default",{enumerable:!0,value:i})}:function(e,i){e.default=i}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(i,e,t);return __setModuleDefault(i,e),i},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidateUtil=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),hvigor_config_loader_js_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader.js"),sdkmanager_common_1=require("@ohos/sdkmanager-common"),fs=__importStar(require("fs-extra")),os=__importStar(require("os")),path_1=__importDefault(require("path")),util=__importStar(require("util")),java_command_builder_js_1=require("../../builder/java-command-builder.js"),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),common_const_js_1=require("../../const/common-const.js"),version_const_js_1=require("../../const/version-const.js"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),sdk_util_js_1=require("../../sdk/sdk-util.js"),array_util_js_1=require("../array-util.js"),file_util_js_1=require("../file-util.js"),ohos_logger_js_1=require("../log/ohos-logger.js"),process_utils_js_1=require("../process-utils.js"),validator_store_js_1=require("./validator-store.js"),const_1=require("@ohos/hvigor/src/common/const/const"),path_const_1=require("@ohos/hvigor/src/common/const/path-const"),sign_request_js_1=require("../../tasks/sign/sign-request.js"),json_util_js_1=require("../json-util.js");class ValidateUtil{static modelVersionCheck(){var e;const i=null===(e=hvigor_config_loader_js_1.HvigorConfigLoader.getInstance().getHvigorConfig())||void 0===e?void 0:e.modelVersion,t=path_1.default.resolve(path_const_1.HVIGOR_PROJECT_ROOT_DIR,const_1.DEFAULT_OH_PACKAGE_JSON_FILE_NAME),o=(0,hvigor_1.parseJsonFile)(t,!1).modelVersion;i&&o?("string"!=typeof i&&this._log._buildError("Incompatible types of hvigor modelVersion")._detail("Required: string, Actual: "+typeof i)._printErrorAndExit(),"string"!=typeof o&&this._log._buildError("Incompatible types of oh-package.json5 modelVersion")._detail("Required: string, Actual: "+typeof o)._printErrorAndExit(),i===o?(((0,sdkmanager_common_1.compareVersion)(i,version_const_js_1.VersionConst.CURRENT_MODEL_VERSION)>0||(0,sdkmanager_common_1.compareVersion)(i,version_const_js_1.VersionConst.MINIMUM_MODEL_VERSION)<0)&&this._log._buildError(`Unsupported modelVersion of Hvigor ${i}.`)._detail(`The supported Hvigor modelVersion is ${version_const_js_1.VersionConst.CURRENT_MODEL_VERSION}`)._printErrorAndExit(),((0,sdkmanager_common_1.compareVersion)(o,version_const_js_1.VersionConst.CURRENT_MODEL_VERSION)>0||(0,sdkmanager_common_1.compareVersion)(o,version_const_js_1.VersionConst.MINIMUM_MODEL_VERSION)<0)&&this._log._buildError(`Unsupported modelVersion of oh-package.json5 ${i}.`)._detail(`The supported oh-package.json5 modelVersion is ${version_const_js_1.VersionConst.CURRENT_MODEL_VERSION}`)._printErrorAndExit()):this._log._buildError(`The modelVersion in hvigor-config.json5 is ${i}, \n      and the modelVersion in oh-package.json5 is ${o}.`)._detail("they need to be consistent. Use the migration tool to update the project structure and configuration with Deveco Studio,or refer to the guide to manually update the project structure and configuration.")._printErrorAndExit()):this._log._buildError("The project structure and configuration need to be upgraded before use.")._detail("Use the migration tool to update the project structure and configuration with Deveco Studio, or refer to the guide to manually update the project structure and configuration.")._printErrorAndExit()}static integrationVersionCheck(e,i,t){if(e){if(i.compileSdkVersion){const e=(0,sdk_util_js_1.parseApiVersion)(i.compileSdkVersion),o=(0,sdk_util_js_1.parseApiVersion)(version_const_js_1.VersionConst.SUPPORT_COMPILE_VERSION);e.version===o.version&&0===(0,sdkmanager_common_1.compareVersion)(e.api,o.api)||this._log._buildError(`Unsupported compileSdkVersion ${i.compileSdkVersion}.`)._detail(`Please modify compileSdkVersion to ${version_const_js_1.VersionConst.SUPPORT_COMPILE_VERSION}.`)._file(t)._printErrorAndExit()}if(i.compatibleSdkVersion){const e=(0,sdk_util_js_1.parseApiVersion)(i.compatibleSdkVersion),o=(0,sdk_util_js_1.parseApiVersion)(version_const_js_1.VersionConst.MINIMUM_COMPATIBLE_VERSION);(e.version<o.version||(0,sdkmanager_common_1.compareVersion)(e.api,o.api)<0)&&this._log._buildError(`Unsupported compatibleSdkVersion ${i.compatibleSdkVersion}.`)._detail(`The supported versions range from ${version_const_js_1.VersionConst.MINIMUM_COMPATIBLE_VERSION} to ${version_const_js_1.VersionConst.SUPPORT_COMPILE_VERSION}.`)._file(t)._printErrorAndExit()}}else i.compileSdkVersion||this._log._buildError("Please configure compileSdkVersion in the product.")._detail("The compileSdkVersion is required in OpenHarmony.")._printErrorAndExit()}static apiConfigurationCheck(e){const i=(0,find_target_product_js_1.findTargetProduct)(e);i.compatibleSdkVersion||this._log._buildError("Please configure compatibleSdkVersion in the product.")._file(e.getProfilePath())._printErrorAndExit(e.getName()),i.runtimeOS!==common_const_js_1.CommonConst.OPEN_HARMONY&&"number"!=typeof i.compatibleSdkVersion||i.compileSdkVersion||this._log._buildError("Please configure compileSdkVersion in the product.")._file(e.getProfilePath())._printErrorAndExit(e.getName())}static checkProducts(e){return!(!e.compileSdkVersion&&!e.compatibleSdkVersion)}static apiCompatibleCheck(e,i,t){if((null==t?void 0:t.getApiType())===hap_extra_info_js_1.ApiType.FA&&i.getCompatibleApiVersion()<=7)return{suggestedVersion:8,errorHandler:()=>{this._log._buildError("According to the compatibility specifications, fa-model project can only support the development of API version 8 or later.")._solution("Upgrade compatibleSdkVersion to 8 or later in the build-profile.json5.")._file(null==e?void 0:e.getProfilePath())._printErrorAndExit()}};const o={suggestedVersion:-1};if((null==t?void 0:t.getApiType())!==hap_extra_info_js_1.ApiType.STAGE&&!i.isHarmonyOS())return o;if((null==t?void 0:t.getApiType())===hap_extra_info_js_1.ApiType.STAGE&&i.getCompatibleApiVersion()<=8)return{suggestedVersion:9,errorHandler:()=>{this._log._buildError("According to the compatibility specifications, stage-model project can only support the development of API version 9 or later.")._solution("Upgrade compatibleSdkVersion to 9 or later in the build-profile.json5.")._file(null==e?void 0:e.getProfilePath())._printErrorAndExit()}};const r=this.hosApiMatrixCheck(i);return r[0]?o:{suggestedVersion:r[1],errorHandler:()=>{this._log._buildError(`According to the compatibility specifications, apps of API version ${i.getCompileApiVersion()} or stage mode can only run on devices of API version ${r[1]} or later.`)._solution(`Upgrade compatibleSdkVersion to ${r[1]} or later in the build-profile.json5.`)._file(null==e?void 0:e.getProfilePath())._printErrorAndExit()}}}static hosApiMatrixCheck(e){if(!e.isHarmonyOS())return[!0,e.getApiMeta().compatibleSdkVersion.version];const i=this.hosApiCompatible.get(e.getApiMeta().compileSdkVersion.version);return i?[e.getApiMeta().compatibleSdkVersion.version>=i,i]:[!0,-1]}static schemaCheckOnly(e,i,t){return t((0,json_util_js_1.getJson5Obj)(i))}static submitSchemaCheckWork(e){const{moduleName:i,filePath:t,schemaPath:o,changeAppSchema:r=!1,checkOnly:n=!1,errorHandlers:s}=e,a=validator_store_js_1.ValidatorStore.addValidator(o,r);return n?ValidateUtil.schemaCheckOnly(i,t,a):ValidateUtil.doSchemaCheck(i,t,a,s)}static schemaCheckJSObject(e,i,t){var o;const r=t(e);if(!r){if(!t.errors)return r;const e=[];if(null===(o=t.errors)||void 0===o||o.forEach((t=>{const o={instancePath:t.instancePath,keyword:t.keyword,params:t.params,message:t.message};i&&(o.location=`${null==i?void 0:i.replace(/\\/g,"/")}`),e.push(o)})),0!==e.length){let t="";null==e||e.forEach((e=>{t+=util.format(e,os.EOL)}));const o=ValidateUtil._log._buildError("Schema validate failed.")._detail(`Please check the following fields.${os.EOL}${t}`);i&&o._file(i),o._printErrorAndExit()}}return r}static doSchemaCheck(e,i,t,o){var r;const n=(0,json_util_js_1.getJson5Obj)(i),s=t(n);if(!s){if(!t.errors)return s;const a=(0,hvigor_1.parseJsonFile)(i,!0);let l=[];if(null===(r=t.errors)||void 0===r||r.forEach((e=>{const t={instancePath:e.instancePath,keyword:e.keyword,params:e.params,message:e.message,location:`${i.replace(/\\/g,"/")}`};ValidateUtil.addLocationInfo(t,a),l.push(t)})),o&&o.forEach((e=>{l=e(l,n)})),0!==l.length){let i="";null==l||l.forEach((e=>{i+=util.format(e,os.EOL)})),ValidateUtil._log._buildError("Schema validate failed.")._detail(`Please check the following fields.${os.EOL}${i}`)._printErrorAndExit(e)}}return s}static addLocationInfo(e,i){var t;let o="",r=i;null===(t=e.instancePath)||void 0===t||t.split("/").forEach((e=>{null===e||""===e||("NaN"===parseInt(e).toString()?(r=r[e],o+=""===o?e:`.${e}`):(r=r[parseInt(e)],o+=`[${e}]`))})),e.instancePath=o,e.location+=`:${r._line}:${r._column+1}`}static async getBundleNameFromP7b(e,i,t,o,r=!1){if(void 0!==i){const{verifyTool:n,signingConfigP7bFile:s,signConfigCheckJsonFile:a}=this.getVerifySignInfo(e,i,t),l="verify signing configuration and get bundle name",d=o.createSubEvent(l,"");d.start(),r?await this.executeVerifySingningConfigRequest(n,s,a):await this.executeVerifySingningConfig(n,s,a),d.stop(),d.setLog(l,hvigor_1.MetricLogType.INFO);const c=(0,json_util_js_1.getJson5Obj)(a).content["bundle-info"]["bundle-name"];return fs.existsSync(a)&&fs.removeSync(a),c}return null}static getVerifySignInfo(e,i,t){const o=e.getVerifySignConfigTool();""!==o&&fs.existsSync(path_1.default.resolve(o))||ValidateUtil._log._buildError("No HAP signing tool found in the SDK.")._solution("Download toolchains in the SDK again.")._file(e.getSdkToolchainsDir())._printErrorAndExit();const r=i.material.profile,n=t.getIntermediatesTemp(),s=path_1.default.resolve(n,"signConfigCheckJson.json");return file_util_js_1.FileUtil.checkDirWithoutDelete(path_1.default.resolve(n)),file_util_js_1.FileUtil.checkFile(s),{verifyTool:o,signingConfigP7bFile:r,signConfigCheckJsonFile:s}}static getVerifySignCommands(e,i,t){if(void 0!==i){const{verifyTool:o,signingConfigP7bFile:r,signConfigCheckJsonFile:n}=this.getVerifySignInfo(e,i,t);return(new java_command_builder_js_1.JavaCommandBuilder).addCalledJarFile(o).addJvmOption("verify-profile").addJvmOption("-inFile").addJvmOption(r).addJvmOption("-outFile").addJvmOption(n).build()}return null}static async executeVerifySingningConfig(e,i,t){const o=(new java_command_builder_js_1.JavaCommandBuilder).addCalledJarFile(e).addJvmOption("verify-profile").addJvmOption("-inFile").addJvmOption(i).addJvmOption("-outFile").addJvmOption(t).build();await(new process_utils_js_1.ProcessUtils).execute(o)}static async executeVerifySingningConfigRequest(e,i,t){await(0,sign_request_js_1.sendVerifyProfileRequest)(e,{inFile:i,outFile:t})}static getBundleNameFromHap(e,i){var t;const o=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt);if(null==o?void 0:o.bundleName)return o.bundleName;const r=e.bundleName;return r||i.getDefaultBundleName()}static searchDuplicateName(e){return(0,array_util_js_1.findDuplicateElement)(e.map((e=>e.name)))}static validateDuplicatedName(e,i,t){if(void 0===e)return;const o=ValidateUtil.searchDuplicateName(e);0!==o.length&&ValidateUtil._log._buildError(`Duplicated ${i}: ${o.join(",")}.`)._solution(`Ensure that all ${i} names are unique.`)._file(t)._printErrorAndExit()}static validateContainsDefault(e,i){e&&e.some((e=>"default"===e.name))||ValidateUtil._log._buildError("Unable to find or load the default product.")._solution("Add the product named 'default' to build-profile.json5.")._file(i)._printErrorAndExit()}static isDeviceTypeExist(e,i){return e.some((e=>i.has(e)))}static isAllLiteDeviceType(e,i){return e.every((e=>i.has(e)))}static validateHybridDeviceTypes(e){const i="Check whether the device type field is correctly configured.";ValidateUtil.isDeviceTypeExist(e,ValidateUtil.richDeviceTypes)&&ValidateUtil.isDeviceTypeExist(e,ValidateUtil.liteDeviceTypes)?ValidateUtil._log._buildError("It's not allowed to configure mini-system device when standard-system device exists.")._solution(i)._printErrorAndExit():ValidateUtil.isAllLiteDeviceType(e,ValidateUtil.liteDeviceTypes)&&e.length>1&&ValidateUtil._log._buildError("The device types cannot include multiple mini-system devices.")._solution(i)._printErrorAndExit()}static validateFALiteDevice(e){e.some((e=>ValidateUtil.liteDeviceTypes.has(e)))&&ValidateUtil._log._buildError("Mini-system devices cannot be configured in an FA project.")._solution("Verify the deviceType field in the config.json file.")._printErrorAndExit()}static validateTargetCustomizeResources(e,i){e&&null!==e.match("^./?[\\s\\S]*[^ ]$")&&fs.existsSync(i)||ValidateUtil._log._buildError(`Invalid Targets resource '${e}' configuration.`)._solution("Check whether the resource directories field is correctly configured.")._printErrorAndExit()}static isDefaultCheck(e,i){if(0===e.length)return;let t=0;for(const i of e){!0===i.isDefault&&(t+=1)}if(t>1){const e="Only one default card can be configured in the form_config.json file ";ValidateUtil._log._buildError(e)._file(i)._printErrorAndExit()}}static checkUpdateEnable(e,i){for(const t of e)if(t.updateEnabled&&void 0===t.scheduledUpdateTime&&void 0===t.updateDuration){const e="In the form_config.json file, if the value of the updateEnabled field is true, the updateDuration and scheduleUpdateTime fields cannot be both empty.";ValidateUtil._log._buildError(e)._file(i)._printErrorAndExit()}}}exports.ValidateUtil=ValidateUtil,ValidateUtil._log=ohos_logger_js_1.OhosLogger.getLogger(ValidateUtil.name),ValidateUtil.richDeviceTypes=new Set(["phone","tablet","tv","wearable","car"]),ValidateUtil.liteDeviceTypes=new Set(["lite Wearable","smart Vision","router"]),ValidateUtil.hosApiCompatible=new Map([[9,9],[10,9],[11,9],[12,10]]);