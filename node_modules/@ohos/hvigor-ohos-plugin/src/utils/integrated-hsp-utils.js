"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAppInfoByProject=exports.generateIntegratedHspCommand=exports.IntegratedHspUtils=void 0;const wdk_1=require("@baize/wdk"),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),find_target_product_js_1=require("../common/find-target-product.js"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),json_util_js_1=require("./json-util.js");class IntegratedHspUtils{constructor(e){this.integratedHspCache={bundleName:"",versionCode:"",integratedRemoteHsps:new Map};const t=(0,find_target_product_js_1.findTargetProduct)(e);this.integratedHspCachePath=path_1.default.resolve(e.getCacheIntegratedHspPath(t.name),build_directory_const_js_1.BuildArtifactConst.INTEGRATED_HSP_CACHE),this.initIntegratedHspCache(e,t)}initIntegratedHspCache(e,t){var a,s,n,r,i;if(e.isFaMode())return;const o=e.getAppRes().getAppResOpt();if(!o.app)return;const d=(0,wdk_1.cloneDeep)(null===(a=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===a?void 0:a.appOpt),p=null!==(n=null!==(s=null==d?void 0:d.bundleName)&&void 0!==s?s:t.bundleName)&&void 0!==n?n:o.app.bundleName,l=null!==(i=null!==(r=null==d?void 0:d.versionCode)&&void 0!==r?r:t.versionCode)&&void 0!==i?i:o.app.versionCode,c={bundleName:p,versionCode:null==l?void 0:l.toString(),integratedRemoteHsps:new Map};if(!fs_extra_1.default.existsSync(this.integratedHspCachePath))return void(this.integratedHspCache=c);const u=(0,json_util_js_1.getJson5Obj)(this.integratedHspCachePath),g=path_1.default.dirname(this.integratedHspCachePath);if(u.bundleName===p&&u.versionCode===l.toString()){const e=fs_extra_1.default.readdirSync(path_1.default.dirname(this.integratedHspCachePath));Object.keys(u.integratedRemoteHsps).forEach((t=>{const a=u.integratedRemoteHsps[t];e.includes(t)&&(null==a?void 0:a.hspPath)&&fs_extra_1.default.existsSync(a.hspPath)&&fs_extra_1.default.existsSync(path_1.default.resolve(g,a.hspDirName,a.hspFileName))&&c.integratedRemoteHsps.set(t,a)}))}this.integratedHspCache=c}getIntegratedHspCache(){return this.integratedHspCache}isNeedIntegrated(e){return!this.integratedHspCache.integratedRemoteHsps.has(e)}setIntegratedRemoteHsps(e){this.integratedHspCache.integratedRemoteHsps.set(e.hspDirName,e)}changeIntegratedHspStatus(e){for(const t of this.integratedHspCache.integratedRemoteHsps.values())t.hspDirName===e&&(t.isIntegratedHsp=!0)}writeIntegratedHspCache(){if(0!==this.integratedHspCache.integratedRemoteHsps.size){for(const e of this.integratedHspCache.integratedRemoteHsps.values())if(!e.isIntegratedHsp)return;fs_extra_1.default.existsSync(path_1.default.dirname(this.integratedHspCachePath))||fs_extra_1.default.mkdirSync(path_1.default.dirname(this.integratedHspCachePath),{recursive:!0}),fs_extra_1.default.writeJsonSync(this.integratedHspCachePath,{bundleName:this.integratedHspCache.bundleName,versionCode:this.integratedHspCache.versionCode,integratedRemoteHsps:Object.fromEntries(this.integratedHspCache.integratedRemoteHsps)})}else fs_extra_1.default.existsSync(path_1.default.dirname(this.integratedHspCachePath))&&fs_extra_1.default.removeSync(path_1.default.dirname(this.integratedHspCachePath))}}function generateIntegratedHspCommand(e,t,a,s){const{bundleName:n,versionCode:r}=getAppInfoByProject(e),i=new packing_tool_options_js_1.PackingToolOptions;return i.addCalledJarFile(t),i.addMode("packageNormalize").addBundleName(n).addVersionCode(r.toString()).addHspList(a).addOutPath(s).build()}function getAppInfoByProject(e){var t,a,s,n,r;const i=e.getAppRes().getAppResOpt(),o=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt),d=(0,find_target_product_js_1.findTargetProduct)(e);return{bundleName:null!==(s=null!==(a=null==o?void 0:o.bundleName)&&void 0!==a?a:d.bundleName)&&void 0!==s?s:i.app.bundleName,versionCode:null!==(r=null!==(n=null==o?void 0:o.versionCode)&&void 0!==n?n:d.versionCode)&&void 0!==r?r:i.app.versionCode}}exports.IntegratedHspUtils=IntegratedHspUtils,exports.generateIntegratedHspCommand=generateIntegratedHspCommand,exports.getAppInfoByProject=getAppInfoByProject;