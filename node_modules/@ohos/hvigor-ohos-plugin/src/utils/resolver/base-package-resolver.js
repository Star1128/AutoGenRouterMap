"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BasePackageResolver=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_1=require("../../const/common-const"),oh_package_loader_1=require("../loader/file/oh-package-loader"),resolver_cache_js_1=require("./resolver-cache.js"),ROOT_PATH_REGEX=/^([A-Za-z]:)?[\\/]+/;class BasePackageResolver{constructor(e,a){this.packageFileWord=e,this.moduleDirWord=a}resolvePackagePath(e,a,r){if(a.includes(common_const_1.CommonConst.DEPENDENCYMAP)&&(resolver_cache_js_1.ResolverCache.get(path_1.default.resolve(a))?a=resolver_cache_js_1.ResolverCache.get(path_1.default.resolve(a)):(oh_package_loader_1.ohPackageLoader.OhPackagePathMap.forEach(((e,a)=>{resolver_cache_js_1.ResolverCache.set(path_1.default.dirname(e),path_1.default.dirname(a))})),a=resolver_cache_js_1.ResolverCache.get(path_1.default.resolve(a))||a)),resolver_cache_js_1.ResolverCache.has(`${e}\0${a}\0${this.packageFileWord}`))return resolver_cache_js_1.ResolverCache.get(`${e}\0${a}\0${this.packageFileWord}`);const t=path_1.default.resolve(a),s=ROOT_PATH_REGEX.test(t)?ROOT_PATH_REGEX.exec(t)[0]:path_1.default.resolve("/");let o=t;for(;s!==o;){path_1.default.basename(o).toLowerCase()===this.moduleDirWord.toLowerCase()&&(o=path_1.default.dirname(o));const t=path_1.default.resolve(o,this.moduleDirWord,e);if(fs_extra_1.default.pathExistsSync(t)){const r=path_1.default.resolve(fs_extra_1.default.realpathSync.native(t),this.packageFileWord);return resolver_cache_js_1.ResolverCache.set(`${e}\0${a}\0${this.packageFileWord}`,r),r}try{fs_extra_1.default.lstatSync(t).isSymbolicLink()&&(null==r||r.warn("Please confirm the symbolic link is valid: ",t))}catch(e){}o=path_1.default.dirname(o)}}}exports.BasePackageResolver=BasePackageResolver;