"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileUtil=void 0;const hvigor_1=require("@ohos/hvigor"),task_util_1=require("@ohos/hvigor/src/base/util/task-util"),crypto_1=require("crypto"),fs_1=__importDefault(require("fs")),promises_1=__importDefault(require("fs/promises")),fs_extra_1=__importDefault(require("fs-extra")),glob_1=require("glob"),node_fs_1=require("node:fs"),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),semver_1=require("semver"),stream_1=require("stream"),common_const_js_1=require("../const/common-const.js"),error_code_map_js_1=require("../error/error-code-map.js"),oh_package_loader_1=require("./loader/file/oh-package-loader"),ohos_logger_js_1=require("./log/ohos-logger.js"),json_util_js_1=require("./json-util.js"),DEPENDENCY_VERSION_REPLACE_PREFIX="@param:";class FileUtil{static async linkFile(e,t){const r=await promises_1.default.lstat(e);if(r.isDirectory())return;const i=r.isSymbolicLink()?await promises_1.default.readlink(e):e;if(fs_1.default.existsSync(i)){await fs_extra_1.default.ensureDir(path_1.default.dirname(t));try{await promises_1.default.access(i,fs_1.default.constants.R_OK),await promises_1.default.link(e,t),this._log.debug(`Link ${i} to ${t} successfully.`)}catch(e){this._log.debug(`Hard link from ${i} to ${t} failed. Do copy instead.`),await promises_1.default.copyFile(i,t)}}}static isDirectory(...e){return fs_extra_1.default.statSync(path_1.default.resolve(...e)).isDirectory()}static checkDirWithoutDelete(...e){const t=path_1.default.resolve(...e);fs_extra_1.default.existsSync(t)||fs_extra_1.default.mkdirSync(t,{recursive:!0})}static checkFile(...e){const t=path_1.default.resolve(...e);fs_extra_1.default.existsSync(t)||FileUtil.makeFile(t),fs_extra_1.default.removeSync(t),FileUtil.makeFile(t)}static makeFile(e,t=""){fs_extra_1.default.writeFileSync(e,t)}static deleteFile(e){try{fs_extra_1.default.existsSync(e)&&fs_extra_1.default.removeSync(e)}catch(t){this._log._buildError("Delete file failed, please check and delete file.")._file(e)._errorCode(error_code_map_js_1.ECM.DECE.COMMON_UTILS)._printErrorAndExit()}}static readFile(e){try{if(!fs_extra_1.default.existsSync(e))return;return fs_extra_1.default.readFileSync(e,{encoding:"utf-8"})}catch(t){return void this._log.error(`Please check file at ${e}.`)}}static checkPathLength(e){const t=(0,hvigor_1.maxPathLength)(),r=`\t\t1. Make your project root path shorter.${os_1.default.EOL}`,i=`\t\t2. Simplify your project name.${os_1.default.EOL}`,s=`\t\t3. Simplify your module name.${os_1.default.EOL}`,a=`\t\t4. Configure a shorter target name.${os_1.default.EOL}`;e.length>t&&this._log._buildError(`The length of path exceeds the maximum length: ${t}.`)._solution(`Please try the following solutions:${os_1.default.EOL}${r}${i}${s}${a}`)._file(`'${e}'`)._errorCode(error_code_map_js_1.ECM.DECE.COMMON_UTILS)._printErrorAndExit()}static async hashEntry(e,t){const r=new Map,i=[];return this.readDir(i,e,r,t),await Promise.all(i),r}static readDir(e,t,r,i){const s=fs_extra_1.default.readdirSync(t,{withFileTypes:!0});for(const a of s){const s=path_1.default.resolve(t,a.name);if(!i||i.test(s))if(a.isDirectory())this.readDir(e,s,r,i);else{const t=this.pipelineAsync(r,s);e.push(t)}}}static async pipelineAsync(e,t){return new Promise((r=>{const i=(0,crypto_1.createHash)("md5"),s=(0,node_fs_1.createReadStream)(t);(0,stream_1.pipeline)(s,i,(()=>{e.set(t,i.digest("hex")),r()}))}))}static convertToAbsolutePath(e,t){return path_1.default.isAbsolute(e)?e:path_1.default.resolve(t,e)}static convertToAbsolutePaths(e,t){return e.map((e=>FileUtil.convertToAbsolutePath(e,t)))}static isSubDir(e,t){const r=path_1.default.relative(e,t);return r&&!r.startsWith("..")&&!path_1.default.isAbsolute(r)}static fileExists(e){return fs_1.default.existsSync(e)&&fs_1.default.realpathSync.native(e)===e}static matchingFile(e,t=!1){return!!glob_1.glob.sync(e,{nocase:t}).length}static copySpecialFileToTempDir(e,t){fs_extra_1.default.readdirSync(e).forEach((r=>{if(this.checkSpecialFile(r)){const i=path_1.default.resolve(e,r);fs_extra_1.default.statSync(i).isFile()&&fs_extra_1.default.copySync(i,path_1.default.resolve(t,r))}}))}static addParamToOhPack(e,t,r,i,s){const a=e?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON,o=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(t,a));let l=(0,json_util_js_1.getJson5Obj)(o);l.metadata?Object.assign(l.metadata,r):Object.assign(l,{metadata:r}),l=FileUtil.mergeExtraParamsToOhPack(l,i,s),fs_extra_1.default.writeJSONSync(o,l)}static mergeExtraParamsToOhPack(e,t,r){return e={...e,...t,nativeComponents:(e.nativeComponents||[]).concat(t.nativeComponents||[])},t.nativeComponents||delete e.nativeComponents,r===(0,task_util_1.getAlignTarget)()&&(e.version+=`+${(0,task_util_1.getAlignTarget)()}`),e}static checkSpecialFile(e){const t=["changelog.md","CHANGELOG.md","readme.md","README.md","readme.OpenSource","README.OpenSource","license","LICENSE"],r=e.split(".")[0];return-1!==t.indexOf(e)||-1!==t.indexOf(r)}static uniqueFileName(e,t){const r=new Map;if(e.forEach((e=>{r.set(e,1)})),r.has(t)){let e=r.get(t);for(;r.has(this.addSuffix(t,e));)e++;r.set(t,e+1);const i=this.addSuffix(t,e);return r.set(i,1),i}return r.set(t,1),t}static addSuffix(e,t){return`${e}${t}`}static traverseFileFolder(e){const t=[];if(!fs_extra_1.default.statSync(e).isDirectory()||!fs_extra_1.default.existsSync(e))return[];return fs_extra_1.default.readdirSync(e).forEach((r=>{const i=path_1.default.join(e,r),s=fs_extra_1.default.statSync(i);s.isDirectory()?this.traverseFileFolder(i):s.isFile()&&t.push(r.split(".")[0])})),t}static getAllFilesFromFolder(e){const t=[];if(!fs_extra_1.default.existsSync(e)||!fs_extra_1.default.statSync(e).isDirectory())return[];return fs_extra_1.default.readdirSync(e).forEach((r=>{const i=path_1.default.join(e,r),s=fs_extra_1.default.statSync(i);s.isDirectory()?t.push(...this.getAllFilesFromFolder(i)):s.isFile()&&t.push(i)})),t}static getFileSuffix(e){const t=path_1.default.parse(e).base;return""===t||-1===t.indexOf(".")?t:t.substring(t.lastIndexOf(".")+1)}static normalizePathSeparator(e){return e.replace(/\\\\/g,"/").replace(/\\/g,"/").replace(/\/:/g,":")}static resolveJsonObjWithoutParam(e,t,r,i){for(const s in e)i&&!i.includes(s)||("object"==typeof e[s]&&null!==e[s]?this.resolveJsonObjWithoutParam(e[s],t,r):this.replacePackageWithoutParam(e,s,t,r));this._log.debug(`jsonObjWithoutParam ${JSON.stringify(e)} at ${r}`)}static replacePackageWithoutParam(e,t,r,i){"string"==typeof e[t]&&(e[t]=this.extracted(e[t],r,i))}static extracted(e,t,r){const i=new RegExp("\\@param:(.*?)(\\s|$)"),s=e.match(i);if(!s)return e;if(!t||!r)return void this._log._buildError(`${e} corresponding to the parameterFile is not find, Check the parameterFile is valid.`)._printErrorAndExit();const a=s[1].split(".");return this.findNested(t,a,s[1],r)}static findNested(e,t,r,i){const s=t.shift();if(!s)return void this._log._buildError(`key ${r} does not exist.`)._file(i)._printErrorAndExit();const a=/^[a-zA-Z][a-zA-Z0-9_-]*$/;if(s in e||this._log._buildError(`key ${r} does not exist.`)._file(i)._printErrorAndExit(),t.length)return a.test(s)||this._log._buildError(`The key: ${s} in parameterFile is invalid, only letters, digits, hyphens (-), and underscores (_) are supported, and cannot start with a digit, (-) or (_).`)._file(i)._printErrorAndExit(),"object"!=typeof e[s]&&this._log._buildError(`The value corresponding to the key ${s} must be object.`)._file(i)._printErrorAndExit(),this.findNested(e[s],t,r,i);{"string"!=typeof e[s]&&this._log._buildError(`The value corresponding to the key ${r} must be string.`)._file(i)._printErrorAndExit();const t=e[s].trim();return t&&!/^\s*$/.test(t)||this._log._buildError(`The value corresponding to the key ${r} cannot be empty.`)._file(i)._printErrorAndExit(),"latest"===t||"*"===t?t:((0,semver_1.validRange)(t,{loose:!0,includePrerelease:!0})||this._log._buildError(`Invalid version: ${e[s]} in parameterFile, the version must comply with the semver specifications.`)._printErrorAndExit(),t)}}}exports.FileUtil=FileUtil,FileUtil._log=ohos_logger_js_1.OhosLogger.getLogger("File");