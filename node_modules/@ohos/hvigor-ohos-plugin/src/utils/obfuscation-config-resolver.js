"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformRules=exports.resolveObfuscationDependencies=exports.resolveObfuscationOptions=void 0;const hvigor_1=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),promises_1=__importDefault(require("fs/promises")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),build_mode_manager_js_1=require("../project/build-option/build-mode-manager.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),file_util_js_1=require("./file-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("obfuscation"),resolveObfuscationOptions=async(e,o,t)=>{var s,n,r;const i=e.getTargetData().getModuleModel();if(!o)return;const l=await(0,exports.resolveObfuscationDependencies)(i);return o.ruleOptions={enable:null===(s=o.ruleOptions)||void 0===s?void 0:s.enable,rules:(null===(n=o.ruleOptions)||void 0===n?void 0:n.rules)||(0,exports.transformRules)(null===(r=o.ruleOptions)||void 0===r?void 0:r.files,i.getProjectDir())},o.consumerRules=o.consumerRules||(0,exports.transformRules)(o.consumerFiles,i.getProjectDir()),{selfConfig:o,sdkApis:[],obfuscationCacheDir:t,exportRulePath:e.getTargetData().getPathInfo().getObfuscationExportRulePath(),dependencies:l}};exports.resolveObfuscationOptions=resolveObfuscationOptions;const resolveObfuscationDependencies=async e=>{const o={libraries:[],hars:[]};return await resolveDepObfuscationOptions(e,o),o};exports.resolveObfuscationDependencies=resolveObfuscationDependencies;const resolveDepObfuscationOptions=async(e,o)=>{var t,s,n;const r=e.getParentProject().isOhpmProject(),i=["version","devDependencies","dynamicDependencies","dependencies"],l=r?e.getOhPackageJson5Path():e.getPackageJsonPath();if(!fs_1.default.existsSync(l))return;const a=await hvigor_1.Json5Reader.readJson5File(l);if(r){const o=e.getParentProject().getParameterFileObj();file_util_js_1.FileUtil.resolveJsonObjWithoutParam(a,o,e.getParentProject().getParameterFileAbsolutePath(),i)}if(!(null==a?void 0:a.name))return;const u=r?common_const_js_1.CommonConst.OH_MODULES:common_const_js_1.CommonNodeConst.NODE_MODULES;for(const r in a.dependencies){if(!Object.prototype.hasOwnProperty.call(null==a?void 0:a.dependencies,r))continue;const i=path_1.default.resolve(e.getProjectDir(),u,...r.split("/"));if(!fs_1.default.existsSync(i)){_log.warn(`Dependency ${r} not found.`);continue}let l;try{l=await promises_1.default.lstat(i)}catch(e){_log.warn(`Dependency ${r} not found or symbolic link is invalid.`);continue}const c=l.isSymbolicLink()?await promises_1.default.realpath(i):i,f=resolveModuleWithPath(c,e.getAllModules());if(!f){const e=path_1.default.resolve(c,common_const_js_1.CommonConst.OBFUSCATION_TXT);fs_1.default.existsSync(e)&&-1===o.hars.indexOf(e)&&(_log.debug(`Collect obfuscation config from dependency ${r}.`),o.hars.push(e));continue}if(!f.isHarModule())continue;const d=null===(t=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(f.getName(),"default").arkOptions)||void 0===t?void 0:t.obfuscation;if(d){if(o.libraries.find((e=>e.libDir===c)))return;_log.debug(`Collect obfuscation config from library ${f.getName()}.`);const e={ruleOptions:{enable:null===(s=d.ruleOptions)||void 0===s?void 0:s.enable,rules:(0,exports.transformRules)(null===(n=d.ruleOptions)||void 0===n?void 0:n.files,c)},consumerRules:(0,exports.transformRules)(d.consumerFiles,c),libDir:c};o.libraries.push(e)}await resolveDepObfuscationOptions(f,o)}},resolveModuleWithPath=(e,o)=>{for(const t of o.values()){if(""===path_1.default.relative(t.getProjectDir(),e))return t}},transformRules=(e,o)=>{if(!e)return[];const t=[];return"string"==typeof e?(checkObFile(e,o,t),t):(e.forEach((e=>checkObFile(e,o,t))),t)};exports.transformRules=transformRules;const checkObFile=(e,o,t)=>{const s=path_1.default.resolve(o,e);fs_1.default.existsSync(s)||_log._buildError("The obfuscation file declared in configuration does not exist.")._detail(`Can not find obfuscation file at ${s}.`)._printErrorAndExit(),t.push(s)};