"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDependenciesPkgBriefInfo=void 0;const hvigor_1=require("@ohos/hvigor"),path_1=__importDefault(require("path")),hvigor_extra_config_info_js_1=require("../common/hvigor-extra-config-info.js"),module_path_info_iml_js_1=require("../common/iml/module-path-info-iml.js"),common_const_js_1=require("../const/common-const.js"),ohos_plugin_id_js_1=require("../plugin/common/ohos-plugin-id.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),module_task_service_js_1=require("../tasks/service/module-task-service.js"),npm_package_resolver_js_1=require("./resolver/npm-package-resolver.js"),ohpm_package_resolver_js_1=require("./resolver/ohpm-package-resolver.js"),isOhosTest=e=>e===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,isHarOrHsp=e=>{const o=e.getDependencyType();return o===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||o===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR},getPkgRoot2Module=e=>{const o=new Map;return e.forEach((e=>{isHarOrHsp(e)&&o.set(e.getDependencyRootPath(),e.getModule())})),o},getPkgRoot2Dependency=e=>{const o=new Map;return e.forEach((e=>{isHarOrHsp(e)&&o.set(e.getDependencyRootPath(),e)})),o},getTargetSourceRoots=({pkgRoot:e,dependency:o,productName:t,projectModel:n,pkgRoot2Module:r,referenceTargetName:a})=>{var s,c,g;const i=r.get(e);if(!i)return;const d=i.getName(),p=n.getModuleModelByName(d),_=o.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP?i.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HSP_PLUGIN):i.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAR_PLUGIN);if(!_||!p)return;const l=[];(0,hvigor_1.getAlignTarget)()&&l.push((0,hvigor_1.getAlignTarget)());const u=null===(s=n.getModuleSpecificTargets().get(d))||void 0===s?void 0:s[0];u&&u!==common_const_js_1.DefaultTargetConst.ALL_TARGET&&l.push(u),l.push(a,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);const m=_.getNeedExecTargetServiceList();let h;for(const e of l){const o=m.find((o=>o.getTargetData().getTargetName()===e));if(o&&(0,module_task_service_js_1.checkHasTargetApplyProduct)(p,e,t)){h=o;break}}if(!h)return;const f=(0,hvigor_extra_config_info_js_1.getBuildRoot)(),P=h.getTargetData().getTargetName(),v=new module_path_info_iml_js_1.ModulePathInfoIml(p,P,t,f),k=v.getModulePath(),j=null===(g=null===(c=h.getTargetData().getTargetOpt())||void 0===c?void 0:c.source)||void 0===g?void 0:g.sourceRoots;return{targetName:P,originalSourceRoots:j,sourceRoots:[...j||[],path_1.default.relative(k,v.getModuleSrcMainPath()),path_1.default.relative(k,path_1.default.resolve(v.getGenerateBuildProfileDir(),P))]}},getPkgName2PkgBriefInfo=({entryRoot:e,productName:o,entryTargetName:t,entryDependencies:n,pkgRoot2Module:r,pkgRoot2Dependency:a,packageResolver:s,projectModel:c})=>{const g={},i=new Set,d=[{basePath:e,targetName:t,dependencies:n}];for(;d.length;){const{targetName:e,basePath:t,dependencies:n}=d.shift(),p=isOhosTest(e)?common_const_js_1.DefaultTargetConst.DEFAULT_TARGET:e;Object.keys(n).forEach((e=>{var n;const _=s.resolvePackagePath(e,t);if(!_)return;const l=path_1.default.dirname(_);if(i.has(l))return;i.add(l);const u=a.get(l);if(!u)return;const m=u.getPackageJsonObj(),h=m.name,f={...m.dependencies,...m.dynamicDependencies};if(!u.isLocal())return d.push({targetName:"",dependencies:f,basePath:l}),void(g[h]={pkgRoot:l,pkgName:h,sourceRoots:null===(n=null==m?void 0:m.metadata)||void 0===n?void 0:n.sourceRoots});const P=getTargetSourceRoots({pkgRoot:l,dependency:u,projectModel:c,pkgRoot2Module:r,referenceTargetName:p,productName:o});P&&(d.push({targetName:P.targetName,dependencies:f,basePath:l}),g[h]={pkgRoot:l,pkgName:h,sourceRoots:P.sourceRoots,originalSourceRoots:P.originalSourceRoots})}))}return g},getDependenciesPkgBriefInfo=e=>{const o=e.getModuleService(),t=o.getModuleModel(),n=o.getProjectModel(),r=n.isOhpmProject(),a=r?t.getOhPackageJson5Path():t.getPackageJsonPath(),s=hvigor_1.Json5Reader.getJson5Obj(a),c=r?n.getOhPackageJson5Path():n.getPackageJsonPath(),g=hvigor_1.Json5Reader.getJson5Obj(c),i={...null==g?void 0:g.dependencies,...null==g?void 0:g.dynamicDependencies,...null==s?void 0:s.dependencies,...null==s?void 0:s.dynamicDependencies};if(!Object.keys(i).length)return{};const d=e.getTargetData(),p=d.getTargetName(),_=r?new ohpm_package_resolver_js_1.OhpmPackageResolver:new npm_package_resolver_js_1.NpmPackageResolver,l=new dependency_manager_js_1.DependencyManager(n.isFaMode(),t,n),{npmDependencies:u,moduleDependencyMap:m}=l.collectAllDependencies(),h=getPkgRoot2Dependency(u),f=getPkgRoot2Module(m);return getPkgName2PkgBriefInfo({projectModel:n,pkgRoot2Module:f,packageResolver:_,pkgRoot2Dependency:h,entryTargetName:p,productName:d.getProduct().name,entryRoot:t.getModule().getNodeDir(),entryDependencies:i})};exports.getDependenciesPkgBriefInfo=getDependenciesPkgBriefInfo;