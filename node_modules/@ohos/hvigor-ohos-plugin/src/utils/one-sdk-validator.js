"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ApiModel=exports.OneSdkValidator=void 0;const hos_sdkmanager_common_1=require("@ohos/hos-sdkmanager-common"),find_target_product_js_1=require("../common/find-target-product.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),project_build_profile_js_1=require("../options/build/project-build-profile.js"),ohos_logger_js_1=require("./log/ohos-logger.js");var ApiValType=project_build_profile_js_1.ProjectBuildProfile.ApiValType;const os_1=__importDefault(require("os")),validate_util_js_1=require("./validate/validate-util.js");class OneSdkValidator{static evlProductRuntimeOS(e){const o=(0,find_target_product_js_1.findTargetProduct)(e),t=e.getTargetRuntimeOSs();if(o.runtimeOS)return o.runtimeOS;return t.filter((e=>e.productName===o.name)).find((e=>e.runtimeOS===common_const_js_1.CommonConst.HARMONY_OS))?common_const_js_1.CommonConst.HARMONY_OS:common_const_js_1.CommonConst.OPEN_HARMONY}static apiInspection(e){var o,t,i;const r=(0,find_target_product_js_1.findTargetProduct)(e),n=this.evlProductRuntimeOS(e)===common_const_js_1.CommonConst.HARMONY_OS;validate_util_js_1.ValidateUtil.integrationVersionCheck(n,(0,find_target_product_js_1.findTargetProduct)(e),e.getProfilePath());const s=null===(o=e.getProductApiMeta(r.name))||void 0===o?void 0:o.compileSdkVersion,a=null===(t=e.getProductApiMeta(r.name))||void 0===t?void 0:t.compatibleSdkVersion,l=null===(i=e.getProductApiMeta(r.name))||void 0===i?void 0:i.targetSdkVersion;this.versionCompatibilityCheck(e,n,common_const_js_1.CommonConst.COMPILE_SDK_VERSION,s),this.versionCompatibilityCheck(e,n,common_const_js_1.CommonConst.COMPATIBLE_SDK_VERSION,a),this.versionCompatibilityCheck(e,n,common_const_js_1.CommonConst.TARGET_SDK_VERSION,l),this.versionTypeCheck(e,n,s),this.versionTypeCheck(e,n,a),this.versionTypeCheck(e,n,l);const d=s.version,_=a.version,p=null==l?void 0:l.version;if(d<8&&this._log._buildError("Hvigor only works with API version 8 and later versions.")._detail(`Change compileSdkVersion:'${d}'.`)._file(e.getProfilePath())._printErrorAndExit(),n&&s.version>9&&(0===s.type||0===a.type||l&&0===l.type)&&this._log._buildError("In the current configuration mode, the value of compileSdkVersion/compatibleSdkVersion/targetSdkVersion must be a character string.")._printErrorAndExit(),this.apiTypeCheck(n,r.compileSdkVersion),this.apiTypeCheck(n,r.compatibleSdkVersion),this.apiTypeCheck(n,r.targetSdkVersion),n&&OneSdkValidator.evlApiModel(e,r)===ApiModel.ONE_MSF&&this.msfCompare(e,s,a,l),!(p?_<=p&&_<=d&&p<=d:_<=d)){const o="compatibleSdkVersion <= targetSdkVersion <= compileSdkVersion";this._log._buildError(`Configure the API version according to the rule of ${o}.`)._file(e.getProfilePath())._printErrorAndExit()}}static apiTypeCheck(e,o){o&&typeof o==(e?"number":"string")&&this._log._buildError(`In the current configuration mode, the value of compileSdkVersion/compatibleSdkVersion/targetSdkVersion must be a ${e?"character string":"number"}.`)._printErrorAndExit()}static versionTypeCheck(e,o,t){if(!o&&(null==t?void 0:t.type)===ApiValType.NUM)return;if(!t)return;const i=t.version;if(t.type===ApiValType.NUM?i>sdk_const_js_1.ApiVersion.API_VERSION_9:i<sdk_const_js_1.ApiVersion.API_VERSION_9){const o=t.type===ApiValType.NUM?"character string":"number";this._log._buildError(`In the current configuration mode, api of ${i} must be a ${o}.`)._file(e.getProfilePath())._printErrorAndExit()}}static versionCompatibilityCheck(e,o,t,i){if(!o||(null==i?void 0:i.type)===ApiValType.NUM)return;if(!i)return;const r=hos_sdkmanager_common_1.HosVersionMapper.INSTANCE.transferVersionIntoHosVersion(i.api);r?this.isBaseApiEqual(r,i.version)||this._log._buildError(`The platform version (${i.api}) and API version (${i.version}) of ${t} in build-profile.json5 do not match.`)._detail("Correct the values based on the platform and API version mappings (which you can find under Tools > SDK Manager).")._file(e.getProfilePath())._printErrorAndExit():this._log._buildError(`Unable to find the ${t} ${i.api}(${i.version})`)._detail(`${os_1.default.EOL}\t 1. Check the ${t} ${i.api}(${i.version}) is supported in SDK Manager (which you can find under Tools > SDK Manager).${os_1.default.EOL}\t 2. Correct the hvigorVersion to ensure that the current hvigorVersion supports the ${t} ${i.api}(${i.version}).`)._printErrorAndExit()}static isBaseApiEqual(e,o){return e.getBaseApi()===o}static msfCompare(e,o,t,i){let r=OneSdkValidator.compareMsf(o.api,t.api);r<0&&this._log._buildError("compileSdkVersion must be greater than or equal to compatibleSdkVersion.")._file(e.getProfilePath())._printErrorAndExit(),i&&(r=OneSdkValidator.compareMsf(o.api,i.api),r<0&&this._log._buildError("compileSdkVersion must be greater than or equal to targetSdkVersion.")._file(e.getProfilePath())._printErrorAndExit(),r=OneSdkValidator.compareMsf(i.api,t.api),r<0&&this._log._buildError("targetSdkVersion must be greater than or equal to compatibleSdkVersion.")._file(e.getProfilePath())._printErrorAndExit())}static ohosProductApiValid(e){return!!e&&"number"==typeof e&&e<sdk_const_js_1.ApiVersion.API_VERSION_10}static compareMsf(e,o){const t=OneSdkValidator.parseMsf(e),i=OneSdkValidator.parseMsf(o);return t.m!==i.m?t.m>i.m?1:-1:t.s!==i.s?t.s>i.s?1:-1:t.f!==i.f?t.f>i.f?1:-1:0}static parseMsf(e){const o=e.split(".");if(3!==o.length)throw new Error("Invalid MSF version string.");return{m:parseInt(o[0]),s:parseInt(o[1]),f:parseInt(o[2])}}static evlApiModel(e,o){var t,i;const r=null===(t=e.getProductApiMeta(o.name))||void 0===t?void 0:t.compileSdkVersion,n=null===(i=e.getProductApiMeta(o.name))||void 0===i?void 0:i.compatibleSdkVersion;return 1===r.type&&1===n.type?ApiModel.ONE_MSF:0===r.type&&0===n.type?ApiModel.ONE_NUM:ApiModel.ORIGINAL}}var ApiModel;exports.OneSdkValidator=OneSdkValidator,OneSdkValidator._log=ohos_logger_js_1.OhosLogger.getLogger("OneSdk"),function(e){e[e.ORIGINAL=0]="ORIGINAL",e[e.ONE_MSF=1]="ONE_MSF",e[e.ONE_NUM=2]="ONE_NUM",e[e.UNDEFINED=4]="UNDEFINED"}(ApiModel=exports.ApiModel||(exports.ApiModel={}));