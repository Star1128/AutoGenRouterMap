"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosModuleModelBean=void 0;const hvigor_1=require("@ohos/hvigor"),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../../../const/build-directory-const.js"),common_const_js_1=require("../../../const/common-const.js"),code_type_enum_js_1=require("../../../enum/code-type-enum.js"),compile_mode_enum_js_1=require("../../../enum/compile-mode-enum.js"),module_type_enum_js_1=require("../../../enum/module-type-enum.js"),ohos_plugin_id_js_1=require("../../../plugin/common/ohos-plugin-id.js"),build_mode_manager_js_1=require("../../../project/build-option/build-mode-manager.js"),compile_resources_util_js_1=require("../../../utils/compile-resources-util.js"),inject_util_js_1=require("../../../utils/inject-util.js"),ohos_logger_js_1=require("../../../utils/log/ohos-logger.js"),map_util_js_1=require("../../../utils/map-util.js"),task_names_js_1=require("../../common/task-names.js"),compile_node_js_1=require("../../compile-node.js"),module_task_service_js_1=require("../../service/module-task-service.js"),target_task_service_js_1=require("../../service/target-task-service.js"),find_target_product_js_1=require("../../../common/find-target-product.js"),har_module_build_profile_loader_js_1=require("../../../utils/loader/file/har-module-build-profile-loader.js"),module_build_profile_loader_js_1=require("../../../utils/loader/file/module-build-profile-loader.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("OhosModuleModelBean"),ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,moduleType2IdMap=new Map([[module_type_enum_js_1.ModuleType.Har,ohos_plugin_id_js_1.OhosPluginId.OHOS_HAR_PLUGIN],[module_type_enum_js_1.ModuleType.Entry,ohos_plugin_id_js_1.OhosPluginId.OHOS_HAP_PLUGIN],[module_type_enum_js_1.ModuleType.Feature,ohos_plugin_id_js_1.OhosPluginId.OHOS_HAP_PLUGIN],[module_type_enum_js_1.ModuleType.Shared,ohos_plugin_id_js_1.OhosPluginId.OHOS_HSP_PLUGIN]]);class OhosModuleModelBean{constructor(e,t){this.modelId="ohos-module",this._isFaMode=t,this._module=e;const o=e.getProject().getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_APP_PLUGIN);this._projectModel=o.getProjectModel(),this._moduleModel=this._projectModel.getModuleModelByName(this._module.getName()),this._moduleType=this._moduleModel.getModuleType(),this.modelId=this.modelId.concat("-").concat(e.getName()),this._isHarModule=this._moduleType===module_type_enum_js_1.ModuleType.Har;const s=moduleType2IdMap.get(this._moduleModel.getModuleType()),_=e.getPluginById(s);_||_log._buildError(`The ${s} plugin was not found when initializing the ${e.getName()} module.`)._detail("Check if the module.type field in the module.json5 file matches the system plugin exported in the hvigorfile.ts file.")._printErrorAndExit(),this._moduleTaskService=_.getTaskService(),this._targetTaskServices=_.getNeedExecTargetServiceList(),this._targetDataSet=this._moduleTaskService.getTargetDataSet()}computeCommonInfo(e){e.set("SELECT_TARGET",common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);const t=path_1.default.resolve(this._module.getNodeDir(),common_const_js_1.CommonConst.BUILD),o=inject_util_js_1.InjectUtil.getBuildCacheParentDir(t,path_1.default.join(hvigor_1.hvigorCore.getProject().getName(),t.substring(hvigor_1.hvigorCore.getProject().getNodeDir().length)));e.set("MODULE_BUILD_DIR",path_1.default.resolve(o))}computeBuildOption(e){const t={};this._targetTaskServices.forEach((e=>{const o=(0,find_target_product_js_1.findTargetProduct)(this._projectModel).name.concat("-").concat(e.getTargetData().getTargetName());t[o]=e.getBuildOption()})),e.set("BUILD_OPTION",t),this._isHarModule?e.set("BUILD_PROFILE_OPT",har_module_build_profile_loader_js_1.harModuleBuildProfileLoader.getBuildProfile(this._moduleModel.getName())):e.set("BUILD_PROFILE_OPT",module_build_profile_loader_js_1.moduleBuildProfileLoader.getBuildProfile(this._moduleModel.getName()))}computePathInfo(e){const t=new Map;this._targetDataSet.forEach((e=>{var o;const s=e[0],_=s.getTargetName();if(this._isHarModule&&_===ohosTestTargetName)return;const a=new Map,i=s.getPathInfo(),r=this._moduleTaskService.getModuleModel(),l=this.getCachePath(i,s,r),d=path_1.default.resolve(i.getIntermediatesLoaderPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON),u=this._moduleTaskService.getHarDependencies(),n=new Map,m=new Map;u.forEach(((e,t)=>{const o=path_1.default.resolve(e.getDependencyRootPath(),"src","main",build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.HAR_COMPILED,t);n.set(o,s)}));const g={OUTPUT_PATH:i.getModuleBuildOutputPath(),INTERMEDIA_PATH:i.getModuleBuildIntermediates(),JS_ASSETS_PATH:i.getInterMediatesLoaderOutPath(),JS_LITE_ASSETS_PATH:i.getInterMediatesLoaderOutLitePath(),RES_PATH:path_1.default.resolve(i.getIntermediatesRes(),this.getFirstEntryName()),RES_PROFILE_PATH:i.getIntermediatesResProfilePath(),ETS_SUPER_VISUAL_PATH:l.etsLoaderCachePath,JS_SUPER_VISUAL_PATH:l.aceLoaderCachePath,WORKER_LOADER:d,MANIFEST_JSON:i.getIntermediatesLegacyManifestJson(),OUTPUT_METADATA_JSON:this._moduleType===module_type_enum_js_1.ModuleType.Shared?i.getIntermediatesHspOutputMetadata():i.getIntermediatesOutputMetadata()};a.set("SOURCE_ROOT",null==r?void 0:r.getSourceRootByTargetName(_));const c=[];c.push(null==r?void 0:r.getSourceSetByTargetName(_).getTargetResPath()),c.forEach(((e,t)=>{const o=path_1.default.isAbsolute(e)?e:path_1.default.resolve(r.getProjectDir(),e),s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.MODULE_COMPILED,t);m.set(o,s)}));const h=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(this._moduleModel.getName(),_);a.set("RESOURCES_PATH",c),a.set("BUILD_PATH",g),a.set("BUILD_OPTION",{debuggable:null===(o=h.debuggable)||void 0===o||o}),t.set(_,a)})),e.set("TARGETS",t)}getCachePath(e,t,o){const s=t.getTargetName();let _=this._targetTaskServices.find((e=>e.getTargetData().getTargetName()===s));s===ohosTestTargetName&&(_=this._targetTaskServices.find((e=>e.getTargetData().getTargetName()!==s)));const a=!_||_.getSdkInfo().hasRollUpPluginInEtsLoader;let i=a?task_names_js_1.TaskNames.LegacyFATask.COMPILE_ARK.name:task_names_js_1.TaskNames.LegacyFATask.COMPILE_NODE.name,r=a?task_names_js_1.TaskNames.Task.COMPILE_ARK.name:task_names_js_1.TaskNames.Task.COMPILE_NODE.name;s===ohosTestTargetName&&(i=a?task_names_js_1.TaskNames.LegacyFATask.OHOS_TEST_ARK_COMPILE.name:task_names_js_1.TaskNames.LegacyFATask.OHOS_TEST_COMPILE_NODE.name,r=a?task_names_js_1.TaskNames.Task.OHOS_TEST_ARK_COMPILE.name:task_names_js_1.TaskNames.Task.OHOS_TEST_COMPILE_NODE.name);const l=this._isFaMode?i:r,d=(0,target_task_service_js_1.computeTargetTaskName)(t.getTargetName(),compile_node_js_1.CompileNode.getCompileNodeTaskName(code_type_enum_js_1.CodeType.ETS,l)),u=path_1.default.resolve(e.getModuleBuildCachePath(),d,`${o.getCompileMode(t.getProduct())}`),n=(0,target_task_service_js_1.computeTargetTaskName)(t.getTargetName(),compile_node_js_1.CompileNode.getCompileNodeTaskName(code_type_enum_js_1.CodeType.JS,l));return{etsLoaderCachePath:u,aceLoaderCachePath:path_1.default.resolve(e.getModuleBuildCachePath(),n,`${compile_mode_enum_js_1.CompileModeEnum.JS_BUNDLE}`)}}getFirstEntryName(){const e=this._moduleTaskService.getRelatedEntryModules(),t=this._moduleTaskService.getModuleModel().getModuleType();return module_task_service_js_1.ModuleTaskService.checkEntryModules(t,e)&&this._moduleTaskService.isFaMode()?e[0]:""}buildModel(){const e=new Map;return this.computeCommonInfo(e),this.computePathInfo(e),this.computeBuildOption(e),(0,map_util_js_1.strMapToObj)(e)}}exports.OhosModuleModelBean=OhosModuleModelBean;