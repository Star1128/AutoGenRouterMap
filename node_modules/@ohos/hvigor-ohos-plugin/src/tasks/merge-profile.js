"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,s)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MergeProfile=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),abstract_merge_profile_js_1=require("./abstract-merge-profile.js"),pre_build_js_1=require("./pre-build.js");var Task=task_names_js_1.TaskNames.Task;const project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),array_util_1=require("../utils/array-util"),inject_util_js_1=require("../utils/inject-util.js"),fs_extra_1=__importStar(require("fs-extra")),har_target_util_js_1=require("../utils/har-target-util.js"),json_util_js_1=require("../utils/json-util.js"),hvigor_config_loader_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader"),build_mode_const_1=require("../const/build-mode-const"),hsp_target_utils_js_1=require("../utils/hsp-target-utils.js"),ohos_test_util_js_1=require("../utils/ohos-test-util.js"),task_util_1=require("../utils/task-util"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-merge-profile");class MergeProfile extends abstract_merge_profile_js_1.AbstractMergeProfile{constructor(e){var t,i;super(e,Task.MERGE_PROFILE),this._ohLibs=[],this._isHarModule=this.service.getModuleModel().isHarModule(),this._multiProjects=this._projectModel.getProfileOpt().app.multiProjects||!1,this._appRes=this._projectModel.getAppRes();const o=this.service.getModuleModel().getSourceSetByTargetName(this._targetName);this._moduleTargetRes=o.getModuleTargetRes(),this._mergedModuleJson=this._pathInfo.getIntermediatesMergeProfile(),this._ohLibs=this.mergeDependsLibs(common_const_js_1.CommonConst.MODULE_JSON),this._moduleBuildAbilities=null===(i=null===(t=(0,array_util_1.getElementFromArr)(this.moduleModel.getProfileOpt().targets,this.targetName))||void 0===t?void 0:t.source)||void 0===i?void 0:i.abilities}declareInputs(){var e,t;return super.declareInputs().set(abstract_merge_profile_js_1.INPUT_KEY.isHarModule,this._isHarModule).set(abstract_merge_profile_js_1.INPUT_KEY.multiProjects,this._multiProjects).set(abstract_merge_profile_js_1.INPUT_KEY.asanEnable,this.asanEnable).set(abstract_merge_profile_js_1.INPUT_KEY.isDebug,this.targetService.isDebug()).set(abstract_merge_profile_js_1.INPUT_KEY.buildProfileAbilities,JSON.stringify(this._moduleBuildAbilities)).set(abstract_merge_profile_js_1.INPUT_KEY.projectConfigAppOpt,JSON.stringify(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt)).set(abstract_merge_profile_js_1.INPUT_KEY.moduleJsonOpt,JSON.stringify(this._moduleTargetRes.getModuleJsonOpt())).set(abstract_merge_profile_js_1.INPUT_KEY.appJsonOpt,JSON.stringify(this._appRes.getAppResOpt())).set("integratedHsp",!!(null===(t=this.targetService.getBuildOption().arkOptions)||void 0===t?void 0:t.integratedHsp))}declareInputFiles(){const e=(new hvigor_2.FileSet).addEntry(this._appRes.getJsonPath()).addEntry(this.projectModel.getProfilePath()).addEntry(this._moduleTargetRes.getJsonPath());return this._ohLibs.forEach((t=>{fs.existsSync(t)&&e.addEntry(t)})),e}declareOutputFiles(){return(new hvigor_2.FileSet).addEntry(this._mergedModuleJson)}initTaskDepends(){this.declareDepends(pre_build_js_1.PreBuild.name)}initHarModuleDepends(){har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach(((e,t)=>this.declareDepends(`${e}@${Task.MERGE_PROFILE.name}`,t)))}async doTaskAction(){var e,t;const i=this.computeAppJsonOpt();this.mergeDslConfig(i),this.mergeAppEnvironmentConfig(i);const o=(0,wdk_1.cloneDeep)(this._moduleTargetRes.getModuleJsonOpt());this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(path_1.default.resolve(this._moduleTargetRes.getResourcePath(),".."))&&(o.module={...(0,ohos_test_util_js_1.getOhosTestAbilityConfig)(),...o.module}),(this.moduleModel.isHapModule()||this.moduleModel.isHspModule()||this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)&&Object.assign(o.module,{packageName:this.packageJsonObj.name});const s=this.mergeBuildProfileAbilities(o),r=this.mergeAllHarModuleOpt(s),n=r.module.requestPermissions;n&&this.moduleModel.isHspModule()&&this.checkPermissions(n),null===(e=o.module.proxyData)||void 0===e||e.forEach((e=>{if(this._bundleName){const t=e.uri.split("/")[2];this._appRes.getAppResOpt().app.bundleName===t&&(e.uri=e.uri.replace(t,this._bundleName))}}));const a={...i,...r};this.customizeModuleOpt(a,this.targetData.getProduct());const l=null===(t=this.targetService.getBuildOption().arkOptions)||void 0===t?void 0:t.integratedHsp;this.moduleModel.isHspModule()&&l&&(a.app.bundleName="");if(hvigor_config_loader_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.HvigorConfigConst.OHOS_PACK_COMPRESS_LEVEL)&&(a.module.compressNativeLibs=!0),fs_extra_1.default.existsSync(this._mergedModuleJson)){const e=(0,json_util_js_1.getJson5Obj)(this._mergedModuleJson);if(e.app.compileSdkVersion&&this.sdkInfo.getToolchainsComponentVersion()&&e.app.compileSdkVersion!==this.sdkInfo.getToolchainsComponentVersion()){_log.debug("Clean the ArkTS cache due to SDK version is changed.");const e=path_1.default.resolve(this.targetData.getPathInfo().getModuleBuildCachePath());await fs_extra_1.default.emptydir(e)}}fs.outputJSONSync(this._mergedModuleJson,a,{spaces:"\t"})}computeAppJsonOpt(){const e=(0,wdk_1.cloneDeep)(this._appRes.getAppResOpt());if(void 0!==e.app.multiProjects&&(_log.warn(`Field 'multiProjects' should be configured in project's build-profile.json5. The value of this field configured in app.json5 will be ignored. Please configure this field in ${this._projectModel.getProfilePath()}.`),delete e.app.multiProjects),this._isHarModule){const t={app:{bundleName:e.app.bundleName,debug:e.app.debug,versionCode:e.app.versionCode,versionName:e.app.versionName,minCompatibleVersionCode:e.app.minCompatibleVersionCode,minAPIVersion:e.app.minAPIVersion,targetAPIVersion:e.app.targetAPIVersion,apiReleaseType:e.app.apiReleaseType}};this.targetService.getTargetData().getTargetName()===common_const_js_1.CommonConst.OHOS_TEST&&Object.assign(t.app,{icon:e.app.icon,label:e.app.label,vendor:e.app.vendor}),e.app=t.app}return this.asanEnable&&(e.app.asanEnabled=this.asanEnable),this.tsanEnable&&(e.app.tsanEnabled=this.tsanEnable),e}mergeAppEnvironmentConfig(e){var t;const i=this.parseToAppEnvironments(this.appEnvironments);if(void 0!==e.app.appEnvironments&&0!==e.app.appEnvironments.length){_log.debug("Change app appEnvironment");const o=new Map;i.forEach((e=>{o.set(e.name,e.value)})),null===(t=e.app.appEnvironments)||void 0===t||t.forEach((e=>{o.set(e.name,e.value)})),e.app.appEnvironments=Array.from(o,(([e,t])=>({name:e,value:t})))}else _log.debug("Use cli appEnvironment"),e.app.appEnvironments=i}checkPermissions(e){const t=[];e.forEach((e=>{e.reason&&!t.includes(e.reason)&&t.push(e.reason.replace("$string:",""))}));const i=this._moduleTargetRes.getResourcePath(),o=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),"resource_str");0!==t.length&&this.filterResStr(i,o,t)}filterResStr(e,t,i){fs_extra_1.default.readdirSync(e).forEach((o=>{if("rawfile"!==o&&"resfile"!==o){const s=path_1.default.resolve(e,o,"element","string.json"),r={string:[]};if(fs_extra_1.default.existsSync(s)){if((0,fs_extra_1.readJSONSync)(s).string.forEach((e=>{i.includes(e.name)&&r.string.push(e)})),0===r.string.length)return;(0,task_util_1.getBuildModeName)()===build_mode_const_1.BuildModeConst.TEST&&fs_extra_1.default.outputFileSync(path_1.default.resolve(this.pathInfo.getModuleBuildIntermediates(),build_directory_const_js_1.BuildDirConst.INTERMEDIATES_RES,common_const_js_1.CommonConst.OHOS_TEST,build_directory_const_js_1.BuildDirConst.RESOURCE_STR,o,"element","string.json"),JSON.stringify(r)),fs_extra_1.default.outputFileSync(path_1.default.resolve(t,o,"element","string.json"),JSON.stringify(r))}}}))}mergeDslConfig(e){this._bundleName&&(e.app.bundleName=this._bundleName,_log.debug(`Change app bundleName with '${this._bundleName}'.`)),this._multiProjects&&(e.app.multiProjects=this._multiProjects,_log.debug(`Change app multiProjects with '${this._multiProjects}'.`)),this._vendor&&(e.app.vendor=this._vendor,_log.debug(`Change app vendor with '${this._vendor}'.`)),e.app.apiReleaseType=this.sdkInfo.getReleaseType(),_log.debug(`Change app api release type with '${this.sdkInfo.getReleaseType()}'`),this.resolveApi(e.app)}resolveApi(e){var t,i,o;const s=this.targetData.getApiMeta(),r=!![s.compileSdkVersion.version,s.compatibleSdkVersion.version,null!==(i=null===(t=s.targetSdkVersion)||void 0===t?void 0:t.version)&&void 0!==i?i:s.compileSdkVersion.version].find((e=>e<=sdk_const_js_1.ApiVersion.API_VERSION_9)),n=null!==(o=s.targetSdkVersion)&&void 0!==o?o:s.compileSdkVersion,a=this.targetData.isHarmonyOS()?this.apiTransform(n):n.version,l=this.targetData.isHarmonyOS()?this.apiTransform(s.compatibleSdkVersion):s.compatibleSdkVersion.version;e.compileSdkVersion=this.sdkInfo.getToolchainsComponentVersion(),_log.debug(`Change app compile API version with '${this.sdkInfo.getToolchainsComponentVersion()}'`),e.targetAPIVersion=r?n.version:a,_log.debug(`Change app target API version with '${e.targetAPIVersion}'`),e.minAPIVersion=r?s.compatibleSdkVersion.version:l,_log.debug(`Change app minimum API version with '${e.minAPIVersion}'`),e.compileSdkType=this.targetData.isHarmonyOS()?"HarmonyOS":"OpenHarmony"}mergeAllHarModuleOpt(e){if(this._isHarModule)return e;const t=this.transformJson2Opts();let i=e.module.metadata,o=e.module.requestPermissions;for(let s=0;s<t.length;s++){const r=t[s];null!==r&&(this.checkHarApiStatus(r),r.module.type!==module_type_enum_js_1.ModuleType.Har&&checkHarDeviceTypes(e,r),i=this.mergeArrayOptions(i,r.module.metadata,r.module.name),o=this.mergeHarRequestPermission(o,r))}return 0!==(null==i?void 0:i.length)&&(e.module.metadata=i),0!==(null==o?void 0:o.length)&&(e.module.requestPermissions=o),e}mergeDependsLibs(e){const t=this.service.getDependencyRootPaths(),i=this.service.getHarModuleDependencies(),o=this.service.getHarModuleDependencyPaths(),s=this.service.getHspModuleDependencies(),r=this.service.getHspModuleDependencyPaths(),n=hsp_target_utils_js_1.HspTargetUtils.calDepHspTargets(this.targetService);return t.map((t=>{var a,l;const u=inject_util_js_1.InjectUtil.getBuildCacheParentDir(t,path_1.default.join(hvigor_1.hvigorCore.getProject().getName(),t.substring(hvigor_1.hvigorCore.getProject().getNodeDir().length)));if(r.includes(t)){const i=(null!==(a=s.find((([,e])=>e.getDependencyRootPath()===t)))&&void 0!==a?a:[""])[0],o=n.get(i);return path_1.default.resolve(u,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,null!==(l=null==o?void 0:o.getTargetName())&&void 0!==l?l:common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,e)}return o.includes(t)?this.getHarDenPath(i,t,u,e):path_1.default.resolve(t,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,e)}))}transformJson2Opts(){return this._ohLibs.map((e=>fs.pathExistsSync(e)?(0,json_util_js_1.getJson5Obj)(e):(_log.warn(`${e} does not exist. This library will not be merged. This may occur when the project is manually modified and the local library is not declared in ${this._projectModel.getProfilePath()}. Please confirm the correctness of this module. You may try to solve the problem by declare it in ${this.moduleModel.getName()} build-profile.json5.`),null)))}mergeHarRequestPermission(e,t){return this.mergeArrayOptions(e,t.module.requestPermissions)}mergeArrayOptions(e,t,i){const o=[],s=[];return null==e||e.forEach((e=>{o.push(e),s.push(e.name)})),null==t||t.forEach((e=>{const t=e.name;void 0!==t&&""!==t?s.includes(e.name)||o.push(e):_log.warn(`The metadata configuration in module.json5 whose name is empty or undefined in the har:${i}.\n        This configuration will not be merged.`)})),o}checkHarApiStatus(e){let t=e.app.minAPIVersion;const i=e.module.name;void 0!==t?(t.toString().length>=4&&(t=this.harMinApiVersionToAPi(t.toString())),this.targetData.getCompatibleApiVersion()<(0,wdk_1.parseInt)(t)&&_log._buildError(`The compatibleSdkVersion ${this.compatibleApiVersion} cannot be smaller than version ${t} declared in library [:${i}]\n          as the library might be using APIS not available in ${this.compatibleApiVersion}`)._printErrorAndExit(this.moduleModel.getName())):_log._buildError(`The HAR module ${i} is not undefined.Please check.`)._printErrorAndExit(this.moduleModel.getName())}harMinApiVersionToAPi(e){const t=e.length,i=e.substring(t-3,t);return(0,wdk_1.parseInt)(i)}customizeModuleOpt(e,t){var i,o,s,r,n,a,l,u,d,p,_,c,m,g;const h=(0,wdk_1.cloneDeep)(null===(i=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===i?void 0:i.appOpt),f=e.module,v=null!==(s=null!==(o=null==h?void 0:h.bundleType)&&void 0!==o?o:t.bundleType)&&void 0!==s?s:null!==(r=e.app.bundleType)&&void 0!==r?r:"app",b=e.app;b.bundleType=v,this._isHarModule||(b.label=null!==(a=null!==(n=null==h?void 0:h.label)&&void 0!==n?n:t.label)&&void 0!==a?a:b.label,b.icon=null!==(u=null!==(l=null==h?void 0:h.icon)&&void 0!==l?l:t.icon)&&void 0!==u?u:b.icon),b.versionCode=null!==(p=null!==(d=null==h?void 0:h.versionCode)&&void 0!==d?d:t.versionCode)&&void 0!==p?p:b.versionCode,b.versionName=null!==(c=null!==(_=null==h?void 0:h.versionName)&&void 0!==_?_:t.versionName)&&void 0!==c?c:b.versionName,v===common_const_js_1.BundleType.ATOMIC_SERVICE&&(f.atomicService=null!==(g=null===(m=this.targetData.getTargetOpt().config)||void 0===m?void 0:m.atomicService)&&void 0!==g?g:f.atomicService,f.installationFree=!0),v!==common_const_js_1.BundleType.APP&&v!==common_const_js_1.BundleType.SHARED||(f.installationFree=!1,f.atomicService&&delete f.atomicService),this.targetService.isDebug()&&(b.debug=!0)}mergeBuildProfileAbilities(e){var t,i,o;if(!this.moduleModel.isHapModule()||!this._moduleBuildAbilities||!e.module.abilities)return this.moduleModel.isHspModule()&&this._moduleBuildAbilities&&_log.warn("hsp module does not support to custome icon/label/lauchType in buildProfile"),e;const s=e.module.abilities.map((e=>e.name));for(const r of this._moduleBuildAbilities)for(const n of e.module.abilities)r.name&&s.includes(r.name)?n.name===r.name&&(n.icon=null!==(t=r.icon)&&void 0!==t?t:n.icon,n.label=null!==(i=r.label)&&void 0!==i?i:n.label,n.launchType=null!==(o=r.launchType)&&void 0!==o?o:n.launchType):_log.warn(`The ability name :${r.name} in build-profile can't find correspond ability name\n            in module.json.`);return e}}function checkHarDeviceTypes(e,t){const i=e.module.deviceTypes,o=t.module.deviceTypes,s="default",r="phone";(o.includes(s)||o.includes(r))&&(o.push(r),o.push(s));const n=i.filter((e=>!o.includes(e)));if(n.length>0){const e=`The ${t.module.type} module '${t.module.name}' that the current module depends on does not support the device type: '${n.join(", ")}',\n      which may cause runtime exception on the device. Please confirm.`;_log.errorMessageExit(e)}}exports.MergeProfile=MergeProfile;