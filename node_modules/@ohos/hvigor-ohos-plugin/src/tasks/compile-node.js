"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,i)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompileNode=void 0;const hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),node_command_builder_js_1=require("../builder/node-command-builder.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),aot_compile_mode_enum_js_1=require("../enum/aot-compile-mode-enum.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_utils_js_1=require("../utils/process-utils.js"),abstract_compile_node_js_1=require("./abstract/abstract-compile-node.js"),compile_resource_js_1=require("./compile-resource.js"),generate_loader_json_js_1=require("./generate-loader-json.js");class CompileNode extends abstract_compile_node_js_1.AbstractCompileNode{constructor(e,t,o){super(e,t,o),this._log=ohos_logger_js_1.OhosLogger.getLogger(CompileNode.name),this._webpackPath="./node_modules/webpack/bin/webpack.js",this.webpackConfig=this.codeType===code_type_enum_js_1.CodeType.ETS?common_const_js_1.CommonConst.ETS_WEBPACK_FILE:common_const_js_1.CommonConst.ACE_RICH_WEBPACK_FILE}initTaskDepends(){this.declareDependsList(generate_loader_json_js_1.GenerateLoaderJson.name,compile_resource_js_1.CompileResource.name)}async beforeTask(){await super.beforeTask(),this.targetService.getAnBuildMode()!==aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&fse.removeSync(this.anBuildOutputPath)}async doTaskAction(){const e=this.durationEvent.createSubEvent("generate compile-ArkTs-or-JS-component command","");e.start(),this.validateModuleJson(this._log),await this.doRealLoaderCompile(this.generateLoaderEnv(),(e=>{this.moveReleaseMap(e,this._log)}),[this.targetData],e,[0,1])}async doRealLoaderCompile(e,t,o,s,i){e.runtimeOS=this.sdkInfo.isOhos?common_const_js_1.CommonConst.OPEN_HARMONY:common_const_js_1.CommonConst.HARMONY_OS,e.sdkInfo=`${this.sdkInfo.isOhos}:${this.sdkInfo.getSdkVersion()}:${this.sdkInfo.getEtsComponentVersion()}:${this.sdkInfo.getEtsComponentReleaseType()}`,fse.ensureDirSync(e.cachePath),fse.ensureDirSync(e.aceModuleBuild);const r=this.createNodeCommandBuilder();this._log._printDebugCommand("NodeEnv",e),this._log._printDebugCommand(`${this.codeType.toUpperCase()}-loader`,r.build());const n=this.getInputData(e,r.build());s.stop(),s.setLog(s.getName(),hvigor_1.MetricLogType.INFO);const a="submit compile-ArkTs-or-JS-component task to work pool",d=this.durationEvent.createSubEvent(a,"");d.start(),await new process_utils_js_1.ProcessUtils(n.moduleName,n.taskName).submitExecutionWithoutReturn(this,this.getWorkerPool(),n,t,o,d,i),d.stop(),d.setLog(a,hvigor_1.MetricLogType.INFO)}createNodeCommandBuilder(){const e=/[0-9]+/.exec(process.version),t=e?Number(e[0]):-1,o=new node_command_builder_js_1.NodeCommandBuilder(!0).addOpenSslLegacyOption(this.codeType===code_type_enum_js_1.CodeType.JS&&17<=t).addWebpackPath(this._webpackPath).addWebpackConfig(this.webpackConfig).addBuildMode(this.targetService.isDebug());return this.isArkModule&&o.addCompilerType("ark"),o}getInputData(e,t){const o={cwd:this.codeType===code_type_enum_js_1.CodeType.ETS?this.sdkInfo.getEtsLoader():this.sdkInfo.getJsLoader(),env:e,windowsHide:!0};return{moduleName:this.moduleName,taskName:this.name,commandLine:t,commandOptions:o}}generateLoaderEnv(){return{...this.commonOption,appResource:this.resourceTable,rawFileResource:this.rawFileResource,aceModuleBuild:this.aceModuleBuild,aceModuleRoot:this.sourcePath,cachePath:this.getTaskTempDir(this.targetData),aceProfilePath:this.resProfileDir,aceModuleJsonPath:this.aceModuleJsonPath,aceSuperVisualPath:this.aceSuperVisualPath,aceBuildJson:path_1.default.resolve(this.aceBuildJsonDir,build_directory_const_js_1.BuildArtifactConst.LOADER_JSON),AnBuildOutPut:path_1.default.resolve(this.anBuildOutputPath,aot_compile_mode_enum_js_1.AotCompileModeEnum.ARM64_V8A),AnBuildMode:this.targetService.getAnBuildMode(),apPath:this.targetService.getApAbsolutePath()}}checkLocalDependency(e,t){if(this.codeType!==code_type_enum_js_1.CodeType.JS)return;for(const t of e)if(t.getSrcLanguage()!==this.codeType)return;const o=this.service.getHarDependencies();for(const e of o)e.getDependencyMainFilePath().endsWith(".ets")&&t._buildError(`JS module '${this.moduleName}' does not allow ArkTS dependency '${e.getDependencyName()}'.`)._file(this.packageManagerPath)._printErrorAndExit(this.moduleName)}}exports.CompileNode=CompileNode;