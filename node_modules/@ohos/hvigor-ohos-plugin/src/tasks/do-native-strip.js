"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DoNativeStrip=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_native_strip_js_1=require("./abstract/abstract-native-strip.js"),task_names_js_1=require("./common/task-names.js"),native_strip_js_1=require("./worker/native-strip.js"),process_libs_js_1=require("./process-libs.js");class DoNativeStrip extends abstract_native_strip_js_1.AbstractNativeStrip{constructor(t){super(t,task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP),this._log=ohos_logger_js_1.OhosLogger.getLogger(DoNativeStrip.name)}declareInputFiles(){const t=new hvigor_1.FileSet;return fs_extra_1.default.existsSync(this.intermediatesProcessLibs)&&t.addEntry(this.intermediatesProcessLibs,{isDirectory:!0}),t}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.strippedNativeLibs,{isDirectory:!0})}async doTaskAction(){var t,e,s;const i={debugSymbol:this.debugSymbol,strip:null!==(t=this.strip)&&void 0!==t&&t,exclude:null!==(e=this.exclude)&&void 0!==e?e:[],intermediatesProcessLibs:this.intermediatesProcessLibs,sdkLlvmStripPath:this.sdkInfo.getSdkLlvmStrip(),strippedNativeLibs:this.strippedNativeLibs,moduleName:this.moduleName,taskName:this.name,cacheFilePath:this.cacheFilePath,lastCache:path_1.default.resolve(this.pathInfo.getIntermediatesPatch(),"libs.json"),collectAllLibs:null===(s=this.targetService.getBuildOption().nativeLib)||void 0===s?void 0:s.collectAllLibs},r=path_1.default.resolve(__dirname,"./worker/native-strip.js/strip"),a={workInput:i};if(this.getWorkerPool().submit(this,r,a).getState()===hvigor_1.TaskState.REJECT){const t="strip native libs",e=this.durationEvent.createSubEvent(t,"");e.start(),this._log.debug("Worker dispatch failed, running native strip on main thread."),await(0,native_strip_js_1.strip)(i),e.stop(),e.setLog(t,hvigor_1.MetricLogType.INFO)}}initTaskDepends(){this.declareDepends(process_libs_js_1.ProcessLibs.name)}}exports.DoNativeStrip=DoNativeStrip;