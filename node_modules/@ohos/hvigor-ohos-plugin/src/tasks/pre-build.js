"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,s)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreBuild=void 0;const hvigor_1=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),fse=__importStar(require("fs-extra")),os_1=__importDefault(require("os")),path=__importStar(require("path")),common_util_js_1=require("../common/common-util.js"),module_ohos_config_manager_js_1=require("../common/global/module-ohos-config-manager.js"),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_const_js_1=require("../const/inject-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),runtime_type_enum_js_1=require("../enum/runtime-type-enum.js"),error_code_map_js_1=require("../error/error-code-map.js"),hap_extra_info_js_1=require("../project/data/hap-extra-info.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),project_extra_info_service_js_1=require("../project/project-extra-info-service.js"),array_util_js_1=require("../utils/array-util.js"),file_util_js_1=require("../utils/file-util.js"),res_model_loader_js_1=require("../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_util_js_1=require("../utils/task-util.js"),error_handlers_js_1=require("../utils/validate/error-handlers.js"),validate_config_js_1=require("../utils/validate/validate-config.js"),validate_util_js_1=require("../utils/validate/validate-util.js"),abstract_pre_build_js_1=require("./abstract/abstract-pre-build.js"),task_names_js_1=require("./common/task-names.js"),target_task_service_js_1=require("./service/target-task-service.js");var Task=task_names_js_1.TaskNames.Task;const json_util_js_1=require("../utils/json-util.js"),const_1=require("@ohos/hvigor/src/common/const/const"),path_const_1=require("@ohos/hvigor/src/common/const/path-const"),build_profile_utils_js_1=require("../utils/build-profile-utils.js"),mock_config_utils_js_1=require("../utils/mock-config-utils.js"),ohos_test_util_js_1=require("../utils/ohos-test-util.js"),log_adaptor_js_1=require("../utils/log/log-adaptor.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-preBuild");class PreBuild extends abstract_pre_build_js_1.AbstractPreBuild{constructor(e){super(e,Task.PRE_BUILD),this.INSIGHT_INTENT_SRC_ENTRY="insightIntent-srcEntry",this.MODULE_SRC_ENTRY="module-srcEntry",this.MODULE_ABILITIES_SRC_ENTRY="module-abilities-srcEntry",this.MODULE_EXTENSION_ABILITIES_SRC_ENTRY="module-extensionAbilities-srcEntry";const t=this.projectModel.getAppRes();this.appJson5Path=t.getJsonPath();const i=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetJsonPath=i.getJsonPath(),this.targetModuleOptObj=i.getModuleJsonOpt(),this.formJsonPathArr=target_task_service_js_1.TargetTaskService.getFormJsonArr(i),this.resourcePath=i.getResourcePath(),this.appStartupPath=e.getAppStartupPath(),this.routerMapJsonPath=e.getRouterMapJsonPath(this.moduleModel),this.insightIntentJsonPath=path.resolve(e.getTargetData().getPathInfo().getModuleSrcMainResourceBaseProfilePath(),build_directory_const_js_1.BuildArtifactConst.INSIGHT_INTENT_JSON),this.pagesJsonPath=this.getPagesJsonPath(),this.arkDataPath=path.resolve(e.getTargetData().getPathInfo().getModuleSrcMainResourceRawfileArkdataPath()),this.utdPath=path.resolve(e.getTargetData().getPathInfo().getModuleSrcMainResourceRawfileUtdPath()),this.hvigorConfigPath=path.resolve(path_const_1.HVIGOR_PROJECT_WRAPPER_HOME,const_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME),this.isPreview=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH,this.extendSourceValidateResult=this.getExtendSourceDirsValidateResult(),this.mockCacheClean()}declareInputs(){var e,t,i,o,s,r,a,n;const l=super.declareInputs(),d=Object.keys(this.getDependencies(this.moduleModel,!1)),h=Object.keys(this.getDependencies(this.projectModel,!1)),c=(0,build_profile_utils_js_1.getRuntimeOnlyObjMap)(this.module.getNodeDir(),null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly,(0,array_util_js_1.getUnionSet)(d,h));for(const[e,t]of c)l.set(e,t);const _=project_ohos_config_manager_js_1.projectOhosConfigManager.getConfig();_&&l.set("appHvigorFileConfig",(0,hvigor_1.hash)(JSON.stringify(_)));const u=module_ohos_config_manager_js_1.moduleOhosConfigManager.getConfig(this.moduleName);u&&l.set("moduleHvigorFileConfig",(0,hvigor_1.hash)(JSON.stringify(u))),this.formJsonPathArr.forEach((e=>{const t=(0,hvigor_1.parseJsonFile)(e,!1);t.forms&&t.forms.forEach((e=>{if(e.src){const t="arkts"===e.uiSyntax?path.resolve(this.moduleModel.getProjectDir(),"src/main",e.src):path.resolve(this.moduleModel.getProjectDir(),"src/main",`${e.src}.json`);fs_1.default.existsSync(t)&&l.set(e.src,t)}}))})),l.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,!!(null===(o=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.strictMode)||void 0===o?void 0:o.useNormalizedOHMUrl)),l.set(build_directory_const_js_1.BuildDirConst.INTEGRATED_HSP,!!(null===(s=this.targetService.getBuildOption().arkOptions)||void 0===s?void 0:s.integratedHsp)),l.set("sourceRoots",this.extendSourceValidateResult.isValid),l.set(build_directory_const_js_1.BuildDirConst.TRANSFORM_LIB,null!==(n=null===(a=null===(r=this.targetService.getBuildOption())||void 0===r?void 0:r.arkOptions)||void 0===a?void 0:a.transformLib)&&void 0!==n?n:"");const g=this.moduleModel.getMockConfigPath();return fse.existsSync(g)&&l.set("mockConfigSources",(0,mock_config_utils_js_1.getMockConfigSources)(g,this.moduleModel.getProjectDir()).join(",")),l}declareInputFiles(){var e;const t=(new hvigor_1.FileSet).addEntries([this.appJson5Path,this.targetJsonPath,...this.formJsonPathArr],{isDirectory:!1});fs_1.default.existsSync(this.projectProfilePath)&&t.addEntry(this.projectProfilePath),fs_1.default.existsSync(this.profilePath)&&t.addEntry(this.profilePath),this.appStartupPath&&fs_1.default.existsSync(this.appStartupPath)&&t.addEntry(this.appStartupPath);const i=this.routerMapJsonPath;i&&fs_1.default.existsSync(i)&&t.addEntry(i),this.targetService.getWorkerConfig().forEach((e=>{fs_1.default.existsSync(e)&&t.addEntry(e)})),fs_1.default.existsSync(path.resolve(null===(e=this.moduleModel)||void 0===e?void 0:e.getSourceRootByTargetName(this.targetName),common_const_js_1.CommonConst.SYSCAP_JSON))&&t.addEntry(this.syscapJsonPath),void 0!==this.pagesJsonPath&&t.addEntry(this.pagesJsonPath),fs_1.default.existsSync(this.insightIntentJsonPath)&&t.addEntry(this.insightIntentJsonPath),fse.existsSync(this.arkDataPath)&&t.addEntry(this.arkDataPath,{isDirectory:!0}),fse.existsSync(this.utdPath)&&t.addEntry(this.utdPath,{isDirectory:!0}),fse.existsSync(this.hvigorConfigPath)&&t.addEntry(this.hvigorConfigPath,{isDirectory:!0}),fse.existsSync(this.moduleModel.getMockConfigPath())&&t.addEntry(this.moduleModel.getMockConfigPath(),{isDirectory:!1});const o=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath();return fs_1.default.existsSync(o)&&t.addEntry(o),t}doValidateForDiffApiType(){var e;if(this.appJson5Validate(),this.moduleJson5Validate(),this.formJsonValidate(),this.pagesJsonValidate(),this.routerMapJsonValidate(),this.hvigorFileConfigValidate(),this.appStartupValidate(),this.hvigorConfigValidate(),this.validateMockConfig(),fs_1.default.existsSync(this.insightIntentJsonPath)&&(this.buildProfileJsonValidate(),this.insightIntentJsonValidate()),this.targetESVerisonValidate(),fs_1.default.existsSync(this.utdPath)){const e=fs_1.default.readdirSync(this.utdPath);if(void 0!==e&&e.length>0)for(const t of e){const e=path.resolve(this.utdPath,t);this.utdJsonValidate(e)}}if(fs_1.default.existsSync(this.arkDataPath)){const e=fs_1.default.readdirSync(this.arkDataPath);if(void 0!==e&&e.length>0)for(const t of e){const e=path.resolve(this.arkDataPath,t);this.arkDataJsonValidate(e)}}(null===(e=this.service.getModuleModel())||void 0===e?void 0:e.isHapModule())&&this.validateMainElementAndAbilities(),this.checkOHMURL(),this.checkDynamicImportFile(),this.checkAppStartupConfig(),this.checkAllSrcEntry()}mockCacheClean(){const e=this.moduleModel.getMockConfigPath();if(!fse.existsSync(e)&&this.isPreview){const e=this.targetData.getTargetName(),t=this.targetData.getPathInfo(),i=t.getModulePreviewPath(),o=t.getModulePreviewIntermediatesResPath(),s=path.resolve(i,`cache/.${e}/mock-config.json`);fse.existsSync(s)&&fse.unlinkSync(s);const r=path.resolve(i,`cache/.${e}/mock-config.json5`);fse.existsSync(r)&&fse.unlinkSync(r);const a=path.resolve(o,"mock-config.json");fse.existsSync(a)&&fse.unlinkSync(a)}}targetESVerisonValidate(){var e,t,i;(null===(i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.tscConfig)||void 0===i?void 0:i.targetESVersion)&&(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_12||this.compatibleApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_12)&&_log._buildError("targetESVersion not supported when below API version 12. ")._detail("Please check compileSdkVersion and compatibleSdkVersion in the project-level build-profile.json5 file.")._printErrorAndExit()}buildProfileJsonValidate(){project_extra_info_service_js_1.ProjectExtraInfoService.getProjectRuntimeOS(this.projectModel)!==runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS&&_log._buildError("The runtimeOS that supports the Insightintent project can only be HarmonyOS")._detail(`Please check if the runtimeOS type of the project is HarmonyOS with '${this.projectProfilePath}'`)._printErrorAndExit(),(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_11||this.compatibleApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_11)&&_log._buildError("Invalid compileSdkVersion or compatibleSdkVersion value. ")._detail("Insight intent not supported when below API version 11. Set compileSdkVersion and compatibleSdkVersion  to 4.1.0(11) or a larger value in the project-level build-profile.json5 file.")._printErrorAndExit()}insightIntentJsonValidate(){const e=this.sdkInfo.getInsightIntentSchema();fs_1.default.existsSync(e)||_log._buildError("The current SDK version does not support InsightIntent.")._detail("Open SDK Manager and update the SDK > HarmonyOS version to API version 11. ")._printErrorAndExit(),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:this.insightIntentJsonPath,schemaPath:e})}utdJsonValidate(e){const t=this.sdkInfo.getUtdSchema();fs_1.default.existsSync(t)||_log._buildError("The current SDK version does not support ArkData.")._detail("To use this feature, go to Tools > SDK Manager and update the SDK.")._printErrorAndExit(),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:e,schemaPath:t})}arkDataJsonValidate(e){const t=this.sdkInfo.getArkDataSchema();fs_1.default.existsSync(t)||_log._buildError("The current SDK version does not support ArkData.")._detail("To use this feature, go to Tools > SDK Manager and update the SDK.")._printErrorAndExit(),validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:e,schemaPath:t})}appJson5Validate(){const e=this.targetService.getSdkInfo().getAppSchema(),t=this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har;validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:this.appJson5Path,schemaPath:e,changeAppSchema:t})}validateModuleSrcEntry(e,t){const i=t.module.srcEntry||t.module.srcEntrance;if(void 0===i)return;const o=this.moduleModel.getSourceSetByTargetName(this.targetData.getTargetName());void 0===t.module.srcEntry&&_log.warn(`Field "module.srcEntrance" has been deprecated. Use "module.srcEntry" instead.\n      at ${o.getModuleTargetRes().getJsonPath()}`);const s=path.isAbsolute(i)?i:path.resolve(o.getSourceSetRoot(),i);if(!file_util_js_1.FileUtil.fileExists(s)){const t=o;e._buildError(`Module-srcEntry '${i}' not found.`)._solution(`Make sure ${i} exists.`)._file(t.getModuleTargetRes().getJsonPath())._errorCode(error_code_map_js_1.ECM.DECE.SERVICE_LOGIC)._printErrorAndExit()}}moduleJson5Validate(){const e=this.targetName,t=this.targetService.getSdkInfo().getModuleSchema();validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.targetJsonPath,schemaPath:t,errorHandlers:[error_handlers_js_1.removeLegacyPhoneSupport,error_handlers_js_1.handleStartWindowErrors]}),e!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&this.validateModuleName(this.moduleName,this.targetModuleOptObj.module.name,common_const_js_1.CommonConst.MODULE_JSON5);const i=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!0),o=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!1);this.validateModuleSrcEntry(_log,(0,json_util_js_1.getJson5Obj)(this.targetJsonPath)),void 0===i.module.uiSyntax&&this.sdkInfo.requireUISyntax()&&_log._buildError("The SDK version is outdated.")._solution("Open SDK Manager to update the ArkTS and JS components to the latest version.")._file(this.targetJsonPath)._printErrorAndExit(),validate_util_js_1.ValidateUtil.validateHybridDeviceTypes(i.module.deviceTypes),validate_util_js_1.ValidateUtil.validateDuplicatedName(o.module.abilities,"ability",this.targetJsonPath)}formJsonValidate(){this.formJsonPathArr.forEach((e=>{validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:e,schemaPath:this.sdkInfo.getFormSchema()}),this.validateFormSrc(e)}))}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.checkEntryModuleJson(),this.checkIntegratedHspHsp(),this.checkTransformLib()}checkEntryModuleJson(){const e=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!0);if(e.module.uiSyntax){const t=e.module.uiSyntax._line,i=e.module.uiSyntax._column+1;_log._file(this.targetJsonPath).warn(`uiSyntax has been deprecated.${os_1.default.EOL}         at ${this.targetJsonPath}:${t}:${i}`)}}getPagesJsonPath(){const e=(0,hvigor_1.parseJsonFile)(this.targetJsonPath,!1).module.pages,t=(0,common_util_js_1.parsingProfileName)(e);if(!t)return;const i=this.targetService.getResourceDirs().find((e=>{const t=path.resolve(e,common_const_js_1.CommonConst.BASE_PROFILE);return t&&fse.existsSync(t)})),o=path.resolve(this.moduleModel.getProjectDir(),null!=i?i:this.resourcePath,common_const_js_1.CommonConst.BASE_PROFILE,`${t}.json`);if(!fse.existsSync(o)){const e=`Unable to find the '${t}.json' file or invalid resource directory configuration.`,i=`Check whether the default resource directory '.src/main/resources' exists, or if the resource directory customization is configured for current target ${this.targetName}, please check whether the resource directory of the current project is correctly configured.`;_log._buildError(e)._detail(i)._file(this.profilePath)._printErrorAndExit()}return o}pagesJsonValidate(){const e=this.getPagesJsonPath();void 0!==e&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:e,schemaPath:this.sdkInfo.getPageSchema()})}routerMapJsonValidate(){this.checkResReferenceConfig(common_const_js_1.CommonConst.ROUTER_MAP),this.routerMapJsonPath&&fse.existsSync(this.routerMapJsonPath)&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.routerMapJsonPath,schemaPath:this.sdkInfo.getRouterMapSchema()})}appStartupValidate(){this.checkResReferenceConfig(common_const_js_1.CommonConst.APP_STARTUP),this.appStartupPath&&fse.existsSync(this.appStartupPath)&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:this.appStartupPath,schemaPath:this.sdkInfo.getAppStartupSchema()})}hvigorConfigValidate(){const e=common_const_js_1.BuildProfileSchemaFileConst.HVIGOR_CONFIG_SCHEMA_PATH;fs_1.default.existsSync(this.hvigorConfigPath)&&fs_1.default.existsSync(e)&&validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.projectModel.getName(),filePath:this.hvigorConfigPath,schemaPath:e})}validateFormSrc(e){const t=(0,hvigor_1.parseJsonFile)(e,!1);if(void 0!==t.forms)for(const i of t.forms){i.src||_log._buildError("form src is required")._detail("Add form src field in the form config file.")._file(e)._printErrorAndExit();const t=this.moduleModel.getProjectDir(),o=path.resolve(t,"src/main"),s=file_util_js_1.FileUtil.convertToAbsolutePath(i.src,o);path.normalize(s).startsWith(path.normalize(t))||_log._buildError(`${i.src} is not under ${t}`)._detail(`Modify ${i.src} in the form config file.`)._file(e)._printErrorAndExit();const r="arkts"===i.uiSyntax;this.isValidWidget(r,o,s)||_log._buildError(`Forms referenced in the config, '${i.src}', was not found in the project or the libraries.`)._detail(`Modify ${i.src} in the form config file.`)._file(e)._printErrorAndExit()}}validateMainElementAndAbilities(){if(void 0===this.targetModuleOptObj||this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(this.moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)))return;const e=this.targetModuleOptObj.module.mainElement;if(this.targetModuleOptObj.module.installationFree&&void 0===e){const e="The 'mainElement' field not found in the module.json5 file.",t="If the current project is of an atomic service, make sure the 'mainElement' field is included.";_log._buildError(e)._solution(t)._file(this.targetJsonPath)._printErrorAndExit()}const t=this.targetModuleOptObj.module.abilities;null==t||t.forEach((t=>{if(void 0!==e&&t.name===e&&(void 0===t.label||void 0===t.icon)){const e="When the value of the mainElement field is the same as that of the name field, icon and label are required under ability.",t="Configuring the 'icon' and 'label' labels in the 'ability' field correctly";_log._buildError(e)._solution(t)._file(this.targetJsonPath)._printErrorAndExit()}}))}validateAtomicService(){var e,t,i,o;if(!this.isAtomicServiceProject())return void _log.debug("current product is not Atomic service.");const s=this.getBundleType(),r=null===(t=null===(e=this.targetModuleOptObj)||void 0===e?void 0:e.module)||void 0===t?void 0:t.installationFree,a=this.targetService.getBuildOption().externalNativeOptions,n=this.getAtomicServiceErrorPath(s,r),l="Atomic service development is not supported in the OpenHarmony stage model.";this.targetData.isHarmonyOS()||(this.validateSpecificField(s,r,l),_log._buildError(l)._detail(n)._printErrorAndExit()),(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_10)||_log._buildError("Atomic service development is not supported compileSdkVersion/compatibleSdkVersion less than api 11.")._printErrorAndExit(),a&&_log._buildError("Atomic service development is not supported Native development.")._printErrorAndExit();const d=this.service.getModuleModel().getModuleType();d!==module_type_enum_js_1.ModuleType.Har&&d!==module_type_enum_js_1.ModuleType.Shared&&(this.formJsonPathArr.forEach((e=>{const t=(0,hvigor_1.parseJsonFile)(e,!1);if(t.forms)for(const e of t.forms)e.uiSyntax&&"arkts"===e.uiSyntax||_log._buildError("Atomic service development is only supported arkts widget.")._printErrorAndExit()})),void 0!==(null===(o=null===(i=this.targetModuleOptObj)||void 0===i?void 0:i.module)||void 0===o?void 0:o.mainElement)||this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(this.moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET))||_log._buildError("If the entry or feature module is atomicService, the mainElement tag in the module.json5 must be configured.")._detail(this.targetJsonPath)._printErrorAndExit())}getAtomicServiceErrorPath(e,t){let i="";return void 0!==e&&"app"!==e||t&&(i=this.targetJsonPath),e!==common_const_js_1.BundleType.ATOMIC_SERVICE&&t||(i=this.appJson5Path),i}validateSpecificField(e,t,i){e===common_const_js_1.BundleType.ATOMIC_SERVICE&&t&&_log._buildError(i)._detail(`Please check installationFree in file: ${this.targetJsonPath} ${os_1.default.EOL}\t and bundleType in file: ${this.appJson5Path}`)._printErrorAndExit()}validateMockConfig(){const e=(0,json_util_js_1.getJson5Obj)(this.moduleModel.getMockConfigPath());e&&Object.values(e).forEach((e=>{const t=e.source;if(t){const e=path.resolve(this.moduleModel.getProjectDir(),t);fse.existsSync(e)||_log._buildError(`source: ${t} not exists.`)._file(this.moduleModel.getMockConfigPath())._printErrorAndExit(this.moduleName)}else _log._buildError("source key must exist")._file(this.moduleModel.getMockConfigPath())._printErrorAndExit(this.moduleName)}))}checkDynamicImportFile(){var e,t,i,o;const s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly;if(!s)return;if((this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_11||this.apiType===hap_extra_info_js_1.ApiType.FA)&&_log._buildError(`Invalid configuration of runtimeOnly in '${this.moduleModel.getName()}' ${common_const_js_1.CommonConst.PROFILE_JSON5}`)._detail(`The field of runtimeOnly for dynamic import only supports the ${sdk_const_js_1.ApiVersion.API_VERSION_11} or later ${hap_extra_info_js_1.ApiType.STAGE} mode project.`)._file(this.profilePath)._printErrorAndExit(),s.sources){const e=null===(o=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.strictMode)||void 0===o?void 0:o.noExternalImportByPath,t=this.module.getNodeDir(),r=[],a=[],n=[],l=[],d=[];this.projectModel.getAllModules().forEach((e=>{d.push(e.getModule().getNodeDir())})),s.sources.forEach((e=>{const i=path.resolve(t,e);d.some((e=>i.startsWith(e)))||l.push(e),fse.existsSync(i)?fse.statSync(i).isFile()&&!common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(file_util_js_1.FileUtil.getFileSuffix(e))&&n.push(e):a.push(e),i.startsWith(this.module.getNodeDir())||r.push(e)})),0!==a.length&&_log._buildError(`Unable to find the file or directory for '${this.moduleName}' using the relative path [${a}].`)._detail(`Verify the path under 'runtimeOnly' in the module '${this.moduleName}' ${common_const_js_1.CommonConst.PROFILE_JSON5}.`)._file(this.profilePath)._printErrorAndExit(),0!==l.length&&_log._buildError(`Invalid dynamic import configuration [${[...new Set(l)]}] in current module '${this.moduleName}'.`)._detail("The relative path of the file which is not in the current module or other modules in the project cannot be configured for dynamic import.")._file(this.profilePath)._printErrorAndExit(),0!==n.length&&_log._buildError(`Invalid file [${n}] found in the module '${this.moduleName}' dynamic import files.`)._detail("The dynamic import file must end with ts or ets.")._file(this.profilePath)._printErrorAndExit(),0!==r.length&&(e?_log._buildError(`Invalid dynamic import configuration [${r}] in current module '${this.moduleName}'.`)._detail("The sources configuration of runtimeOnly in module is not allowed to configure across modules when strictMode-noExternalImportByPath is true.")._file(this.profilePath)._printErrorAndExit():_log.warn(`Invalid dynamic import configuration [${r}] in current module '${this.moduleName}'. \n   Detail: The sources configuration of runtimeOnly in module is not allowed to configure across modules.\n   at :${this.profilePath}`))}const r=Object.keys(this.getDependencies(this.moduleModel,!1)),a=Object.keys(this.getDependencies(this.projectModel,!1));if(s.packages&&!(0,array_util_js_1.isSubset)((0,array_util_js_1.getUnionSet)(r,a),s.packages)){const e=`Invalid dynamic import configurations in current module '${this.moduleModel.getName()}'.`,t=`All dynamic import files or relative paths configured for the '${this.moduleModel.getName()}' must exist in the added dependencies in its ${common_const_js_1.CommonConst.OH_PACKAGE_JSON5}.`;_log._buildError(e)._detail(t)._file(this.profilePath)._printErrorAndExit()}}checkAppStartupConfig(){const e=this.targetService.getAppStartupPath();if(!e||!fse.existsSync(e))return;const t=(0,json_util_js_1.getJson5Obj)(e);this.checkStartupTaskName(t.startupTasks),t.startupTasks.forEach((t=>{this.checkStartupPath(e,t.srcEntry)})),this.checkStartupPath(e,t.configEntry)}checkStartupTaskName(e){if(!e||e.length<=1)return;const t=e.map((e=>e.name));new Set(t).size!==t.length&&_log._buildError(`Duplicate object name of startupTask in the '${this.moduleName}' app startup configuration file.`)._detail("The object name of startupTask in the app startup configuration file must be unique.")._file(this.targetService.getAppStartupPath())._printErrorAndExit()}checkStartupPath(e,t){const i=`Invalid app startup configuration '${t}' in the module '${this.moduleName}'.`,o=path.resolve(this.moduleModel.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,t);common_const_js_1.ValidateRegExp.STARTUP_TASK_SRC_ENTRY_REG_EXP.test(path.extname(o))||_log._buildError(i)._detail("The suffix of the code file specified by the field 'srcEntry' or 'configEntry' must be ets,ts or js.")._file(e)._printErrorAndExit(),fse.existsSync(o)||_log._buildError(i)._detail("The code file specified by the field 'srcEntry' or 'configEntry' must exist.")._file(e)._printErrorAndExit()}getJsonProfileByModel(){const e=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath);return{jsonFilePath:this.targetJsonPath,profile:e,deviceTypes:e.module.deviceTypes,deviceConfig:common_const_js_1.CommonConst.DEVICE_TYPES,configurationProfile:common_const_js_1.CommonConst.MODULE_JSON5}}hvigorFileConfigValidate(){const e=project_ohos_config_manager_js_1.projectOhosConfigManager.getConfig();void 0!==e&&(0,validate_config_js_1.validateOhosProjectConfig)(e,`${this.module.getProject().getBuildFilePath()}.ts`);const t=module_ohos_config_manager_js_1.moduleOhosConfigManager.getConfig(this.moduleName);void 0!==t&&(this.moduleModel.isHarModule()?(0,validate_config_js_1.validateOhosHarModuleConfig)(t,`${this.module.getBuildFilePath()}.ts`):(0,validate_config_js_1.validateOhosModuleConfig)(t,`${this.module.getBuildFilePath()}.ts`))}checkOHMURL(){var e,t;const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl;i&&!(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_11)&&_log.printErrorExit(new log_adaptor_js_1.OhosLogAdaptor("HE10301",hvigor_1.globalData.buildId).formatMessage(this.projectModel.getProfilePath()).getLogMessage());const o=this.targetService.getModuleService().getAllDependencies(),s=[];for(const e of o)this.isEqualOHMUrl(e,i)||s.push(e.getPackageName());s.length>0&&_log.printErrorExit(new log_adaptor_js_1.OhosLogAdaptor("HE10300",hvigor_1.globalData.buildId).formatMessage(s.join(),String(i)).formatSolutions(0,s.join()).getLogMessage())}isEqualOHMUrl(e,t){return e.getDependencyType()!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||(dependency_manager_js_1.DependencyManager.isLocalDependency(e,this.moduleModelNodePaths)||!!t==!!e.getUseNormalizedOHMUrl())}getExtendSourceDirsValidateResult(){var e;let t="",i="";const o=this.targetService.getTargetData(),s=null===(e=o.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots;if(!(null==s?void 0:s.length))return{isValid:!0,cause:t,detail:i};const r=this.pathInfo.getModulePath(),a=this.pathInfo.getModuleSrcPath(),n=this.pathInfo.getModuleSrcMainPath().split(path.sep).length,l=`targets[${this.moduleModel.getTargetOptions().findIndex((e=>e.name===o.getTargetName()))}].source.sourceRoots`,d=new Set;for(const e of s){if(path.isAbsolute(e)){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are relative paths.`;break}let o=path.resolve(r,e);if(!fse.existsSync(o)){t=`Path '${e}' not found in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are valid paths.`;break}let s=fse.lstatSync(o);if(s.isSymbolicLink())try{o=fse.realpathSync(o),s=fse.lstatSync(o)}catch{t=`Path '${e}' not found in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are valid paths.`;break}if(!s.isDirectory()){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are valid directory paths.`;break}if(!file_util_js_1.FileUtil.isSubDir(a,o)||o.split(path.sep).length!==n){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are subdirectories of '${a}'.`;break}if(d.has(o)){t=`Invalid value '${e}' in module '${this.moduleModel.getName()}'.`,i=`Make sure the values of '${l}' are unique.`;break}d.add(o)}return{isValid:!(t&&i),cause:t,detail:i}}checkExtendSourceDirs(){const{isValid:e,cause:t,detail:i}=this.extendSourceValidateResult;e||_log._buildError(t)._detail(i)._file(this.profilePath)._printErrorAndExit()}checkIntegratedHspHsp(){var e,t;const i=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.integratedHsp,o=null===(t=this.targetService.getBuildOption().strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl;i&&!(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_11)&&_log._buildError("The integratedHsp can only be used in API 12 and later.")._file(`${this.moduleModel.getProfilePath()}`)._printErrorAndExit(),i&&!o&&_log._buildError("The integratedHsp is available only when useNormalizedOHMUrl is set to true.")._printErrorAndExit(),i&&this.service.getModuleModel().isHapModule()&&_log.warn(`The integratedHsp does not take effect in the HAP ${this.moduleModel.getName()}.`)}checkTransformLib(){var e,t;const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.transformLib;if(i){path.isAbsolute(i)&&_log.errorMessageExit(`Invalid transformLib, its value should be a relative path.,\n        at File: ${path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")}`);const e=path.resolve(this.pathInfo.getModulePath(),i);fse.existsSync(e)?(fse.statSync(e).isFile()||_log.errorMessageExit(`Invalid transformLib value ${i} is not File,\n         at File: ${path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")}`),this.checkTransformLibFileType(e.substring(e.lastIndexOf(".")+1))):_log.errorMessageExit(`Invalid transformLib value, ${i} is not exist,\n         at File: ${path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")}`)}}checkTransformLibFileType(e){(0,hvigor_1.isWindows)()&&"dll"!==e&&_log.errorMessageExit(`Invalid transformLib value, it requires a .dll file in Windows,\n        at File: ${path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")}`),((0,hvigor_1.isMac)()||(0,hvigor_1.isLinux)())&&"so"!==e&&_log.errorMessageExit(`Invalid file type, it requires a .so file in Mac or Linux,\n        at File: ${path.resolve(this.pathInfo.getModulePath(),"build-profile.json5")}`)}checkResReferenceConfig(e){const t=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath).module[e];if(!t)return;const i=(0,common_util_js_1.parsingProfileName)(t);if(!i)return;const o=this.targetService.getTargetResourceBaseProfilePath(`${i}.json`);o&&fse.existsSync(o)||_log._buildError(`Invalid configuration in the '${this.moduleName}' ${common_const_js_1.CommonConst.MODULE_JSON5}.`)._detail(`The path of '${e}' configuration file does not exist.`)._file(this.targetJsonPath)._printErrorAndExit()}checkAllSrcEntry(){const e=new Map,t=res_model_loader_js_1.resModelLoader.getModuleJson(this.targetJsonPath);t.module.srcEntry&&e.set(this.MODULE_SRC_ENTRY,[t.module.srcEntry]);const i=t.module.abilities,o=[];if(null==i?void 0:i.length){for(const e of i)e.srcEntry&&o.push(e.srcEntry);e.set(this.MODULE_ABILITIES_SRC_ENTRY,o)}const s=t.module.extensionAbilities,r=[];if(s){for(const e of s)e.srcEntry&&r.push(e.srcEntry);e.set(this.MODULE_EXTENSION_ABILITIES_SRC_ENTRY,r)}const a=[];if(fse.existsSync(this.insightIntentJsonPath)){const t=(0,json_util_js_1.getJson5Obj)(this.insightIntentJsonPath);for(const e of t.insightIntents)e.srcEntry&&a.push(e.srcEntry);e.set(this.INSIGHT_INTENT_SRC_ENTRY,a)}e.forEach(((e,t)=>{(null==e?void 0:e.length)&&(null==e||e.forEach((e=>{common_const_js_1.ValidateRegExp.RELATIVE_PATH_REG_EXP.test(e)||_log._buildError(`Invalid configuration of '${t}' field.`)._detail("Relative file path(like ./**) is required for srcEntry.")._file(t===this.INSIGHT_INTENT_SRC_ENTRY?this.insightIntentJsonPath:this.targetJsonPath)._printErrorAndExit()})))}))}}exports.PreBuild=PreBuild;