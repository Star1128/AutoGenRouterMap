"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.sendSocketRequest=exports.ErrorCode=void 0;const hvigor_1=require("@ohos/hvigor"),ws_1=__importDefault(require("ws")),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),_logger=ohos_logger_js_1.OhosLogger.getLogger("JavaDaemonWebSocket");var ErrorCode;function sendSocketRequest(e){return new Promise((function(o,r){const s=(0,hvigor_1.readJavaDaemonInfoFromCacheFile)();s&&s.port||r({code:ErrorCode.NETWORK_ERROR,message:"read java daemon port failed"});const t=new ws_1.default(`ws://localhost:${s.port}`);t.on("error",(function(e){r({code:ErrorCode.NETWORK_ERROR,message:e.message})})),t.on("open",(function(){t.send(JSON.stringify(e))})),t.on("close",(function(e,o){_logger.debug(`java daemon socket close code:${e} reason:${o.toString()}`),1e3!==e&&r({code:ErrorCode.NETWORK_ERROR,message:o.toString()})})),t.on("message",(function(e){_logger.debug(`java daemon socket received message:${e.toString()}`);try{const s=JSON.parse(e.toString());0===s.code?o({code:ErrorCode.SUCCESS,message:"ok"}):r({code:s.code,message:s.message})}catch(e){r({code:ErrorCode.FAIL,message:e.message})}t.close(1e3,"close by user")}))}))}!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAIL=-1]="FAIL",e[e.NETWORK_ERROR=1006]="NETWORK_ERROR",e[e.CLASS_NOT_FOUND=1007]="CLASS_NOT_FOUND"}(ErrorCode=exports.ErrorCode||(exports.ErrorCode={})),exports.sendSocketRequest=sendSocketRequest;