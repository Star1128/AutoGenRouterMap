"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractMergeProfile=exports.INPUT_KEY=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),har_target_util_js_1=require("../utils/har-target-util.js"),inject_util_js_1=require("../utils/inject-util.js");exports.INPUT_KEY={isHarModule:"isHarModule",bundleName:"bundleName",targetSdkVersion:"targetSdkVersion",compatibleSdkVersion:"compatibleSdkVersion",multiProjects:"multiProjects",releaseType:"releaseType",buildRoot:"buildRoot",isDebug:"isDebug",asanEnable:"asanEnable",tsanEnable:"tsanEnable",projectConfigAppOpt:"projectConfigAppOpt",vendor:"vendor",buildProfileAbilities:"buildProfileAbilities",appEnvironments:"appEnvironments",toolChainSdkVersion:"toolChainSdkVersion",moduleJsonOpt:"moduleJsonOpt",appJsonOpt:"appJsonOpt"};class AbstractMergeProfile extends ohos_hap_task_js_1.OhosHapTask{constructor(t,e){var s,o,r;super(t,e);const i=(0,wdk_1.cloneDeep)(null===(s=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===s?void 0:s.appOpt);this._moduleTargetData=this.targetService.getTargetData(),this._projectModel=this.service.getProjectModel(),this._bundleName=null!==(o=null==i?void 0:i.bundleName)&&void 0!==o?o:this._moduleTargetData.getProduct().bundleName,this._vendor=null!==(r=null==i?void 0:i.vendor)&&void 0!==r?r:this._moduleTargetData.getProduct().vendor,this._targetName=this._moduleTargetData.getTargetName(),this._pathInfo=this._moduleTargetData.getPathInfo(),this._buildRoot=this._pathInfo.getBuildRoot(),this.asanEnable="true"===hvigor_1.hvigorCore.getExtraConfig().get("ohos-debug-asan"),this.tsanEnable="true"===hvigor_1.hvigorCore.getExtraConfig().get("ohos-enable-tsan"),this.appEnvironments=hvigor_1.hvigorCore.getParameter().getExtParam("ohos-app-environment")}mergeDependsLibs(t){const e=this.service.getDependencyRootPaths(),s=this.service.getHarModuleDependencies(),o=this.service.getHarModuleDependencyPaths(),r=this.service.getHspModuleDependencyPaths();return e.map((e=>{const i=inject_util_js_1.InjectUtil.getBuildCacheParentDir(e,path_1.default.join(hvigor_1.hvigorCore.getProject().getName(),e.substring(hvigor_1.hvigorCore.getProject().getNodeDir().length)));if(r.includes(e)){const e=path_1.default.resolve(i,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,this._targetName,t);return fs_extra_1.default.pathExistsSync(e)?e:path_1.default.resolve(i,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,t)}return o.includes(e)?this.getHarDenPath(s,e,i,t):path_1.default.resolve(e,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,t)}))}getHarDenPath(t,e,s,o){const r=t.find((([,t])=>t.getDependencyRootPath()===e));if(!r)return path_1.default.resolve(s,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,o);const i=path_1.default.resolve(s,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,har_target_util_js_1.HarTargetUtil.getHarDependencyTargetName(this.targetService,r),o);return fs_extra_1.default.pathExistsSync(i)?i:path_1.default.resolve(s,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,o)}apiTransform(t){if(t.version<=sdk_const_js_1.ApiVersion.API_VERSION_9)return t.version;let e="";const s=t.api.split(".");for(const t of s)e+=t.padStart(2,"0");e+=`${t.version}`.padStart(3,"0");let o=0;for(let t=0;t<e.length;t++)if(0!==(0,wdk_1.parseInt)(e[t])){o=t;break}return e=e.substring(o),(0,wdk_1.parseInt)(e)}declareInputs(){const t=new Map;this._bundleName&&t.set(exports.INPUT_KEY.bundleName,this._bundleName),this._vendor&&t.set(exports.INPUT_KEY.vendor,this._vendor),t.set(exports.INPUT_KEY.targetSdkVersion,this.compileApiVersion),t.set(exports.INPUT_KEY.compatibleSdkVersion,this.compatibleApiVersion),t.set(exports.INPUT_KEY.releaseType,this.sdkInfo.getReleaseType()),t.set(exports.INPUT_KEY.buildRoot,this._buildRoot),t.set(exports.INPUT_KEY.isDebug,this.targetService.isDebug()),t.set(exports.INPUT_KEY.asanEnable,this.asanEnable),t.set(exports.INPUT_KEY.tsanEnable,this.tsanEnable),this.appEnvironments&&t.set(exports.INPUT_KEY.appEnvironments,this.appEnvironments);const e=this.moduleModel.getJsonProfileOptByTargetName(this.targetName,this.isFaMode);return t.set(exports.INPUT_KEY.moduleJsonOpt,JSON.stringify(e)),t}parseToAppEnvironments(t){const e=[];if(void 0===t)return e;const s=t.replace(/^\s*{\s*(.*)\s*}\s*$/,"$1"),o=/(\w+):([^,]+)/g;let r;for(;null!==(r=o.exec(s));){const t={name:r[1],value:r[2].trim()};e.push(t)}return e}}exports.AbstractMergeProfile=AbstractMergeProfile;