"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var a=Object.getOwnPropertyDescriptor(t,o);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,a)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractMakePackInfo=void 0;const wdk_1=require("@baize/wdk"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),hvigor_1=require("@ohos/hvigor"),device_type_const_js_1=require("../const/device-type-const.js"),module_task_service_js_1=require("./service/module-task-service.js"),abstract_merge_profile_js_1=require("./abstract-merge-profile.js");class AbstractMakePackInfo extends ohos_hap_task_js_1.OhosHapTask{declareInputs(){var e,t,o;const s=new Map,a=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt),i=null!==(t=null==a?void 0:a.bundleName)&&void 0!==t?t:this.targetData.getProduct().bundleName;i&&s.set("bundleName",i);const r=null===(o=this.targetData.getTargetOpt().output)||void 0===o?void 0:o.artifactName;r&&s.set("artifactName",r);const n=this.targetData.getTargetDeviceType();s.set("deviceTypes",n),s.set("compileSdkVersion",this.compileApiVersion),s.set("compatibleSdkVersion",this.compatibleApiVersion);const l=this.moduleModel.getJsonProfileOptByTargetName(this.targetName,this.isFaMode);if(void 0!==l.module.packageName&&delete l.module.packageName,void 0!==l.module.installationFree&&delete l.module.installationFree,s.set(abstract_merge_profile_js_1.INPUT_KEY.moduleJsonOpt,JSON.stringify(l)),!this.isFaMode)return s;const d=this.service.getRelatedEntryModules(),u=this.service.getModuleModel().getModuleType();if(module_task_service_js_1.ModuleTaskService.checkEntryModules(u,d))for(const e of d)if(this.projectModel.getModuleModelByName(e)){const t=this.targetData.findTargetDataByName(e),o=this.projectModel.getModuleModelByName(e);s.set(e,!!t&&this.getEntryDeviceType(t,o))}return s}declareOutputFiles(){const e=new hvigor_1.FileSet,t=this.service.getRelatedEntryModules(),o=this.service.getModuleModel().getModuleType();if(module_task_service_js_1.ModuleTaskService.checkEntryModules(o,t)){for(const o of t)if(this.projectModel.getModuleModelByName(o)){const t=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),o,build_directory_const_js_1.BuildArtifactConst.PACK_INFO);e.addEntry(t)}}else{const t=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO);e.addEntry(t)}return e}doMakePackInfo(e,t,o){const s=this.targetData.getTargetDeviceType(),a=this.targetData.getTargetName(),i=this.moduleModel.getJsonObjByTargetName(a),r=this.getModuleObj(s,this.moduleModel,o,a),n=this.service.getRelatedEntryModules(),l=a===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET?this.getModuleObj(s,this.moduleModel,o,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET):void 0,d=this.service.getModuleModel().getModuleType();if(module_task_service_js_1.ModuleTaskService.checkEntryModules(d,n)){for(const d of n)if(this.projectModel.getModuleModelByName(d)){const n=this.targetData.findRelatedTargetData(d),u=this.projectModel.getModuleModelByName(d),c=this.getEntryDeviceType(n,u),_=[r,this.getModuleObj(this.getDeviceTypeSubset(e,d,c,s),u,o,a)];if(l){const t=this.getModuleObj(this.getDeviceTypeSubset(e,d,c,s),u,o,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);_.push(l,t)}this.buildPackInfo(e,d,i,t,_,u.getJsonObjByTargetName(a))}}else{const o=l?[r,l]:[r];this.buildPackInfo(e,"",i,t,o,void 0)}}buildPackInfo(e,t,o,s,a,i){var r,n,l,d;const u=this.targetData.getModuleTargetOutputFileName(t,null),c=null!==(n=null===(r=this.targetData.getTargetOpt().output)||void 0===r?void 0:r.artifactName)&&void 0!==n?n:u.substring(0,u.lastIndexOf(build_directory_const_js_1.BuildArtifactExtension.DOT_HAP)),_=this.targetData.getModuleTargetOutputFileName(t,null,void 0,device_type_const_js_1.DeviceTypeConst.LITE),g=_.substring(0,_.lastIndexOf(build_directory_const_js_1.BuildArtifactExtension.DOT_HAP)),p=i?this.getPackageObj(null!==(l=this.targetData.findTargetDataByName(t))&&void 0!==l?l:this.targetData,o,c,g):this.getPackageObj(null!==(d=this.targetData.findTargetDataByName(t))&&void 0!==d?d:this.targetData,o,c,g),h=this.getPackInfoObj(s,a,p);this.outputJSON(e,h,this.targetData.getPathInfo().getModuleBuildOutputPath(),t)}processForms(e){if(void 0===e)return;const t=[];for(let o=0;o<e.length;o++){const s=e[o],a={name:s.name,type:"JS",updateEnabled:s.updateEnabled,scheduledUpdateTime:s.scheduledUpdateTime,updateDuration:s.updateDuration,supportDimensions:s.supportDimensions,defaultDimension:s.defaultDimension};t.push(a)}return t}processAbilities(e){if(void 0===e)return;const t=[];for(const{forms:o,label:s,name:a,visible:i}of e){const e={name:a,label:s,visible:i,forms:this.processForms(o)};t.push(e)}return t}outputJSON(e,t,o,s){e.debug("Module Pack Info: ",t),fse.outputJSONSync(path_1.default.resolve(o,s,build_directory_const_js_1.BuildArtifactConst.PACK_INFO),t)}getPackInfoObj(e,t,o){return{summary:{app:e,modules:t},packages:o}}checkEntryTarget(e,t,o,s){!s&&this.isFaMode&&e._buildError(`Unable to find target '${t}' in module '${o}'. Make sure module '${this.moduleName}' has the same target as module '${o}'.`)._printErrorAndExit(this.moduleName)}getEntryDeviceType(e,t){return e?e.getTargetDeviceType():t.getDeviceTypes()}getDeviceTypeSubset(e,t,o,s){const a=new Set(s),i=o.filter((e=>a.has(e)));return 0===i.length&&e.warn(`The device types of ${this.moduleModel.getName()} and ${t} are different. Invalid HAP ${this.moduleModel.getName()}.`),i}}exports.AbstractMakePackInfo=AbstractMakePackInfo;