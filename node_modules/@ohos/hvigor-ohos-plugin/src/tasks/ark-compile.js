"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,s)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ArkCompile=void 0;const hvigor_1=require("@ohos/hvigor"),crypto_1=__importDefault(require("crypto")),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_const_js_1=require("../const/inject-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),har_target_util_js_1=require("../utils/har-target-util.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),math_util_js_1=require("../utils/math-util.js"),obfuscation_config_resolver_js_1=require("../utils/obfuscation-config-resolver.js"),task_util_js_1=require("../utils/task-util.js"),abstract_compile_node_js_1=require("./abstract/abstract-compile-node.js"),task_names_js_1=require("./common/task-names.js"),har_extend_info_js_1=require("./har/har-extend-info.js"),global_project_data_service_js_1=require("./service/global-project-data-service.js"),target_task_service_js_1=require("./service/target-task-service.js"),run_ark_js_1=require("./worker/run-ark.js"),compile_resource_js_1=require("./compile-resource.js"),generate_loader_json_js_1=require("./generate-loader-json.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const inject_util_js_1=require("../utils/inject-util.js"),mock_config_utils_js_1=require("../utils/mock-config-utils.js"),source_roots_utils_js_1=require("../utils/source-roots-utils.js");class ArkCompile extends abstract_compile_node_js_1.AbstractCompileNode{constructor(e,t,o){super(e,t,o),this._log=ohos_logger_js_1.OhosLogger.getLogger(ArkCompile.name);const i=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.formJsonPathArr=target_task_service_js_1.TargetTaskService.getFormJsonArr(i),this.needSubmitArkTsWidget=this.shouldCompileArkTsWidget(),this.pkgNameToPkgBriefInfo={},this._taskService=e,this.arkdataPathAll=[]}taskShouldDo(){return(void 0!==this.sourcePath||this.checkPackageMain())&&this.checkRollUpPlugin()}declareInputs(){var e,t,o,i;const s=super.declareInputs().set("arkTsWdiget",this.needSubmitArkTsWidget),r=hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.DEBUG_LINE);r&&s.set(common_const_js_1.CommonConst.DEBUG_LINE,r);const a=this.getObfuscationEnable();return s.set(common_const_js_1.CommonConst.OBFUSCATION_ENABLE,String(a)),this.obfuscationOptions&&!this.obfuscationHash&&(this.obfuscationHash=this.computeObfuscationFileHash(this.obfuscationOptions),s.set(common_const_js_1.CommonConst.OBFUSCATION_FILES_HASH,null!==(e=this.obfuscationHash)&&void 0!==e?e:"")),s.set(common_const_js_1.CommonConst.NO_EXTERNAL_IMPORT_BY_PATH,null!==(i=null===(o=null===(t=this.buildOption)||void 0===t?void 0:t.strictMode)||void 0===o?void 0:o.noExternalImportByPath)&&void 0!==i&&i),s}declareOutputFiles(){const e=super.declareOutputFiles(),t=this.targetService.getTargetData().getTargetName();return!this.moduleModel.isHspModule()||t===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET||inject_util_js_1.InjectUtil.isColdReload()||inject_util_js_1.InjectUtil.isUnitTestProcess()||inject_util_js_1.InjectUtil.isHotReload()||inject_util_js_1.InjectUtil.isPreviewProcess()||e.addEntry(path_1.default.resolve(this.aceModuleBuild,`../${build_directory_const_js_1.BuildDirConst.DECLARE_FILE_OUTPUT}`),{isDirectory:!0}),e}async beforeAlwaysAction(){this.obfuscationOptions=await this.getObfuscationOptions(),this.arkDataCompile(),this.setPkgNameToPkgBriefInfo()}async beforeTask(){if(await super.beforeTask(),this.moduleModel.isHspModule()){const e=path_1.default.resolve(this.aceModuleBuild,`../${build_directory_const_js_1.BuildDirConst.DECLARE_FILE_OUTPUT}`);fse.existsSync(e)&&fse.removeSync(e)}if(this.targetService.isDebug())return;const e=this.getIncrementalCacheItem(common_const_js_1.CommonConst.OBFUSCATION_ENABLE);if(String(e)!==String(this.getObfuscationEnable()))return this._log.debug("Clean the arkts cache due to obfuscation config changes."),void await this.cleanCache();this.getIncrementalCacheItem(common_const_js_1.CommonConst.OBFUSCATION_FILES_HASH)!==this.obfuscationHash&&(this._log.debug("Clean the arkts cache due to obfuscation file changes."),await this.cleanCache())}declareInputFiles(){var e,t;const o=super.declareInputFiles().addEntries(this.formJsonPathArr),i=this.targetService.getTargetData().getTargetName(),s=this.pathInfo.getGenerateBuildProfilePath(i);fse.existsSync(s)&&o.addEntry(s);const r=this.targetService.getModuleService().getModuleModel().getProjectDir(),a=path_1.default.resolve(r,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES);fse.existsSync(a)&&o.addEntry(a,{isDirectory:!0}),this.service.getHarModuleDependencies().forEach((([,e])=>{var t;const i=e.getDependencyRootPath(),s=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES);fse.existsSync(s)&&o.addEntry(s,{isDirectory:!0});const r=path_1.default.resolve(i,build_directory_const_js_1.BuildArtifactConst.BUILD_PROFILE_FILE);fse.existsSync(r)&&o.addEntry(r);const a=null===(t=this.pkgNameToPkgBriefInfo[e.getPackageName()])||void 0===t?void 0:t.originalSourceRoots;(null==a?void 0:a.length)&&a.forEach((e=>{const t=path_1.default.resolve(i,e);fse.existsSync(t)&&o.addEntry(path_1.default.resolve(i,e),{isDirectory:!0})}))}));const n=null===(t=null===(e=this.targetService.getTargetData().getTargetOpt())||void 0===e?void 0:e.source)||void 0===t?void 0:t.sourceRoots;(null==n?void 0:n.length)&&n.forEach((e=>{o.addEntry(path_1.default.resolve(this.pathInfo.getModulePath(),e),{isDirectory:!0})}));const l=this.moduleModel.getMockConfigPath();return fse.existsSync(l)&&(o.addEntry(l,{isDirectory:!1}),o.addEntries((0,mock_config_utils_js_1.getMockConfigSources)(l,this.moduleModel.getProjectDir()))),o}async doTaskAction(){this.validateModuleJson(this._log);const e=await this.initDefaultArkCompileConfig();this._log.debug("build config:"),this._log.debug(e),e.externalApiPaths.length>0&&this._log.debug(`Compile arkts with external api path: ${e.externalApiPaths.join(path_1.default.delimiter)}`),e.obfuscationOptions&&(await fse.ensureDir(e.obfuscationOptions.obfuscationCacheDir),await fse.ensureDir(path_1.default.dirname(e.obfuscationOptions.exportRulePath))),fse.ensureDirSync(e.cachePath),fse.ensureDirSync(e.aceModuleBuild);let t=null;const o=void 0===hvigor_1.coreParameter.properties.ohosArkCompileMaxSize||hvigor_1.coreParameter.properties.ohosArkCompileMaxSize<=0||hvigor_1.coreParameter.properties.ohosArkCompileMaxSize>hvigor_1.PoolConstant.MAX_POOL_NUM?common_const_js_1.ArkPackConst.MAX_ARK_COMPILE_NUM:hvigor_1.coreParameter.properties.ohosArkCompileMaxSize;if(t=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this._log,e,(e=>{this.moveReleaseMap(this.targetData,this._log,this.codeType),this.handleCompileEvents(e,t?this.getSubDurationEvent(t):this.durationEvent,!1)}),0===this.getWorkerPool().getMaxPoolNum()?void 0:[(0,math_util_js_1.mod)((0,hvigor_1.getModuleIndex)(e.modulePath),Math.min(this.getWorkerPool().getMaxPoolNum(),o))]),this.needSubmitArkTsWidget){const t=await this.initWidgetDefaultArkCompileConfig();t.ignoreWarning=!0;let i=null;i=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this._log,t,(e=>this.handleCompileEvents(e,i?this.getSubDurationEvent(i):this.durationEvent,!1)),0===this.getWorkerPool().getMaxPoolNum()?void 0:[(0,math_util_js_1.mod)((0,hvigor_1.getModuleIndex)(e.modulePath,!0),Math.min(this.getWorkerPool().getMaxPoolNum(),o))])}(0,task_util_js_1.warnCreateBuildProfileTask)(this.targetData,this.targetService,this._log)}getSelfPkgBriefInfo(){var e;const t=null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots,o=this.pathInfo.getModulePath(),i=this.packageJsonObj.name||this.moduleName,s={pkgRoot:o,originalSourceRoots:t,sourceRoots:[...t||[],path_1.default.relative(o,this.pathInfo.getModuleSrcMainPath()),path_1.default.relative(o,path_1.default.resolve(this.pathInfo.getGenerateBuildProfileDir(),this.targetName))],pkgName:i};return{[i]:s}}setPkgNameToPkgBriefInfo(){this.pkgNameToPkgBriefInfo={...(0,source_roots_utils_js_1.getDependenciesPkgBriefInfo)(this.targetService),...this.getSelfPkgBriefInfo()}}getCollectImportersConfig(){var e;const t=this.pathInfo.getBuildConfigPath(),o=(0,json_util_js_1.getJson5Obj)(t);if("coldReload"===(null===(e=null==o?void 0:o.patchConfig)||void 0===e?void 0:e.mode))return{relativeDir:path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),"ets"),buildConfigJsonPath:this.pathInfo.getBuildConfigPath(),isReload:!1}}getTscAddressPaths(e){const t=this.pkgNameToPkgBriefInfo,o={};return Object.values(t).forEach((t=>{var i;const s=null===(i=t.sourceRoots)||void 0===i?void 0:i.map((o=>path_1.default.join(path_1.default.relative(e,path_1.default.resolve(t.pkgRoot,o)),"*")));(null==s?void 0:s.length)&&(o[`${t.pkgName}/*`]=s)})),o}async initDefaultArkCompileConfig(){var e,t,o;const i=this.targetData.getModuleModel().getMockConfigPath(),s={...await super.initDefaultArkCompileConfig(),pkgNameToPkgBriefInfo:this.pkgNameToPkgBriefInfo,projectModel:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getCompileProjectModel(),pkgJsonFileHash:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getProjectPkgJsonFileHash(),allModulePaths:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getAllModulePaths(),routerMap:this.getRouterMapConfig(),obfuscationOptions:this.obfuscationOptions,mockParams:{decorator:"@MockSetup",packageName:"@ohos/hamock",etsSourceRootPath:"src/main/ets",mockConfigPath:fse.existsSync(i)?i:void 0,mockConfigKey2ModuleInfo:(0,mock_config_utils_js_1.getMockConfigKey2ModuleInfoMap)(this.moduleModel.getMockConfigPath(),this.service)},caseSensitiveCheck:!(!(0,hvigor_1.isWindows)()&&!(0,hvigor_1.isMac)())&&(null!==(o=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.caseSensitiveCheck)&&void 0!==o&&o)};return s.aceModuleRoot||(s.aceModuleRoot=path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),this.codeType)),s.otherPaths=this.getTscAddressPaths(s.aceModuleRoot),s.collectImportersConfig=this.getCollectImportersConfig(),s}async initWidgetDefaultArkCompileConfig(){const e=this.getTaskTempDir(this.targetData,"_widget"),t={...await this.initDefaultArkCompileConfig(),widgetCompile:"true",cachePath:e};return t.obfuscationOptions&&(t.obfuscationOptions.obfuscationCacheDir=path_1.default.resolve(e,"obfuscation")),t}getRouterMapConfig(){var e;const t=new Map,o=[];this.service.getHarDependencies().forEach((e=>{if(e.isLocal()){const t=dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(e,this.projectModel);t&&Array.prototype.push.apply(o,t)}else{const t=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e);t&&Array.prototype.push.apply(o,t)}}));const i=null!==(e=this.targetService.getTargetRouterMapObjList(this.moduleModel))&&void 0!==e?e:o;return null==i||i.sort(((e,t)=>e.name.localeCompare(t.name))).forEach((e=>{const o=path_1.default.resolve(e.moduleNodeDir,e.pageSourceFile),i=`${e.name}@${e.buildFunction}`,s=t.has(o)?`${t.get(o)}#${i}`:i;t.set(o,s)})),t}shouldCompileArkTsWidget(){return this.formJsonPathArr.some((e=>{var t;let o;try{o=fse.readJsonSync(e)}catch(t){throw new Error(`${e} is not in valid JSON format.`)}return null===(t=o.forms)||void 0===t?void 0:t.some((e=>"arkts"===e.uiSyntax))}))}arkDataCompile(){const e=this._taskService.getModuleService().getHarDependencies();if(void 0===e||e.length<=0)return;const t=this._taskService.getModuleService().getModuleModel().getName(),o=this._taskService.getTargetData().getPathInfo().getModuleSrcMainResourceRawfileArkdataPath(),i=this._taskService.getTargetData().getPathInfo().getIntermediatesResArkDataPath();this.arkdataPathAll.push(o);const s=new Set;if(fse.existsSync(o)){const e=fse.readdirSync(o);for(const t of e)s.add(t)}fse.existsSync(i)||fse.mkdirSync(i,{recursive:!0});for(const o of e){const e=o.getPackageName(),r=this._taskService.getModuleService().getProjectModel().getModuleModelByName(e),a=null==r?void 0:r.getProjectDir();if(void 0!==a){const o=path_1.default.resolve(a,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES,build_directory_const_js_1.BuildDirConst.RAW_FILE,build_directory_const_js_1.BuildDirConst.ARK_DATA,build_directory_const_js_1.BuildDirConst.SCHEMA);if(!fse.existsSync(o))continue;this.arkdataPathAll.push(o);const r=fse.readdirSync(o);for(const a of r){s.has(a)&&this._log._buildError(`The ${a} file in the ${e} module has the same name as the ${a} file in the ${t} module.`)._detail("Rename either of the files to proceed.")._printErrorAndExit(),s.add(a);const r=path_1.default.resolve(o,a),n=path_1.default.resolve(i,a);fse.existsSync(i)&&fse.copyFileSync(r,n)}}}}initTaskDepends(){if((0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_9)){this.declareDependsList(generate_loader_json_js_1.GenerateLoaderJson.name,compile_resource_js_1.CompileResource.name,CommonTask.CREATE_BUILD_PROFILE.name);har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach(((e,t)=>this.declareDepends(`${e}@${CommonTask.CREATE_HAR_BUILD_PROFILE.name}`,t)))}else this.declareDependsList(generate_loader_json_js_1.GenerateLoaderJson.name,compile_resource_js_1.CompileResource.name)}async getObfuscationOptions(){var e,t,o,i;const s=this.targetService.getBuildOption();if(s.debuggable)return void("true"===(null===(e=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.ARK_OBFUSCATION))||void 0===e?void 0:e.toLowerCase())&&this._log.warn("Obfuscation is only enabled in release mode."));const r=path_1.default.resolve(this.getTaskTempDir(this.targetData),"obfuscation");let a=null===(t=s.arkOptions)||void 0===t?void 0:t.obfuscation;s.artifactType&&this._log.warn("buildOption/artifactType is deprecated, please use buildOption/arkOptions/obfuscation instead."),s.artifactType===har_extend_info_js_1.ArtifactType.OBFUSCATION&&void 0===(null===(o=null==a?void 0:a.ruleOptions)||void 0===o?void 0:o.enable)&&(a={...a,ruleOptions:{enable:!0},libDir:this.module.getNodeDir()});const n=this.getObfuscationEnable();if(!a||void 0===(null===(i=a.ruleOptions)||void 0===i?void 0:i.enable)){if(void 0===n)return;this._log.debug(`Command line specified enable was used, obfuscationEnable is: ${n}`),a={ruleOptions:{enable:n},libDir:this.module.getNodeDir()}}if(!(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_10||this.isFaMode))return void 0!==n&&a.ruleOptions&&(a.ruleOptions.enable=n),(0,obfuscation_config_resolver_js_1.resolveObfuscationOptions)(this.targetService,a,r);this._log.warn(`Obfuscation is supported in stage mode of API${sdk_const_js_1.ApiVersion.API_VERSION_10} or later.`)}computeObfuscationFileHash(e){var t,o,i,s,r,a,n,l;const c=[];c.push(...null!==(i=null===(o=null===(t=e.selfConfig)||void 0===t?void 0:t.ruleOptions)||void 0===o?void 0:o.rules)&&void 0!==i?i:[]),c.push(...null!==(r=null===(s=e.selfConfig)||void 0===s?void 0:s.consumerRules)&&void 0!==r?r:[]),c.push(...e.dependencies.hars);for(const t of e.dependencies.libraries)c.push(...null!==(n=null===(a=t.ruleOptions)||void 0===a?void 0:a.rules)&&void 0!==n?n:[]),c.push(...null!==(l=t.consumerRules)&&void 0!==l?l:[]);const u=crypto_1.default.createHash("sha256");for(const e of c)fse.existsSync(e)&&u.update(fse.readFileSync(e));return u.digest("hex")}getIncrementalCacheItem(e){var t,o,i;return null===(i=null===(o=null===(t=hvigor_1.ProjectCacheService.getInstance(this.projectModel.getProject()).getTaskSnapShot(this.getName(),this.module))||void 0===t?void 0:t.getInputs())||void 0===o?void 0:o.find((t=>t.getName()===e)))||void 0===i?void 0:i.getValue()}async cleanCache(){const e=this.getTaskTempDir(this.targetData);await fse.emptydir(e);const t=path_1.default.resolve(e,"..",".ts_checker_cache");fse.existsSync(t)&&await fse.rm(t)}getObfuscationEnable(){var e,t,o,i,s;const r=null===(e=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.ARK_OBFUSCATION))||void 0===e?void 0:e.toLowerCase();return"false"!==r&&("true"===r||(null===(s=null===(i=null===(o=null===(t=this.buildOption)||void 0===t?void 0:t.arkOptions)||void 0===o?void 0:o.obfuscation)||void 0===i?void 0:i.ruleOptions)||void 0===s?void 0:s.enable))}checkPackageMain(){const e=this.packageJsonObj.main?this.packageJsonObj.main:build_directory_const_js_1.BuildArtifactConst.INDEX_ETS;return fse.existsSync(path_1.default.resolve(this.pathInfo.getModulePath(),e))}checkRollUpPlugin(){return this.codeType===code_type_enum_js_1.CodeType.ETS?this.sdkInfo.hasRollUpPluginInEtsLoader:this.sdkInfo.hasRollUpPluginInJsLoader}}exports.ArkCompile=ArkCompile;