"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenerateLoaderJson=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),aot_compile_mode_enum_js_1=require("../enum/aot-compile-mode-enum.js"),build_mode_manager_js_1=require("../project/build-option/build-mode-manager.js"),file_util_js_1=require("../utils/file-util.js"),inject_util_js_1=require("../utils/inject-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),strategy_js_1=require("../utils/strategy.js"),sdk_version_js_1=require("../version/sdk-version.js"),sdk_version_enum_js_1=require("../version/sdk-version-enum.js"),task_names_js_1=require("./common/task-names.js"),abstract_generate_loader_json_js_1=require("./abstract-generate-loader-json.js"),pre_build_js_1=require("./pre-build.js"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),inject_const_1=require("../const/inject-const"),module_type_enum_js_1=require("../enum/module-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),array_util_js_1=require("../utils/array-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),json_util_js_1=require("../utils/json-util.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),build_profile_utils_js_1=require("../utils/build-profile-utils.js"),cmake_util_js_1=require("../utils/cmake-util.js"),hsp_target_utils_js_1=require("../utils/hsp-target-utils.js"),oh_package_loader_js_1=require("../utils/loader/file/oh-package-loader.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),log=ohos_logger_js_1.OhosLogger.getLogger("GenerateLoaderJson");class GenerateLoaderJson extends abstract_generate_loader_json_js_1.AbstractGenerateLoaderJson{constructor(e){super(e,task_names_js_1.TaskNames.Task.GENERATE_LOADER_JSON),this.aceLoaderJson=path_1.default.resolve(e.getTargetData().getPathInfo().getIntermediatesLoaderPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON),this.nodeModulesPath=path_1.default.resolve(e.getTargetData().getPathInfo().getInterMediatesLoaderOutPath(),common_const_js_1.CommonNodeConst.NODE_MODULES),this.harNameOhmMap=this.getHarNameOhmMap(),this.hspResourcesMap=this.getHspResourcesMap(),this.moduleSrcMainPath=e.getTargetData().getPathInfo().getModuleSrcMainPath(),this.modulePath=e.getTargetData().getPathInfo().getModulePath(),this.appStartupPath=e.getAppStartupPath(),this.moduleSrcMockPath=e.getTargetData().getPathInfo().getModuleSrcMockPath(),this.mockConfigJsonPath=path_1.default.resolve(this.moduleSrcMockPath,build_directory_const_js_1.BuildArtifactConst.MOCK_CONFIG_JSON),this.moduleJson5Path=path_1.default.resolve(this.moduleSrcMainPath,build_directory_const_js_1.BuildArtifactConst.MODULE_JSON5),this.etsSourcePath=path_1.default.join(this.pathInfo.getModuleSrcMainPath(),code_type_enum_js_1.CodeType.ETS),this.insightIntentJsonPath=path_1.default.resolve(this.pathInfo.getModuleSrcMainResourceBaseProfilePath(),build_directory_const_js_1.BuildArtifactConst.INSIGHT_INTENT_JSON),this.compileEntry=this.readInsightIntentSrcEntry(),this.dynamicImportLibInfo={},this.intermediatesRouterMapObjs=[],this.tempApDir=this.pathInfo.getIntermediatesApPath(),this.tempApPath=path_1.default.resolve(this.tempApDir,`${this.moduleName}.ap`),this.anBuildOutPutPath=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),aot_compile_mode_enum_js_1.AotCompileModeEnum.AN,aot_compile_mode_enum_js_1.AotCompileModeEnum.ARM64_V8A),this.isPreview=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_1.InjectConst.BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH,this.fallbackAnBuild=inject_util_js_1.InjectUtil.isOhosTestCoverage()||this.moduleModel.isHarModule();const t=this.targetService.getApPath();t&&(this.apPath=path_1.default.resolve(this.moduleModel.getProjectDir(),t))}declareInputs(){var e,t,i,s;const o=super.declareInputs(),n=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath(),r=(0,json_util_js_1.getJson5Obj)(n);o.set("module_dependencies",JSON.stringify(r.dependencies));const a=this.isOhpmProject?this.projectModel.getOhPackageJson5Path():this.projectModel.getPackageJsonPath(),l=(0,json_util_js_1.getJson5Obj)(a);if(o.set("project_dependencies",JSON.stringify(l.dependencies)),this.isOhpmProject){const e=path_1.default.resolve(this.projectRootPath,common_const_js_1.CommonConst.OH_PACKAGE_JSON5);if(fse.existsSync(e)){const t=(0,json_util_js_1.getJson5Obj)(e);o.set("overrides",t.overrides)}}o.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,!!(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl));const d=common_const_js_1.HvigorConfigConst.OHOS_COMPILE_LIB_ENTRY;return o.set(d,!!hvigor_1.coreParameter.properties[d]),this.declareDynamicImportInputs(o),o.set("compileMode",this.targetCompileMode.toString()).set("nodeModulesPath",this.nodeModulesPath).set("targetConfig",JSON.stringify(this.targetData.getTargetOpt())).set("harNameOhmMap",JSON.stringify(this.harNameOhmMap)).set("anBuildMode",null!==(i=this.targetService.getAnBuildMode())&&void 0!==i?i:"").set("apPath",null!==(s=this.apPath)&&void 0!==s?s:"").set("fallbackAnBuild",this.fallbackAnBuild).set("isHarUnitTestWithCoverage",this.isHarUnitTestWithCoverage())}declareDynamicImportInputs(e){var t,i;const s=Object.keys(this.getDependencies(this.moduleModel,!1)),o=Object.keys(this.getDependencies(this.projectModel,!1)),n=(0,build_profile_utils_js_1.getRuntimeOnlyObjMap)(this.module.getNodeDir(),null===(i=null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.arkOptions)||void 0===i?void 0:i.runtimeOnly,(0,array_util_js_1.getUnionSet)(o,s));for(const[t,i]of n)e.set(t,i);this.service.getHarModuleDependencies().forEach((([t,i])=>{var s;const n=(null===(s=i.getPackageJsonObj())||void 0===s?void 0:s.dependencies)||{},r=(0,build_profile_utils_js_1.getRuntimeOnlyObjMap)(i.getDependencyRootPath(),this.getLocalDependencyRuntimeOnly(i),(0,array_util_js_1.getUnionSet)(o,Object.keys(n)),t);for(const[t,i]of r)e.set(t,i)}))}declareInputFiles(){var e,t;const i=new hvigor_1.FileSet;this.apPath&&fse.existsSync(this.apPath)&&i.addEntry(this.apPath,{isDirectory:!1}),this.insightIntentJsonPath&&fse.existsSync(this.insightIntentJsonPath)&&i.addEntry(this.insightIntentJsonPath),this.mockConfigJsonPath&&fse.existsSync(this.mockConfigJsonPath)&&i.addEntry(this.mockConfigJsonPath),this.appStartupPath&&fse.existsSync(this.appStartupPath)&&i.addEntry(this.appStartupPath),fse.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&i.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath());const s=this.getModuleEntryFile();this.isHarUnitTestWithCoverage()&&fse.existsSync(s)&&i.addEntry(s);const o=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.INTERMEDIATES_ROUTER_MAP_FOR_LOADER_FILE_NAME);if(fse.existsSync(o)){(null===(e=(0,json_util_js_1.getJson5Obj)(o).routerMap)||void 0===e?void 0:e.length)&&i.addEntry(o)}const n=this.pathInfo.getIntermediatesRouterMap(null!==(t=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.INTERMEDIATES_TEMP_ROUTER_MAP_FILE_NAME);return fse.existsSync(n)&&i.addEntry(n),this.allowToCollectEtsFolderFilesEntry()&&fse.existsSync(this.etsSourcePath)&&i.addEntry(this.etsSourcePath,{isDirectory:!0}),this.addDependencyDynamicImportFileSet(i),i}addDependencyDynamicImportFileSet(e){var t,i,s;if(!this.allowToCollectDepEtsFolderFilesEntry())return;const o=[],n=new Map;this.service.getHarDependencies().forEach((e=>{n.set(e.getDependencyName(),e);const t=e.isLocal()?this.getLocalDependencyDynamicImportList(e):this.getRemoteDependencyDynamicImportList(e);o.push(...t)}));const r=null===(s=null===(i=null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.arkOptions)||void 0===i?void 0:i.runtimeOnly)||void 0===s?void 0:s.packages;o.concat(r||[]).forEach((t=>{const i=n.get(t);if(!i)return;const s=path_1.default.join(i.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,code_type_enum_js_1.CodeType.ETS);this.allowToCollectDepEtsFolderFilesEntry()&&fse.existsSync(s)&&e.addEntry(s,{isDirectory:!0})}))}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.aceLoaderJson,{isDirectory:!1})}initTaskDepends(){this.declareDepends(pre_build_js_1.PreBuild.name)}getWorkerConfig(){var e;if(this.moduleModel.isHarModule())return 0===this.targetService.getWorkerConfig().length?void 0:this.targetService.getWorkerConfig();const t=this.service.getHarModuleDependencies().reduce(((e,t)=>{var i,s;const o=this.projectModel.getModuleModelByName(t[0]);if(void 0===o)return e;const n=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(t[0],har_target_util_js_1.HarTargetUtil.getHarDependencyTargetName(this.targetService,t)),r=file_util_js_1.FileUtil.convertToAbsolutePaths(null!==(s=null===(i=n.sourceOption)||void 0===i?void 0:i.workers)&&void 0!==s?s:[],o.getProjectDir());return r?e.concat(r):e}),null!==(e=this.targetService.getWorkerConfig())&&void 0!==e?e:[]),i=this.service.getHarModuleDependencyPaths();return this.service.getHarDependencies().forEach((e=>{var s;if(i.includes(e.getDependencyRootPath()))return;const o=(0,json_util_js_1.getJson5Obj)(e.getPackageFilePath(),"utf-8");(null===(s=null==o?void 0:o.metadata)||void 0===s?void 0:s.workers)&&t.push(...file_util_js_1.FileUtil.convertToAbsolutePaths(o.metadata.workers,e.getDependencyRootPath()))})),0===t.length?void 0:t}collectEtsFolderFilesEntry(e){if(!fse.existsSync(e))return;const t=[".ets",".ts",".js"],i=[e];for(;i.length;){const e=i.shift();fse.readdirSync(e).forEach((s=>{const o=path_1.default.join(e,s),n=fse.statSync(o);n.isDirectory()?i.push(o):n.isFile()&&t.includes(path_1.default.extname(o).toLowerCase())&&this.compileEntry.push(o)}))}}allowToCollectEtsFolderFilesEntry(){return this.targetName!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&!hvigor_1.coreParameter.properties[common_const_js_1.HvigorConfigConst.OHOS_COMPILE_LIB_ENTRY]&&(this.moduleModel.isHspModule()||this.moduleModel.isHarModule())}allowToCollectDepEtsFolderFilesEntry(){return!hvigor_1.coreParameter.properties[common_const_js_1.HvigorConfigConst.OHOS_COMPILE_LIB_ENTRY]&&(this.moduleModel.isHspModule()||this.moduleModel.isHapModule())}collectDepEtsFolderFilesEntry(e){const t=path_1.default.join(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,code_type_enum_js_1.CodeType.ETS);this.allowToCollectDepEtsFolderFilesEntry()&&this.collectEtsFolderFilesEntry(t)}isHarUnitTestWithCoverage(){return this.moduleModel.isHarModule()&&inject_util_js_1.InjectUtil.isUnitTestProcess()&&inject_util_js_1.InjectUtil.isOhosTestCoverage()}getModuleEntryFile(){const e=this.packageJsonObj.main?this.packageJsonObj.main:build_directory_const_js_1.BuildArtifactConst.INDEX_ETS;return path_1.default.resolve(this.pathInfo.getModulePath(),e)}processHarUnitTestWithCoverage(){const e=this.getModuleEntryFile();this.isHarUnitTestWithCoverage()&&fse.existsSync(e)&&this.compileEntry.push(e)}doTaskAction(){var e,t,i,s,o,n;const r=this.moduleModel.getSourceSetByTargetName(this.targetName);if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET){const s=null===(i=null===(t=null===(e=r.getModuleTargetRes())||void 0===e?void 0:e.getModuleJsonOpt())||void 0===t?void 0:t.module)||void 0===i?void 0:i.name;s&&(this.modulePathMap[s]=this.module.getNodeDir())}this.processHarUnitTestWithCoverage(),(this.isPreview||"ohosTest"===this.targetName)&&this.collectMockFileEntry(this.modulePath,this.mockConfigJsonPath),this.allowToCollectEtsFolderFilesEntry()&&this.collectEtsFolderFilesEntry(this.etsSourcePath),fse.existsSync(this.insightIntentJsonPath)&&this.validateForInsightIntentJson(),this.processDynamicImport(),this.processAppStartupConfig(this.appStartupPath),this.processRouterMap(this.moduleModel.getRouterMapCompileEntry());const a=this.handleAotFields(),l={workers:this.workerConfig,modulePathMap:this.modulePathMap,compileMode:this.targetCompileMode,projectRootPath:this.projectRootPath,nodeModulesPath:this.nodeModulesPath,moduleName:null===(n=null===(o=null===(s=r.getModuleTargetRes())||void 0===s?void 0:s.getModuleJsonOpt())||void 0===o?void 0:o.module)||void 0===n?void 0:n.name,harNameOhmMap:this.harNameOhmMap,packageManagerType:this.isOhpmProject?"ohpm":"npm",compileEntry:Array.from(new Set(this.compileEntry)).map((e=>fse.realpathSync.native(e))),dynamicImportLibInfo:this.dynamicImportLibInfo,routerMap:this.intermediatesRouterMapObjs,hspResourcesMap:this.hspResourcesMap,...a},d=this.pathInfo.getBuildConfigPath();if(fse.existsSync(d)&&"ohosTest"!==this.targetName){const e=(0,json_util_js_1.getJson5Obj)(d);l.patchConfig=e.patchConfig}fse.outputJSONSync(this.aceLoaderJson,l,{spaces:2})}collectMockFileEntry(e,t){if(!fse.existsSync(t))return;const i=(0,hvigor_1.parseJsonFile)(t,!1);i&&Object.values(i).forEach((t=>{const i=t.source;if(i){const t=path_1.default.resolve(e,i);fse.existsSync(t)&&this.compileEntry.push(t)}}))}logBuildError(e,t){log._buildError(e)._detail(t)._printErrorAndExit()}extensionAbilitiesValidate(e,t,i,s){if(void 0===e.form||void 0===e.form.ability)return;const o=e.form.ability;if(t.has(o)){"form"!==t.get(o).type&&(i=`Invalid ability name '${o}'.`,s=`Make sure under extensionAbilities in the module.json5 file, there is an extension ability whose type is 'form' and name is '${o}'.`,this.logBuildError(i,s))}else i=`Invalid ability name '${o}'.`,s=`Make sure under extensionAbilities in the module.json5 file, there is an extension ability whose type is 'form' and name is '${o}'.`,this.logBuildError(i,s)}serviceExtensionValidate(e,t,i,s,o){if(void 0!==e.uiAbility&&void 0!==e.uiAbility.ability){const i=e.uiAbility.ability;void 0!==i&&(t.has(i)||(s=`Invalid ability name '${i}'`,o="Make sure the name has been configured under abilities in the module.json5 file.",this.logBuildError(s,o)))}if(void 0===e.serviceExtension||void 0===e.serviceExtension.ability)return;const n=e.serviceExtension.ability;if(i.has(n)){"service"!==i.get(n).type&&(s=`Invalid ability name '${n}'`,o=`Make sure under extensionAbilities in the module.json5 file, there is an extension ability whose type is 'service' and name is '${n}'`,this.logBuildError(s,o))}else s=`Invalid ability name '${n}'`,o=`Make sure under extensionAbilities in the module.json5 file, there is an extension ability whose type is 'service' and name is '${n}'`,this.logBuildError(s,o)}uiExtensionValidate(e,t,i,s,o){if(void 0===e.uiExtension||void 0===e.uiExtension.ability)return;const n=e.uiExtension.ability;t.has(n)||i.has(n)||(s=`Invalid ability name '${n}'. `,this.logBuildError(s,"Make sure the name has been configured under abilities or extensionAbilities in the module.json5 file."))}validateForInsightIntentJson(){let e="",t="";for(const i of this.compileEntry)i.endsWith(".ets")||(e=`The file must end with '.ets' in '${i}'.`,t="Please check if the file name is correct.",this.logBuildError(e,t)),fse.existsSync(i)||(e=`Cannot find the file under the specified path '${i}'.`,t="Please check if the file in the path exists.",this.logBuildError(e,t));const i=new Set,s=(0,hvigor_1.parseJsonFile)(this.moduleJson5Path,!1);if(void 0!==s.module.abilities)for(const e of s.module.abilities)i.add(e.name);const o=new Map;if(void 0!==s.module.extensionAbilities)for(const e of s.module.extensionAbilities)o.set(e.name,e);if(null!==this.insightIntentJson)for(const s of this.insightIntentJson.insightIntents)this.serviceExtensionValidate(s,i,o,e,t),this.extensionAbilitiesValidate(s,o,e,t),this.uiExtensionValidate(s,i,o,e,t)}readInsightIntentSrcEntry(){const e=new Set;let t="";if(fse.existsSync(this.insightIntentJsonPath)){const i=(0,hvigor_1.parseJsonFile)(this.insightIntentJsonPath,!1);this.insightIntentJson=i;const s=this.moduleSrcMainPath;for(const o of i.insightIntents){const i=o.srcEntry;t=path_1.default.resolve(s,i),e.add(t)}}return Array.from(e)}checkAotCompatibleSdkVersion(){if(!this.sdkInfo.isOhos)return;const e=sdk_version_enum_js_1.SdkVersionEnum.SUPPORT_AOT_OHOS,t=this.sdkInfo.getEtsComponentVersion();if(""===t)return;const i=new sdk_version_js_1.SdkVersion(t);if(e.isHigherThan(i)){const t="SDK > OpenHarmony";log._buildError(`Unsupported SDK version for using AOT compiling. Current SDK version is ${i.getVersion()}, but the lowest SDK version which supportAoT compiling is ${e.getVersion()}.`)._detail(`Update SDK to the latest version by going to Tools > SDK Manager > ${t}. Open SDK Manager`)._printErrorAndExit()}}handleAotFields(){const e=this.targetService.getAnBuildMode();this.warnAnBuildMode(),e&&this.compileApiVersion===sdk_const_js_1.ApiVersion.API_VERSION_9&&this.checkAotCompatibleSdkVersion();const t={anBuildMode:e,apPath:this.apPath,apiVersion:this.compileApiVersion,fallbackAnBuild:this.fallbackAnBuild};return this.getAotStrategy(t)}warnAnBuildMode(){var e,t,i,s,o;const n=this.targetData.getCompileApiVersion(),r=null!==(i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.aotCompileMode)&&void 0!==i?i:null===(s=this.targetService.getBuildOption())||void 0===s?void 0:s.aotCompileMode,a=null===(o=this.targetService.getBuildOption().arkOptions)||void 0===o?void 0:o.hostPGO;switch(n){case sdk_const_js_1.ApiVersion.API_VERSION_9:void 0!==a&&log.warn('Field "hostPGO" is not supported in API version 9. The value of this field will be ignored.');break;case sdk_const_js_1.ApiVersion.API_VERSION_10:default:if(void 0!==r&&log.warn('Field "aotCompileMode" is not supported since API version 10. The value of this field will be ignored.'),this.sdkInfo.isOhos&&!this.sdkInfo.checkAotFixedSdkVersion()){const e="SDK > OpenHarmony";log._buildError(`Current version of sdk has a bug when using AoT compiling. The compiling will continue with AoT compiling function disabled. Current SDK version is ${this.sdkInfo.getEtsComponentVersion()}, but the lowest fixed SDK version is ${sdk_version_enum_js_1.SdkVersionEnum.FIXED_AOT_OHOS.getVersion()}.`)._detail(`Update SDK to the latest version by going to Tools > SDK Manager > ${e}. Open SDK Manager`)._printWarn(this.moduleName)}}}getHarNameOhmMap(){var e,t;let i={};if((null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)&&!this.service.getModuleModel().isHarModule()){const e=this.pathInfo.getIntermediatesPkgContextInfoPath(),t=(0,json_util_js_1.getJson5Obj)(e),s=this.service.getHspDependencies();i=this.getOHMUrlMap(s,t)}else this.service.getHspDependencies().forEach((e=>{const t=e.getDependencyName(),s=this.getHspDependencyModuleName(e),o=this.getHspDependencyPackageMainName(e);""!==o&&(i[t]=`@bundle:${s}${o}`)}));return i}getHspResourcesMap(){const e={};return hsp_target_utils_js_1.HspTargetUtils.calDepHspTargets(this.targetService).forEach(((t,i)=>{const s=path_1.default.resolve(t.getPathInfo().getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT);fse.existsSync(s)?e[t.getModuleModel().getName()]=s:this._log.debug(`The ResourceTable.txt in ${t.getPathInfo().getModulePath()} does not exist.`)})),this.service.getHspDependencies().forEach((t=>{const i=t.getDependencyName();let s;t.isLocal()||(s=path_1.default.resolve(t.getDependencyRootPath(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT)),s&&fse.existsSync(s)?e[i]=s:this._log.debug(`The ResourceTable.txt in ${t.getDependencyRootPath()} does not exist.`)})),e}getOHMUrlMap(e,t){const i={},s=e.map((e=>e.getPackageName()));return Object.values(t).forEach((t=>{if(s.includes(t.packageName)){const s=e.filter((e=>e.getPackageName()===t.packageName));i[s[0].getDependencyName()]=(0,ohmurl_utils_js_1.generateOhmUrl)(t)}})),i}getHspDependencyPackageMainName(e){const t=path_1.default.resolve(e.getDependencyRootPath(),"./src/main");let i,s;return i=hvigor_1.Json5Reader.getJson5Obj(e.getPackageFilePath()).main?e.getDependencyMainFilePath():e.getDependencyTypesFilePath(),i.startsWith(t)?s=i.replace(t,""):i.startsWith(e.getDependencyRootPath())&&(s=i.replace(e.getDependencyRootPath(),"")),s?(0,ohmurl_utils_js_1.removeSuffix)(s):(log._buildError(`The "main" or "types" field of hsp module ${e.getPackageName()} must be under the\n      root path of hsp module or under src/main path. Please confirm.`)._file(e.getPackageFilePath())._printWarn(this.moduleName),"")}getHspDependencyModuleName(e){var t,i,s,o,n;const r=this.service.getHspModuleDependencyPaths();let a;const l=path_1.default.resolve(e.getDependencyRootPath(),"src","main","module.json5"),d=path_1.default.resolve(e.getDependencyRootPath(),"src","main","module.json");let c;const _=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt);return r.includes(e.getDependencyRootPath())?(a=hvigor_1.Json5Reader.getJson5Obj(l),c=null!==(s=null!==(i=null==_?void 0:_.bundleName)&&void 0!==i?i:this.targetData.getProduct().bundleName)&&void 0!==s?s:this.projectModel.getDefaultBundleName()):fse.existsSync(d)?(a=(0,json_util_js_1.getJson5Obj)(d),c=a.app.bundleName):(a=hvigor_1.Json5Reader.getJson5Obj(l),c=null!==(n=null!==(o=null==_?void 0:_.bundleName)&&void 0!==o?o:this.targetData.getProduct().bundleName)&&void 0!==n?n:this.projectModel.getDefaultBundleName()),`${c}/${a.module.name}`}getAotStrategy(e){const{apiVersion:t,anBuildMode:i,apPath:s,fallbackAnBuild:o}=e,n=void 0!==s&&fse.pathExistsSync(s),r=void 0!==s&&s.endsWith("ap"),a=[{name:"withEmpty",condition:o,strategy:this.withEmpty},{name:"mismatchAotCompileMode",condition:t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i!==aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&void 0!==s,strategy:this.mismatchAotCompileMode},{name:"partialEmptyPath",condition:t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&void 0===s,strategy:this.partialEmptyPath},{name:"invalidSuffix",condition:void 0!==s&&!r,strategy:this.invalidSuffix},{name:"invalidPath",condition:i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&!n,strategy:this.invalidPath},{name:"withEmpty",condition:(t===sdk_const_js_1.ApiVersion.API_VERSION_9&&void 0===s||t>=sdk_const_js_1.ApiVersion.API_VERSION_10)&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_NULL,strategy:this.withEmpty},{name:"withApPath",condition:(t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL||t>=sdk_const_js_1.ApiVersion.API_VERSION_10)&&n&&r,strategy:this.withApPath},{name:"withoutApPath",condition:t===sdk_const_js_1.ApiVersion.API_VERSION_9&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_TYPE&&void 0===s,strategy:this.withoutApPath},{name:"withoutApPath",condition:t>=sdk_const_js_1.ApiVersion.API_VERSION_10&&i===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_TYPE&&!n,strategy:this.withoutApPath}];return(0,strategy_js_1.getStrategy)(a,(()=>({}))).bind(this)(e)}withApPath(e){return fse.emptyDirSync(this.tempApDir),fse.copyFileSync(e.apPath,this.tempApPath),{anBuildOutPut:this.anBuildOutPutPath,anBuildMode:e.anBuildMode,apPath:e.apPath}}withoutApPath(e){return{anBuildOutPut:this.anBuildOutPutPath,anBuildMode:e.anBuildMode}}withEmpty(){return{}}mismatchAotCompileMode(){log._buildError('apPath must be configured with aotCompileMode = "partial".')._detail('Configure aotCompileMode = "partial" or remove apPath field.')._file(this.moduleModel.getProfilePath())._printErrorAndExit()}partialEmptyPath(){log._buildError("AoT's Partial mode must configure a valid apPath.")._detail("Configure a valid apPath.")._file(this.moduleModel.getProfilePath())._printErrorAndExit()}invalidPath(){log._buildError(`The file corresponding to apPath under AoT's partial mode was not found in ${this.apPath}.`)._file(this.moduleModel.getProfilePath())._printErrorAndExit()}invalidSuffix(){log._buildError('apPath must be with suffix ".ap".')._file(cmake_util_js_1.CmakeUtil.getMayBeOccurErrorsFilePath(this.moduleModel))._printErrorAndExit()}processAppStartupConfig(e){if(!e||!fse.existsSync(e))return;const t=(0,json_util_js_1.getJson5Obj)(e),i=path_1.default.resolve(this.module.getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN);this.compileEntry.push(path_1.default.resolve(i,t.configEntry)),t.startupTasks.forEach((e=>{this.compileEntry.push(path_1.default.resolve(i,e.srcEntry))}))}processDynamicImport(){var e,t;this.processIndirectDependency(this.service.getHarDependencies());const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly;if(i){if(i.sources){const e=this.module.getNodeDir();i.sources.forEach((t=>{const i=path_1.default.resolve(e,t),s=fse.statSync(i);s.isFile()&&this.compileEntry.push(i),s.isDirectory()&&this.processDirectoryImport(i)}))}i.packages&&i.packages.forEach((e=>{this.isHarDependency(e)?this.processHarDynamicImport(e,this.dynamicImportLibInfo):this.processOtherDynamicImport(e,this.dynamicImportLibInfo)}))}}processHarDynamicImport(e,t){this.service.getHarDependencies().forEach((i=>{const s=i.getDependencyName();if(s===e){const o=i.getDependencyMainFilePath(),n=i.getPackageFilePath();if(this.existInDynamicImportLibsInfo(e))return;const r={[s]:{hostModulesInfo:[{hostDependencyName:s,hostModuleName:this.moduleModel.getName()}],moduleName:this.getHarDependencyModuleName(i,e),entryFilePath:o,isLocalDependency:i.isLocal(),pkgPath:n.substring(0,n.lastIndexOf(path_1.default.sep))}};Object.assign(t,r),this.compileEntry.push(o),this.collectDepEtsFolderFilesEntry(i)}}))}processOtherDynamicImport(e,t){const i=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),common_const_js_1.CommonConst.OH_MODULES,e),s=path_1.default.resolve(this.projectRootPath,common_const_js_1.CommonConst.OH_MODULES,e),o=fse.existsSync(i)?i:fse.existsSync(s)?s:"";if(""===o)return;const n=fse.realpathSync(o);if(!fse.existsSync(n))return;const r=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(o,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)),a=(0,json_util_js_1.getJson5Obj)(r);if(!a)return;const l=this.getEntryMainFilePath(n,a),d=path_1.default.resolve(n,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),c=dependency_manager_js_1.DependencyManager.isLocalDependencyForSo(l),_=c?path_1.default.resolve(d,common_const_js_1.CommonConst.MODULE_JSON5):path_1.default.resolve(d,common_const_js_1.CommonConst.MODULE_JSON);let h,u=a.name;if(fse.existsSync(_)){const t=(0,json_util_js_1.getJson5Obj)(_);if(!t)return;h=t.module.type,this.isHspDependency(e)&&(u=t.module.name)}if(h||h===module_type_enum_js_1.ModuleType.Shared||common_const_js_1.ValidateRegExp.SO_DEPENDENCY_REG_EXP.test(e)||this.compileEntry.push(l),this.existInDynamicImportLibsInfo(e))return;const p={[e]:{hostModulesInfo:[{hostDependencyName:e,hostModuleName:this.moduleModel.getName()}],moduleName:u,entryFilePath:l,isLocalDependency:c,pkgPath:n}};Object.assign(t,p)}getLocalDependencyRuntimeOnly(e){var t;return null===(t=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(path_1.default.basename(e.getDependencyRootPath()),this.targetData.getTargetName()).arkOptions)||void 0===t?void 0:t.runtimeOnly}getLocalDependencyDynamicImportList(e){return this.collectDynamicImport(this.getLocalDependencyRuntimeOnly(e))}getRemoteDependencyDynamicImportList(e){var t;const i=e.getPackageFilePath(),s=(0,json_util_js_1.getJson5Obj)(i);if(!s)return[];const o=null===(t=s.metadata)||void 0===t?void 0:t.runtimeOnly;return this.collectDynamicImport(o)}processIndirectDependency(e){e.forEach((e=>{const t=e.isLocal()?this.getLocalDependencyDynamicImportList(e):this.getRemoteDependencyDynamicImportList(e);0!==t.length&&this.processIndirectDependencyInfo(e,t)}))}collectDynamicImport(e){if(!e)return[];const t=[];return e.sources&&e.sources.forEach((e=>{t.push(e)})),e.packages&&e.packages.forEach((e=>{t.push(e)})),t}processIndirectDependencyInfo(e,t){t.forEach((t=>{if(this.isHarDependency(t)&&this.writeIndirectDependencyInfo(this.service.getHarDependencies(),t),this.isHspDependency(t)&&this.writeIndirectDependencyInfo(this.service.getHspDependencies(),t),common_const_js_1.ValidateRegExp.SO_DEPENDENCY_REG_EXP.test(t)&&this.processIndirectSoDependencyInfo(e,t),common_const_js_1.ValidateRegExp.RELATIVE_PATH_REG_EXP.test(t)){const i=path_1.default.resolve(e.getDependencyRootPath(),t);if(!fse.existsSync(i))return;const s=fse.statSync(i);s.isFile()&&this.compileEntry.push(i),s.isDirectory()&&this.processDirectoryImport(i)}}))}processDirectoryImport(e){file_util_js_1.FileUtil.getAllFilesFromFolder(e).forEach((e=>{common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(file_util_js_1.FileUtil.getFileSuffix(e))&&fse.existsSync(e)&&this.compileEntry.push(e)}))}processIndirectSoDependencyInfo(e,t){const i=e.getDependencyRootPath(),s=e.getDependencyMainFilePath(),o=e.getPackageFilePath(),n=dependency_manager_js_1.DependencyManager.isLocalDependencyForSo(s);if(!this.existInDynamicImportLibsInfo(t)&&common_const_js_1.ValidateRegExp.SO_DEPENDENCY_REG_EXP.test(t)){let s=n?path_1.default.resolve(i,common_const_js_1.CommonConst.OH_MODULES,t,common_const_js_1.CommonConst.OH_PACKAGE_JSON5):path_1.default.resolve(i.substring(0,i.lastIndexOf(path_1.default.sep)),t,common_const_js_1.CommonConst.OH_PACKAGE_JSON5);s=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(s);const r=(0,json_util_js_1.getJson5Obj)(s);if(!r)return;const a=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES,t,r.types),l={[t]:{hostModulesInfo:[{hostDependencyName:t,hostModuleName:this.getHostModuleName(e)}],moduleName:r.name,entryFilePath:a,isLocalDependency:n,pkgPath:o.substring(0,o.lastIndexOf(path_1.default.sep))}};Object.assign(this.dynamicImportLibInfo,l)}}writeIndirectDependencyInfo(e,t){e.forEach((e=>{if(e.getDependencyName()===t){const i=this.isHarDependency(t);i&&this.collectDepEtsFolderFilesEntry(e);const s=e.getDependencyMainFilePath(),o=fse.existsSync(s)?s:e.getDependencyTypesFilePath();if(!fse.existsSync(o))return;const n=fse.statSync(o);if(i&&(n.isFile()?this.compileEntry.push(o):n.isDirectory()&&file_util_js_1.FileUtil.getAllFilesFromFolder(o).forEach((e=>{common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(file_util_js_1.FileUtil.getFileSuffix(e))&&this.compileEntry.push(e)}))),this.existInDynamicImportLibsInfo(t))return;const r=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),a=path_1.default.resolve(r,common_const_js_1.CommonConst.MODULE_JSON),l=path_1.default.resolve(r,common_const_js_1.CommonConst.MODULE_JSON5),d=fse.existsSync(a)?a:fse.existsSync(l)?l:"",c=(0,json_util_js_1.getJson5Obj)(d);if(!c)return;const _=c.module.type,h=_===module_type_enum_js_1.ModuleType.Har?this.getHarDependencyModuleName(e,t):_===module_type_enum_js_1.ModuleType.Shared?c.module.name:"",u=e.getPackageFilePath(),p={[t]:{hostModulesInfo:[{hostDependencyName:t,hostModuleName:this.moduleName}],moduleName:h,entryFilePath:o,isLocalDependency:e.isLocal(),pkgPath:u.substring(0,u.lastIndexOf(path_1.default.sep))}};Object.assign(this.dynamicImportLibInfo,p)}}))}getEntryMainFilePath(e,t){var i,s;const o=path_1.default.resolve(e,(0,hvigor_arkts_compose_1.findNodeEntryFiles)(t)[0]);if(fse.existsSync(o))return o;{const o=path_1.default.resolve(e,null!==(i=t.main)&&void 0!==i?i:null!==(s=t.types)&&void 0!==s?s:build_directory_const_js_1.BuildArtifactConst.INDEX_JS);return fse.existsSync(o)?o:""}}getHostModuleName(e){var t;const i=e.getDependencyRootPath(),s=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,`${e.isLocal()?common_const_js_1.CommonConst.MODULE_JSON5:common_const_js_1.CommonConst.MODULE_JSON}`),o=(0,json_util_js_1.getJson5Obj)(s);return o?null===(t=o.module)||void 0===t?void 0:t.name:""}getHarDependencyModuleName(e,t){var i;if(!this.isHarDependency(t))return"";const s=e.getDependencyRootPath(),o=path_1.default.resolve(s,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,common_const_js_1.CommonConst.MODULE_JSON5),n=(0,json_util_js_1.getJson5Obj)(o);return e.isLocal()?null!==(i=null==n?void 0:n.module.name)&&void 0!==i?i:"":dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s)}existInDynamicImportLibsInfo(e){return Object.prototype.hasOwnProperty.call(this.dynamicImportLibInfo,e)}isHarDependency(e){const t=[];return this.service.getHarDependencies().forEach((e=>{t.push(e.getDependencyName())})),t.includes(e)}isHspDependency(e){const t=[];return this.service.getHspDependencies().forEach((e=>{t.push(e.getDependencyName())})),t.includes(e)}processRouterMap(e){var t;this.compileEntry.push(...e);const i=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.INTERMEDIATES_ROUTER_MAP_FOR_LOADER_FILE_NAME);if(!fse.existsSync(i))return;const s=(0,json_util_js_1.getJson5Obj)(i);(null===(t=s.routerMap)||void 0===t?void 0:t.length)&&Object.assign(this.intermediatesRouterMapObjs,s.routerMap)}}exports.GenerateLoaderJson=GenerateLoaderJson;