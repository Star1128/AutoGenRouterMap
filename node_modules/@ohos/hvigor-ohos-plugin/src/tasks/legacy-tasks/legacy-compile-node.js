"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyCompileNode=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../../const/build-directory-const.js"),device_type_const_js_1=require("../../const/device-type-const.js"),ability_type_enum_js_1=require("../../enum/ability-type-enum.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_names_js_1=require("../common/task-names.js"),compile_node_js_1=require("../compile-node.js"),module_task_service_js_1=require("../service/module-task-service.js"),legacy_hook_compile_resource_js_1=require("./hook/legacy-hook-compile-resource.js"),legacy_generate_js_manifest_js_1=require("./legacy-generate-js-manifest.js"),legacy_generate_loader_json_js_1=require("./legacy-generate-loader-json.js");class LegacyCompileNode extends compile_node_js_1.CompileNode{constructor(e,t,s=task_names_js_1.TaskNames.LegacyFATask.COMPILE_NODE){super(e,t,s),this.log=ohos_logger_js_1.OhosLogger.getLogger(LegacyCompileNode.name),this.manifestDir=this.pathInfo.getIntermediatesLegacyManifestJson();const a=this.service.getRelatedEntryModules(),i=this.service.getModuleModel().getModuleType(),r=module_task_service_js_1.ModuleTaskService.checkEntryModules(i,a)?a[0]:"";this.resourceTablePath=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),r,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.rawFileResource=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),r,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES,build_directory_const_js_1.BuildDirConst.RAW_FILE)}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.aceModuleBuild,{isDirectory:!0})}declareInputFiles(){const e=(new hvigor_1.FileSet).addEntry(this.manifestDir,{isDirectory:!0}).addEntry(this.aceBuildJsonDir,{isDirectory:!0}).addEntries(this.getAllExistDependentMainPath()).addEntries(this.getAllExistHarSrcPath(),{isDirectory:!0});return this.targetService.getResourceDirs().length>0&&e.addEntry(this.resourceTablePath),fs_extra_1.default.existsSync(this.rawFileResource)&&e.addEntry(this.rawFileResource,{isDirectory:!0}),this.sourcePath&&fs_extra_1.default.existsSync(this.sourcePath)&&e.addEntry(this.sourcePath,{isDirectory:!0}),this.aceSuperVisualPath&&fs_extra_1.default.existsSync(this.aceSuperVisualPath)&&e.addEntry(this.aceSuperVisualPath,{isDirectory:!0}),e}initTaskDepends(){this.declareDepends(legacy_generate_js_manifest_js_1.LegacyGenerateJsManifest.name),this.declareDepends(legacy_hook_compile_resource_js_1.LegacyHookCompileResource.name),this.declareDepends(legacy_generate_loader_json_js_1.LegacyGenerateLoaderJson.name)}taskShouldDo(){return this.targetData.getTargetDeviceTypeClasses().includes(device_type_const_js_1.DeviceTypeConst.RICH)&&super.taskShouldDo()}async doTaskAction(){const e=this.durationEvent.createSubEvent("generate compile-ArkTs-or-JS-component command","");e.start();const t=this.moduleModel.getLegacyAbilities(this.targetData.getTargetName());this.checkLocalDependency(t,this.log),this.validateAbility(this.log);for(const s of t){if(s.getSrcLanguage()!==this.codeType)continue;const t={...this.commonOption,abilityType:s.getType(),aceManifestPath:path_1.default.resolve(this.manifestDir,s.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON),appResource:this.resourceTablePath,rawFileResource:this.rawFileResource,aceModuleRoot:path_1.default.resolve(this.sourcePath,s.getRelateSrcPath()),aceModuleBuild:path_1.default.resolve(this.aceModuleBuild,s.getRelateSrcPath()),cachePath:path_1.default.resolve(this.getTaskTempDir(this.targetData),s.getRelateSrcPath()),aceSuperVisualPath:path_1.default.resolve(this.aceSuperVisualPath,s.getRelateSrcPath()),aceBuildJson:path_1.default.resolve(this.aceBuildJsonDir,s.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)};await this.doRealLoaderCompile(t,((e,t)=>{this.moveReleaseMap(e,this.log,t)}),[this.targetData,`js/${s.getRelateSrcPath()}`],e,[0,1])}await this.compileTestRunner()}async compileTestRunner(){const e=this.needCompileTestRunner();if(!e[0])return;const t=this.durationEvent.createSubEvent("generate compile-ArkTs-or-JS-component command for test runner","");t.start();const s=e[1],a={...this.commonOption,abilityType:ability_type_enum_js_1.AbilityTypeEnum.TEST_RUNNER,appResource:this.resourceTablePath,rawFileResource:this.rawFileResource,aceModuleRoot:path_1.default.resolve(this.sourcePath,s),aceModuleBuild:path_1.default.resolve(this.aceModuleBuild,s),cachePath:path_1.default.resolve(this.getTaskTempDir(this.targetData),s)};await this.doRealLoaderCompile(a,wdk_1.noop,[],t,[0,1])}needCompileTestRunner(){var e,t,s;const a=this.targetData.getTargetName(),i=null===(s=null===(t=null===(e=this.moduleModel.getSourceSetByTargetName(a).getLegacyModuleTargetRes().getConfigJsonOpt())||void 0===e?void 0:e.module)||void 0===t?void 0:t.testRunner)||void 0===s?void 0:s.srcPath;return["ohosTest"===a&&void 0!==i&&this.codeType===code_type_enum_js_1.CodeType.JS,i]}}exports.LegacyCompileNode=LegacyCompileNode;