"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyCompileLiteNode=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),node_command_builder_js_1=require("../../builder/node-command-builder.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),file_util_js_1=require("../../utils/file-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),process_utils_js_1=require("../../utils/process-utils.js"),task_names_js_1=require("../common/task-names.js"),compile_node_js_1=require("../compile-node.js"),legacy_hook_compile_resource_js_1=require("./hook/legacy-hook-compile-resource.js"),legacy_generate_js_manifest_js_1=require("./legacy-generate-js-manifest.js"),legacy_generate_loader_json_js_1=require("./legacy-generate-loader-json.js");class LegacyCompileLiteNode extends compile_node_js_1.CompileNode{constructor(e){super(e,code_type_enum_js_1.CodeType.JS,task_names_js_1.TaskNames.LegacyFATask.COMPILE_LITE_NODE),this._logger=ohos_logger_js_1.OhosLogger.getLogger(LegacyCompileLiteNode.name)}declareOutputFiles(){const e=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutLitePath(),this.codeType);return(new hvigor_1.FileSet).addEntry(e,{isDirectory:!0})}taskShouldDo(){return this.service.hasLiteDevice()}initTaskDepends(){this.declareDepends(legacy_generate_js_manifest_js_1.LegacyGenerateJsManifest.name),this.declareDepends(legacy_hook_compile_resource_js_1.LegacyHookCompileResource.name),this.declareDepends(legacy_generate_loader_json_js_1.LegacyGenerateLoaderJson.name)}async doTaskAction(){const e=this.service.getModuleModel(),t=e.getSourceSetByTargetName(this.targetName).getCodeMap().get(this.codeType);if(void 0===t)return void this._logger.errorMessageExit("Lite wearable only support JS.");const o=this.durationEvent.createSubEvent("generate compile-JS-component command","");o.start();const s=t.getSrcPath(),a=this.pathInfo,i=path_1.default.resolve(a.getIntermediatesLegacyManifestJson()),r=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutLitePath(),code_type_enum_js_1.CodeType.JS),_=e.getLegacyAbilities(this.targetName);this.checkLocalDependency(_,this._logger),file_util_js_1.FileUtil.checkDirWithoutDelete(a.getIntermediatesLiteBinSource()),fs_extra_1.default.copySync(e.getSourceSetByTargetName().getLegacyModuleTargetRes().getResourcePath(),a.getIntermediatesLiteBinSource(),{filter:e=>fs_extra_1.default.statSync(e).isDirectory()||e.toLowerCase().endsWith(".png")||e.toLowerCase().endsWith(".jpg"),recursive:!0});for(let e=0;e<_.length;e++){const t=_[e],n={...this.commonOption,abilityType:t.getType(),aceManifestPath:path_1.default.resolve(i,t.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON),aceModuleRoot:path_1.default.resolve(s,t.getRelateSrcPath()),aceModuleBuild:path_1.default.resolve(r,t.getRelateSrcPath()),hapMode:(!this.targetService.isDebug()).toString(),img2bin:"true",iconPath:a.getIntermediatesLiteBinSource(),cachePath:this.getTaskTempDir(this.targetData),aceBuildJson:path_1.default.resolve(a.getIntermediatesLoaderPath(),t.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)};await this.doRealLoaderCompile(n,((e,t)=>{this.moveReleaseMap(e,this._logger,t)}),[this.targetData,`js/${t.getRelateSrcPath()}`],o,[0,1])}}moveReleaseMap(e,t,o=this.codeType){const s=path_1.default.resolve(e.getPathInfo().getInterMediatesLoaderOutLitePath(),o,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);if(!fs_extra_1.default.existsSync(s))return;const a=path_1.default.resolve(this.getTaskTempDir(e),o,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);fs_extra_1.default.existsSync(a)&&fs_extra_1.default.removeSync(a),fs_extra_1.default.moveSync(s,a),t.debug(`move ${s} to ${a}`)}async doRealLoaderCompile(e,t,o,s,a){const i=new node_command_builder_js_1.NodeCommandBuilder(!0).addWebpackPath("./node_modules/webpack/bin/webpack.js").addWebpackConfig(common_const_js_1.CommonConst.ACE_LITE_WEBPACK_FILE).addBuildMode(this.targetService.isDebug());this._logger._printDebugCommand("NodeEnv",e),this._logger._printDebugCommand("lite-loader",i.build());const r=this.getInputData(e,i.build());s.stop(),s.setLog(s.getName(),hvigor_1.MetricLogType.INFO);const _="submit compile-JS-component task to work pool",n=this.durationEvent.createSubEvent(_,"");n.start(),await new process_utils_js_1.ProcessUtils(r.moduleName,r.taskName).submitExecutionWithoutReturn(this,this.getWorkerPool(),r,t,o,s,a),n.stop(),n.setLog(_,hvigor_1.MetricLogType.INFO)}}exports.LegacyCompileLiteNode=LegacyCompileLiteNode;