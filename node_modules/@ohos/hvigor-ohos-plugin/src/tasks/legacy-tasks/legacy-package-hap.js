"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,i){void 0===i&&(i=a);var s=Object.getOwnPropertyDescriptor(t,a);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,i,s)}:function(e,t,a,i){void 0===i&&(i=a),e[i]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyPackageHap=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../../builder/inner-java-command-builder/packing-tool-options.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),device_type_const_js_1=require("../../const/device-type-const.js"),code_type_enum_1=require("../../enum/code-type-enum"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),process_utils_js_1=require("../../utils/process-utils.js"),task_names_js_1=require("../common/task-names.js"),legacy_generate_metadata_js_1=require("./legacy-generate-metadata.js"),legacy_make_pack_info_js_1=require("./legacy-make-pack-info.js"),legacy_sign_lite_bin_js_1=require("./legacy-sign-lite-bin.js"),legacy_syscap_transform_js_1=require("./legacy-syscap-transform.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const sign_type_enum_1=require("../../enum/sign-type-enum"),cache_native_libs_js_1=require("../cache-native-libs.js"),module_task_service_js_1=require("../service/module-task-service.js"),sign_util_1=require("../sign/sign-util"),ohos_hap_task_1=require("../task/ohos-hap-task");class LegacyPackageHap extends ohos_hap_task_1.OhosHapTask{constructor(e){super(e,LegacyFATask.PACKAGE_HAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyPackageHap.name),this.allPackHapPathsObj=[],this.signType=sign_type_enum_1.SignTypeEnum.BIN,this.signUtil=new sign_util_1.SignUtil(this.service,this.signType,this.pathInfo,this.targetData.getProduct(),this.sdkInfo);const t=this.targetService.getTargetData(),a=t.getPathInfo();this.needPackBin=this.targetService.needPackBin(t),this.unSignBinPath=path_1.default.resolve(a.getModuleBinOutput(),t.getModuleTargetOutputFileName("",!1,build_directory_const_js_1.BuildArtifactExtension.DOT_BIN)),this.signBinPath=path_1.default.resolve(a.getModuleBinOutput(),t.getModuleTargetOutputFileName("",!0,build_directory_const_js_1.BuildArtifactExtension.DOT_BIN)),this.binOutPath=path_1.default.resolve(a.getModuleBuildOutputPath(),t.getModuleTargetOutputFileName("",!1,void 0,this.targetData.isSingleDeviceTypeTarget()?void 0:device_type_const_js_1.DeviceTypeConst.LITE)),this.libPath=path_1.default.resolve(a.getIntermediatesProcessLibs()),this.rpcidSc=path_1.default.resolve(a.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC),this.apkPath=path_1.default.resolve(a.getIntermediatesApkDir(),t.getApkName()),this.arkCodeModel=this.moduleModel.getSourceSetByTargetName(this.targetName).getCodeMap().get(code_type_enum_1.CodeType.ETS),this.jsCodeModel=this.moduleModel.getSourceSetByTargetName(this.targetName).getCodeMap().get(code_type_enum_1.CodeType.JS)}declareExecutionTool(){return this.sdkInfo.getPackageTool()}declareExecutionCommand(){if(this.needPackBin)return this.getHapBinCommand().toString();{const e=[];for(let t=0;t<this.allPackHapPathsObj.length;t++)e.push(this.getHapCommand(this.allPackHapPathsObj[t]).toString());return e.join()}}declareInputs(){return(new Map).set("needPackBin",this.needPackBin)}declareInputFiles(){if(this.needPackBin){const e=new hvigor_1.FileSet;return this.targetData.hasLiteDeviceInTarget()&&e.addEntry(this.signUtil._signingConfig?this.signBinPath:this.unSignBinPath,{isDirectory:!1}),e}const e=new hvigor_1.FileSet;return e.addEntry(this.libPath,{isDirectory:!1}),this.allPackHapPathsObj.forEach((t=>{(this.arkCodeModel||this.jsCodeModel)&&e.addEntry(t.assetsPath,{isDirectory:!1}),e.addEntry(t.jsonPath,{isDirectory:!1}),e.addEntry(t.resourcePath,{isDirectory:!1}),e.addEntry(t.indexPath,{isDirectory:!1}),e.addEntry(t.packInfoPath,{isDirectory:!1})})),fse.existsSync(this.rpcidSc)&&e.addEntry(this.rpcidSc,{isDirectory:!1}),e}declareOutputFiles(){if(this.needPackBin)return(new hvigor_1.FileSet).addEntry(this.binOutPath,{isDirectory:!1});const e=new hvigor_1.FileSet;return this.allPackHapPathsObj.forEach((t=>{e.addEntry(t.outPath,{isDirectory:!1})})),e}initTaskDependsForOtherModule(){const e=this.service.getRelatedEntryModules(),t=this.service.getModuleModel().getModuleType();this.targetData.getTargetDeviceTypeClasses().forEach((a=>{if(module_task_service_js_1.ModuleTaskService.checkEntryModules(t,e)){for(const t of e)if(this.validateRelatedModule(t,this.targetData),this.module.findModuleByName(t)){const e=this.targetData.findRelatedTargetData(t);this.pushEntryInfo(this.pathInfo,t,this.targetData,e,a)}}else{const e="",t=this.targetData.findRelatedTargetData(e);this.pushEntryInfo(this.pathInfo,e,this.targetData,t,a)}}))}pushEntryInfo(e,t,a,i,s){let o,n,r,d;if(s){if(device_type_const_js_1.DeviceTypeConst.LITE===s&&this.needPackBin)return;n=path_1.default.resolve(e.getIntermediatesRes(),t,this.targetData.isSingleDeviceTypeTarget()||this.needPackBin||s!==device_type_const_js_1.DeviceTypeConst.LITE?"":device_type_const_js_1.DeviceTypeConst.LITE,common_const_js_1.CommonConst.CONFIG_JSON),r=s===device_type_const_js_1.DeviceTypeConst.LITE?e.getInterMediatesLoaderOutLitePath():e.getIntermediatesFaAssetsPath(this.targetData.getProduct()),o=this.targetData.isSingleDeviceTypeTarget()?path_1.default.resolve(e.getModuleBuildOutputPath(),a.getModuleTargetOutputFileName(t,!1)):path_1.default.resolve(e.getModuleBuildOutputPath(),a.getModuleTargetOutputFileName(t,!1,void 0,s))}else n=path_1.default.resolve(e.getIntermediatesRes(),t,common_const_js_1.CommonConst.CONFIG_JSON),o=path_1.default.resolve(e.getModuleBuildOutputPath(),a.getModuleTargetOutputFileName(t,!1)),r=e.getIntermediatesFaAssetsPath(this.targetData.getProduct());d=device_type_const_js_1.DeviceTypeConst.LITE===s?path_1.default.resolve(e.getIntermediatesLiteSource(),"assets",this.module.getName(),t,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES):path_1.default.resolve(e.getIntermediatesRes(),t,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES);const c={jsonPath:n,resourcePath:d,indexPath:path_1.default.resolve(e.getIntermediatesRes(),t,build_directory_const_js_1.BuildArtifactConst.RESOURCE_INDEX),packInfoPath:path_1.default.resolve(e.getModuleBuildOutputPath(),t,build_directory_const_js_1.BuildArtifactConst.PACK_INFO),outPath:o,shellApkPath:undefined,assetsPath:r,dexPath:undefined};this.allPackHapPathsObj.push(c)}initTaskDepends(){this.declareDepends(legacy_make_pack_info_js_1.LegacyMakePackInfo.name),this.declareDepends(cache_native_libs_js_1.CacheNativeLibs.name),this.declareDepends(task_names_js_1.TaskNames.LegacyFATask.MERGE_NODE_ASSETS.name),this.declareDepends(legacy_generate_metadata_js_1.LegacyGenerateMetadata.name),this.declareDepends(legacy_syscap_transform_js_1.LegacySyscapTransform.name),this.service.hasLiteDevice()&&this.declareDepends(legacy_sign_lite_bin_js_1.LegacySignLiteBin.name)}async doTaskAction(){for(const e of this.targetData.getTargetDeviceTypeClasses())device_type_const_js_1.DeviceTypeConst.LITE===e&&this.needPackBin?await this.buildHapBinBuilder():await this.buildHapBuilder()}async buildHapBuilder(){for(let e=0;e<this.allPackHapPathsObj.length;e++)await this.buildHapPackageOptions(this.allPackHapPathsObj[e])}async buildHapPackageOptions(e){await this.executeCommandList(this.getHapCommand(e))}async buildHapBinBuilder(){await this.executeCommandList(this.getHapBinCommand())}getHapCommand(e){const t="generate HAP packaging command",a=this.durationEvent.createSubEvent(t,"");a.start();const i=new packing_tool_options_js_1.PackingToolOptions;return i.addCalledJarFile(this.sdkInfo.getPackageTool()),this.jsCodeModel||this.arkCodeModel?i.addMode("hap").force(!0).addLibPath(this.libPath).addJsonPath(e.jsonPath).addResourcesPath(e.resourcePath).addAssetsPath(e.assetsPath).addIndexPath(e.indexPath).addPackInfoPath(e.packInfoPath).addOutPath(e.outPath):i.addMode("hap").force(!0).addLibPath(this.libPath).addJsonPath(e.jsonPath).addResourcesPath(e.resourcePath).addIndexPath(e.indexPath).addPackInfoPath(e.packInfoPath).addOutPath(e.outPath),fse.existsSync(this.rpcidSc)&&i.addSysCapPath(this.rpcidSc),a.stop(),a.setLog(t,hvigor_1.MetricLogType.INFO),i.build()}getHapBinCommand(){const e="generate HAP BIN packaging command",t=this.durationEvent.createSubEvent(e,"");t.start();const a=new packing_tool_options_js_1.PackingToolOptions;return a.addCalledJarFile(this.sdkInfo.getPackageTool()),this.signUtil._signingConfig?a.addMode("hap").addBinPath(this.signBinPath).addOutPath(this.binOutPath).force(!0):a.addMode("hap").addBinPath(this.unSignBinPath).addOutPath(this.binOutPath).force(!0),t.stop(),t.setLog(e,hvigor_1.MetricLogType.INFO),a.build()}async executeCommandList(e){this._log._printDebugCommand("PackageHap",e);const t={moduleName:this.moduleName,taskName:this.name,commandLine:e},a="submit HAP packaging task to work pool",i=this.durationEvent.createSubEvent(a,"");i.start(),await new process_utils_js_1.ProcessUtils(this.moduleName,this.name).submitExecutionWithoutReturn(this,this.getWorkerPool(),t,wdk_1.noop,[],i),i.stop(),i.setLog(a,hvigor_1.MetricLogType.INFO)}validateRelatedModule(e,t){var a;const i=t.getTargetName(),s=t.getModuleModel().getName(),o=t.getTargetDeviceType(),n=t.findRelatedTargetData(e),r=null==n?void 0:n.getModuleModel().getName(),d=null==n?void 0:n.getTargetName(),c=null==n?void 0:n.getTargetDeviceType(),l=(0,array_util_js_1.getIntersection)(o,c),u=(null==n?void 0:n.getModuleSourceSetModel()).getLegacyModuleTargetRes().getJsonPath(),h=void 0===(null===(a=null==n?void 0:n.getTargetOpt().config)||void 0===a?void 0:a.deviceType)?u:null==n?void 0:n.getModuleModel().getProfilePath(),_=`The deviceType values ('${o}') of ${i} in the ${s} don't overlap that ('${c}') of ${d} in the associated ${r} module.`,g=`Change the deviceType values of ${i} in the above modules so that they overlap.`;0===l.length&&this._log._buildError(_)._detail(g)._file(h)._printErrorAndExit()}}exports.LegacyPackageHap=LegacyPackageHap;