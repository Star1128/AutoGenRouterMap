"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyProcessProfile=void 0;const fs=__importStar(require("fs-extra")),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_names_js_1=require("../common/task-names.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),legacy_merge_profile_js_1=require("./legacy-merge-profile.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const hvigor_1=require("@ohos/hvigor"),common_const_js_1=require("../../const/common-const.js"),device_type_const_js_1=require("../../const/device-type-const.js"),json_util_js_1=require("../../utils/json-util.js"),INPUT_KEY={arkEnable:"arkEnable",compileMode:"compileMode",deviceTypes:"deviceTypes",targetName:"targetName",isDebug:"isDebug"};class LegacyProcessProfile extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,LegacyFATask.PROCESS_PROFILE),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyProcessProfile.name),this._arkEnable=this.service.isArkModule(),this._deviceTypes=this.targetData.getTargetDeviceType(),this._intermediatesMergeLegacyProfile=this.pathInfo.getIntermediatesMergeLegacyProfile(),this._processedModuleJson=this.pathInfo.getIntermediatesProcessLegacyProfile(),this._moduleBuildProfilePath=this.moduleModel.getProfilePath()}initTaskDepends(){this.declareDepends(legacy_merge_profile_js_1.LegacyMergeProfile.name)}doTaskAction(){var e,t,i;const s=(0,json_util_js_1.getJson5Obj)(this._intermediatesMergeLegacyProfile);if(this._arkEnable){if(void 0!==s.module.distro){const e=this.projectModel.getCompatibleApiMetaByProduct(this.targetData.getProduct().name).version;this._deviceTypes.includes(device_type_const_js_1.DeviceTypeConst.LITE_WEARABLE)||this._deviceTypes.includes(device_type_const_js_1.DeviceTypeConst.SMART_VISION)||(s.module.distro.virtualMachine=`ark${this.sdkInfo.getArkVersion(e)}`)}}const o=this.moduleModel.getLegacyAbilities(this.targetData.getTargetName());this.validateTargetAbilityName(this.targetData.getTargetOpt(),o);const r=o.map((e=>this.targetData.findTargetConfigOpt(e)));this.replaceTargetAbilityPages(r,s),s.module.deviceType=this._deviceTypes;const a=null===(e=this.targetData.getTargetOpt().config)||void 0===e?void 0:e.distroFilter;a&&(s.module.distroFilter=a),this.moduleModel.isMixedDeviceModule()&&this.targetData.hasRichDeviceInTarget()&&(s.module.package=common_const_js_1.CommonConst.DEFAULT_PACKAGE_NAME,(null===(t=s.module.abilities)||void 0===t?void 0:t.length)&&((null===(i=s.module.abilities[0].skills)||void 0===i?void 0:i.length)?s.module.abilities[0].skills=[...s.module.abilities[0].skills,{entities:["entity.system.home"],actions:["action.system.home"]}]:s.module.abilities[0].skills=[{entities:["entity.system.home"],actions:["action.system.home"]}])),fs.outputJSONSync(this._processedModuleJson,s)}replaceTargetAbilityPages(e,t){var i;for(const s of e)void 0!==s&&(null===(i=t.module.js)||void 0===i||i.forEach((e=>{e.name===s.name&&this.replaceAbilityPage(e,s)})))}replaceAbilityPage(e,t){if(void 0===t.pages)return;const i=t.pages.filter((t=>!e.pages.includes(t)));0===i.length?e.pages=t.pages:this.printInvalidError("page",i.join(","))}validateTargetAbilityName(e,t){var i,s,o,r;const a=null===(s=null===(i=null==e?void 0:e.source)||void 0===i?void 0:i.abilities)||void 0===s?void 0:s.filter((e=>!t.some((t=>e.name===t.getName())))).map((e=>e.name));if(a&&a.length>0)return void this.printInvalidError("ability",a.join(","));const l=null===(r=null===(o=null==e?void 0:e.source)||void 0===o?void 0:o.abilities)||void 0===r?void 0:r.filter((e=>!t.some((t=>e.name===t.getName()&&"page"===t.getType())))).map((e=>e.name));l&&l.length>0&&this.printInvalidError("ability type, not page ability",l.join(","))}printInvalidError(e,t){this._log._buildError(`Invalid ${e} under target.`)._solution(`Check ${t} in build-profile.json5 configured in config.json.`)._file(this.moduleModel.getProfilePath())._printErrorAndExit(this.moduleModel.getName())}declareInputs(){const e=new Map;return e.set(INPUT_KEY.arkEnable,this._arkEnable),e.set(INPUT_KEY.deviceTypes,this._deviceTypes),e.set(INPUT_KEY.isDebug,this.targetService.isDebug()),e}declareInputFiles(){const e=new hvigor_1.FileSet;return e.addEntry(this._intermediatesMergeLegacyProfile),e.addEntry(this._moduleBuildProfilePath),e}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this._processedModuleJson)}}exports.LegacyProcessProfile=LegacyProcessProfile;