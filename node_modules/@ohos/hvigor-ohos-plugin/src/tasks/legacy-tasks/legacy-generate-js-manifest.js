"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyGenerateJsManifest=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),crypto_1=require("crypto"),fse=__importStar(require("fs-extra")),wdk_1=require("@baize/wdk"),path=__importStar(require("path")),build_directory_const_js_1=require("../../const/build-directory-const.js"),inject_const_js_1=require("../../const/inject-const.js"),ability_type_enum_js_1=require("../../enum/ability-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),task_names_js_1=require("../common/task-names.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const legacy_pre_build_js_1=require("./legacy-pre-build.js"),common_const_js_1=require("../../const/common-const.js"),inject_util_js_1=require("../../utils/inject-util.js"),SRC_PATH=inject_const_js_1.InjectConst.PREVIEWER_REPLACE_SRC_PATH,UNIT_TEST_SRC_PATH=inject_const_js_1.InjectConst.UNIT_TEST_REPLACE_SRC_PATH,PAGE=inject_const_js_1.InjectConst.PREVIEWER_REPLACE_PAGE,UNIT_TEST_PAGE=inject_const_js_1.InjectConst.UNIT_TEST_REPLACE_PAGE,BUILD_ROOT=inject_const_js_1.InjectConst.BUILD_ROOT;class LegacyGenerateJsManifest extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,LegacyFATask.GENERATE_JS_MANIFEST),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyGenerateJsManifest.name),this.previewSrcPath=hvigor_2.hvigorCore.getExtraConfig().get(SRC_PATH),this.unitTestSrcPath=hvigor_2.hvigorCore.getExtraConfig().get(UNIT_TEST_SRC_PATH),this.previewPage=hvigor_2.hvigorCore.getExtraConfig().get(PAGE),this.unitTestPage=hvigor_2.hvigorCore.getExtraConfig().get(UNIT_TEST_PAGE),this.isUnitTest=inject_util_js_1.InjectUtil.isUnitTestProcess(),this.isPreview=hvigor_2.hvigorCore.getExtraConfig().get(BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH,this._moduleModel=this.service.getModuleModel(),this._abilityModels=this._moduleModel.getLegacyAbilities(this.targetData.getTargetName()),this._configOpt=(0,wdk_1.cloneDeep)(this._moduleModel.getJsonObjByTargetName(this.targetData.getTargetName())),this._minPlatformVersion=this.targetData.getCompatibleApiVersion()}initTaskDepends(){this.declareDepends(legacy_pre_build_js_1.LegacyPreBuild.name)}declareInputs(){var e;const t=new Map,i=null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.abilities,s=JSON.stringify(i||[]),o=(0,crypto_1.createHash)("MD5").update(JSON.stringify(this._abilityModels)).digest("hex"),r=(0,crypto_1.createHash)("MD5").update(JSON.stringify(this._configOpt)).digest("hex"),n=(0,crypto_1.createHash)("MD5").update(s).digest("hex");return t.set("ABI_OBJ_HASH",o),t.set("CONFIG_OBJ",r),t.set("ABILITIES_HASH",n),t.set("HAS_LITE_DEVICE",this.service.hasLiteDevice()),t.set("MIN_PLATFORM_VERSION",this._minPlatformVersion),this.isPreview&&(t.set("PREVIEWER_REPLACE_PAGE",JSON.stringify(hvigor_2.hvigorCore.getExtraConfig().get(PAGE))),t.set("PREVIEWER_REPLACE_SRCPATH",JSON.stringify(hvigor_2.hvigorCore.getExtraConfig().get(SRC_PATH)))),t}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.targetData.getPathInfo().getIntermediatesLegacyManifestJson())}doTaskAction(){for(const e of this._abilityModels)e.getType()!==ability_type_enum_js_1.AbilityTypeEnum.PAGE&&e.getType()!==ability_type_enum_js_1.AbilityTypeEnum.FORM||this.generateJsonInfo(e,this._configOpt,this.targetData)}getUnitTestManifestPage(e,t){var i;if(!this.unitTestPage){let s=this.getAbilityPages(e,t);return void 0===s&&(s=null===(i=t.getConfigJsonJsObj())||void 0===i?void 0:i.pages),s||[]}return this._log.debug(`replace ${this.unitTestPage} for ${this.unitTestSrcPath} manifest.`),[this.unitTestPage]}getManifestPages(e,t){var i;if(!this.isPreview||!this.previewPage||this.previewSrcPath&&this.previewSrcPath!==t.getRelateSrcPath()){let s=this.getAbilityPages(e,t);return void 0===s&&(s=null===(i=t.getConfigJsonJsObj())||void 0===i?void 0:i.pages),s||[]}return this._log.debug(`replace ${this.previewPage} for ${this.previewSrcPath} manifest.`),[this.previewPage]}getAbilityPages(e,t){const i=e.findTargetConfigOpt(t);if(i)return i.pages}generateJsonInfo(e,t,i){var s,o;let r={appID:t.app.bundleName,versionName:t.app.version.name,versionCode:t.app.version.code,minPlatformVersion:this._minPlatformVersion,appName:LegacyGenerateJsManifest.findAppName(t),deviceType:t.module.deviceType,window:this.getWindowObj(e),pages:this.isUnitTest?this.getUnitTestManifestPage(i,e):this.getManifestPages(i,e)};const n=null===(s=e.getConfigJsonJsObj())||void 0===s?void 0:s.mode,a=e.getType()===ability_type_enum_js_1.AbilityTypeEnum.FORM?ability_type_enum_js_1.AbilityTypeEnum.FORM:null===(o=e.getConfigJsonJsObj())||void 0===o?void 0:o.type;n?r={...r,mode:n}:a&&(r={...r,type:a}),this._log._printDebugCommand("JsManifest",r);const _=path.resolve(i.getPathInfo().getIntermediatesLegacyManifestJson(),e.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON);fse.outputJSONSync(_,r)}static findAppName(e){var t,i,s;const o=null!==(t=e.module.abilities)&&void 0!==t?t:[];for(const e of o)if(e.skills&&(null===(i=e.skills[0])||void 0===i?void 0:i.actions)&&"action.system.home"===(null===(s=e.skills[0])||void 0===s?void 0:s.actions[0]))return e.name;return o[0].label?o[0].label:o[0].name}getWindowObj(e){var t,i;if(this.targetData.isSingleDeviceTypeTarget())return this.service.hasLiteDevice()||null===(t=e.getConfigJsonJsObj())||void 0===t?void 0:t.window;{const t=null===(i=e.getConfigJsonJsObj())||void 0===i?void 0:i.window;return null!=t?t:{autoDesignWidth:!1,designWidth:common_const_js_1.CommonConst.DEFAULT_DESIGN_WIDTH}}}}exports.LegacyGenerateJsManifest=LegacyGenerateJsManifest;