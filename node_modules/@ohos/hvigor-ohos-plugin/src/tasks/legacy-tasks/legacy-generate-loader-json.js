"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,i)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyGenerateLoaderJson=void 0;const hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../../const/build-directory-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),ability_type_enum_js_1=require("../../enum/ability-type-enum.js"),compile_mode_enum_js_1=require("../../enum/compile-mode-enum.js"),inject_util_js_1=require("../../utils/inject-util.js"),abstract_generate_loader_json_js_1=require("../abstract-generate-loader-json.js"),task_names_js_1=require("../common/task-names.js"),legacy_generate_js_manifest_js_1=require("./legacy-generate-js-manifest.js"),legacy_pre_build_js_1=require("./legacy-pre-build.js");class LegacyGenerateLoaderJson extends abstract_generate_loader_json_js_1.AbstractGenerateLoaderJson{constructor(e){super(e,task_names_js_1.TaskNames.LegacyFATask.GENERATE_LOADER_JSON),this.outputAceLoaderJsonArray=[],this.multiResourceBuildArray=[],this.isWorkerArray=[];const t=this.service.getModuleModel().getLegacyAbilities(this.targetName);for(let r=0;r<t.length;r++){const s=t[r],i=s.getType();if(i===ability_type_enum_js_1.AbilityTypeEnum.PAGE||i===ability_type_enum_js_1.AbilityTypeEnum.FORM||i===ability_type_enum_js_1.AbilityTypeEnum.WORKER){const t=path_1.default.resolve(e.getTargetData().getPathInfo().getIntermediatesLoaderPath(),s.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON);this.outputAceLoaderJsonArray.push(t),this.isWorkerArray.push(i===ability_type_enum_js_1.AbilityTypeEnum.WORKER)}}}declareInputs(){return super.declareInputs().set("multiResourceBuildArray",JSON.stringify(this.multiResourceBuildArray))}declareOutputFiles(){return(new hvigor_1.FileSet).addEntries([...this.outputAceLoaderJsonArray])}initTaskDepends(){this.declareDepends(legacy_pre_build_js_1.LegacyPreBuild.name),this.declareDepends(legacy_generate_js_manifest_js_1.LegacyGenerateJsManifest.name)}shouldLoaderWorker(e){return!!inject_util_js_1.InjectUtil.isPreviewProcess()||(this.compileApiVersion>sdk_const_js_1.ApiVersion.API_VERSION_8&&this.workerConfig&&this.workerConfig.filter((e=>".ts"===path_1.default.extname(e))).length>0?this.isWorkerArray[e]:0===e)}doTaskAction(){const e=this.service.getModuleModel().getLegacyAbilities(this.targetName);for(let t=0;t<e.length;t++){const r=e[t];this.multiResourceBuildArray.push(this.getMultiResourceBuild(this.targetService.getTargetData(),r))}for(let e=0;e<this.outputAceLoaderJsonArray.length;e++){const t={workers:this.shouldLoaderWorker(e)?this.workerConfig:void 0,multiResourceBuild:this.multiResourceBuildArray[e],modulePathMap:this.modulePathMap,compileMode:compile_mode_enum_js_1.CompileModeEnum.JS_BUNDLE,projectRootPath:this.projectRootPath,packageManagerType:this.isOhpmProject?"ohpm":"npm"};fse.outputJSONSync(this.outputAceLoaderJsonArray[e],t)}}getMultiResourceBuild(e,t){const r=e.findTargetConfigOpt(t);if(r)return r.pages?{pages:r.pages,res:r.res}:{pages:this.getManifestPage(e,t),res:r.res}}getManifestPage(e,t){const r=path_1.default.resolve(this.pathInfo.getIntermediatesLegacyManifestJson(),t.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON);if(fse.existsSync(r))return[];return fse.readJSONSync(r).pages}}exports.LegacyGenerateLoaderJson=LegacyGenerateLoaderJson;