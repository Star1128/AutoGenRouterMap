"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyArkCompile=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),ability_type_enum_js_1=require("../../enum/ability-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),math_util_js_1=require("../../utils/math-util.js"),task_names_js_1=require("../common/task-names.js"),run_ark_js_1=require("../worker/run-ark.js"),legacy_compile_node_js_1=require("./legacy-compile-node.js");class LegacyArkCompile extends legacy_compile_node_js_1.LegacyCompileNode{constructor(e,t,o=task_names_js_1.TaskNames.LegacyFATask.COMPILE_ARK){super(e,t,o)}async doTaskAction(){const e=ohos_logger_js_1.OhosLogger.getLogger(LegacyArkCompile.name),t=this.moduleModel.getLegacyAbilities(this.targetName),o=this.sdkInfo.isOhos?common_const_js_1.CommonConst.OPEN_HARMONY:common_const_js_1.CommonConst.HARMONY_OS,i=`${this.sdkInfo.isOhos}:${this.sdkInfo.getSdkVersion()}:${this.sdkInfo.getEtsComponentVersion()}:${this.sdkInfo.getEtsComponentReleaseType()}`;this.validateAbility(this.log);for(let s=0;s<t.length;s++){const a=t[s];if(a.getSrcLanguage()!==this.codeType)continue;const r=this.initDefaultLegacyArkConfig(o,i,a);this.log.debug("build config:"),this.log.debug(r);let l=null;l=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),e,r,(t=>{this.moveReleaseMap(this.targetData,e,`js/${a.getRelateSrcPath()}`),this.handleCompileEvents(t,l?this.getSubDurationEvent(l):this.durationEvent,!1)}),0===this.getWorkerPool().getMaxPoolNum()?void 0:[(0,math_util_js_1.mod)((0,hvigor_1.getModuleIndex)(r.modulePath),this.getWorkerPool().getMaxPoolNum())])}await this.arkCompileTestRunner(o,i,e)}async arkCompileTestRunner(e,t,o){const i=this.needCompileTestRunner();if(!i[0])return;const s=i[1],a=this.initTestRunnerLegacyArkConfig(e,t,s);let r=null;r=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),o,a,(e=>this.handleCompileEvents(e,r?this.getSubDurationEvent(r):this.durationEvent,!1)),0===this.getWorkerPool().getMaxPoolNum()?void 0:[(0,math_util_js_1.mod)((0,hvigor_1.getModuleIndex)(a.modulePath),this.getWorkerPool().getMaxPoolNum())])}initCommonLegacyArkConfig(e,t){var o;return{...super.initCommonArkConfig(),appResource:this.resourceTablePath,rawFileResource:this.rawFileResource,resourceTableHash:(0,hvigor_1.hashFile)(this.resourceTablePath),runtimeOS:e,sdkInfo:t,compileMode:null===(o=this.moduleModel.getProfileOpt().buildOption)||void 0===o?void 0:o.compileMode}}initTestRunnerLegacyArkConfig(e,t,o){return{...this.initCommonLegacyArkConfig(e,t),abilityType:ability_type_enum_js_1.AbilityTypeEnum.TEST_RUNNER,aceModuleRoot:path_1.default.resolve(this.sourcePath,o),aceModuleBuild:path_1.default.resolve(this.aceModuleBuild,o),cachePath:this.getLegacyArkCachePath(o),supportChunks:!1}}initDefaultLegacyArkConfig(e,t,o){return{...this.initCommonLegacyArkConfig(e,t),abilityType:o.getType(),aceManifestPath:path_1.default.resolve(this.manifestDir,o.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON),aceModuleRoot:path_1.default.resolve(this.sourcePath,o.getRelateSrcPath()),aceModuleBuild:path_1.default.resolve(this.aceModuleBuild,o.getRelateSrcPath()),cachePath:this.getLegacyArkCachePath(o.getRelateSrcPath()),aceSuperVisualPath:path_1.default.resolve(this.aceSuperVisualPath,o.getRelateSrcPath()),aceBuildJson:path_1.default.resolve(this.aceBuildJsonDir,o.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON),supportChunks:o.getType()===ability_type_enum_js_1.AbilityTypeEnum.PAGE}}getLegacyArkCachePath(e){const t=path_1.default.resolve(this.getTaskTempDir(this.targetData),e);return fs_extra_1.default.ensureDirSync(t),t}}exports.LegacyArkCompile=LegacyArkCompile;