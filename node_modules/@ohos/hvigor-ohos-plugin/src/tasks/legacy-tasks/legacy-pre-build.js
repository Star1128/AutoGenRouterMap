"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyPreBuild=void 0;const hvigor_1=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),error_handlers_js_1=require("../../utils/validate/error-handlers.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),abstract_pre_build_js_1=require("../abstract/abstract-pre-build.js"),task_names_js_1=require("../common/task-names.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const fs_extra_1=__importDefault(require("fs-extra")),file_util_js_1=require("../../utils/file-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const meta_util_js_1=require("../../utils/meta-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-legacyPreBuild");class LegacyPreBuild extends abstract_pre_build_js_1.AbstractPreBuild{constructor(e){super(e,LegacyFATask.PRE_BUILD),this.logger=ohos_logger_js_1.OhosLogger.getLogger(LegacyPreBuild.name);const t=e.getTargetData().getModuleSourceSetModel().getLegacyModuleTargetRes();this.targetJsonPath=t.getJsonPath(),this.targetConfigOptObj=t.getConfigJsonOpt(),this.configOptObj=fs_extra_1.default.readJsonSync(this.targetJsonPath)}declareInputFiles(){var e;const t=(new hvigor_1.FileSet).addEntries([this.targetJsonPath],{isDirectory:!1});fs_1.default.existsSync(path_1.default.resolve(null===(e=this.moduleModel)||void 0===e?void 0:e.getSourceRootByTargetName(this.targetName),common_const_js_1.CommonConst.SYSCAP_JSON))&&t.addEntry(this.syscapJsonPath);const i=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath();return fs_1.default.existsSync(i)&&t.addEntry(i),fs_1.default.existsSync(this.projectProfilePath)&&t.addEntry(this.projectProfilePath),fs_1.default.existsSync(this.profilePath)&&t.addEntry(this.profilePath),t}doValidateForDiffApiType(){const e=this.targetName,t=this.service.hasLiteDevice()?this.sdkInfo.getLiteSchema():this.sdkInfo.getRichSchema(),i=this.targetJsonPath;validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.moduleName,filePath:i,schemaPath:t,errorHandlers:[error_handlers_js_1.removeLegacyPhoneSupport]}),this.validateAbilities(),this.validateForm(),e!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&this.validateModuleName(this.moduleName,this.targetConfigOptObj.module.distro.moduleName,common_const_js_1.CommonConst.CONFIG_JSON),validate_util_js_1.ValidateUtil.validateFALiteDevice(this.configOptObj.module.deviceType),validate_util_js_1.ValidateUtil.validateHybridDeviceTypes(this.configOptObj.module.deviceType)}getJsonProfileByModel(){return{jsonFilePath:this.targetJsonPath,profile:this.configOptObj,deviceTypes:this.configOptObj.module.deviceType,deviceConfig:common_const_js_1.CommonConst.DEVICE_TYPE,configurationProfile:common_const_js_1.CommonConst.CONFIG_JSON}}validateForm(){var e,t;null===(t=null===(e=this.targetConfigOptObj)||void 0===e?void 0:e.module.js)||void 0===t||t.forEach((e=>{var t;if("form"===e.type){const i=this.moduleModel.getProjectDir();null===(t=e.pages)||void 0===t||t.forEach((t=>{const o=file_util_js_1.FileUtil.convertToAbsolutePath(t,path_1.default.resolve(i,"src/main/js",e.name));this.isValidWidget(!1,"",o)||this.logger._buildError(`Forms referenced in the config, '${t}', was not found in the project or the libraries.`)._detail(`Modify ${t} in the config.json file.`)._file(this.targetJsonPath)._printErrorAndExit()}))}}))}validateJsType(e){var t,i;null===(i=null===(t=this.targetConfigOptObj)||void 0===t?void 0:t.module.js)||void 0===i||i.forEach((t=>{var i;if(t.name===e)switch(t.type){case void 0:"form"===(null===(i=t.mode)||void 0===i?void 0:i.type)&&this.logger._buildError(`Forms referenced in the config, In the configuration item named '${e}', the type field does not match between module.abilities and module.js.mode.`)._file(this.targetJsonPath)._printErrorAndExit();break;case"form":this.logger._buildError(`Forms referenced in the config, In the configuration item named '${e}', the type field does not match between module.abilities and module.js.`)._file(this.targetJsonPath)._printErrorAndExit()}}))}validateAbilities(){var e,t;null===(t=null===(e=this.targetConfigOptObj)||void 0===e?void 0:e.module.abilities)||void 0===t||t.forEach((e=>{if("page"===e.type){const t=e.name;this.validateJsType(t)}}))}validateAtomicService(){this.isAtomicServiceProject()&&_log._buildError("Atomic service development is not supported in the fa model.")._printErrorAndExit()}initTaskDepends(){(0,meta_util_js_1.hvigorOrToolChainsChanged)(this.targetService.getSdkInfo())&&this.dependsOn(CommonTask.CLEAN.name)}checkExtendSourceDirs(){}}exports.LegacyPreBuild=LegacyPreBuild;