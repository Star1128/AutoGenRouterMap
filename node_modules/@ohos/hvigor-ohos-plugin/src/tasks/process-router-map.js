"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessRouterMap=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),file_util_js_1=require("../utils/file-util.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");class ProcessRouterMap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t,o,r;super(e,task_names_js_1.TaskNames.Task.PROCESS_ROUTER_MAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessRouterMap.name);const s=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetJsonPath=s.getJsonPath(),this.resourcePath=s.getResourcePath(),this.compileEntry=[],this.routerMapFileName=this.targetService.getRouterMapJsonFileName(this.moduleModel),this.intermediatesRouterMapObjs=[],this.intermediatesTempRouterMapFilePath=this.pathInfo.getIntermediatesRouterMap(null!==(t=this.routerMapFileName)&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.INTERMEDIATES_TEMP_ROUTER_MAP_FILE_NAME),this.intermediatesToLoaderRouterMap=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.INTERMEDIATES_ROUTER_MAP_FOR_LOADER_FILE_NAME),this.stageModuleModel=this.moduleModel,this.useNormalizedOHMUrl=!!(null===(r=null===(o=this.targetService.getBuildOption())||void 0===o?void 0:o.strictMode)||void 0===r?void 0:r.useNormalizedOHMUrl)}declareInputFiles(){const e=super.declareInputFiles(),t=this.projectModel.isOhpmProject();e.addEntry(t?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()).addEntry(t?this.projectModel.getOhPackageJson5Path():this.projectModel.getPackageJsonPath()).addEntry(this.moduleModel.getJsonPathByTargetName(this.targetName));const o=this.targetService.getRouterMapJsonPath(this.moduleModel);return o&&fs_extra_1.default.existsSync(o)&&e.addEntry(o),fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.intermediatesTempRouterMapFilePath).addEntry(this.intermediatesToLoaderRouterMap)}declareInputs(){const e=super.declareInputs();return e.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,this.useNormalizedOHMUrl),e.set("obfuscated",this.targetService.isOpenSource()),this.service.getHarDependencies().forEach((t=>{if(t.isLocal()){const o=dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(t,this.projectModel);o&&e.set("localDependencyRouterMapObjList",JSON.stringify(o))}else{const o=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(t);o&&e.set("remoteDependencyRouterMapObjList",JSON.stringify(o))}})),e}doTaskAction(){const e=this.targetService.getTargetRouterMapObjList(this.moduleModel);this.checkRouterMapObjName(e),this.checkModuleRouterMapObj(e),this.checkRouterMapObjPageSourceFile(e);this.service.getModuleModel().getModuleType()===module_type_enum_js_1.ModuleType.Har?this.processHarRouterMap(e):this.processHapOrHspRouterMap(e)}processHarRouterMap(e){if(!e)return;const t=this.hasUseTsHarField()?".ts":".js";e.forEach((e=>{const o={name:e.name,pageSourceFile:path_1.default.resolve(this.module.getNodeDir(),e.pageSourceFile),buildFunction:e.buildFunction};if(this.intermediatesRouterMapObjs.push(o),!this.targetService.isOpenSource()){const o=e.pageSourceFile,r=file_util_js_1.FileUtil.getFileSuffix(o);common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(r)&&Object.assign(e,{pageSourceFile:`${o.substring(0,o.lastIndexOf("."))}${t}`})}})),this.generateTempRouterMap(e,this.intermediatesRouterMapObjs)}processHapOrHspRouterMap(e){const t=[];this.processModuleSelfRouterMap(t,e),this.processModuleDependencyRouterMap(t),this.checkRouterMapObjName(t),this.stageModuleModel.setRouterMapCompileEntry(this.compileEntry),this.generateTempRouterMap(t,this.intermediatesRouterMapObjs)}processModuleSelfRouterMap(e,t){t&&(t.forEach((e=>{const t=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),e.pageSourceFile);this.compileEntry.push(t);let o="";if(this.useNormalizedOHMUrl){const t=this.pathInfo.getIntermediatesPkgContextInfoPath(),r=(0,json_util_js_1.getJson5Obj)(t)[this.packageJsonObj.name];o=(0,ohmurl_utils_js_1.generateOhmUrlForRouterMap)(r,e.pageSourceFile)}else o=this.generateModuleOhmurl(this.moduleName,e.pageSourceFile);Object.assign(e,{ohmurl:o,bundleName:this.getBundleName(),moduleName:this.moduleName});const r={name:e.name,pageSourceFile:t,buildFunction:e.buildFunction};this.intermediatesRouterMapObjs.push(r)})),e.push(...t))}processModuleDependencyRouterMap(e){this.service.getHarDependencies().forEach((t=>{t.isLocal()?this.processLocalDependencyRouterMap(t,e):this.processRemoteDependencyRouterMap(t,e)}))}processLocalDependencyRouterMap(e,t){const o=this.getModuleModelByDependency(e);if(!o)return;const r=dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapObjList(o);r&&(r.forEach((t=>{const r=path_1.default.resolve(e.getDependencyRootPath(),t.pageSourceFile),s=o.getModuleType();this.pushCompileEntry(s,r);let a="";this.useNormalizedOHMUrl?a=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(s===module_type_enum_js_1.ModuleType.Shared&&(a=this.generateModuleOhmurl(o.getName(),t.pageSourceFile)),s===module_type_enum_js_1.ModuleType.Har&&(a=this.generateHarOhmurl(this.moduleName,o.getName(),t.pageSourceFile,!0))),Object.assign(t,{ohmurl:a,bundleName:this.getBundleName(),moduleName:this.moduleName});const i={name:t.name,pageSourceFile:r,buildFunction:t.buildFunction};this.intermediatesRouterMapObjs.push(i)})),this.checkDependencyRouterMap(e,r),t.push(...r))}processRemoteDependencyRouterMap(e,t){const o=e.getDependencyRootPath(),r=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e);r&&(r.forEach((t=>{const r=t.pageSourceFile,s=path_1.default.resolve(o,r),a=dependency_manager_js_1.DependencyManager.getModuleObjByDependency(e),i=a.module.type;this.pushCompileEntry(i,s);const n=a.module.name;let u;this.useNormalizedOHMUrl?u=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(i===module_type_enum_js_1.ModuleType.Shared&&(u=this.generateModuleOhmurl(n,t.pageSourceFile)),i===module_type_enum_js_1.ModuleType.Har&&(u=this.generateHarOhmurl(this.moduleName,n,s,!1,e.getDependencyName()))),Object.assign(t,{ohmurl:u,bundleName:this.getBundleName(),moduleName:this.moduleName});const l={name:t.name,pageSourceFile:s,buildFunction:t.buildFunction};this.intermediatesRouterMapObjs.push(l)})),this.checkDependencyRouterMap(e,r),t.push(...r))}checkModuleRouterMapObj(e){e&&e.forEach((e=>{const t=this.targetService.getRouterMapJsonPath(this.moduleModel),o=this.getModulePageSourceFile(this.moduleModel,e);""!==e.pageSourceFile&&""!==o&&o&&fs_extra_1.default.existsSync(o)||this._log._buildError(`Unable to find the page source file '${null!=o?o:""}' in module '${this.moduleName}' routerMap configuration.`)._detail(`Check the routerMap configuration of the module '${this.moduleName}'.`)._file(null!=t?t:"")._printErrorAndExit()}))}getModulePageSourceFile(e,t){const o=t.pageSourceFile;if(""!==o)return path_1.default.resolve(e.getModule().getNodeDir(),o)}checkDependencyRouterMap(e,t){t&&t.forEach((t=>{const o=this.getModuleModelByDependency(e);if(!o)return;const r=null==o?void 0:o.getName(),s=dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapJsonPath(o),a=t.pageSourceFile,i=path_1.default.resolve(e.getDependencyRootPath(),a);""!==a&&""!==i&&i&&fs_extra_1.default.existsSync(i)||this._log._buildError(`Unable to find the page source file '${""===a?"":i}' in module '${r}' routerMap configuration.`)._detail(`Check the routerMap configuration of the module '${r}'.`)._file(null!=s?s:"")._printErrorAndExit()}))}getModuleModelByDependency(e){const t=this.projectModel.getAllModules().find((t=>(this.projectModel.isOhpmProject()?t.getOhPackageJson5Path():t.getPackageJsonPath())===e.getPackageFilePath()));return null!=t?t:void 0}checkRouterMapObjName(e){var t;if(!e||e.length<=1)return;const o=e.map((e=>e.name));new Set(o).size!==e.length&&this._log._buildError("The object name of routerMap in the routerMap configuration file must be unique.")._detail(`Check the routerMap configuration of the module '${this.moduleName}' or its dependencies.`)._file(null!==(t=this.targetService.getRouterMapJsonPath(this.moduleModel))&&void 0!==t?t:"")._printErrorAndExit()}checkRouterMapObjPageSourceFile(e){null==e||e.forEach((e=>{var t;const o=e.pageSourceFile;common_const_js_1.ValidateRegExp.PAGE_SOURCE_FILE_REG_EXP.test(o)||this._log._buildError(`Invalid pageSourceFile format in the '${this.moduleName}' routerMap configuration.`)._detail("PageSourceFile field in routerMap configuration must be defined as relative path starting with 'src/main' format.")._file(null!==(t=this.targetService.getRouterMapJsonPath(this.moduleModel))&&void 0!==t?t:"")._printErrorAndExit()}))}getBundleName(){var e;return null!==(e=this.targetData.getProduct().bundleName)&&void 0!==e?e:this.projectModel.getDefaultBundleName()}generateModuleOhmurl(e,t){const o=t.substring(0,t.indexOf(".")),r=o.includes("src/main/ets/")?o.replace("src/main/",""):o;return`@bundle:${this.getBundleName()}/${e}/${r}`}generateHarOhmurl(e,t,o,r,s){let a;if(r){const r=o.substring(0,o.indexOf(".")),s=r.includes("src/main/ets/")?r.replace("src/main/",""):r;a=`@bundle:${this.getBundleName()}/${e}@${t}/${s}`}else{const e=path_1.default.parse(o).name,t=o.substring(0,o.indexOf(e)+e.length),r=t.substring(t.indexOf(common_const_js_1.CommonConst.OH_MODULES)).replace(common_const_js_1.CommonConst.OH_MODULES,common_const_js_1.CommonConst.PKG_MODULES).split(path_1.default.sep);let i;for(let e=0;e<r.length;e++)if(r[e]===s){i=e-1;break}if(!i)return"";r[i]=common_const_js_1.CommonConst.PKG_MODULES,a=`@package:${r.join("/")}`}return a}pushCompileEntry(e,t){e!==module_type_enum_js_1.ModuleType.Shared&&this.compileEntry.push(t)}initTaskDepends(){}getOhmUrlWithNormalize(e,t){const o=e.getPackageName(),r=this.pathInfo.getIntermediatesPkgContextInfoPath(),s=(0,json_util_js_1.getJson5Obj)(r);s||this._log._buildError(`The pkgContextInfoPath ${r} is not available.`)._printErrorAndExit();const a=s[o];return a||this._log._buildError(`The pkgName ${o} does not exist in ${r}.`)._printErrorAndExit(),(0,ohmurl_utils_js_1.generateOhmUrlForRouterMap)(a,t)}generateTempRouterMap(e,t){fs_extra_1.default.ensureFileSync(this.intermediatesTempRouterMapFilePath),fs_extra_1.default.writeFileSync(this.intermediatesTempRouterMapFilePath,JSON.stringify({routerMap:e})),fs_extra_1.default.ensureFileSync(this.intermediatesToLoaderRouterMap),fs_extra_1.default.writeFileSync(this.intermediatesToLoaderRouterMap,JSON.stringify({routerMap:t}))}}exports.ProcessRouterMap=ProcessRouterMap;