"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),worker_threads_1=require("worker_threads"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),job_js_1=require("./job.js"),util_js_1=require("./util.js"),updatePkgName2SourceRoots=(0,util_js_1.onTerminateWorker)().updatePkgName2SourceRoots;(0,util_js_1.setLogLevel)(worker_threads_1.workerData.logLevel);const logger=ohos_logger_js_1.OhosLogger.getLogger("Preview_Build"),projectConfig=worker_threads_1.workerData.projectConfig;(0,util_js_1.generateLoaderEnv)(projectConfig);const onBuildFailed=e=>{const r=e instanceof Error?e.message:e||"unknown error";worker_threads_1.parentPort.postMessage({event:hvigor_1.PoolConstant.WORK_ERROR,error:r})};function parseFileId(e){if("string"!=typeof e.msg)return!1;const r="[33mArkTS:WARN File: ";if(e.msg.startsWith(r))return t(e.msg.substring(22));const o="[31mArkTS:ERROR File: ";return!!e.msg.startsWith(o)&&t(e.msg.substring(23));function t(r){let o=r.split("\n")[0];for(let e=0;e<2;e++){const e=o.lastIndexOf(":");if(-1===e)return!1;o=o.substring(0,e)}return e.fileId=o,!0}}(0,hvigor_arkts_compose_1.watch)(projectConfig,job_js_1.errorCallback,((e,r)=>{if(updatePkgName2SourceRoots((0,hvigor_arkts_compose_1.getPkgName2SourceRootsMap)(projectConfig)),r){const o=[];for(const t of e)parseFileId(t)&&t.fileId&&r.has(t.fileId)&&(o.push(t),worker_threads_1.parentPort.postMessage({type:hvigor_1.WatchEvent.WATCH_LOG,content:[t]}));e.length=0,e.push(...o)}else worker_threads_1.parentPort.postMessage({type:hvigor_1.WatchEvent.WATCH_LOG,content:e})}),worker_threads_1.parentPort,logger).then((e=>{e.isSuccess?(worker_threads_1.parentPort.on("message",(async e=>{e&&e.command&&e.data&&e.data.script?(0,hvigor_arkts_compose_1.compileCodeSnippet)(e):logger.debug(`bad codeSnippet ${e}`)})),worker_threads_1.parentPort.postMessage({event:hvigor_1.PoolConstant.WORK_DONE,returnVal:e.compileEvents})):onBuildFailed(e.error)})).catch((e=>{onBuildFailed(e)})).finally((()=>{logger.debug("Ark compile finished.")}));