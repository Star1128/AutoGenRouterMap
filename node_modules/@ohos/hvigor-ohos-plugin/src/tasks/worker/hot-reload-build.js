"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),worker_threads_1=require("worker_threads"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),job_js_1=require("./job.js"),util_js_1=require("./util.js"),updatePkgName2SourceRoots=(0,util_js_1.onTerminateWorker)().updatePkgName2SourceRoots;(0,util_js_1.setLogLevel)(worker_threads_1.workerData.logLevel);const logger=ohos_logger_js_1.OhosLogger.getLogger("Hot_Reload"),projectConfig=worker_threads_1.workerData.projectConfig;(0,util_js_1.generateLoaderEnv)(projectConfig);const onBuildFailed=e=>{const o=e instanceof Error?e.message:e||"unknown error";worker_threads_1.parentPort.postMessage({event:hvigor_1.PoolConstant.WORK_ERROR,error:o})};(0,hvigor_arkts_compose_1.watch)(projectConfig,job_js_1.errorCallback,((e,o)=>{updatePkgName2SourceRoots((0,hvigor_arkts_compose_1.getPkgName2SourceRootsMap)(projectConfig)),o?e.length=0:worker_threads_1.parentPort.postMessage({type:hvigor_1.WatchEvent.WATCH_LOG,content:e})}),worker_threads_1.parentPort,logger).then((e=>{e.isSuccess?worker_threads_1.parentPort.postMessage({event:hvigor_1.PoolConstant.WORK_DONE,returnVal:e.compileEvents}):onBuildFailed(e.error)})).catch((e=>{onBuildFailed(e)})).finally((()=>{logger.debug("Ark compile finished.")}));