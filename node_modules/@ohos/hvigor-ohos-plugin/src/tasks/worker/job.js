"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.cacheNativeLibs=exports.runArkLint=exports.run=exports.errorCallback=void 0;const libs_file_cache_util_js_1=require("../../utils/libs-file-cache-util.js"),startTime=Number(process.hrtime.bigint()),hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),crypto_1=__importDefault(require("crypto")),fs_1=__importDefault(require("fs")),log4js_1=require("log4js"),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),error_code_map_js_1=require("../../error/error-code-map.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),util_js_1=require("./util.js"),endTime=Number(process.hrtime.bigint()),log=ohos_logger_js_1.OhosLogger.getLogger("Ark");let level=log4js_1.levels.DEBUG;const errorCallback=e=>{e.dece=error_code_map_js_1.ECM.DECE.ARKTS_COMPILER};exports.errorCallback=errorCallback;let hasLoadDependencies=!1;const run=async(e,r)=>((0,util_js_1.generateLoaderEnv)(e),level=log4js_1.levels.getLevel(e.level,log4js_1.levels.INFO),log.setLevel(level),new Promise((o=>{(0,hvigor_arkts_compose_1.runArkPack)(e,exports.errorCallback,void 0,void 0,log,r).then((r=>{r.isSuccess?((0,ohos_logger_js_1.handleLogs)(r.compileLogEvents,log,level),!e.isMainThread&&!hasLoadDependencies&&r.compileEvents.push(getLoadDependencyEvent()),o(r.compileEvents)):o(r.error)})).catch((r=>{var o;const s=path_1.default.resolve(null!==(o=e.cachePath)&&void 0!==o?o:"",hvigor_arkts_compose_1.MSGPACK_COMPILE_CACHE_FILE_NAME);throw fs_1.default.rmSync(s,{force:!0}),r})).finally((()=>{log.debug(`Ark compile task finished.finished time is ${process.hrtime.bigint()}`)}))})));exports.run=run;const runArkLint=async e=>{(0,util_js_1.generateLoaderEnv)(e.config);const r=await(0,hvigor_arkts_compose_1.runEtsStandaloneChecker)(e);level=log4js_1.levels.getLevel(e.config.level,log4js_1.levels.INFO),(0,ohos_logger_js_1.handleLogs)(r,log,level);const o=r.filter((e=>"error"===e.level));if(o.length>0){const e=o.map((e=>e.msg)).join(os_1.default.EOL);log._buildError(`ArkTS lint errors.${os_1.default.EOL}${e}`)._printErrorAndExit()}};exports.runArkLint=runArkLint;const cacheNativeLibs=async e=>{await libs_file_cache_util_js_1.LibsFileCacheUtil.refreshLibsFileCache(e.intermediatesProcessLibs,e.strippedNativeLibs,e.cacheFilePath,e.debugSymbol)};function getLoadDependencyEvent(){return hasLoadDependencies=!0,new hvigor_arkts_compose_1.CompileEvent(crypto_1.default.randomUUID(),"load compilation dependencies",process.pid,hvigor_1.MAIN_THREAD,0,0).setStartTime(startTime).setEndTime(endTime).setState("success")}exports.cacheNativeLibs=cacheNativeLibs;