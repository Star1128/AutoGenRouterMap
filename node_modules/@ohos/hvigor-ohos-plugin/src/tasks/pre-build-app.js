"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreBuildApp=void 0;const hvigor_1=require("@ohos/hvigor"),task_names_js_1=require("./common/task-names.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const sdk_const_js_1=require("../const/sdk-const.js"),api_version_handler_js_1=require("../distribution/api-version-handler.js"),distro_filter_handler_js_1=require("../distribution/distro-filter-handler.js"),distro_filter_validate_entrance_js_1=require("../distribution/distro-filter-validate-entrance.js"),screen_shape_handler_js_1=require("../distribution/screen-shape-handler.js"),screen_window_handler_js_1=require("../distribution/screen-window-handler.js"),array_util_js_1=require("../utils/array-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),meta_util_js_1=require("../utils/meta-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-preBuildApp");class PreBuildApp extends ohos_app_task_js_1.OhosAppTask{constructor(e,r){super(e,r,CommonTask.PRE_BUILD_APP)}doTaskAction(){this.checkConfigModuleStatus(),this.isApi8Fa(this.service)&&this.validateDistroFilter(this.service.getProjectModel())}checkConfigModuleStatus(){if(void 0!==hvigor_1.hvigorCore.getExtraConfig().get("module")){const e=this.service.getProjectModel().getModuleSpecificTargets().keys();for(const r of e){const e=this.service.getProjectModel().getModuleModelByName(r);e&&!e.isHarModule()&&_log.errorMessageExit("Cannot run '-p' to configure entry/hsp module in the command line when packaging App.")}}if(0===this.service.getProductDataMap().size){const e=this.service.getTargetProduct().name;_log._buildError("No HAP found for the APP.")._solution(`Check the build-profile.json file or hvigorconfig.ts of the project root directory and make sure at least one target is set to specified product: ${e} in applyToProducts.`)._file(this.service.getProjectModel().getProfilePath())._printErrorAndExit()}}validateDistroFilter(e){distro_filter_handler_js_1.DistroFilterHandler.validateMultiTarget(e)?this.processTargetDistroFilter(e):distro_filter_handler_js_1.DistroFilterHandler.validateMultiEntry(e)&&this.processEntryDistroFilter(e)}isApi8Fa(e){var r;const t=e.getTargetProduct(),i=null===(r=e.getProjectModel().getProductApiMeta(t.name))||void 0===r?void 0:r.compileSdkVersion;return e.isFaMode()&&(null==i?void 0:i.version)===sdk_const_js_1.ApiVersion.API_VERSION_8}processTargetDistroFilter(e){let r=[];e.getAllEntryModules().forEach((t=>{const i=distro_filter_handler_js_1.DistroFilterHandler.getCurModuleExecutableTargets(e,t);i.length>1&&distro_filter_handler_js_1.DistroFilterHandler.checkSingleEntryTargetDeviceType(e,t,i)&&(i.forEach((i=>{const s=distro_filter_handler_js_1.DistroFilterHandler.getTargetDistroFilterConfig(e,t,i);r.push(s)})),this.sendDistroFilterRequest(e,r),r=[]);distro_filter_handler_js_1.DistroFilterHandler.findIntersectedEntryList(e,t).forEach((s=>{const o=distro_filter_handler_js_1.DistroFilterHandler.getCurModuleExecutableTargets(e,s);i.forEach((i=>{o.forEach((o=>{const l=distro_filter_handler_js_1.DistroFilterHandler.getTargetDeviceType(e,t,i),n=distro_filter_handler_js_1.DistroFilterHandler.getTargetDeviceType(e,s,o);if((0,array_util_js_1.checkIntersection)(l,n)){const l=distro_filter_handler_js_1.DistroFilterHandler.getTargetDistroFilterConfig(e,t,i),n=distro_filter_handler_js_1.DistroFilterHandler.getTargetDistroFilterConfig(e,s,o);r.push(l),r.push(n)}this.sendDistroFilterRequest(e,r),r=[]}))}))}))}))}processEntryDistroFilter(e){e.getAllEntryModules().forEach((r=>{const t=distro_filter_handler_js_1.DistroFilterHandler.getCurModuleExecutableTargets(e,r)[0],i=distro_filter_handler_js_1.DistroFilterHandler.getTargetDeviceType(e,r,t);let s=[];const o=distro_filter_handler_js_1.DistroFilterHandler.findIntersectedEntryList(e,r);0!==o.length&&o.forEach((t=>{const o=distro_filter_handler_js_1.DistroFilterHandler.getCurModuleExecutableTargets(e,t)[0],l=distro_filter_handler_js_1.DistroFilterHandler.getTargetDeviceType(e,t,o);if((0,array_util_js_1.checkIntersection)(i,l)){const i=distro_filter_handler_js_1.DistroFilterHandler.getFADistroFilterConfig(e,r);i&&s.push(i);const o=distro_filter_handler_js_1.DistroFilterHandler.getFADistroFilterConfig(e,t);o&&s.push(o),this.sendDistroFilterRequest(e,s),s=[]}}))}))}sendDistroFilterRequest(e,r){const t=new distro_filter_validate_entrance_js_1.DistroFilterValidateEntrance(e),i=new api_version_handler_js_1.ApiVersionHandler(e),s=new screen_shape_handler_js_1.ScreenShapeHandler(e),o=new screen_window_handler_js_1.ScreenWindowHandler(e);t.setNextDimensionHandler(i),i.setNextDimensionHandler(s),s.setNextDimensionHandler(o),t.executeValidate(r)}initTaskDepends(){(0,meta_util_js_1.hvigorOrToolChainsChanged)(this.service.getSdkInfo())&&this.dependsOn(CommonTask.CLEAN.name)}}exports.PreBuildApp=PreBuildApp;