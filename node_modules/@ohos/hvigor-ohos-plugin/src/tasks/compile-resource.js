"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompileResource=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),compile_resources_util_js_1=require("../utils/compile-resources-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_compile_resource_js_1=require("./abstract/abstract-compile-resource.js"),task_names_js_1=require("./common/task-names.js"),process_resource_js_1=require("./process-resource.js");var Task=task_names_js_1.TaskNames.Task;const common_util_js_1=require("../common/common-util.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),distro_filter_handler_js_1=require("../distribution/distro-filter-handler.js"),file_util_js_1=require("../utils/file-util.js"),json_util_js_1=require("../utils/json-util.js");class CompileResource extends abstract_compile_resource_js_1.AbstractCompileResource{constructor(e){super(e,Task.COMPILE_RESOURCE),this._log=ohos_logger_js_1.OhosLogger.getLogger(CompileResource.name),this.generateSourceRDir=this.pathInfo.getGenerateSourceR(),this.resConfigFilePath=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.RES_CONFIG_FILE),this.processProfileTask=process_resource_js_1.ProcessResource.name}declareInputFiles(){var e,t;const s=this.restoolConfigBuilder.inputFiles,o=this.pathInfo.getIntermediatesRouterMap(null!==(e=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==e?e:build_directory_const_js_1.BuildArtifactConst.INTERMEDIATES_TEMP_ROUTER_MAP_FILE_NAME);if(fs_extra_1.default.existsSync(o)){(null===(t=(0,json_util_js_1.getJson5Obj)(o).routerMap)||void 0===t?void 0:t.length)&&s.addEntry(o)}return s.addEntries([this.resConfigFilePath],{isDirectory:!1})}declareExecutionCommand(){return this.getCommand().toString()}initTaskDepends(){this.declareDepends(process_resource_js_1.ProcessResource.name)}async doTaskAction(){await this.compilationProcess(compile_resources_util_js_1.CompileResourceBuildCommandType.FILE,this.targetData)}async invokeRestool(e){const t="create intermediate resource category",s=this.durationEvent.createSubEvent(t,"");s.start(),await fs_extra_1.default.ensureDir(path_1.default.resolve(this.pathInfo.getIntermediatesRes(),"ids_map")),s.stop(),s.setLog(t,hvigor_1.MetricLogType.INFO),await this.executeCommand(this.getCommand(),this._log,(()=>{this.replaceTargetPages(e,this._log)})),this.customizeDistroFilter(),this.customizeShortcut(),this.processRouterMap()}customizeDistroFilter(){var e,t;const s=this.targetData.getTargetOpt();if(!(null===(e=s.config)||void 0===e?void 0:e.distributionFilter))return;const o=s.config.distributionFilter,r=this.service.getProjectModel().getProjectDir(),i=this.targetData.getApiMeta().compileSdkVersion.version,a=this.service.getModuleModel(),_=a.getModule().getNodeDir(),l=path_1.default.resolve(r,_,`src/main/${common_const_js_1.CommonConst.MODULE_JSON5}`),n=(0,json_util_js_1.getJson5Obj)(l).module.metadata;let u,c={};const d=distro_filter_handler_js_1.DistroFilterHandler.findFirstDistroFilterConfigMetadata(r,a,n);let m="";if(9===i?m="distroFilter":i>=10&&(m="distributionFilter"),!d){const e=path_1.default.resolve(this.pathInfo.getModuleProductPath(),`intermediates/res/${s.name}/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}`),t=file_util_js_1.FileUtil.traverseFileFolder(e);u=file_util_js_1.FileUtil.uniqueFileName(t,"ohos_module_distro_filter");const r=path_1.default.resolve(this.pathInfo.getModuleProductPath(),`intermediates/res/${s.name}/module.json`),i=(0,json_util_js_1.getJson5Obj)(r);i.module.metadata?i.module.metadata.push({resource:`$profile:${u}`}):Object.assign(i.module,{metadata:[{resource:`$profile:${u}`}]}),fs_extra_1.default.writeJSONSync(r,i),c={[m]:o}}if(null==d?void 0:d.resource){u=(0,common_util_js_1.parsingProfileName)(d.resource);const e=path_1.default.resolve(r,_,`src/main/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${u}.json`),s=(0,json_util_js_1.getJson5Obj)(e);m=null!==(t=Object.keys(s)[0])&&void 0!==t?t:m,c={[m]:{...s.distroFilter,...o}}}const h=path_1.default.resolve(this.pathInfo.getModuleProductPath(),`intermediates/res/${s.name}/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${u}.json`);fs_extra_1.default.existsSync(h)||fs_extra_1.default.createFileSync(h),fs_extra_1.default.writeJSONSync(h,c)}writeRouterMap(e){var t;if(!e||0===e.length)return;const s=null!==(t=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.DEFAULT_ROUTER_MAP,o=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${s}.json`);fs_extra_1.default.ensureFileSync(o),fs_extra_1.default.writeFileSync(o,JSON.stringify({routerMap:e}));const r=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),i=(0,json_util_js_1.getJson5Obj)(r);Object.assign(i.module,{routerMap:`$profile:${s}`}),fs_extra_1.default.writeFileSync(r,JSON.stringify(i))}processRouterMap(){var e;const t=this.pathInfo.getIntermediatesRouterMap(null!==(e=this.targetService.getRouterMapJsonFileName(this.moduleModel))&&void 0!==e?e:build_directory_const_js_1.BuildArtifactConst.INTERMEDIATES_TEMP_ROUTER_MAP_FILE_NAME);if(!fs_extra_1.default.existsSync(t))return;const s=(0,json_util_js_1.getJson5Obj)(t).routerMap;(null==s?void 0:s.length)&&(s.forEach((e=>{delete e.moduleNodeDir})),this.writeRouterMap(s))}}exports.CompileResource=CompileResource;