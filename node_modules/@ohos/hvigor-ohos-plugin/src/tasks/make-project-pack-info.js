"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,a)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MakeProjectPackInfo=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js");var CommonHookTask=task_names_js_1.TaskNames.CommonHookTask;const json_util_js_1=require("../utils/json-util.js"),module_task_service_js_1=require("./service/module-task-service.js"),task_util_1=require("@ohos/hvigor/src/base/util/task-util"),remote_hsp_utils_js_1=require("../utils/remote-hsp-utils.js"),zip_util_js_1=require("../utils/zip-util.js"),Task=task_names_js_1.TaskNames.Task,_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-make-project-info");class MakeProjectPackInfo extends ohos_app_task_js_1.OhosAppTask{constructor(e,t){super(e,t,Task.MAKE_PROJECT_PACK_INFO),this.moduleSet=new Set,this.hapPackInfoPathMap=new Map,this.allRemoteHspPathMap=new Map,this.remoteHspModuleSet=new Set,this._projectPackInfoObj={summary:{app:{bundleName:"bundleName",version:{name:"name",code:0}},modules:[]},packages:[]}}declareInputs(){const e=new Map;return e.set("allRemoteHspPathMap",JSON.stringify([...this.allRemoteHspPathMap])),e}declareInputFiles(){const e=new hvigor_2.FileSet;for(const t of this.hapPackInfoPathMap.keys())e.addEntry(t);return e}declareOutputFiles(){const e=path_1.default.resolve(this.service.getPathInfo().getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO);return(new hvigor_2.FileSet).addEntry(e)}initTaskDepends(){hvigor_1.hvigor.nodesEvaluated((()=>{const e=this.service.getProjectModel().getSubModuleModels();_log.debug(`project has submodules:${[...e.keys()]}`),e.forEach((e=>{const t=e,s=this.isNeedPackageHap(t);t.isHapModule()&&s?this.dependsOn(CommonHookTask.ASSEMBLE_HAP.name,e.getName()):_log.debug(`module:${e.getName()} no need to execute packageHap`),t.isHspModule()&&s&&this.dependsOn(CommonHookTask.ASSEMBLE_HSP.name,e.getName())}))}))}isNeedPackageHap(e){if((0,task_util_1.getAlignTarget)())return!0;const t=this.service.getTargetProduct().name,s=this.service.getProjectModel().getModuleProfileOpt(e.getName()),o=null==s?void 0:s.targets;return void 0!==o&&o.some((e=>{const s=e.name;let o=e.applyToProducts;return void 0===o&&(o=["default"]),s!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&o.includes(t)}))}async beforeAlwaysAction(){const e=this.service.getProjectModel().getRemoteHspPath();(0,remote_hsp_utils_js_1.initSignRemoteHspMap)(e,this.allRemoteHspPathMap),this.service.getProductDataMap().forEach((e=>{for(const t of e){const e=t.getModuleModel().getName(),s=t.getRelatedEntryModules(),o=t.getModuleModel().getModuleType();if(module_task_service_js_1.ModuleTaskService.checkEntryModules(o,s))for(const o of s){const s=path_1.default.resolve(t.getPathInfo().getModuleBuildOutputPath(),o,build_directory_const_js_1.BuildArtifactConst.PACK_INFO);this.hapPackInfoPathMap.set(s,e)}else{const s=path_1.default.resolve(t.getPathInfo().getModuleBuildOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO);this.hapPackInfoPathMap.set(s,e)}const a=t.getModuleModel(),r=a.getRemoteHspPath();this.remoteHspModuleSet.has(a.getName())||((0,remote_hsp_utils_js_1.initSignRemoteHspMap)(r,this.allRemoteHspPathMap),this.remoteHspModuleSet.add(a.getName()))}}))}async doTaskAction(){this.hapPackInfoPathMap.forEach(((e,t)=>{this.mergeHapPackInfo(t,e)}));const e=[...this.allRemoteHspPathMap.values()];for(const{hspPath:t,hspFileName:s}of e){const e=await zip_util_js_1.ZipUtil.readFileInZIP(t,[build_directory_const_js_1.BuildArtifactConst.PACK_INFO,common_const_js_1.CommonConst.MODULE_JSON]),o=e.get(build_directory_const_js_1.BuildArtifactConst.PACK_INFO),a=e.get(common_const_js_1.CommonConst.MODULE_JSON);o&&a&&this.mergeRemoteHspPackInfo(JSON.parse(o),JSON.parse(a).module.name,s)}_log.debug("Project Pack Info:",this._projectPackInfoObj),fse.outputJSONSync(path_1.default.resolve(this.service.getPathInfo().getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO),this._projectPackInfoObj,{spaces:"\t"}),this.moduleSet.clear()}mergeHapPackInfo(e,t){if(fse.existsSync(e)){const s=(0,json_util_js_1.getJson5Obj)(e);s.summary.app.bundleName&&(this._projectPackInfoObj.summary.app=s.summary.app),this.moduleSet.has(t)||(this._projectPackInfoObj.summary.modules.push(s.summary.modules[0]),this.moduleSet.add(t)),this._projectPackInfoObj.packages=this._projectPackInfoObj.packages.concat(s.packages)}}mergeRemoteHspPackInfo(e,t,s){e.packages[0].name=this.removeHspExtension(s),this.moduleSet.has(t)||(this._projectPackInfoObj.summary.modules.push(e.summary.modules[0]),this.moduleSet.add(t)),this._projectPackInfoObj.packages=this._projectPackInfoObj.packages.concat(e.packages)}removeHspExtension(e){const t=build_directory_const_js_1.BuildArtifactExtension.DOT_HSP;return e.endsWith(t)?e.slice(0,-t.length):e}}exports.MakeProjectPackInfo=MakeProjectPackInfo;