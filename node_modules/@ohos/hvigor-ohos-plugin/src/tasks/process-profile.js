"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,r)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessProfile=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),virtual_machine_enum_js_1=require("../enum/virtual-machine-enum.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),merge_profile_js_1=require("./merge-profile.js");var Task=task_names_js_1.TaskNames.Task;const integrated_hsp_utils_js_1=require("../utils/integrated-hsp-utils.js"),json_util_js_1=require("../utils/json-util.js"),INPUT_KEY={arkEnable:"arkEnable",compileMode:"compileMode",deviceTypes:"deviceTypes",dependency:"dependency"};class ProcessProfile extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,Task.PROCESS_PROFILE),this._dependencies=[],this._arkEnable=this.service.isArkModule(),this._moduleTargetData=this.targetService.getTargetData(),this._deviceTypes=this._moduleTargetData.getTargetDeviceType(),this._pathInfo=this._moduleTargetData.getPathInfo(),this._intermediatesMergeProfile=this._pathInfo.getIntermediatesMergeProfile(),this._processedModuleJson=this._pathInfo.getIntermediatesProcessProfile(),this.mergeHspLibs().forEach((e=>this._dependencies.push(e)))}initTaskDepends(){this.declareDepends(merge_profile_js_1.MergeProfile.name)}doTaskAction(){const e=(0,json_util_js_1.getJson5Obj)(this._intermediatesMergeProfile),t=this.projectModel.getCompatibleApiMetaByProduct(this.targetData.getProduct().name).version;e.module.virtualMachine=this._arkEnable?`${virtual_machine_enum_js_1.VirtualMachine.ARK}${this.sdkInfo.getArkVersion(t)}`:virtual_machine_enum_js_1.VirtualMachine.DEFAULT,e.module.compileMode=this.targetCompileMode,e.module.deviceTypes=this._deviceTypes,e.module.dependencies=this._dependencies,fs.outputJSONSync(this._processedModuleJson,e,{spaces:"\t"})}declareInputs(){const e=new Map;return e.set(INPUT_KEY.arkEnable,this._arkEnable),e.set(INPUT_KEY.compileMode,this.targetCompileMode),e.set(INPUT_KEY.deviceTypes,this._deviceTypes),e.set(INPUT_KEY.dependency,JSON.stringify(this._dependencies)),e}declareInputFiles(){return(new hvigor_1.FileSet).addEntry(this._intermediatesMergeProfile)}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this._processedModuleJson)}mergeHspLibs(){const e=this.service.getHspDependencyPaths(),t=this.service.getHspModuleDependencyPathsWithOutDynamic(),{versionCode:s}=(0,integrated_hsp_utils_js_1.getAppInfoByProject)(this.projectModel);return[...(0,wdk_1.difference)(e,t).map((e=>{const t=path_1.default.resolve(e,"src","main","module.json"),s=path_1.default.resolve(e,"src","main","module.json5");return fs_extra_1.default.existsSync(t)?t:s})),...t.map((e=>path_1.default.resolve(e,"src","main","module.json5")))].map((e=>{var t,i,r;let o;return o=e.endsWith("module.json")?fs_extra_1.default.readJsonSync(e):hvigor_1.Json5Reader.getJson5Obj(e),{moduleName:o.module.name,versionCode:(null===(t=null==o?void 0:o.app)||void 0===t?void 0:t.bundleName)&&null!==(r=null===(i=null==o?void 0:o.app)||void 0===i?void 0:i.versionCode)&&void 0!==r?r:s}}))}}exports.ProcessProfile=ProcessProfile;