"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var o=Object.getOwnPropertyDescriptor(t,s);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,o)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ArkLinter=void 0;const hvigor_1=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_util_js_1=require("../../utils/task-util.js"),abstract_compile_node_js_1=require("../abstract/abstract-compile-node.js"),task_names_js_1=require("../common/task-names.js"),legacy_pre_build_js_1=require("../legacy-tasks/legacy-pre-build.js"),legacy_process_profile_js_1=require("../legacy-tasks/legacy-process-profile.js"),pre_build_js_1=require("../pre-build.js"),run_ark_js_1=require("../worker/run-ark.js");var CommonTask=task_names_js_1.TaskNames.CommonTask,Task=task_names_js_1.TaskNames.Task;const fse=__importStar(require("fs-extra")),sdk_const_js_1=require("../../const/sdk-const.js");class ArkLinter extends abstract_compile_node_js_1.AbstractCompileNode{constructor(e){super(e,code_type_enum_js_1.CodeType.ETS,Task.LINT),this._log=ohos_logger_js_1.OhosLogger.getLogger(ArkLinter.name)}taskShouldDo(){return super.taskShouldDo()&&this.codeType===code_type_enum_js_1.CodeType.ETS&&this.sdkInfo.hasRollUpPluginInEtsLoader}async doTaskAction(){const e="initialize and add necessary parameters",t=this.durationEvent.createSubEvent(e,"");t.start();const s=await this.findAvailableEntry(),r=await this.customizeProjectConfig(),o={};o[path_1.default.relative(r.aceModuleRoot,s)]=s,this.service.getDependencyMainPaths(),t.stop(),t.setLog(e,hvigor_1.MetricLogType.INFO);const i="submit ark linter task to work pool",a=this.durationEvent.createSubEvent(i,"");a.start(),await(0,run_ark_js_1.submitArkLintWork)(this,this.getWorkerPool(),this._log,r,o,a),a.stop(),a.setLog(i,hvigor_1.MetricLogType.INFO)}async findAvailableEntry(){const e=await hvigor_1.Json5Reader.readJson5File(this.packageManagerPath),t=this.moduleModel.getProjectDir();if(!e.main){const e=["ets","ts","js"].find((e=>fs_1.default.existsSync(path_1.default.resolve(t,`index.${e}`))));return e||this._log._buildError("No available main file defined in oh-package.json.")._file(this.moduleModel.getOhPackageJson5Path())._printErrorAndExit(this.moduleName),path_1.default.resolve(t,`index.${e}`)}return e.main&&!fs_1.default.existsSync(path_1.default.resolve(t,e.main))&&this._log._buildError(`Invalid main file ${e.main} defined in oh-package.json.`)._file(this.moduleModel.getOhPackageJson5Path())._printErrorAndExit(this.moduleName),path_1.default.resolve(t,e.main)}async customizeProjectConfig(){const e=await this.initDefaultArkCompileConfig();process.env.compileTool=common_const_js_1.ArkPackConst.COMPILE_TOOL,e.projectPath=e.projectTopDir;const t={};return this.projectModel.getSubModuleModels().forEach(((e,s)=>t[s]={moduleName:s,modulePkgPath:e.getProjectDir()})),e.projectModel=t,e}initTaskDepends(){this.declareDepends(this.isFaMode?legacy_pre_build_js_1.LegacyPreBuild.name:pre_build_js_1.PreBuild.name),this.declareDepends(legacy_process_profile_js_1.LegacyProcessProfile.name),(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_9)&&!this.isFaMode&&this.declareDepends(CommonTask.CREATE_HAR_BUILD_PROFILE.name)}declareInputs(){var e;return(new Map).set("customTypes",null!==(e=this.targetService.getCustomTypes())&&void 0!==e?e:"").set(common_const_js_1.CommonConst.BUILD_MODE,this.targetService.getBuildMode())}declareInputFiles(){const e=new hvigor_1.FileSet;this.sourcePath&&fs_1.default.existsSync(this.sourcePath)&&e.addEntry(this.sourcePath,{isDirectory:!0});const t=this.pathInfo.getHarGenerateBuildProfilePath();return fse.existsSync(t)&&e.addEntry(t),e}declareOutputFiles(){return new hvigor_1.FileSet}}exports.ArkLinter=ArkLinter;