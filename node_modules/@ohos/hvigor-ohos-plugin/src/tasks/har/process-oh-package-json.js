"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,r)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.processResourceConfig=exports.ProcessOhPackageJson=void 0;const fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),task_names_js_1=require("../common/task-names.js"),core_process_package_json_js_1=require("./core-process-package-json.js"),har_extend_info_js_1=require("./har-extend-info.js");var Task=task_names_js_1.TaskNames.Task;const file_util_js_1=require("../../utils/file-util.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader");class ProcessOhPackageJson extends core_process_package_json_js_1.CoreProcessPackageJson{constructor(e){super(e,Task.PROCESS_OH_PACKAGE_JSON),this.generateOhPackageJsonFilePath=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.generatePmDir,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)),this.workerConfig=this.processWorkerConfig()}doTaskAction(){super.doTaskAction(),this.addWorkerData(),this.addDynamicImport(),processResourceConfig(this.targetService,this.packageJsonObj),fse.outputJSONSync(this.generateOhPackageJsonFilePath,this.packageJsonObj)}addArtifactType(e){e.artifactType=har_extend_info_js_1.ArtifactType.OBFUSCATION}addWorkerData(){var e;this.workerConfig&&(this.packageJsonObj.metadata={...null!==(e=this.packageJsonObj.metadata)&&void 0!==e?e:{},workers:this.workerConfig})}processWorkerConfig(){var e;const t=null===(e=this.targetService.getBuildOption().sourceOption)||void 0===e?void 0:e.workers;if(this._harExtendInfo.isObfuscatedHar()&&t){const e=this.hasUseTsHarField()?".ts":".js";return t.map((t=>{const s=path_1.default.extname(t);return`${t.substring(0,t.lastIndexOf(s))}${e}`}))}return t}addDynamicImport(){var e,t,s;const o=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.runtimeOnly;if(!o)return;const r=this.hasUseTsHarField()?".ts":".js",a=[];o.sources&&o.sources.forEach((e=>{if(common_const_js_1.ValidateRegExp.RELATIVE_PATH_REG_EXP.test(e)){const t=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),e),s=fse.statSync(t);s.isDirectory()&&a.push(e),s.isFile()&&(this.targetService.isOpenSource()||common_const_js_1.ValidateRegExp.JS_FILE_SUFFIX_REG_EXP.test(file_util_js_1.FileUtil.getFileSuffix(e))?a.push(e):a.push(`${e.substring(0,e.lastIndexOf("."))}${r}`))}}));let i=[];o.packages&&(i=o.packages),this.packageJsonObj.metadata={...null!==(s=this.packageJsonObj.metadata)&&void 0!==s?s:{},runtimeOnly:{sources:a,packages:i}}}}function processResourceConfig(e,t){var s,o;let r=null===(s=e.getTargetData().getTargetOpt().resource)||void 0===s?void 0:s.directories;if(r&&r.length&&(r=r.filter((e=>!path_1.default.isAbsolute(e))),r.length)){const e={directories:r};t.metadata={...null!==(o=t.metadata)&&void 0!==o?o:{},resource:e}}}exports.ProcessOhPackageJson=ProcessOhPackageJson,exports.processResourceConfig=processResourceConfig;