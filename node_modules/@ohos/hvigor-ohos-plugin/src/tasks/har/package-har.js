"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageHar=void 0;const wdk_1=require("@baize/wdk"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),validate_systemHsp_js_1=require("../../utils/validate/validate-systemHsp.js"),abstract_package_har_js_1=require("../abstract/abstract-package-har.js"),task_names_js_1=require("../common/task-names.js"),compile_resource_js_1=require("../compile-resource.js"),process_obfuscation_files_js_1=require("./process-obfuscation-files.js");var Task=task_names_js_1.TaskNames.Task;const common_util_js_1=require("../../common/common-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),cache_native_libs_js_1=require("../cache-native-libs.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-PackageHar");class PackageHar extends abstract_package_har_js_1.AbstractPackageHar{constructor(e){super(e,Task.PACKAGE_HAR),this.arkTsCompiledOutputDir=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath());const t=this.projectModel.getAppRes();this.appOptObj=t.getAppResOpt();const s=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetModuleOptObj=s.getModuleJsonOpt(),this.targetJsonPath=s.getJsonPath()}declareInputs(){var e,t,s;const a=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt);return super.declareInputs().set("bundleType",null!==(s=null!==(t=null==a?void 0:a.bundleType)&&void 0!==t?t:(0,find_target_product_js_1.findTargetProduct)(this.service.getProjectModel()).bundleType)&&void 0!==s?s:this.projectModel.getBundleType())}initTaskDepends(){this.declareDependsList(cache_native_libs_js_1.CacheNativeLibs.name,compile_resource_js_1.CompileResource.name),this.addSpecialDepends()}addSpecialDepends(){if(this._harExtendInfo.isObfuscatedHar()){const e=this.sdkInfo.hasRollUpPluginInEtsLoader;this.declareDepends(e?"HarCompileArkTS":"HarBuildArkTS")}else this.declareDepends(common_const_js_1.ArktSTaskConst.LINT_ARKTS);this.declareDepends(this.moduleModel.isOhpmProject()?Task.PROCESS_OH_PACKAGE_JSON.name:Task.PROCESS_PACKAGE_JSON.name),this.declareDepends(process_obfuscation_files_js_1.ProcessObfuscationFiles.name)}copyCompiledSourceFileToTempDir(){fs_extra_1.default.existsSync(this.arkTsCompiledOutputDir)&&fs_extra_1.default.copySync(this.arkTsCompiledOutputDir,this.taskTmpDir)}copyOtherGenerateFiles(){if(this._harExtendInfo.isObfuscatedHar())fs_extra_1.default.readdirSync(this.generateDir).forEach((e=>{const t=path_1.default.resolve(this.generateDir,e);fs_extra_1.default.copySync(t,path_1.default.resolve(this.taskTmpDir,e))}));else try{fs_extra_1.default.copySync(oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.generateDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)),oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.taskTmpDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)))}catch(e){_log.warn(e.message)}}processHarRouterMap(){const e=this.moduleModel.getJsonPathByTargetName(this.targetName),t=res_model_loader_js_1.resModelLoader.getModuleJson(e).module.routerMap,s=(0,common_util_js_1.parsingProfileName)(t);if(!s)return;const a=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${s}.json`),o=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${s}.json`),r=(0,json_util_js_1.getJson5Obj)(a);fs_extra_1.default.writeFileSync(o,JSON.stringify(r))}addSourceDirsToPackageJson(){var e;const t=path_1.default.basename(this.packageManagerPath),s=path_1.default.resolve(this.taskTmpDir,t);if(!fs_extra_1.default.existsSync(s))return;const a=(0,json_util_js_1.getJson5Obj)(s);a.metadata||(a.metadata={});const o=[...(null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots)||[],`./${build_directory_const_js_1.BuildDirConst.SRC}/${build_directory_const_js_1.BuildDirConst.MAIN}`];Object.assign(a.metadata,{sourceRoots:o}),fs_extra_1.default.writeFileSync(s,JSON.stringify(a))}async doTaskAction(){return(0,validate_systemHsp_js_1.validatePackageBySystemHspModel)(this.service,this.appOptObj,this.targetJsonPath,this.targetModuleOptObj),super.doTaskAction()}}exports.PackageHar=PackageHar;