"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessObfuscationFiles=void 0;const hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),sdk_const_js_1=require("../../const/sdk-const.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),obfuscation_config_resolver_js_1=require("../../utils/obfuscation-config-resolver.js"),compile_resource_js_1=require("../compile-resource.js"),ohos_har_task_js_1=require("../task/ohos-har-task.js");class ProcessObfuscationFiles extends ohos_har_task_js_1.OhosHarTask{constructor(e){super(e,{name:ProcessObfuscationFiles.name}),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessObfuscationFiles.name)}taskShouldDo(){var e,s,o;const t=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.obfuscation;return void 0!==(null===(s=this.moduleModel.getSourceSetByTargetName(this.targetName).getCodeMap().get(code_type_enum_js_1.CodeType.ETS))||void 0===s?void 0:s.getSrcPath())&&!this._harExtendInfo.isObfuscatedHar()&&!!(null==t?void 0:t.consumerFiles)&&0<(null===(o=t.consumerFiles)||void 0===o?void 0:o.length)}async doTaskAction(){var e;if(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_10||this.isFaMode)return;const s=this.targetService.getBuildOption();if(s.debuggable)return;s.artifactType&&this._log.warn("buildOption/artifactType is deprecated, please use buildOption/arkOptions/obfuscation instead.");const o=null===(e=s.arkOptions)||void 0===e?void 0:e.obfuscation;if(!o)return;const t=await(0,obfuscation_config_resolver_js_1.resolveObfuscationOptions)(this.targetService,o,"");t&&(await fs_extra_1.default.ensureDir(path_1.default.dirname(t.exportRulePath)),await(0,hvigor_arkts_compose_1.generateObfuscationFile)(t,this.sdkInfo.getEtsLoader(),this.sdkInfo.getSdkVersion(),this.sdkInfo.getEtsComponentVersion(),this.isFaMode,this._log))}initTaskDepends(){this.declareDepends(compile_resource_js_1.CompileResource.name)}}exports.ProcessObfuscationFiles=ProcessObfuscationFiles;