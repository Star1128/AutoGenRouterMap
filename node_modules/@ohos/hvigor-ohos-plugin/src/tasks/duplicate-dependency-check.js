"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DuplicateDependencyCheck=void 0;const hvigor_1=require("@ohos/hvigor"),task_names_js_1=require("./common/task-names.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const fs_extra_1=__importDefault(require("fs-extra")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),ohos_plugin_id_js_1=require("../plugin/common/ohos-plugin-id.js"),har_plugin_js_1=require("../plugin/har-plugin.js"),hsp_plugin_js_1=require("../plugin/hsp-plugin.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-duplicateDependencyCheck");class DuplicateDependencyCheck extends ohos_app_task_js_1.OhosAppTask{constructor(e,t){super(e,t,CommonTask.DUPLICATE_DEPENDENCY_CHECK),this.ohPackagePath=t.getProjectModel().getOhPackageJson5Path()}doTaskAction(){var e;if(!!!(null===(e=this.service.getBuildOption().strictMode)||void 0===e?void 0:e.duplicateDependencyCheck))return;const t=[],s=new Map,o=new Map,n=new Map,i=new Map;this.collectProjectDependencies(n),this.project.getSubModules().forEach((e=>{var t,s;const o=e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAR_PLUGIN);if(o&&o instanceof har_plugin_js_1.HarPlugin&&(null===(t=o.getTaskService())||void 0===t?void 0:t.getModuleModel().isHarModule())){const e=null===(s=o.getModuleModel())||void 0===s?void 0:s.getProjectDir();e&&n.get(e)&&i.set(e,n.get(e))}})),this.project.getSubModules().forEach((e=>{const t=e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HSP_PLUGIN);if(!(t&&t instanceof hsp_plugin_js_1.HspPlugin))return;const n=t.getTaskService();if(!n)return;const a=e.getName();i.forEach(((e,t)=>{o.has(t)||o.set(t,[]),o.get(t).push(a),s.set(t,e)})),n.getHarDependencies().forEach((e=>{const t=e.getDependencyRootPath();o.has(t)||o.set(t,[]),o.get(t).push(a),s.set(t,e.getPackageName())}))})),o.forEach(((e,o)=>{e.length<=1||t.push(`[${e.join(", ")}] depend on the same HAR [${s.get(o)}].`)})),t.length&&(t.unshift(`Found HSPs that have the same HAR ${t.length>1?"dependencies":"dependency"}:`),_log._buildError(t.join(`${os_1.default.EOL}\t `))._detail("Follow the best practice at https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/bpta-modular-design-V5#section1079344610211")._printErrorAndExit())}collectProjectDependencies(e){if(fs_extra_1.default.existsSync(this.ohPackagePath)){const t=(0,hvigor_1.parseJsonFile)(this.ohPackagePath);Object.keys(t.dependencies).forEach((s=>{const o=t.dependencies[s],n=/^file:(.*)/i.test(o)?/^file:(.*)/i.exec(o)[1]:o;if(!n)return;const i=path_1.default.resolve(this.project.getNodeDir(),n);fs_extra_1.default.existsSync(i)&&e.set(i,s)}))}}initTaskDepends(){this.dependsOn(CommonTask.PRE_BUILD_APP.name)}}exports.DuplicateDependencyCheck=DuplicateDependencyCheck;