"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SignApp=void 0;const hvigor_1=require("@ohos/hvigor"),path_1=__importDefault(require("path")),sign_type_enum_js_1=require("../enum/sign-type-enum.js"),task_names_js_1=require("./common/task-names.js"),sign_model_js_1=require("./sign/command-builder-impl/sign-model.js"),sign_util_js_1=require("./sign/sign-util.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js"),package_app_js_1=require("./package-app.js"),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),common_const_js_1=require("../const/common-const.js");class SignApp extends ohos_app_task_js_1.OhosAppTask{constructor(e,t){super(e,t,task_names_js_1.TaskNames.CommonTask.SIGN_APP),this.log=ohos_logger_js_1.OhosLogger.getLoggerWithDurationId(SignApp.name,this.durationEvent.getId()),this.pathInfo=this.service.getPathInfo(),this.signUtil=new sign_util_js_1.SignUtil(t,sign_type_enum_js_1.SignTypeEnum.APP,this.pathInfo,this.service.getTargetProduct(),this.service.getSdkInfo()),this.signingConfig=this.signUtil._signingConfig}async beforeAlwaysAction(){this.log.warn(this.signUtil._signingConfigCheckLogStr)}declareInputs(){return sign_util_js_1.SignUtil.getSigningConfigInputs(this.service.getSdkInfo(),this.signingConfig)}declareInputFiles(){return this.signUtil.getSigningConfigInputFiles().addEntry(path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName()),{isDirectory:!1})}declareOutputFiles(){const e=path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName(!0));return e?super.declareOutputFiles().addEntry(e,{isDirectory:!1}):super.declareOutputFiles()}async doTaskAction(){const e=path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName(!0)),t=new sign_model_js_1.SignModel(sign_type_enum_js_1.SignTypeEnum.APP,path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName()),e);file_util_js_1.FileUtil.deleteFile(t.getOutPutFilePath()),hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.ENABLE_SIGN_TASK)&&await this.signUtil.sign(t,this.durationEvent)}initTaskDepends(){this.dependsOn(package_app_js_1.PackageApp.name)}}exports.SignApp=SignApp;