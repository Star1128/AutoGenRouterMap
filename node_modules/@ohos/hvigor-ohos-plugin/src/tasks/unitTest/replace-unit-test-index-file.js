"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReplaceUnitTestIndexFile=void 0;const hvigor_1=require("@ohos/hvigor"),inject_const_js_1=require("../../const/inject-const.js"),json_util_js_1=require("../../utils/json-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_names_js_1=require("../common/task-names.js"),compile_resource_js_1=require("../compile-resource.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js");class ReplaceUnitTestIndexFile extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,CommonTask.REPLACE_UNIT_TEST_INDEX_FILE),this._log=ohos_logger_js_1.OhosLogger.getLogger(ReplaceUnitTestIndexFile.name),this.PAGE_JSON="main_pages",this.PAGE_JSON_FILE=`${this.PAGE_JSON}.json`,this.PAGE_JSON_RESOURCE=`$profile:${this.PAGE_JSON}`}initTaskDepends(){this.declareDepends(compile_resource_js_1.CompileResource.name)}doTaskAction(){var e;const s=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),t=path_1.default.resolve(this.pathInfo.getIntermediatesResProfilePath(),this.PAGE_JSON_FILE);if(this.moduleModel.isHarModule())return this.writeModuleJson(s),void this.writeMainPages(t);const o=(0,json_util_js_1.getJson5Obj)(s),i=null===(e=null==o?void 0:o.module)||void 0===e?void 0:e.pages;if(this.moduleModel.isHspModule())return i||this.writeModuleJson(s),void this.writeMainPages(t);this.moduleModel.isHapModule()&&!i&&(this.writeModuleJson(s),this.writeMainPages(t));const _=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.UNIT_TEST_REPLACE_PAGE);_&&this.replacePagesInPreview(this._log,[_])}writeModuleJson(e){let s;if(fs_extra_1.default.existsSync(e))s=fs_extra_1.default.readJsonSync(e),(null==s?void 0:s.module)&&(s.module.pages=this.PAGE_JSON_RESOURCE);else{const e=this.targetData.getPathInfo().getIntermediatesProcessProfile();s=(0,json_util_js_1.getJson5Obj)(e),(null==s?void 0:s.module)?s.module.pages=this.PAGE_JSON_RESOURCE:s={module:{pages:this.PAGE_JSON_RESOURCE}}}fs_extra_1.default.ensureFileSync(e),fs_extra_1.default.writeJSONSync(e,s)}writeMainPages(e){const s=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.UNIT_TEST_REPLACE_PAGE);if(!s)return;const t={src:[s]};fs_extra_1.default.ensureFileSync(e),fs_extra_1.default.writeJSONSync(e,t)}}exports.ReplaceUnitTestIndexFile=ReplaceUnitTestIndexFile;