"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleInspection=void 0;const hvigor_1=require("@ohos/hvigor"),find_target_product_js_1=require("../../common/find-target-product.js"),common_const_js_1=require("../../const/common-const.js"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),one_sdk_validator_js_1=require("../../utils/one-sdk-validator.js");class ModuleInspection{constructor(e){this._log=ohos_logger_js_1.OhosLogger.getLogger("Inspection"),this.moduleModel=e,this.projectModel=e.getParentProject()}doInspection(){return this.collectTargetRuntimeOS(),this.checkModuleType(),this.targetApiVersionCheck(),this.targetBuildOptInspection(),this}collectTargetRuntimeOS(){const e=this.projectModel.getModuleProfileOpt(this.moduleModel.getName());e&&!this.moduleModel.isHarModule()&&this.moduleModel.getTargetOptions().forEach((t=>{var o;const r=null===(o=e.targets)||void 0===o?void 0:o.find((e=>e.name===t.name));"ohosTest"!==t.name&&(r&&r.applyToProducts?r.applyToProducts.forEach((e=>{this.projectModel.getTargetRuntimeOSs().push({moduleName:this.moduleModel.getName(),targetName:t.name,productName:e,runtimeOS:t.runtimeOS})})):this.projectModel.getTargetRuntimeOSs().push({moduleName:this.moduleModel.getName(),targetName:t.name,productName:"default",runtimeOS:t.runtimeOS}))}))}targetApiVersionCheck(){const e=this.projectModel.getCompileApiMetaByProduct((0,find_target_product_js_1.findTargetProduct)(this.projectModel).name).version;this.moduleModel.getApiType()===hap_extra_info_js_1.ApiType.STAGE&&9>e&&this._log._buildError(`API version ${e} does not support the Stage model.`)._file(this.projectModel.getProfilePath())._record()}targetBuildOptInspection(){const e=(0,find_target_product_js_1.findTargetProduct)(this.projectModel),t=this.projectModel.getTargetRuntimeOSs();one_sdk_validator_js_1.OneSdkValidator.evlApiModel(this.projectModel,e)===one_sdk_validator_js_1.ApiModel.ORIGINAL||this.moduleModel.isHarModule()||t.filter((t=>t.moduleName===this.moduleModel.getName()&&t.productName===e.name)).forEach((t=>this.runtimeOSInspection(t,e)))}runtimeOSInspection(e,t){const o=this.projectModel.getTargetRuntimeOSs();if(t.runtimeOS)e.runtimeOS&&e.runtimeOS!==t.runtimeOS&&this._log._buildError(`The runtimeOS configuration of the target ${this.moduleModel.getName()}:${e.targetName} does not match the product ${t.name}.`)._file(this.moduleModel.getProfilePath())._printErrorAndExit(this.moduleModel.getName());else{const e=[],r=[],i=[];if(o.filter((e=>e.productName===t.name)).forEach((t=>{t.runtimeOS?t.runtimeOS===common_const_js_1.CommonConst.HARMONY_OS?r.push(t):e.push(t):i.push(t)})),0===r.length)return;if(e.length>0||i.length>0){e.push(...i);const t=e.map((e=>`${e.moduleName}:${e.targetName}`)).join(","),o=r.map((e=>`${e.moduleName}:${e.targetName}`)).join(",");this._log._buildError(`The runtimeOS configuration of the target ${t} does not match ${o}`)._file(this.moduleModel.getProfilePath())._printErrorAndExit(this.moduleModel.getName())}}}checkModuleType(){if(this.moduleModel.getApiType()===hap_extra_info_js_1.ApiType.FA||!this.moduleModel.isHarModule()||this.projectModel.isOhpmProject())return;const e=this.moduleModel.getPackageJsonPath(),t=common_const_js_1.CommonConst.PACKAGE_JSON;"module"===hvigor_1.Json5Reader.getJson5Obj(e).type||this._log._buildError(`Invalid module type! Please check the ${t} of current library module.`)._file(e)._detail('Set \'{ "type": "module" }\'.')._record()}exitOnError(){this._log._printAllExit()}}exports.ModuleInspection=ModuleInspection;