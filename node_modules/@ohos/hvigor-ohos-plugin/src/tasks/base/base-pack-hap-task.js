"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,a)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.packageHapDepends=exports.BasePackHapTask=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),const_1=require("@ohos/hvigor/src/common/const/const"),hvigor_config_loader_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../../builder/inner-java-command-builder/packing-tool-options.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),aot_compile_mode_enum_js_1=require("../../enum/aot-compile-mode-enum.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),module_type_enum_1=require("../../enum/module-type-enum"),inject_util_js_1=require("../../utils/inject-util.js"),integrated_hsp_utils_js_1=require("../../utils/integrated-hsp-utils.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),process_utils_js_1=require("../../utils/process-utils.js"),abstract_merge_profile_js_1=require("../abstract-merge-profile.js"),cache_native_libs_js_1=require("../cache-native-libs.js"),task_names_js_1=require("../common/task-names.js"),generate_metadata_js_1=require("../generate-metadata.js"),make_pack_info_js_1=require("../make-pack-info.js"),process_integrated_hsp_js_1=require("../process-integrated-hsp.js"),process_router_map_js_1=require("../process-router-map.js"),module_task_service_js_1=require("../service/module-task-service.js"),syscap_transform_js_1=require("../syscap-transform.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET;class BasePackHapTask extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t,s,o){var a,i;super(e,t),this.allPackInfoPath=[],this.allOutPath=[],this._log=ohos_logger_js_1.OhosLogger.getLoggerWithDurationId("base-pack-hap-task",this.durationEvent.getId()),this.mode=s;const r=this.targetService.getTargetData(),n=r.getPathInfo();this.libPath=n.getIntermediatesStrippedLibsDir(),this.jsonPath=path_1.default.resolve(n.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),this.packageHapJsonPath=path_1.default.resolve(this.pathInfo.getPackageHapProductPath(),common_const_js_1.CommonConst.MODULE_JSON),this.pkgContextInfoPath=path_1.default.resolve(this.pathInfo.getIntermediatesLoaderPath(),common_const_js_1.CommonConst.PKG_CONTEXT_INFO_JSON),this.resourcePath=path_1.default.resolve(n.getIntermediatesRes(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),this.indexPath=path_1.default.resolve(n.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_INDEX),this.rpcidSc=path_1.default.resolve(n.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC),this.jsAssetsPath=path_1.default.resolve(n.getInterMediatesLoaderOutPath(),code_type_enum_js_1.CodeType.JS),this.etsAssetsPath=path_1.default.resolve(n.getInterMediatesLoaderOutPath(),code_type_enum_js_1.CodeType.ETS),this.nodeModulesPath=path_1.default.resolve(n.getInterMediatesLoaderOutPath(),common_const_js_1.CommonNodeConst.NODE_MODULES),this.syscapJsonPath=path_1.default.resolve(null===(a=this.moduleModel)||void 0===a?void 0:a.getSourceRootByTargetName(this.targetName),common_const_js_1.CommonConst.SYSCAP_JSON),this.anBuildOutputPath=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),aot_compile_mode_enum_js_1.AotCompileModeEnum.AN),this.moduleBuildOpt=this.moduleModel.getProfileOpt(),this.buildOption=this.targetService.getBuildOption(),this.apDirPath=this.pathInfo.getIntermediatesApPath(),this.integratedHsp=this.moduleModel.isHspModule()&&!!(null===(i=this.targetService.getBuildOption().arkOptions)||void 0===i?void 0:i.integratedHsp);const _=this.integratedHsp?n.getIntegratedHspOutputPath():n.getModuleBuildOutputPath();fse.existsSync(_)||fse.mkdirSync(_,{recursive:!0});const d=this.service.getRelatedEntryModules(),l=this.service.getModuleModel().getModuleType();if(module_task_service_js_1.ModuleTaskService.checkEntryModules(l,d))for(const e of d)this.module.findModuleByName(e)&&(this.allPackInfoPath.push(path_1.default.resolve(n.getModuleBuildOutputPath(),e,build_directory_const_js_1.BuildArtifactConst.PACK_INFO)),this.allOutPath.push(path_1.default.resolve(_,r.getModuleTargetOutputFileName(e,!1))));else this.allPackInfoPath.push(path_1.default.resolve(n.getModuleBuildOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO)),this.allOutPath.push(path_1.default.resolve(_,r.getModuleTargetOutputFileName("",!1,this.getSuffix())))}declareExecutionTool(){return this.sdkInfo.getPackageTool()}declareExecutionCommand(){const e=[];for(let t=0;t<this.allPackInfoPath.length;t++)e.push(this.generateCommand(this.allPackInfoPath[t],this.allOutPath[t]).toString());return e.join()}declareInputFiles(){const e=(new hvigor_1.FileSet).addEntries([this.libPath,this.jsonPath,this.resourcePath,this.indexPath,...this.allPackInfoPath],{isDirectory:!1});fse.existsSync(this.rpcidSc)&&e.addEntry(this.rpcidSc,{isDirectory:!1}),fse.existsSync(this.jsAssetsPath)&&e.addEntry(this.jsAssetsPath,{isDirectory:!1}),fse.existsSync(this.etsAssetsPath)&&e.addEntry(this.etsAssetsPath,{isDirectory:!1}),fse.existsSync(this.nodeModulesPath)&&e.addEntry(this.nodeModulesPath,{isDirectory:!0}),fse.existsSync(this.pkgContextInfoPath)&&e.addEntry(this.pkgContextInfoPath,{isDirectory:!1});const t=this.targetService.getTargetData().getTargetName(),s=this.pathInfo.getGenerateBuildProfilePath(t);return fse.existsSync(s)&&e.addEntry(s),e}declareOutputFiles(){var e;const t=(new hvigor_1.FileSet).addEntries([...this.allOutPath],{isDirectory:!1});if(this.integratedHsp&&this.allOutPath.forEach((e=>{t.addEntry(path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),path_1.default.basename(e)),{isDirectory:!1})})),(null===(e=this.buildOption)||void 0===e?void 0:e.debuggable)&&this.sdkInfo.hasRollUpPluginInEtsLoader)if(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]){const e=this.getSourceMapPath(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]);t.addEntry(path_1.default.resolve(e,this.moduleName,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),{isDirectory:!1})}else t.addEntry(path_1.default.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP));return t}declareInputs(){var e,t,s;const o=(new Map).set("hotReload",inject_util_js_1.InjectUtil.isHotReload()).set(build_directory_const_js_1.BuildDirConst.INTEGRATED_HSP,this.integratedHsp).set(abstract_merge_profile_js_1.INPUT_KEY.projectConfigAppOpt,JSON.stringify(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.signingConfig));return this.moduleModel.getModuleType()!==module_type_enum_1.ModuleType.Har&&(null===(t=this.buildOption)||void 0===t?void 0:t.debuggable)&&o.set("sourceMapDir",null!==(s=hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR])&&void 0!==s?s:""),o}async doTaskAction(){for(let e=0;e<this.allPackInfoPath.length;e++)await this.executeCommandList(this.allPackInfoPath[e],this.allOutPath[e]);this.moveSourceMap()}async executeCommandList(e,t){const s=this.durationEvent.createSubEvent("generate HAP packaging command","");s.start(),this.checkCompressNativeLib();const o=this.generateCommand(e,t);this._log._printDebugCommand(this.sdkInfo.getPackageTool(),o);const a={moduleName:this.moduleName,taskName:this.name,commandLine:o,integratedHspCommand:this.integratedHsp?(0,integrated_hsp_utils_js_1.generateIntegratedHspCommand)(this.projectModel,this.sdkInfo.getPackageTool(),t,this.pathInfo.getModuleBuildOutputPath()):void 0};s.stop(),s.setLog(s.getName(),hvigor_1.MetricLogType.INFO);const i="submit HAP packaging task to work pool",r=this.durationEvent.createSubEvent(i,"");r.start(),await new process_utils_js_1.ProcessUtils(a.moduleName,a.taskName).submitExecutionWithoutReturn(this,this.getWorkerPool(),a,wdk_1.noop,[],r),r.stop(),r.setLog(i,hvigor_1.MetricLogType.INFO)}checkCompressNativeLib(){this.moduleModel;const e=hvigor_config_loader_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.HvigorConfigConst.OHOS_PACK_COMPRESS_LEVEL);if(e&&fse.existsSync(path_1.default.resolve(this.pathInfo.getModulePath(),"libs"))){const t=common_const_js_1.HvigorConfigConst.OHOS_PACK_COMPRESS_LEVEL_MAP.get(e);if(this.compileApiVersion<12)return void this._log.warn(`Invalid ohos.pack.compressLevel configuration, ohos.pack.compressLevel configuration \n      minimum requirement is api 12 version of the project, your project is api ${this.compileApiVersion} project`);t||this._log.warn(`invalid ohos.pack.compress parameter:${e}\n      ,It won't work, the packing will follow the fast compression level.`)}}generateCommand(e,t){var s,o;const a=new packing_tool_options_js_1.PackingToolOptions;a.addCalledJarFile(this.sdkInfo.getPackageTool()),a.addMode(this.mode).force(!0).addLibPath(this.libPath).addJsonPath(this.packageHapJsonPath).addResourcesPath(this.resourcePath).addIndexPath(this.indexPath).addPackInfoPath(e).addOutPath(t);const i=hvigor_config_loader_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.HvigorConfigConst.OHOS_PACK_COMPRESS_LEVEL);return i&&fse.existsSync(path_1.default.resolve(this.pathInfo.getModulePath(),"libs"))&&a.addCompressLevel(i,this.moduleModel,this.compileApiVersion),this.targetService.getAnBuildMode()&&(fse.existsSync(this.anBuildOutputPath)&&a.addAnPath(this.anBuildOutputPath),fse.existsSync(this.apDirPath)&&a.addDirList([this.apDirPath])),fse.existsSync(this.rpcidSc)&&a.addSysCapPath(this.rpcidSc),fse.existsSync(this.jsAssetsPath)&&a.addJsPath(this.jsAssetsPath),fse.existsSync(this.etsAssetsPath)&&a.addEtsPath(this.etsAssetsPath),fse.existsSync(this.nodeModulesPath)&&a.addDirList([this.nodeModulesPath]),fse.existsSync(this.pkgContextInfoPath)&&(null===(o=null===(s=this.targetService.getBuildOption())||void 0===s?void 0:s.strictMode)||void 0===o?void 0:o.useNormalizedOHMUrl)&&a.addPkgContextInfoPath(this.pkgContextInfoPath),a.build()}getSuffix(){switch(this.mode){case"hap":default:return build_directory_const_js_1.BuildArtifactExtension.DOT_HAP;case"hsp":return build_directory_const_js_1.BuildArtifactExtension.DOT_HSP}}moveSourceMap(){var e;if(!this.sdkInfo.hasRollUpPluginInEtsLoader&&!(null===(e=this.buildOption)||void 0===e?void 0:e.debuggable))return;const t=path_1.default.resolve(this.etsAssetsPath,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP);if(fse.existsSync(t))if(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]){const e=this.getSourceMapPath(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]);fse.ensureDirSync(path_1.default.resolve(e,this.moduleName)),fse.copyFileSync(t,path_1.default.resolve(e,this.moduleName,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP))}else fse.ensureDirSync(this.pathInfo.getDefaultSourceMapPath()),fse.copyFileSync(t,path_1.default.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP))}initTaskDepends(){this.declareDependsList(make_pack_info_js_1.MakePackInfo.name,cache_native_libs_js_1.CacheNativeLibs.name,generate_metadata_js_1.GenerateMetadata.name),this.declareDepends(syscap_transform_js_1.SyscapTransform.name),this.declareDepends(process_router_map_js_1.ProcessRouterMap.name);const e=fse.existsSync(path_1.default.resolve(this.sdkInfo.getEtsLoader(),sdk_const_js_1.ToolChainsConst.ROLL_UP_CONFIG_FILE)),t=fse.existsSync(path_1.default.resolve(this.sdkInfo.getJsLoader(),sdk_const_js_1.ToolChainsConst.ROLL_UP_CONFIG_FILE));if(this._log.debug("initTaskDepends:",`moduleName=${this.moduleName}, taskName=${this.name}, useRollupETS=${e}, useRollupJS=${t}`),inject_util_js_1.InjectUtil.isHotReload()||inject_util_js_1.InjectUtil.isColdReload())return e&&this.declareDepends(inject_util_js_1.InjectUtil.isHotReload()?"HotReloadArkTS":"ColdReloadArkTS"),void(t?this.declareDepends("CompileJS"):this.declareDepends("BuildJS"));const s=this.targetName===ohosTestTargetName?"OhosTest":"";this.targetName===ohosTestTargetName&&this.declareDepends(task_names_js_1.TaskNames.Task.OHOS_TEST_COPY_MOCK_CONFIG_JSON.name),this.declareDepends(this.sdkInfo.hasRollUpPluginInEtsLoader?`${s}CompileArkTS`:`${s}BuildArkTS`),this.declareDepends(this.sdkInfo.hasRollUpPluginInJsLoader?`${s}CompileJS`:`${s}BuildJS`)}getSourceMapPath(e){return path_1.default.isAbsolute(e)?e:path_1.default.resolve(this.projectModel.getProjectDir(),"hvigor",e)}}exports.BasePackHapTask=BasePackHapTask;const packageHapDepends=e=>{const t=[make_pack_info_js_1.MakePackInfo.name,cache_native_libs_js_1.CacheNativeLibs.name,generate_metadata_js_1.GenerateMetadata.name],s=e.getTargetData(),o=e.getSdkInfo();if(t.push(syscap_transform_js_1.SyscapTransform.name),t.push(process_router_map_js_1.ProcessRouterMap.name),inject_util_js_1.InjectUtil.isHotReload()||inject_util_js_1.InjectUtil.isColdReload())return o.hasRollUpPluginInEtsLoader&&t.push(inject_util_js_1.InjectUtil.isHotReload()?"HotReloadArkTS":"ColdReloadArkTS"),t.push(o.hasRollUpPluginInJsLoader?"CompileJS":"BuildJS"),t;s.getTargetName()===ohosTestTargetName&&t.push(task_names_js_1.TaskNames.Task.OHOS_TEST_COPY_MOCK_CONFIG_JSON.name);const a=s.getTargetName()===ohosTestTargetName?"OhosTest":"";return t.push(o.hasRollUpPluginInEtsLoader?`${a}CompileArkTS`:`${a}BuildArkTS`),t.push(o.hasRollUpPluginInJsLoader?`${a}CompileJS`:`${a}BuildJS`),t.push(process_integrated_hsp_js_1.ProcessIntegratedHsp.name),t};exports.packageHapDepends=packageHapDepends;