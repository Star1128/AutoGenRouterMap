"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReplacePreviewerPage=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),inject_const_js_1=require("../../const/inject-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),file_util_js_1=require("../../utils/file-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_names_js_1=require("../common/task-names.js"),preview_hook_compile_resource_js_1=require("../hook/preview-hook-compile-resource.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const json_util_js_1=require("../../utils/json-util.js"),copy_preview_profile_js_1=require("./copy-preview-profile.js");class ReplacePreviewerPage extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,CommonTask.REPLACE_PREVIEWER_PAGES),this._log=ohos_logger_js_1.OhosLogger.getLogger(ReplacePreviewerPage.name)}initTaskDepends(){this.declareDepends(preview_hook_compile_resource_js_1.PreviewHookCompileResource.name);"true"===hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_COMPILE_RES_INC)&&this.declareDepends(copy_preview_profile_js_1.CopyPreviewProfile.name)}doTaskAction(){this.processPreviewProfile(this._log)}processPreviewProfile(e){this.appendMainPages();let o=!0;if(hvigor_1.hvigorCore.getExtraConfig().get("compileHspDependencies")){const e=hvigor_1.hvigorCore.getExtraConfig().get("mainModule"),s=this.targetData.getModuleModel();s.getName()!==e&&s.getModuleType()===module_type_enum_js_1.ModuleType.Shared&&(o=!1)}o&&this.replacePreviewPage(e)}replacePreviewPage(e){const o=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_REPLACE_PAGE);return!!o&&(this.replacePagesInPreview(e,[o]),!0)}appendMainPages(){if(this.moduleModel.getModuleType()!==module_type_enum_js_1.ModuleType.Shared)return;const e=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),o=(0,json_util_js_1.getJson5Obj)(e);Object.assign(o.module,{pages:"$profile:main_pages"});const s=this.pathInfo.getPreviewIntermediatesResModuleJsonPath();file_util_js_1.FileUtil.checkFile(s),fs_extra_1.default.writeJSONSync(s,o)}}exports.ReplacePreviewerPage=ReplacePreviewerPage;