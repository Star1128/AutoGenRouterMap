"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a);var r=Object.getOwnPropertyDescriptor(t,a);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,r)}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageSharedTgz=void 0;const task_names_1=require("../common/task-names"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");var Task=task_names_1.TaskNames.Task;const hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),tar_1=__importDefault(require("tar")),build_directory_const_js_1=require("../../const/build-directory-const.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),package_shared_har_js_1=require("./package-shared-har.js"),sign_hsp_js_1=require("./sign-hsp.js");class PackageSharedTgz extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t,a;super(e,Task.PACKAGE_SHARED_TGZ),this.RELEASE="Release",this._log=ohos_logger_js_1.OhosLogger.getLogger(PackageSharedTgz.name),this._taskService=e,this.outputDir=this.pathInfo.getModuleBuildOutputPath(),this.isRelease=e.getBuildMode()===this.RELEASE,this.tgzOutPath=path_1.default.resolve(this.outputDir,this.targetData.getModuleTargetOutputFileName("",!1,build_directory_const_js_1.BuildArtifactExtension.DOT_TGZ)).replace("-unsigned","");const s=null===(t=this.targetData.getTargetOpt().output)||void 0===t?void 0:t.artifactName,r=s?`${s}`:`${this.moduleName}`;this.sharedHspName=this.targetData.getModuleTargetOutputFileName("",!1,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP),this.sharedHspRename=this.sharedHspName.replace("-unsigned",""),this.sharedHarName=`${r}.har`,this.tempSharedHspPath=path_1.default.resolve(this.pathInfo.getIntermediatesTemp(),this.sharedHspRename),this.tempSharedHarPath=path_1.default.resolve(this.pathInfo.getIntermediatesTemp(),this.sharedHarName);const i=!!(null===(a=this.targetService.getBuildOption().arkOptions)||void 0===a?void 0:a.integratedHsp);this.sharedHspPath=path_1.default.resolve(i?this.pathInfo.getIntegratedHspOutputPath():this.outputDir,this.sharedHspName),this.sharedHarPath=path_1.default.resolve(this.outputDir,this.sharedHarName)}declareInputFiles(){const e=new hvigor_1.FileSet;return fse.existsSync(this.sharedHspPath)&&e.addEntry(this.sharedHspPath),fse.existsSync(this.sharedHarPath)&&e.addEntry(this.sharedHarPath),e}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.tgzOutPath,{isDirectory:!1})}initTaskDepends(){const e=`${this._taskService.getTargetData().getTargetName()}@${sign_hsp_js_1.SignHsp.name}`,t=`${this._taskService.getTargetData().getTargetName()}@${package_shared_har_js_1.PackageSharedHar.name}`;this.declareDepends(e),this.declareDepends(t)}async doTaskAction(){this.isRelease&&await this.buildTgzPackage()}async buildTgzPackage(){this.copyTempFiles(this.sharedHspPath,this.tempSharedHspPath),this.copyTempFiles(this.sharedHarPath,this.tempSharedHarPath),await tar_1.default.create({cwd:this.pathInfo.getIntermediatesTemp(),noDirRecurse:!1,file:this.tgzOutPath,gzip:!0},[this.sharedHspRename,this.sharedHarName]),this.removeTempFiles()}copyTempFiles(e,t){fse.existsSync(e)||this._log.errorMessageExit(`${e} is not exist, Failed to pack the tgz package.`),fse.existsSync(this.pathInfo.getIntermediatesTemp())||fse.mkdirsSync(this.pathInfo.getIntermediatesTemp()),fse.copyFileSync(e,t)}removeTempFiles(){fse.removeSync(this.tempSharedHspPath),fse.removeSync(this.tempSharedHarPath)}}exports.PackageSharedTgz=PackageSharedTgz;