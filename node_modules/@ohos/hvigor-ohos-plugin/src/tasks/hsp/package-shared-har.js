"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(e,s);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,a,i)}:function(t,e,s,a){void 0===a&&(a=s),t[a]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageSharedHar=void 0;const hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),npm_command_builder_js_1=require("../../builder/npm-command-builder.js"),log_combine_type_js_1=require("../../utils/log/log-combine-type.js"),npm_utils_js_1=require("../../utils/npm-utils.js"),process_utils_js_1=require("../../utils/process-utils.js"),task_names_js_1=require("../common/task-names.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;class PackageSharedHar extends ohos_hap_task_js_1.OhosHapTask{constructor(t){super(t,Task.PACKAGE_SHARED_HAR),this.taskTmpDir=this.getTaskTempDir(this.targetData,"shared_har",!1),this.npmPath=path_1.default.dirname((0,npm_utils_js_1.getNpmPath)()),this.npmCommand=new npm_command_builder_js_1.NpmCommandBuilder(this.npmPath).addAllParams(["pack"]),this.outputDir=this.pathInfo.getModuleBuildOutputPath()}declareExecutionCommand(){return`${this.npmCommand.toString()}`}declareExecutionEnv(){const t=new Map;return fs.existsSync(this.taskTmpDir)&&t.set("cwd",this.taskTmpDir),t}declareInputs(){return super.declareInputs().set("isOhpmProject",this.isOhpmProject)}declareInputFiles(){const t=super.declareInputFiles();return fs.existsSync(this.taskTmpDir)&&t.addEntry(this.taskTmpDir,{isDirectory:!0}),t}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.outputDir,{isDirectory:!0})}initTaskDepends(){this.declareDepends(Task.PREPARE_SHARED_HAR_RES.name)}async doTaskAction(){this.isOhpmProject?await this.executeOhpmPack():await this.executeNpmPack()}async executeNpmPack(){const t="generate npm packaging command",e=this.durationEvent.createSubEvent(t,"");e.start();const s={moduleName:this.moduleName,taskName:this.name,commandLine:this.npmCommand,commandOptions:{cwd:this.taskTmpDir}},a=t=>{fs.copySync(this.taskTmpDir,this.outputDir,{filter:e=>!fs.lstatSync(e).isDirectory()&&e.endsWith(t)||e===this.taskTmpDir})};e.stop(),e.setLog(t,hvigor_1.MetricLogType.INFO);const i="submit npm packaging task to work pool",r=this.durationEvent.createSubEvent(i,"");if(r.start(),!new process_utils_js_1.ProcessUtils(this.moduleName,this.name).submitSyncExecutionWithReturn(this,this.getWorkerPool(),"packageHar",s,a)){const t="execute npm packaging command",e=r.createSubEvent(t,"");e.start();const i=await new process_utils_js_1.ProcessUtils(this.moduleName,this.name).execute(s.commandLine,s.commandOptions,log_combine_type_js_1.LogCombineType.DEBUG);e.stop(),e.setLog(t,hvigor_1.MetricLogType.INFO),a(i.stdout.toString())}r.stop(),r.setLog(i,hvigor_1.MetricLogType.INFO)}async executeOhpmPack(){var t;const e=null===(t=this.targetData.getTargetOpt().output)||void 0===t?void 0:t.artifactName,s=e?`${e}`:`${this.moduleName}`;await(0,npm_utils_js_1.execOhpmPack)(this.taskTmpDir,path_1.default.resolve(this.outputDir,`${s}.har`),this.durationEvent)}}exports.PackageSharedHar=PackageSharedHar;