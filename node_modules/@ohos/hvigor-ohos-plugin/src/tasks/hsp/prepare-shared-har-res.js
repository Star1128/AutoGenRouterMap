"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrepareSharedHarRes=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js"),cmake_util_js_1=require("../../utils/cmake-util.js"),file_util_js_1=require("../../utils/file-util.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),npm_utils_js_1=require("../../utils/npm-utils.js"),task_names_js_1=require("../common/task-names.js"),har_extend_info_1=require("../har/har-extend-info"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;const _log=ohos_logger_js_1.OhosLogger.getLogger("PrepareSharedHarRes"),DECLARE_FILE_OUTPUT=build_directory_const_js_1.BuildDirConst.DECLARE_FILE_OUTPUT,REGEX_ETS=/(.+)\.ets$/,REGEX_TS=/(.+)\.ts$/,REGEX_D=/(.+)\.d$/;class PrepareSharedHarRes extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t;super(e,Task.PREPARE_SHARED_HAR_RES),this.INTERFACE_HAR="InterfaceHar",this.ignoreFileList=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,common_const_js_1.CommonConst.OH_MODULES,".cxx",".previewer",".hvigor",".gitignore",".ohpmignore"],this.allInvalidPrefix=[];const s=path_1.default.relative(this.projectModel.getProjectDir(),this.moduleModel.getProjectDir());this.inputPackageJson5Path=e.getTargetData().getModuleModel().getOhPackageJson5Path(),this.inputModuleJsonPath=this.pathInfo.getIntermediatesProcessProfile(),this.inputResourceStr=this.pathInfo.getResourceStr(),this.inputDeclareFilesPath=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),DECLARE_FILE_OUTPUT,s),this.headerPath=null===(t=this.targetService.getBuildOption().nativeLib)||void 0===t?void 0:t.headerPath,this.libsPath=this.pathInfo.getIntermediatesStrippedLibsDir(),this.taskTmpDir=this.getTaskTempDir(this.targetData,"shared_har",!1),this.outputPackageJsonPath=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.taskTmpDir,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)),this.outputModuleJsonPath=path_1.default.resolve(this.taskTmpDir,"src","main",common_const_js_1.CommonConst.MODULE_JSON),this.outputResourceStr=path_1.default.resolve(this.taskTmpDir,"src","main","resource"),this.outputDeclareFilesPath=this.taskTmpDir,this._moduleDir=this.moduleModel.getProjectDir(),this.initAllInvalidPrefix(),this._harExtendInfo=new har_extend_info_1.HarExtendInfo(this.moduleModel,e.getBuildOption()),this.hasNativeOption=this._harExtendInfo.hasConfiguredNativeOption(),this.cmakeListDir=cmake_util_js_1.CmakeUtil.getCmakeListDir(this._moduleDir,this.targetService.getBuildOption().externalNativeOptions)}declareInputs(){var e;const t=new Map;return this.packageJsonObj&&t.set("modulePackageJsonObj",JSON.stringify(this.packageJsonObj)),t.set("integratedHsp",!!(null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.integratedHsp)),t.set(common_const_js_1.CommonConst.KEEP_DEPENDENCY,!!hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.KEEP_DEPENDENCY)),t}declareInputFiles(){const e=this.allInvalidPrefix.join("|").replace(/\\/g,"\\\\"),t=RegExp(`^(?!${e}).*`),s=super.declareInputFiles().addEntry(this.inputPackageJson5Path).addEntry(this.inputModuleJsonPath).addEntry(this._moduleDir,{isDirectory:!0,test:t}).addEntry(this.libsPath);if(fs_extra_1.default.existsSync(this.inputDeclareFilesPath)&&s.addEntry(this.inputDeclareFilesPath,{isDirectory:!0}),fs_extra_1.default.existsSync(this.inputResourceStr)&&s.addEntry(this.inputResourceStr),this.headerPath){const e=path_1.default.isAbsolute(this.headerPath)?this.headerPath:path_1.default.resolve(this._moduleDir,this.headerPath);fs_extra_1.default.existsSync(e)&&s.addEntry(e)}return s}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.taskTmpDir,{isDirectory:!0})}initTaskDepends(){this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET?this.declareDepends("OhosTestCompileArkTS"):this.declareDepends("CompileArkTS"),this.declareDepends(task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP.name)}async doTaskAction(){this.preCheckBeforePack(),this.copyLocalDepsFileToTempDir(),file_util_js_1.FileUtil.copySpecialFileToTempDir(this.moduleModel.getProjectDir(),this.taskTmpDir),fs_extra_1.default.existsSync(this.inputDeclareFilesPath)&&fs_extra_1.default.copySync(this.inputDeclareFilesPath,this.outputDeclareFilesPath),this.generatePackageJson(),this.generateModuleJson(),this.copyResourcesTxt(),this.initRes(),await this.syncNative()}copyResourcesTxt(){const e=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT);fs_extra_1.default.existsSync(e)&&fs_extra_1.default.copySync(e,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT))}async syncNative(){if(this.headerPath){const e=path_1.default.isAbsolute(this.headerPath)?this.headerPath:path_1.default.resolve(this._moduleDir,this.headerPath);cmake_util_js_1.CmakeUtil.checkNativeHeader(e,this.moduleModel),fs_extra_1.default.existsSync(e)&&await fs_extra_1.default.copy(e,path_1.default.resolve(this.taskTmpDir,"include"),{recursive:!0})}fs_extra_1.default.existsSync(this.libsPath)&&fs_extra_1.default.readdirSync(this.libsPath).length>0&&await fs_extra_1.default.copy(this.libsPath,path_1.default.resolve(this.taskTmpDir,"libs"),{recursive:!0})}generatePackageJson(){var e,t,s,i;let a=this.packageJsonObj;a.types=this.getTypesFieldFromMainField(a.main),a.main=void 0,a.packageType&&a.packageType!==this.INTERFACE_HAR&&_log.warn("share library packageType in oh-package.json should use InterfaceHar"),a.packageType||(a.packageType=this.INTERFACE_HAR);const r=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl,o=path_1.default.relative(this.pathInfo.getModuleBuildPath(),this.pathInfo.getGenerateBuildProfileDir()),n=[...(null===(s=this.targetData.getTargetOpt().source)||void 0===s?void 0:s.sourceRoots)||[],`./${build_directory_const_js_1.BuildDirConst.SRC}/${build_directory_const_js_1.BuildDirConst.MAIN}`,`./${this.pathInfo.getBuildRoot()}/${o.replace(/\\/g,"/")}/${this.targetName}`],l=null===(i=this.targetService.getBuildOption().arkOptions)||void 0===i?void 0:i.integratedHsp;a.metadata?Object.assign(a.metadata,{useNormalizedOHMUrl:r,integratedHsp:l,sourceRoots:n}):Object.assign(a,{metadata:{useNormalizedOHMUrl:r,integratedHsp:l,sourceRoots:n}}),!0!==hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.KEEP_DEPENDENCY)&&(a.dependencies=this.getDependenciesWithoutHar(dependency_interface_js_1.DependencyEnum.DEPENDENCIES),a.dynamicDependencies=this.getDependenciesWithoutHar(dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES),a.devDependencies&&delete a.devDependencies);const d=cmake_util_js_1.CmakeUtil.getHarExtraParams(this);a=file_util_js_1.FileUtil.mergeExtraParamsToOhPack(a,d,this.targetName),fs_extra_1.default.outputJsonSync(this.outputPackageJsonPath,a,{encoding:"utf8",spaces:"  "})}getDependenciesWithoutHar(e){const t={},s=this.service.getHspDependencies().filter((t=>t.getDependencyEnum()===e));return 0===s.length?{}:(s.forEach((e=>{const s=e.getDependencyName();t[s]=file_util_js_1.FileUtil.extracted(e.getDependedVersion(),this.moduleModel.getParentProject().getParameterFileObj(),this.moduleModel.getParentProject().getParameterFileAbsolutePath())})),t)}copyLocalDepsFileToTempDir(){(0,npm_utils_js_1.collectLocalFileDependency)(this.inputPackageJson5Path,this.packageJsonObj).forEach((e=>{fs_extra_1.default.pathExistsSync(path_1.default.resolve(this.moduleModel.getProjectDir(),e))&&fs_extra_1.default.copySync(path_1.default.resolve(this.moduleModel.getProjectDir(),e),path_1.default.resolve(this.taskTmpDir,e))}))}generateModuleJson(){var e;const t=fs_extra_1.default.readJsonSync(this.inputModuleJsonPath,{encoding:"utf8"});let s=t.app.bundleName;const i=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.integratedHsp;this.moduleModel.isHspModule()&&i&&(s=""),t.app={bundleName:s,bundleType:t.app.bundleType,debug:t.app.debug,versionCode:t.app.versionCode,versionName:t.app.versionName,minCompatibleVersionCode:t.app.minCompatibleVersionCode,minAPIVersion:t.app.minAPIVersion,targetAPIVersion:t.app.targetAPIVersion,apiReleaseType:t.app.apiReleaseType},t.module={name:t.module.name,type:t.module.type,deliveryWithInstall:t.module.deliveryWithInstall,deviceTypes:t.module.deviceTypes,requestPermissions:t.module.requestPermissions,dependencies:t.module.dependencies,libIsolation:t.module.libIsolation},fs_extra_1.default.outputJsonSync(this.outputModuleJsonPath,t,{encoding:"utf8"})}getTypesFieldFromMainField(e){return void 0===e?"./src/main/ets/index.d.ets":REGEX_ETS.test(e)?e.replace(REGEX_ETS,"$1.d.ets"):REGEX_TS.test(e)?e.replace(REGEX_TS,"$1.d.ts"):REGEX_D.test(e)?e:`${e}.d`}preCheckBeforePack(){const e=this.moduleModel.getOhPackageJson5Path(),t=this.packageJsonObj;return(0,npm_utils_js_1.checkHasLocalFileDependency)(e,t)&&_log._buildError(`Local dependencies detected during har packing of module ${this.moduleName}. Declaring local dependencies in har module might cause failing during install har package.`)._detail("Check oh-package.json5 file of current shared library module and replace the local dependencies.")._file(e)._printWarn(this.moduleName),fs_extra_1.default.emptyDirSync(this.taskTmpDir),!0}initAllInvalidPrefix(){for(const e of this.ignoreFileList)this.allInvalidPrefix.push(path_1.default.resolve(this._moduleDir,e))}initRes(){fs_extra_1.default.existsSync(this.pathInfo.getResourceStr())&&fs_extra_1.default.copySync(this.inputResourceStr,this.outputResourceStr)}}exports.PrepareSharedHarRes=PrepareSharedHarRes;