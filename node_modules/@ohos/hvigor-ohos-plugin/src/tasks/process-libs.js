"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,i){void 0===i&&(i=s);var r=Object.getOwnPropertyDescriptor(e,s);r&&!("get"in r?!e.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,i,r)}:function(t,e,s,i){void 0===i&&(i=s),t[i]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)"default"!==s&&Object.prototype.hasOwnProperty.call(t,s)&&__createBinding(e,t,s);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessLibs=void 0;const hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),cmake_util_js_1=require("../utils/cmake-util.js"),file_util_js_1=require("../utils/file-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),build_native_with_ninja_js_1=require("./build-native-with-ninja.js");var Task=task_names_js_1.TaskNames.Task;const ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_libs_js_1=require("./worker/process-libs.js");class ProcessLibs extends ohos_hap_task_js_1.OhosHapTask{constructor(t){var e;super(t,Task.PROCESS_LIB),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ProcessLibs.name);const s=t.getTargetData().getPathInfo();this._moduleDir=this.moduleModel.getProjectDir(),this.hapLocalLibs=path_1.default.resolve(this._moduleDir,build_directory_const_js_1.BuildDirConst.LIBS),this.collectAllLibs=!!(null===(e=this.targetService.getBuildOption().nativeLib)||void 0===e?void 0:e.collectAllLibs),this.libsPattern=this.collectAllLibs?common_const_js_1.NativeConst.LIBRARY_ALL_FILE_PATTERN:common_const_js_1.NativeConst.LIBRARY_FILE_PATTERN,this.allHarLibs=this.getAllHarLibs(),this.libsWithPkg=this.getHarLibsWithPkg(),this.libsOutputDir=s.getIntermediatesProcessLibs(),this.localOutput=s.getIntermediatesCppOutPut(),this._nativeOption=t.getBuildOption().externalNativeOptions,this.hasLocalNativeOutput=cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this._nativeOption),this.filterRule=t.getNativeLibOption().filter,this.cangjieLibs=path_1.default.resolve(s.getIntermediatesCangjieOutPut())}async beforeAlwaysAction(){this.service.isFaMode()&&(this.allHarLibs=this.getAllHarLibs(),this.libsWithPkg=this.getHarLibsWithPkg()),this.hasLocalNativeOutput&&(this.localOutputHash=await file_util_js_1.FileUtil.hashEntry(this.localOutput))}declareInputs(){const t=super.declareInputs();return void 0!==this.filterRule&&Object.entries(this.filterRule).filter((([,t])=>!!t)).forEach((([e,s])=>t.set(e,s))),this.hasLocalNativeOutput&&this.localOutputHash&&this.localOutputHash.forEach(((e,s)=>t.set(path_1.default.relative(this.localOutput,s),e))),t}declareInputFiles(){const t=new hvigor_1.FileSet;fs.existsSync(this.hapLocalLibs)&&t.addEntry(this.hapLocalLibs,{isDirectory:!0});for(const e of this.allHarLibs.keys())fs.existsSync(e)&&t.addEntry(e);return fs.existsSync(this.projectModel.getProfilePath())&&t.addEntry(this.projectModel.getProfilePath()),fs.existsSync(this.moduleModel.getProfilePath())&&t.addEntry(this.moduleModel.getProfilePath()),fs.existsSync(this.cangjieLibs)&&t.addEntry(this.cangjieLibs,{isDirectory:!0}),t}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.libsOutputDir,{isDirectory:!0})}initTaskDepends(){this.declareDepends(build_native_with_ninja_js_1.BuildNativeWithNinja.name)}async doTaskAction(){const t=path_1.default.resolve(__dirname,"./worker/process-libs.js/processLibs"),e=this.service.getDependencyInfo().getSelfAsDependency(),s={allHarLibs:this.libsWithPkg,outputDir:this.libsOutputDir,filterRule:this.filterRule,localLibs:(0,process_libs_js_1.buildLibs)(path_1.default.resolve(this._moduleDir,"libs"),e,this.libsPattern),outputLibs:(0,process_libs_js_1.buildLibs)(this.pathInfo.getIntermediatesCppOutPut(),e,this.libsPattern),profilePath:cmake_util_js_1.CmakeUtil.getMayBeOccurErrorsFilePath(this.moduleModel),moduleName:this.moduleName,cangjieLibs:(0,process_libs_js_1.buildLibs)(this.cangjieLibs,e,this.libsPattern),collectAllLibs:this.collectAllLibs},i={workInput:s};if(this.getWorkerPool().submit(this,t,i).getState()===hvigor_1.TaskState.REJECT){const t="process libs",e=this.durationEvent.createSubEvent(t,"");e.start(),this.logger.debug("Worker dispatch failed, running processLibs on main thread."),await(0,process_libs_js_1.processLibs)(s),e.stop(),e.setLog(t,hvigor_1.MetricLogType.INFO)}}getHarLibsWithPkg(){const t=[];for(const[e,s]of this.allHarLibs.entries())t.push(...(0,process_libs_js_1.buildLibs)(e,s,this.libsPattern));return t}getAllHarLibs(){const t=new Map;if(this.moduleModel.isHarModule()&&this.targetService.getTargetData().getTargetName()!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return t;const e=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService);for(const[s,i]of e){const e=this.projectModel.getTarget(s,i);if(e){const s=e.getTargetData().getPathInfo().getIntermediatesProcessLibs(),i=e.getModuleService().getDependencyInfo().getSelfAsDependency();t.set(s,i),t.set(i.getDefaultLibsDir(),i)}}return this.service.getHarDependencies().filter((t=>!t.isLocal())).forEach((e=>t.set(e.getDefaultLibsDir(),e))),t}}exports.ProcessLibs=ProcessLibs;