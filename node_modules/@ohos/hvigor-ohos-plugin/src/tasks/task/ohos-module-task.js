"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,i)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosModuleTask=void 0;const hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),trace_js_1=require("../../common/trace.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),error_util_js_1=require("../../error/error-util.js"),file_util_js_1=require("../../utils/file-util.js"),json_util_js_1=require("../../utils/json-util.js");class OhosModuleTask extends hvigor_1.IncrementalExecTask{constructor(e,t){super(e.getTargetData().getModuleModel().getModule(),e.buildTaskName(t)),this.paramWhiteList=["version","devDependencies","dynamicDependencies","dependencies"],this.registryAction=()=>async()=>{this.initTrace(),await this.beforeTask(),this.taskShouldDo()&&await this.doTaskAction()},this.module=e.getTargetData().getModuleModel().getModule(),this.moduleName=this.module.getName(),this.targetService=e,this.targetData=e.getTargetData(),this.service=e.getModuleService(),this.projectModel=this.service.getProjectModel(),this.moduleModel=this.service.getModuleModel(),this.sdkInfo=this.targetService.getSdkInfo(),this.isFaMode=this.service.isFaMode(),this.targetName=this.targetService.getTargetData().getTargetName(),this.pathInfo=e.getTargetData().getPathInfo(),this.compileApiVersion=this.targetData.getCompileApiVersion(),this.compatibleApiVersion=this.targetData.getCompatibleApiVersion(),this.targetSdkVersion=this.targetData.getTargetSdkVersion(),this.moduleModelNodePaths=new Set(this.projectModel.getAllModules().map((e=>e.getModule().getNodeDir()))),this.isOhpmProject=this.projectModel.isOhpmProject(),this.packageManagerPath=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath(),this.initHarModuleDepends(),hvigor_1.hvigor.nodesEvaluated((()=>{this.initTaskDependsForOtherModule()})),this.getWorkerPool().warmUp(common_const_js_1.CommonConst.WARM_UP_SCRIPT),this.shouldCloseWorkerPoolAfterBuild()&&this.getWorkerPool().setResident(!1);const s=this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath();if(this.packageJsonObj=hvigor_1.Json5Reader.getJson5Obj(s),this.isOhpmProject){const e=this.projectModel.getParameterFileObj();file_util_js_1.FileUtil.resolveJsonObjWithoutParam(this.packageJsonObj,e,this.projectModel.getParameterFileAbsolutePath(),this.paramWhiteList)}}shouldCloseWorkerPoolAfterBuild(){return(0,hvigor_1.isLinux)()||this.isFaMode||this.sdkInfo.isOhos||this.sdkInfo.getSdkVersion()<sdk_const_js_1.ApiVersion.API_VERSION_11}initTaskDependsForOtherModule(){}initHarModuleDepends(){}beforeTask(){}taskShouldDo(){return!0}onFailed(){let e="app";this.moduleModel.isHapModule()?e="hap":this.moduleModel.isHspModule()?e="hsp":this.moduleModel.isHarModule()&&(e="har"),(0,error_util_js_1.recordErrorCode)(this.moduleModel.getApiType(),e,this.getGroup()),trace_js_1.ohosTrace.setTaskName(this.getName()),trace_js_1.ohosTrace.traceToHvigor(!0)}initTrace(){trace_js_1.ohosTrace.traceToHvigor(),this.getWorkerPool().setErrorCallback((e=>{(0,error_util_js_1.recordDECE)(e)}))}getTaskTempDir(e,t,s=!0){const o=path_1.default.resolve(e.getPathInfo().getModuleBuildCachePath(),t||this.name);return s&&!fse.existsSync(o)&&fse.mkdirsSync(o),o}replacePagesInPreview(e,t){const s=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),o=(0,json_util_js_1.getJson5Obj)(s),i=path_1.default.resolve(this.projectModel.getProjectDir(),this.moduleModel.getName(),`src/main/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${build_directory_const_js_1.BuildArtifactConst.MAIN_PAGES_JSON}`);if(this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Shared&&!fse.existsSync(i)){const e=this.pathInfo.getPreviewIntermediatesMainPagesJsonPath();fse.writeJSONSync(e,{src:["pages/Index"]})}const r=`${o.module.pages.replace(/\$profile:/,"")}.json`,a=path_1.default.resolve(this.pathInfo.getIntermediatesResProfilePath(),r),n=fse.readJSONSync(a);n.src=t,e.debug(`Resolved file ${a}.`),e.debug(`Replace page to ${t}`),fse.outputJSONSync(a,n)}replacePages(e,t){const s={src:t},o=this.getPageJsonFileName(e),i=path_1.default.resolve(this.pathInfo.getIntermediatesResProfilePath(),o);e.debug(`Resolved file ${i}.`),e.debug(`Replace page to ${t}`),fse.outputJSONSync(i,s)}getPageJsonFileName(e){const t=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),s=(0,json_util_js_1.getJson5Obj)(t).module.pages;return s||e._buildError("Unable to replace pages. Cannot find moduleJsonObj.module.pages.")._printErrorAndExit(this.moduleModel.getName()),`${s.replace(/\$profile:/,"")}.json`}getDependencies(e,t){const s=this.projectModel.isOhpmProject()?e.getOhPackageJson5Path():e.getPackageJsonPath();let o={};if(fse.existsSync(s)){const e=hvigor_1.Json5Reader.getJson5Obj(s);o={dependency:o,...e.dependencies},t&&Object.assign(o,e.devDependencies)}const i={};return Object.keys(o).sort().forEach((e=>i[e]=o[e])),i}declareDepends(e,t){let s;return s=e instanceof hvigor_1.CoreTask?e.getName():e,s.split("@").length>1||(s=`${this.targetName}@${s}`),super.dependsOn(s,t)}declareDependsList(...e){e.forEach((e=>{this.declareDepends(e)}))}dependsOnHook(e,t){let s;return s=e instanceof hvigor_1.CoreTask?e.getName():e,super.dependsOn(s,t)}hasUseTsHarField(){var e;if(!this.isFaMode){return void 0!==(null===(e=this.moduleModel.getJsonProfileOptByTargetName(this.targetName,!1).module.metadata)||void 0===e?void 0:e.find((e=>e.name===common_const_js_1.CommonConst.USE_TS_HAR&&"true"===e.value)))}return!1}}exports.OhosModuleTask=OhosModuleTask;