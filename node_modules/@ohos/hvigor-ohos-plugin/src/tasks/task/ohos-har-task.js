"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosHarTask=exports.DEFAULT_MAIN_FILED_FILE_SUFFIX=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),har_extend_info_js_1=require("../har/har-extend-info.js"),ohos_module_task_js_1=require("./ohos-module-task.js"),DEFAULT_MAIN_FILED_FILE_NAME="index";exports.DEFAULT_MAIN_FILED_FILE_SUFFIX=[".ets",".ts",".js"];const _log=ohos_logger_js_1.OhosLogger.getLogger("process-package-json");class OhosHarTask extends ohos_module_task_js_1.OhosModuleTask{constructor(e,o){if(super(e,o),this._harExtendInfo=new har_extend_info_js_1.HarExtendInfo(this.moduleModel,e.getBuildOption()),this.modulePackageJsonPath=this.getModulePackageJsonPath(),!this.packageJsonObj){const e=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON);_log._buildError(`The ${e} file does not exist`)._file(this.modulePackageJsonPath)._printErrorAndExit(this.moduleName)}}getModulePackageJsonPath(){return this.moduleModel.isOhpmProject()?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()}getPackageJsonValidMainField(){const e=this.packageJsonObj.main;let o;if(void 0===e||""===e)o=this.findValidMainField();else{o=e;const s=path_1.default.resolve(this.moduleModel.getProjectDir(),o);fs_extra_1.default.existsSync(s)||_log._buildError(`The main field set in package.json corresponding path \n        ${s} in Har is invalid,Please check.`)._file(this.modulePackageJsonPath)._printErrorAndExit(this.moduleName)}return o}findValidMainField(){const e=this.moduleModel.getProjectDir();let o;return exports.DEFAULT_MAIN_FILED_FILE_SUFFIX.forEach((s=>{const t=`index${s}`,a=path_1.default.resolve(e,`index${s}`);fs_extra_1.default.existsSync(a)&&(o=t)})),null!=o?o:"index.ets"}}exports.OhosHarTask=OhosHarTask;