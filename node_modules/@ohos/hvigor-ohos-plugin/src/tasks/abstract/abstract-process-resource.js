"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractProcessResource=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_util_js_1=require("../../common/common-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),device_type_const_js_1=require("../../const/device-type-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),legacy_process_profile_js_1=require("../legacy-tasks/legacy-process-profile.js"),process_profile_js_1=require("../process-profile.js"),abstract_resource_task_js_1=require("./abstract-resource-task.js"),ohos_test_util_js_1=require("../../utils/ohos-test-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-abstract-process-resource");class AbstractProcessResource extends abstract_resource_task_js_1.AbstractResource{constructor(e,s){super(e,s),this.processedJson=this.isFaMode?this.pathInfo.getIntermediatesProcessLegacyProfile():this.pathInfo.getIntermediatesProcessProfile()}getEnabled(){return this.initCommandBuilder(),super.getEnabled()}initTaskDepends(){this.declareDepends(this.isFaMode?legacy_process_profile_js_1.LegacyProcessProfile.name:process_profile_js_1.ProcessProfile.name)}doTaskAction(){const e=this.restoolConfigBuilder.getConfigObject();fs_extra_1.default.outputJSONSync(this.resConfigFilePath,e)}declareInputs(){return(new Map).set("resConfigJsonContent",JSON.stringify(this.restoolConfigBuilder.getConfigObject()))}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.resConfigFilePath,{isDirectory:!1})}isEnabledIconCheck(){const e=this.moduleModel.getModuleType();if(e!==module_type_enum_js_1.ModuleType.Entry&&e!==module_type_enum_js_1.ModuleType.Feature)return!1;let s=(0,common_util_js_1.isSingleFramework)()&&this.targetData.getCompileApiVersion()>=sdk_const_js_1.ApiVersion.API_VERSION_10;const t=[device_type_const_js_1.DeviceTypeConst.DEFAULT,device_type_const_js_1.DeviceTypeConst.PHONE,device_type_const_js_1.DeviceTypeConst.TABLET],o=this.moduleModel.getJsonProfileByModel(this.service,this.targetName);s=s&&!t.every((e=>{var s;return!(null===(s=o.deviceTypes)||void 0===s?void 0:s.includes(e))}));const r=this.moduleModel.isInstallFree();if(this.isFaMode)return s&&!r;const i=this.projectModel.getAppRes();return s&&(i.getAppResOpt().app.bundleType===common_const_js_1.BundleType.APP||void 0===i.getAppResOpt().app.bundleType)&&!r}addOhosTestExtraCompilationResources(e){const s=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES);fs_extra_1.default.existsSync(s)&&e.addInputDir(s,"Module")}addIntermediatesSrcResource(e,s){if((0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(s)){const s=(0,ohos_test_util_js_1.getOhosTestIntermediatesSrcResource)(this.module.getNodeDir());fs_extra_1.default.existsSync(s)&&e.addInputDir(s,"Module")}}}exports.AbstractProcessResource=AbstractProcessResource;