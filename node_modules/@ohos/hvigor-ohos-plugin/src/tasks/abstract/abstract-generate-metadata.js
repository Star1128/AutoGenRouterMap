"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,i)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractGenerateMetadata=void 0;const fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../../const/build-directory-const.js"),device_type_const_js_1=require("../../const/device-type-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),sign_util_js_1=require("../sign/sign-util.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),common_const_js_1=require("../../const/common-const.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),remote_hsp_utils_js_1=require("../../utils/remote-hsp-utils.js"),module_task_service_js_1=require("../service/module-task-service.js");class AbstractGenerateMetadata extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t){super(e,t),this._log=ohos_logger_js_1.OhosLogger.getLogger(AbstractGenerateMetadata.name),this.sourceSetModel=e.getTargetData().getModuleSourceSetModel(),this.remoteHspMetaData=(0,remote_hsp_utils_js_1.getSignRemoteHspMetadata)(this.targetService)}doTaskAction(){const e=this.service.getModuleModel().getModuleType();if(e===module_type_enum_js_1.ModuleType.Har)return;const t=this.generateTargetMetadata(this.targetData);e===module_type_enum_js_1.ModuleType.Shared?fs.outputJSONSync(this.pathInfo.getIntermediatesHspOutputMetadata(),t):fs.outputJSONSync(this.pathInfo.getIntermediatesOutputMetadata(),t)}declareInputs(){var e;let t=new Map;const s=this.projectModel.getProfileOpt().app.signingConfigs;if(s){const e=s.filter((e=>e.name===this.targetData.getProduct().signingConfig));t=sign_util_js_1.SignUtil.getSigningConfigInputs(this.sdkInfo,e[0])}return t.set("targetConfig",JSON.stringify(this.targetData.getTargetOpt())).set("moduleDeviceType",this.targetData.getTargetDeviceType()).set("product",this.targetData.getProduct().signingConfig).set("entryModules",null!==(e=this.targetData.getRelatedEntryModules())&&void 0!==e?e:[]).set("remoteHspMetaData",JSON.stringify(this.remoteHspMetaData))}declareOutputFiles(){const e=this.service.getModuleModel().getModuleType()===module_type_enum_js_1.ModuleType.Shared,t=super.declareOutputFiles();return e?t.addEntry(this.pathInfo.getIntermediatesHspOutputMetadata()):t.addEntry(this.pathInfo.getIntermediatesOutputMetadata())}initTaskDepends(){}generateTargetMetadata(e){const t=(0,sign_util_js_1.isSigned)(this.projectModel),s=[],a=e.getRelatedEntryModules(),i=e.getModuleModel().getModuleType();switch(i){case module_type_enum_js_1.ModuleType.Entry:s.push(this.generateModuleMetadata(this.targetData,t));break;case module_type_enum_js_1.ModuleType.Feature:if(module_task_service_js_1.ModuleTaskService.checkEntryModules(i,a))for(const i of a)s.push(this.generateFeatureMetadata(e,i,t));else s.push(this.generateModuleMetadata(e,t));break;case module_type_enum_js_1.ModuleType.Shared:s.push(this.generateHspMetadata(e,t))}return s}generateModuleMetadata(e,t){const s=this.service.getModuleModel().getName(),a=e.findRelatedTargetData(s),i=null==a?void 0:a.getTargetName();let r="",o=[];return e.getTargetDeviceTypeClasses().forEach((n=>{var d;const u=n!==device_type_const_js_1.DeviceTypeConst.LITE||e.isSingleDeviceTypeTarget()?"":`-${n}`,_=t?"signed":"unsigned",l=null===(d=this.targetData.getTargetOpt().output)||void 0===d?void 0:d.artifactName;r=l?`${l}${t?"":"-unsigned"}${build_directory_const_js_1.BuildArtifactExtension.DOT_HAP}`:`${s}-${i}${u}-${_}${build_directory_const_js_1.BuildArtifactExtension.DOT_HAP}`,o=null==a?void 0:a.getTargetDeviceType().filter((e=>n===device_type_const_js_1.DeviceTypeConst.LITE?device_type_const_js_1.DeviceTypeConst.LITE_DEVICES.includes(e):device_type_const_js_1.DeviceTypeConst.RICH_DEVICES.includes(e)))})),{hapName:r,deviceTypes:o,isSigned:t,entryModule:void 0,dependRemoteHsps:this.remoteHspMetaData}}generateFeatureMetadata(e,t,s){var a,i;const r=e.getTargetName(),o=e.getModuleModel().getName(),n=null===(a=this.targetData.getTargetOpt().output)||void 0===a?void 0:a.artifactName,d=n?`${n}${s?"":"-unsigned"}${build_directory_const_js_1.BuildArtifactExtension.DOT_HAP}`:`${o}-${t}-${r}-${s?"signed":"unsigned"}${build_directory_const_js_1.BuildArtifactExtension.DOT_HAP}`,u=e.getTargetDeviceType(),_=this.targetData.findRelatedTargetData(t);return{hapName:d,deviceTypes:u,isSigned:s,entryModule:{moduleName:t,distroFilter:this.getDistroFilterObj(_),deviceType:null!==(i=null==_?void 0:_.getTargetDeviceType())&&void 0!==i?i:[]},dependRemoteHsps:this.remoteHspMetaData}}generateHspMetadata(e,t){var s;const a=e.getTargetName(),i=e.getModuleModel().getName(),r=null===(s=this.targetData.getTargetOpt().output)||void 0===s?void 0:s.artifactName;return{hspName:r?`${r}${t?"":"-unsigned"}${build_directory_const_js_1.BuildArtifactExtension.DOT_HSP}`:`${i}-${a}-${t?"signed":"unsigned"}${build_directory_const_js_1.BuildArtifactExtension.DOT_HSP}`,deviceTypes:e.getTargetDeviceType(),isSigned:t,entryModule:void 0,dependRemoteHsps:this.remoteHspMetaData}}getRelatedEntryJsonList(e){const t=[],s=this.moduleModel.getModuleType(),a=this.targetData.getRelatedEntryModules();if(!module_task_service_js_1.ModuleTaskService.checkEntryModules(s,a))return[];const i=this.moduleModel.getParentProject().getProjectDir();for(const s of a){const a=this.projectModel.getModuleModelByName(s).getModule().getNodeDir(),r=path_1.default.resolve(i,a,`src/main/${e}`);fs.existsSync(r)&&t.push(r);const o=path_1.default.resolve(i,a,common_const_js_1.CommonConst.PROFILE_JSON5);fs.existsSync(o)&&t.push(o)}return t}}exports.AbstractGenerateMetadata=AbstractGenerateMetadata;