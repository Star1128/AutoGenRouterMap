"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractPackageHar=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),minimatch_1=__importDefault(require("minimatch")),path_1=__importDefault(require("path")),npm_command_builder_js_1=require("../../builder/npm-command-builder.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),cmake_util_js_1=require("../../utils/cmake-util.js"),file_util_js_1=require("../../utils/file-util.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),log_combine_type_js_1=require("../../utils/log/log-combine-type.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),npm_utils_js_1=require("../../utils/npm-utils.js"),obfuscation_config_resolver_js_1=require("../../utils/obfuscation-config-resolver.js"),process_utils_js_1=require("../../utils/process-utils.js"),abstract_merge_profile_js_1=require("../abstract-merge-profile.js"),ohos_har_task_js_1=require("../task/ohos-har-task.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("PackageHar");class AbstractPackageHar extends ohos_har_task_js_1.OhosHarTask{constructor(e,t){var i;super(e,t),this.allInvalidPrefix=[],this.ignoreFileNames=[".gitignore",".ohpmignore"],this.ohpmIgnoreRules=[],this.releaseWhiteListTemDir=["example"],this.needCopyFileNames=[],this._moduleDir=this.moduleModel.getProjectDir(),this.taskTmpDir=this.getTaskTempDir(this.targetData,void 0,!1),this.outputDir=this.pathInfo.getModuleBuildOutputPath(),this.generateDir=this.pathInfo.getGeneratePmDir(),this.headerPath=null===(i=this.targetService.getBuildOption().nativeLib)||void 0===i?void 0:i.headerPath,this.resourceDir=this.pathInfo.getIntermediatesRes(),this.processedLibs=this.pathInfo.getIntermediatesStrippedLibsDir(),this.resourceTablePath=path_1.default.resolve(this.resourceDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.harProfile=this.pathInfo.getIntermediatesProcessProfileDir(),this.harModuleJson=path_1.default.resolve(this.taskTmpDir,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this.targetService.getBuildOption().externalNativeOptions)&&(this.cmakeListDir=cmake_util_js_1.CmakeUtil.getCmakeListDir(this._moduleDir,this.targetService.getBuildOption().externalNativeOptions)),this.obfuscationFiles=this.resolveObfuscationFiles(),this.cppTypes=path_1.default.resolve(this._moduleDir,"src","main","cpp","types"),this.hasNativeOption=this._harExtendInfo.hasConfiguredNativeOption(),this.needCppTypes=fs.pathExistsSync(this.cppTypes),this.npmPath=path_1.default.dirname(process.execPath),this.npmCommand=new npm_command_builder_js_1.NpmCommandBuilder(this.npmPath).addAllParams(["pack"]),this.initModuleToplevelPathFilter(),this.initNeedCopyFileNames()}declareExecutionCommand(){return`${this.npmCommand.toString()}`}declareExecutionEnv(){return(new Map).set("cwd",this.taskTmpDir)}declareInputs(){var e;const t=(new Map).set("hasNativeOption",this.hasNativeOption).set("needCppTypes",this.needCppTypes).set("harModuleJson",this.harModuleJson).set("isOhpmProject",this.isOhpmProject).set("artifactType",this._harExtendInfo.getArtifactType()).set(abstract_merge_profile_js_1.INPUT_KEY.projectConfigAppOpt,JSON.stringify(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.signingConfig));return this.hasNativeOption&&void 0!==this.cmakeListDir&&t.set("cmakeListDir",this.cmakeListDir),this.hasNativeOption&&this.needCppTypes&&t.set("cppTypes",this.cppTypes),t}declareInputFiles(){const e=this.allInvalidPrefix.join("|").replace(/\\/g,"\\\\"),t=RegExp(`^(?!${e}).*`),i=(new hvigor_1.FileSet).addEntry(this.harProfile,{isDirectory:!0}).addEntry(this._moduleDir,{isDirectory:!0,test:t}).addEntry(this.generateDir,{isDirectory:!0});if(fs.pathExistsSync(this.processedLibs)&&i.addEntry(this.processedLibs,{isDirectory:!0}),fs.pathExistsSync(this.resourceTablePath)&&i.addEntry(this.resourceTablePath,{isDirectory:!1}),this.headerPath){const e=path_1.default.isAbsolute(this.headerPath)?this.headerPath:path_1.default.resolve(this._moduleDir,this.headerPath);fs.pathExistsSync(e)&&i.addEntry(e)}return i}declareOutputFiles(){var e;const t=(new hvigor_1.FileSet).addEntries([this.taskTmpDir,this.outputDir],{isDirectory:!0});return hvigor_1.coreParameter.properties[hvigor_2.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]||!this.sdkInfo.hasRollUpPluginInEtsLoader||(null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.debuggable)||t.addEntry(path_1.default.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),{isDirectory:!1}),t}initModuleToplevelPathFilter(){const e=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,common_const_js_1.CommonConst.OH_MODULES,".cxx",".previewer",".hvigor",...this.ignoreFileNames];e.includes(this.pathInfo.getBuildRoot())||e.push(this.pathInfo.getBuildRoot()),e.forEach((e=>{this.allInvalidPrefix.push(path_1.default.resolve(this._moduleDir,e))}))}initNeedCopyFileNames(){const e=this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON,t=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this._moduleDir,e));if(fs.existsSync(t)){const e=hvigor_1.Json5Reader.getJson5Obj(t);e.main&&this.needCopyFileNames.push(e.main)}this.needCopyFileNames=this.needCopyFileNames.map((e=>path_1.default.resolve(this._moduleDir,e)))}initFilterRules(){if(!this.isOhpmProject)return;for(const e of this.ignoreFileNames){const t=path_1.default.resolve(this._moduleDir,e);if(!fs.existsSync(t)||fs.statSync(t).isDirectory())continue;const i=fs.readFileSync(t).toString().split(/\r?\n/).filter((e=>!/^#|^$/.test(e.trim()))).map((e=>e.trim()));this.ohpmIgnoreRules.push(...i)}this.headerPath&&this.ohpmIgnoreRules.push(this.headerPath);this.ohpmIgnoreRules.push("/src/test");this.ohpmIgnoreRules.push("/src/ohosTest"),this.initSourceRootFilterRules()}initSourceRootFilterRules(){var e;const t=this.targetData.getTargetOpt(),i=null===(e=t.source)||void 0===e?void 0:e.sourceRoots;if(!(null==i?void 0:i.length))return;const s=t.name,o=this.moduleModel.getTargetOptions(),r=/^\.[/\\]/,a=i.reduce(((e,t)=>(e.add(t.replace(r,"")),e)),new Set);o.forEach((e=>{var t,i;e.name!==s&&(null===(i=null===(t=e.source)||void 0===t?void 0:t.sourceRoots)||void 0===i||i.forEach((e=>{const t=e.replace(r,"");a.has(t)||this.ohpmIgnoreRules.push(t)})))}))}async doTaskAction(){var e,t;const i="verify and initialize packaging information",s=this.durationEvent.createSubEvent(i,"");s.start(),this.preCheckBeforePack(),this.copyLocalDepsFileToTempDir(),this._harExtendInfo.isObfuscatedHar()?(this.copyModuleSourceFileToTempDirByWhiteList(),this.copyCompiledSourceFileToTempDir(),file_util_js_1.FileUtil.copySpecialFileToTempDir(this._moduleDir,this.taskTmpDir)):(this.initFilterRules(),this.copyModuleSourceFileToTempDirByBlackList()),await this.syncNativeHeader(),await this.syncObfuscationFile(),this.copyBuildIntermediatesOutToTempDir(),this.copyOtherGenerateFiles(),this.addSourceDirsToPackageJson(),this.processHarRouterMap();const o=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl,r=cmake_util_js_1.CmakeUtil.getHarExtraParams(this);file_util_js_1.FileUtil.addParamToOhPack(this.isOhpmProject,this.taskTmpDir,{useNormalizedOHMUrl:o},r,this.targetName),s.stop(),s.setLog(i,hvigor_1.MetricLogType.INFO),this.isOhpmProject?await this.executeOhpmPack():await this.executeNpmPack(),this.moveSourceMap()}async syncNativeHeader(){if(!this.headerPath)return;const e=path_1.default.isAbsolute(this.headerPath)?this.headerPath:path_1.default.resolve(this._moduleDir,this.headerPath);cmake_util_js_1.CmakeUtil.checkNativeHeader(e,this.moduleModel),await fs.copy(e,path_1.default.resolve(this.taskTmpDir,"include"),{recursive:!0})}async syncObfuscationFile(){var e,t,i;const s=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.obfuscation;if((null===(t=null==s?void 0:s.ruleOptions)||void 0===t?void 0:t.enable)||(null==s?void 0:s.consumerFiles)&&(null===(i=null==s?void 0:s.consumerFiles)||void 0===i?void 0:i.length)>0){const e=this.pathInfo.getObfuscationExportRulePath();fs.existsSync(e)&&await fs.copyFile(e,path_1.default.resolve(this.taskTmpDir,common_const_js_1.CommonConst.OBFUSCATION_TXT))}}resolveObfuscationFiles(){var e;const t=[];return(null!==(e=this.moduleModel.getProfileOpt().buildOptionSet)&&void 0!==e?e:[]).forEach((e=>{var i,s,o,r,a;t.push(...(0,obfuscation_config_resolver_js_1.transformRules)(null===(o=null===(s=null===(i=e.arkOptions)||void 0===i?void 0:i.obfuscation)||void 0===s?void 0:s.ruleOptions)||void 0===o?void 0:o.files,this._moduleDir)),t.push(...(0,obfuscation_config_resolver_js_1.transformRules)(null===(a=null===(r=e.arkOptions)||void 0===r?void 0:r.obfuscation)||void 0===a?void 0:a.consumerFiles,this._moduleDir))})),t}noNeedCopyCmakeList(e){return!(this.hasNativeOption&&e===this.cmakeListDir)}moveSourceMap(){var e;if(this.sdkInfo.hasRollUpPluginInEtsLoader&&!hvigor_1.coreParameter.properties[hvigor_2.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]&&!(null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.debuggable)){const e=path_1.default.resolve(this.pathInfo.getModuleBuildCachePath(),`${this.targetName}@HarCompileArkTS`,"esmodule","release",build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP);fs.existsSync(e)&&(fs.ensureDirSync(this.pathInfo.getDefaultSourceMapPath()),fs.copyFileSync(e,path_1.default.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP)))}}copyLocalDepsFileToTempDir(){(0,npm_utils_js_1.collectLocalFileDependency)(this.packageManagerPath,this.packageJsonObj).forEach((e=>{fs.pathExistsSync(path_1.default.resolve(this._moduleDir,e))&&fs.copySync(path_1.default.resolve(this._moduleDir,e),path_1.default.resolve(this.taskTmpDir,e))}))}copyModuleSourceFileToTempDirByWhiteList(){var e;const t=null===(e=this.targetService.getTargetData().getTargetOpt().resource)||void 0===e?void 0:e.directories;if(null==t?void 0:t.length)t.forEach((e=>{const t=file_util_js_1.FileUtil.convertToAbsolutePath(e,this.targetService.getTargetData().getPathInfo().getModulePath());if(fs.existsSync(t)){const i=file_util_js_1.FileUtil.convertToAbsolutePath(e,this.taskTmpDir);fs.copySync(t,i)}}));else{const e=this.targetData.getModuleSourceSetModel().getTargetResPath(),t=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES);fs.existsSync(e)&&fs.copySync(e,t)}for(const e of this.releaseWhiteListTemDir){const t=path_1.default.resolve(this._moduleDir,e);if(fs.existsSync(t)){const i=path_1.default.resolve(this.taskTmpDir,e);fs.copySync(t,i,{overwrite:!1})}}}getCopyFilter(e){return t=>this.noNeedCopyCmakeList(t)&&!this.needIgnoreSrc(e,t)&&!this.excludeObfuscationFiles(t)||this.needCopyFile(t)}needCopyFile(e){return-1!==this.needCopyFileNames.indexOf(e)}excludeObfuscationFiles(e){return!!this.obfuscationFiles.find((t=>""===path_1.default.relative(e,t)))}needIgnoreSrc(e,t){const i=e.length,s=t.substring(i+1).split(path_1.default.sep).join("/");return this.ohpmIgnoreRules.some((e=>(0,minimatch_1.default)(s,e)||(0,minimatch_1.default)(`/${s}`,e)))}copyModuleSourceFileToTempDirByBlackList(){fs.readdirSync(this._moduleDir).forEach((e=>{const t=path_1.default.resolve(this._moduleDir,e);this.allInvalidPrefix.includes(t)||fs.copySync(t,path_1.default.resolve(this.taskTmpDir,e),{filter:this.getCopyFilter(this._moduleDir)})}));const e=this.pathInfo.getHarGenerateBuildProfilePath(),t=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.BUILD_PROFILE_FILE);fs.existsSync(e)&&fs.copySync(e,t),fs.pathExistsSync(this.harModuleJson)&&fs.removeSync(this.harModuleJson)}preCheckBeforePack(){const e=this.packageManagerPath,t=this.packageJsonObj;(0,npm_utils_js_1.checkHasLocalFileDependency)(e,t)&&_log._buildError(`Local dependencies detected during har packing of module ${this.moduleName}. Declaring local dependencies in har module might cause failing during install har package.`)._detail("Check package.json/oh-package.json5 of current library module and replace the local dependencies.")._file(e)._printWarn(this.moduleName),fs.emptyDirSync(this.outputDir),fs.emptyDirSync(this.taskTmpDir)}copyBuildIntermediatesOutToTempDir(){fs.pathExistsSync(this.processedLibs)&&fs.copySync(this.processedLibs,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.LIBS)),fs.pathExistsSync(this.resourceTablePath)&&fs.copySync(this.resourceTablePath,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT)),fs.copySync(this.harProfile,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN))}async executeNpmPack(){const e={moduleName:this.moduleName,taskName:this.name,commandLine:this.npmCommand,commandOptions:{cwd:this.taskTmpDir}},t=e=>{fs.copySync(this.taskTmpDir,this.outputDir,{filter:t=>!fs.lstatSync(t).isDirectory()&&t.endsWith(e)||t===this.taskTmpDir})},i="execute npm packaging command",s=this.durationEvent.createSubEvent(i,"");if(s.start(),!new process_utils_js_1.ProcessUtils(this.moduleName,this.name).submitSyncExecutionWithReturn(this,this.getWorkerPool(),"packageHar",e,t)){t((await new process_utils_js_1.ProcessUtils(this.moduleName,this.name).execute(e.commandLine,e.commandOptions,log_combine_type_js_1.LogCombineType.DEBUG)).stdout.toString())}s.stop(),s.setLog(i,hvigor_1.MetricLogType.INFO)}async executeOhpmPack(){var e;const t=null===(e=this.targetData.getTargetOpt().output)||void 0===e?void 0:e.artifactName,i=t?`${t}`:`${this.moduleName}`;await(0,npm_utils_js_1.execOhpmPack)(this.taskTmpDir,path_1.default.resolve(this.outputDir,`${i}.har`),this.durationEvent)}copyOtherGenerateFiles(){}processHarRouterMap(){}}exports.AbstractPackageHar=AbstractPackageHar;