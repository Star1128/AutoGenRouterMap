"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,i){void 0===i&&(i=t);var s=Object.getOwnPropertyDescriptor(o,t);s&&!("get"in s?!o.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,i,s)}:function(e,o,t,i){void 0===i&&(i=t),e[i]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ColdReloadArkCompile=void 0;const hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),math_util_js_1=require("../utils/math-util.js"),run_ark_js_1=require("./worker/run-ark.js"),ark_compile_js_1=require("./ark-compile.js"),json_util_js_1=require("../utils/json-util.js");class ColdReloadArkCompile extends ark_compile_js_1.ArkCompile{constructor(){super(...arguments),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ColdReloadArkCompile.name)}taskShouldDo(){const e=this.pathInfo.getBuildConfigPath();return super.taskShouldDo()&&fse.existsSync(e)}declareInputFiles(){var e;const o=super.declareInputFiles(),t=this.pathInfo.getBuildConfigPath();if(fse.existsSync(t)){const i=(0,json_util_js_1.getJson5Obj)(t),s=null===(e=null==i?void 0:i.patchConfig)||void 0===e?void 0:e.changedFileList;s&&fse.existsSync(s)&&o.addEntry(s)}return o}async doTaskAction(){const e=this.pathInfo.getBuildConfigPath();let o,t;if(fse.existsSync(e)){const i=(0,json_util_js_1.getJson5Obj)(e);o=i.compileConfig,t=i.patchConfig}else this.logger.debug(`Build config file not found: ${e}`);const i={...await this.initDefaultArkCompileConfig(),...null!=o?o:{}};if(i.obfuscationOptions&&delete i.obfuscationOptions,i.watchMode="false",i.projectPath=i.aceModuleRoot,i.collectImportersConfig&&(i.collectImportersConfig.isReload=!0),fse.ensureDirSync(i.cachePath),fse.ensureDirSync(i.aceModuleBuild),this._log.debug(`coldReload build config: ${i}`),t&&i.aceBuildJson&&fse.existsSync(i.aceBuildJson)){const e=(0,json_util_js_1.getJson5Obj)(i.aceBuildJson);e.patchConfig=t,fse.outputJSONSync(i.aceBuildJson,e)}let s=null;s=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this.logger,i,(e=>!!s&&this.handleCompileEvents(e,this.getSubDurationEvent(s),!0)),0===this.getWorkerPool().getMaxPoolNum()?void 0:[(0,math_util_js_1.mod)((0,hvigor_1.getModuleIndex)(i.modulePath),this.getWorkerPool().getMaxPoolNum())])}initTaskDepends(){this.dependsOnHook("buildHotReloadResource")}}exports.ColdReloadArkCompile=ColdReloadArkCompile;