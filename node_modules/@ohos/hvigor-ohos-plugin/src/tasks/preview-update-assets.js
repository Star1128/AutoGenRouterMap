"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewUpdateAssets=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");var TASK=task_names_js_1.TaskNames.Task;const res_model_loader_js_1=require("../utils/loader/file/res-model-loader.js");class PreviewUpdateAssets extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,TASK.PREVIEW_UPDATE_ASSETS),this.logger=ohos_logger_js_1.OhosLogger.getLogger(PreviewUpdateAssets.name),this.paths=[],this.contents=[],this.buildConfigPath=this.pathInfo.getBuildConfigPath(!0)}declareInputs(){const e=new Map;if(fs_extra_1.default.existsSync(this.buildConfigPath)){const t=fs_extra_1.default.readJsonSync(this.buildConfigPath);t.port&&delete t.port,e.set("previewBuildConfigJson",JSON.stringify(t))}return e}declareOutputFiles(){if(fs_extra_1.default.existsSync(this.buildConfigPath)){const e=fs_extra_1.default.readJsonSync(this.buildConfigPath).stageRouterConfig;if(!e)return new hvigor_1.FileSet;this.paths=e.paths,this.contents=e.contents,this.paths.length!==this.contents.length&&this.logger._buildError("The number of 'paths' doesn't match that of 'contents'.")._file(this.buildConfigPath)._printErrorAndExit()}else this.logger.debug(`Build config file not found: ${this.buildConfigPath}`);return(new hvigor_1.FileSet).addEntries(this.paths,{isDirectory:!1})}doTaskAction(){const e=this.targetData.getModuleSourceSetModel().getModuleTargetRes().getJsonPath(),t=res_model_loader_js_1.resModelLoader.getModuleJson(e).module.pages;if(t){const e=t.slice(t.indexOf(":")+1);this.resolveRouterConfig(this.paths,this.contents,`${e}.json`)}else this.resolveRouterConfig(this.paths,this.contents,"main_pages.json")}resolveRouterConfig(e,t,s){for(let o=0;o<e.length;o++){const i=e[o],r=t[o];i.endsWith("module.json")?this.writeModuleJson(i,r):i.endsWith(s)&&this.writeMainPages(i,r)}}writeModuleJson(e,t){if(this.moduleModel.isHarModule())if(fs_extra_1.default.existsSync(e)){const s=JSON.parse(t),o=fs_extra_1.default.readJsonSync(e);o.app&&(s.app=o.app),s.module&&(s.module.compileMode=this.targetCompileMode),fs_extra_1.default.writeJSONSync(e,s)}else fs_extra_1.default.ensureFileSync(e),fs_extra_1.default.writeFileSync(e,t)}writeMainPages(e,t){let s;fs_extra_1.default.existsSync(e)?s=fs_extra_1.default.readJsonSync(e):(fs_extra_1.default.ensureFileSync(e),s={src:[]});const o=JSON.parse(t);s.src=o.src,fs_extra_1.default.writeJSONSync(e,s)}initTaskDepends(){this.dependsOnHook("buildPreviewerResource")}}exports.PreviewUpdateAssets=PreviewUpdateAssets;