"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CacheNativeLibs=void 0;const hvigor_1=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_native_strip_js_1=require("./abstract/abstract-native-strip.js"),task_names_js_1=require("./common/task-names.js"),job_js_1=require("./worker/job.js"),do_native_strip_js_1=require("./do-native-strip.js");class CacheNativeLibs extends abstract_native_strip_js_1.AbstractNativeStrip{constructor(e){super(e,task_names_js_1.TaskNames.Task.CACHE_NATIVE_LIBS),this.logger=ohos_logger_js_1.OhosLogger.getLogger(CacheNativeLibs.name)}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.cacheFilePath,{isDirectory:!1})}declareInputFiles(){const e=new hvigor_1.FileSet;return fs_1.default.existsSync(this.intermediatesProcessLibs)&&e.addEntry(this.intermediatesProcessLibs,{isDirectory:!0}),fs_1.default.existsSync(this.strippedNativeLibs)&&e.addEntry(this.strippedNativeLibs,{isDirectory:!0}),e}async doTaskAction(){const e=path_1.default.resolve(__dirname,"./worker/job.js/cacheNativeLibs"),t={workInput:{intermediatesProcessLibs:this.intermediatesProcessLibs,strippedNativeLibs:this.strippedNativeLibs,cacheFilePath:this.cacheFilePath,debugSymbol:this.debugSymbol}};if(this.getWorkerPool().submit(this,e,t).getState()===hvigor_1.TaskState.REJECT){const e="cache native libs",s=this.durationEvent.createSubEvent(e,"");s.start(),this.logger.debug("Worker dispatch failed, running cacheNativeLibs on main thread."),await(0,job_js_1.cacheNativeLibs)(t.workInput),s.stop(),s.setLog(e,hvigor_1.MetricLogType.INFO)}}initTaskDepends(){this.declareDepends(do_native_strip_js_1.DoNativeStrip.name)}}exports.CacheNativeLibs=CacheNativeLibs;