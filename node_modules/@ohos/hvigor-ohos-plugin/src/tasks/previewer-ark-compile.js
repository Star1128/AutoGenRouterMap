"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewerArkCompile=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),ark_compile_js_1=require("./ark-compile.js"),preview_update_assets_js_1=require("./preview-update-assets.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const sdk_const_js_1=require("../const/sdk-const.js"),task_util_js_1=require("../utils/task-util.js");class PreviewerArkCompile extends ark_compile_js_1.ArkCompile{constructor(){super(...arguments),this.logger=ohos_logger_js_1.OhosLogger.getLogger(PreviewerArkCompile.name)}declareInputFiles(){return this.moduleModel.isHarModule()?super.declareInputFiles().deleteEntry(this.aceBuildJsonDir):super.declareInputFiles()}async doTaskAction(){var e;const t=hvigor_2.hvigorCore.getExtraConfig().get("pageType"),r=await this.getPreviewCompileConfig(this.logger),s=path_1.default.resolve(__dirname,"./worker/preview-build.js");if(r.pkgNameToPkgBriefInfo=this.pkgNameToPkgBriefInfo,r.otherPaths=this.getTscAddressPaths(r.aceModuleRoot),!t||t===common_const_js_1.PageType.PAGE){const e="true"===hvigor_2.hvigorCore.getExtraConfig().get("compileHspDependencies"),t=hvigor_2.hvigorCore.getExtraConfig().get("mainModule"),o=(e&&t!==this.moduleName?hvigor_1.normalWorker:hvigor_1.watchWorker).createWorker(this,s,!0,(e=>this.handleCompileEvents(e,this.getSubDurationEvent(o),!0)),{workerData:{projectConfig:r,logLevel:this.logger.getLevel().levelStr}})}if(this.needSubmitArkTsWidget&&t===common_const_js_1.PageType.CARD){const t={...r,widgetCompile:"true",cachePath:path_1.default.resolve(null!==(e=r.cachePath)&&void 0!==e?e:this.getTaskTempDir(this.targetData,"_widget"),"widget"),port:void 0},o=hvigor_1.watchWorker.createWorker(this,s,!0,(e=>this.handleCompileEvents(e,this.getSubDurationEvent(o),!0)),{workerData:{projectConfig:t,logLevel:this.logger.getLevel().levelStr}})}(0,task_util_js_1.warnCreateBuildProfileTask)(this.targetData,this.targetService,this._log)}initTaskDepends(){this.declareDepends(preview_update_assets_js_1.PreviewUpdateAssets.name),(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_9)&&this.declareDepends(CommonTask.CREATE_BUILD_PROFILE.name)}}exports.PreviewerArkCompile=PreviewerArkCompile;