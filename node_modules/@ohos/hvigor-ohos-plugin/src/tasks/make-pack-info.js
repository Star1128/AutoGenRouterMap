"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MakePackInfo=void 0;const wdk_1=require("@baize/wdk"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),merge_profile_js_1=require("./merge-profile.js");var Task=task_names_js_1.TaskNames.Task;const hvigor_1=require("@ohos/hvigor"),path_1=__importDefault(require("path")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),common_const_js_1=require("../const/common-const.js"),abstract_make_pack_info_js_1=require("./abstract-make-pack-info.js"),abstract_merge_profile_js_1=require("./abstract-merge-profile.js");class MakePackInfo extends abstract_make_pack_info_js_1.AbstractMakePackInfo{constructor(e){super(e,Task.MAKE_PACK_INFO),this.log=ohos_logger_js_1.OhosLogger.getLogger(MakePackInfo.name)}declareInputs(){var e,t;const o=this.projectModel.getAppRes().getAppResOpt();return super.declareInputs().set("releaseType",this.sdkInfo.getReleaseType()).set(abstract_merge_profile_js_1.INPUT_KEY.projectConfigAppOpt,JSON.stringify(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.signingConfig)).set("integratedHsp",!!(null===(t=this.targetService.getBuildOption().arkOptions)||void 0===t?void 0:t.integratedHsp)).set("appResOpt",JSON.stringify(o))}declareInputFiles(){const e=this.projectModel.getAppRes().getJsonPath(),t=this.targetService.getTargetData().getModuleSourceSetModel().getModuleTargetRes(),o=t.getJsonPath(),s=MakePackInfo.getFormPathList(this.moduleModel,this.targetName),i=this.projectModel.getProfilePath(),r=(new hvigor_1.FileSet).addEntry(e).addEntry(o).addEntry(i);return null==s||s.forEach((e=>{if(e){const o=path_1.default.resolve(t.getResourcePath(),e);r.addEntry(o)}})),r}initTaskDepends(){this.declareDepends(merge_profile_js_1.MergeProfile.name)}doTaskAction(){var e,t,o,s,i,r,n,a,l,d,p;const c=this.projectModel.getAppRes().getAppResOpt(),u=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt),g=this.targetData.getProduct(),m={code:null!==(o=null!==(t=null==u?void 0:u.versionCode)&&void 0!==t?t:g.versionCode)&&void 0!==o?o:c.app.versionCode,name:null!==(i=null!==(s=null==u?void 0:u.versionName)&&void 0!==s?s:g.versionName)&&void 0!==i?i:c.app.versionName,minCompatibleVersionCode:c.app.minCompatibleVersionCode};let _=null!==(n=null!==(r=null==u?void 0:u.bundleName)&&void 0!==r?r:g.bundleName)&&void 0!==n?n:c.app.bundleName;const h=null===(a=this.targetService.getBuildOption().arkOptions)||void 0===a?void 0:a.integratedHsp;this.moduleModel.isHspModule()&&h&&(_="");const f={bundleName:_,bundleType:null!==(p=null!==(d=null!==(l=null==u?void 0:u.bundleType)&&void 0!==l?l:g.bundleType)&&void 0!==d?d:c.app.bundleType)&&void 0!==p?p:common_const_js_1.BundleType.APP,version:m};this.doMakePackInfo(this.log,f)}processExtensionAbilities(e,t,o){if(void 0===e)return;const s=[];for(const i of e){const e={name:i.name,forms:this.processForms(MakePackInfo.processMetaData(i.metadata,t,o))};s.push(e)}return s}static processMetaData(e,t,o){if(void 0===e)return;const s=[];for(const i of e){const e=MakePackInfo.processResourcePath(i.resource);if(i.name&&i.name.indexOf("form")>=0&&void 0!==e){const i=t.getFormJsonObjByTargetName(o,e).forms;for(let e=0;e<i.length;e++)s.push(i[e])}}return s}static getFormPathList(e,t){const o=e.getJsonObjByTargetName(t).module.extensionAbilities;if(void 0===o)return;const s=[];for(const e of o){if(void 0===e.metadata)return[];for(const t of e.metadata){const e=MakePackInfo.processResourcePath(t.resource);e&&s.push(e)}}return s}static processResourcePath(e){if(!e)return;const t=e.split(":");return 2!==t.length||"$"!==t[0].charAt(0)||t[0].length<2?void 0:`base/${t[0].substring(1)}/${t[1]}.json`}getModuleObj(e,t,o,s){var i,r,n,a,l;const d=t.getJsonObjByTargetName(s),p=this.projectModel.getAppRes().getAppResOpt(),c=(0,wdk_1.cloneDeep)(null===(i=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===i?void 0:i.appOpt);let u;switch(null!==(n=null!==(r=null==c?void 0:c.bundleType)&&void 0!==r?r:this.targetData.getProduct().bundleType)&&void 0!==n?n:null!==(a=p.app.bundleType)&&void 0!==a?a:common_const_js_1.BundleType.APP){case common_const_js_1.BundleType.ATOMIC_SERVICE:u=!0;break;case common_const_js_1.BundleType.APP:u=!1;break;default:u=d.module.installationFree}const g={moduleType:d.module.type,installationFree:u,deliveryWithInstall:d.module.deliveryWithInstall,moduleName:d.module.name},m={compatible:this.compatibleApiVersion,releaseType:this.sdkInfo.getReleaseType(),target:null!==(l=this.targetSdkVersion)&&void 0!==l?l:this.compileApiVersion};return{mainAbility:d.module.mainElement,deviceType:e,abilities:this.processAbilities(d.module.abilities),extensionAbilities:this.processExtensionAbilities(d.module.extensionAbilities,t,s),distro:g,apiVersion:m}}getPackageObj(e,t,o){return[{deviceType:e.getTargetDeviceType(),moduleType:t.module.type,deliveryWithInstall:t.module.deliveryWithInstall,name:o}]}}exports.MakePackInfo=MakePackInfo;