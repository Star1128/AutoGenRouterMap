"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginFactory=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),module_ohos_config_manager_1=require("../../common/global/module-ohos-config-manager"),common_const_1=require("../../const/common-const"),global_project_data_service_1=require("../../tasks/service/global-project-data-service"),ohos_module_task_js_1=require("../../tasks/task/ohos-module-task.js"),legacy_task_initializer_js_1=require("../../utils/legacy-task-initializer.js"),config_file_loader_js_1=require("../../utils/loader/config-file-loader.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_logger_1=require("../../utils/log/ohos-logger"),one_sdk_validator_js_1=require("../../utils/one-sdk-validator.js"),project_task_initializer_js_1=require("../../utils/project-task-initializer.js"),resolver_cache_js_1=require("../../utils/resolver/resolver-cache.js"),run_command_util_1=require("../../utils/run-command-util"),task_initializer_js_1=require("../../utils/task-initializer.js"),app_plugin_js_1=require("../app-plugin.js"),legacy_app_plugin_js_1=require("../legacy/legacy-app-plugin.js"),legacy_plugin_builder_js_1=require("./legacy-plugin-builder.js"),plugin_builder_js_1=require("./plugin-builder.js"),plugin_inspector_js_1=require("./plugin-inspector.js"),_log=ohos_logger_1.OhosLogger.getLogger("PluginFactory");class PluginFactory{static getAppPlugin(e,i=!1){config_file_loader_js_1.configFileLoader.clean(),res_model_loader_js_1.resModelLoader.clean(),oh_package_loader_1.ohPackageLoader.clean();const a=i?new legacy_app_plugin_js_1.LegacyAppPlugin(e):new app_plugin_js_1.AppPlugin(e);return a.doProjectInspection(),e.afterBindSystemPlugins((async()=>{var e;a.initGlobalData(),a.initBuildOptionMap(),a.initTaskService(),await(null===(e=a.getTaskService())||void 0===e?void 0:e.setup()),a.initContext(),project_task_initializer_js_1.ProjectTaskInitializer.initialize(a,i)})),hvigor_1.hvigorCore.hvigorNodeBeforeEvaluatedInternalHook((()=>{var e;const i=null!==(e=(0,hvigor_2.getAlignTarget)())&&void 0!==e?e:"";if(!this.isOnlyCleanTask()&&(oh_package_loader_1.ohPackageLoader.loadUpdatedOhPackageToDisk(i),oh_package_loader_1.ohPackageLoader.isUpdateOhPackageInfo)){_log.info("start to execute ohpm install");const e=process.env.ohpmBin||"ohpm";if(e&&fs_1.default.existsSync(e)||run_command_util_1.RunCommandUtil.run("ohpm -v",void 0,!0)){const a=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP,i);_log.debug(`ohpm install command is "${e}" i --all --target_path ${a}`),run_command_util_1.RunCommandUtil.run(`"${e}" i --all --target_path ${a}`,void 0,!0)}else _log.warn("need to configure ohpm environment in your system, please see official guide to configure ohpm environment")}const o=global_project_data_service_1.GlobalProjectDataService.getInstance().initProjectPkgJsonFileHash(a.getProjectModel());global_project_data_service_1.GlobalProjectDataService.getInstance().setProjectPkgJsonFileHash(o)})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var i,o;resolver_cache_js_1.ResolverCache.clear(),null===(i=a.getTaskService())||void 0===i||i.initDependencyInfo(),this.initializeTaskDepends(e,void 0,!1),one_sdk_validator_js_1.OneSdkValidator.apiInspection(a.getProjectModel()),a.initTraceData(),null===(o=a.getTaskService())||void 0===o||o.initProductData()})),a}static getHapPlugin(e,i=!1){let a,o,t;return i?(o=new legacy_plugin_builder_js_1.LegacyPluginBuilder(e),a=o.createFaHapPlugin()):(o=new plugin_builder_js_1.PluginBuilder(e),a=o.createStageHapPlugin()),a.initGlobalData(),o.setUpModulePlugin(a),i?(0,legacy_task_initializer_js_1.legacyHapTasksInitialize)(a):t=task_initializer_js_1.TaskInitializer.initializeHap(a),hvigor_1.hvigorCore.hvigorAfterNodeInternalHook(e.getName(),(async()=>{a.initContext()})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var o;null===(o=a.getTaskService())||void 0===o||o.initDependencyInfo(),this.initializeTaskDepends(e,t,i),plugin_inspector_js_1.PluginInspector.checkFeatureEntryModules(a)})),a}static getHarPlugin(e,i=!1){let a,o,t;return i?(o=new legacy_plugin_builder_js_1.LegacyPluginBuilder(e),a=o.createFaHarPlugin()):(o=new plugin_builder_js_1.PluginBuilder(e),a=o.createStageHarPlugin()),a.initGlobalData(),o.setUpModulePlugin(a),i?(0,legacy_task_initializer_js_1.legacyHarTasksInitialize)(a):t=task_initializer_js_1.TaskInitializer.initializeHar(a),hvigor_1.hvigorCore.hvigorAfterNodeInternalHook(e.getName(),(async()=>{a.initContext()})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var o;null===(o=a.getTaskService())||void 0===o||o.initDependencyInfo(),plugin_inspector_js_1.PluginInspector.checkAtomicServiceHspModules(a),this.initializeTaskDepends(e,t,i)})),a}static getHspPlugin(e){const i=new plugin_builder_js_1.PluginBuilder(e),a=i.createStageHspPlugin();i.setUpModulePlugin(a);const o=task_initializer_js_1.TaskInitializer.initializeHsp(a);return this.initHspPluginGlobalData(e),hvigor_1.hvigorCore.hvigorAfterNodeInternalHook(e.getName(),(async()=>{a.initContext()})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var e;null===(e=a.getTaskService())||void 0===e||e.initDependencyInfo(),o.configure()})),a}static initializeTaskDepends(e,i,a){a||!i?e.getTaskContainer().getAllTasks().filter((e=>e instanceof ohos_module_task_js_1.OhosModuleTask)).forEach((e=>e.initTaskDepends())):null==i||i.configure()}static isOnlyCleanTask(){const e=hvigor_1.hvigor.getCommandEntryTask();return 1===(null==e?void 0:e.length)&&"clean"===e[0]}static initHspPluginGlobalData(e){var i;const a=null===(i=e.getConfigOpt())||void 0===i?void 0:i.getObject("ohos");a&&module_ohos_config_manager_1.moduleOhosConfigManager.loaderConfig(e.getName(),a)}}exports.PluginFactory=PluginFactory;