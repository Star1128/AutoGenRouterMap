"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,s)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getEntryPath=exports.getEntryMainFilePath=exports.DependencyManager=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),legacy_module_model_impl_js_1=require("../../model/module/legacy-module-model-impl.js"),core_project_model_impl_js_1=require("../../model/project/core-project-model-impl.js"),har_extend_info_js_1=require("../../tasks/har/har-extend-info.js"),error_url_js_1=require("../../utils/error-url.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),base_package_resolver_js_1=require("../../utils/resolver/base-package-resolver.js"),npm_package_resolver_js_1=require("../../utils/resolver/npm-package-resolver.js"),ohpm_package_resolver_js_1=require("../../utils/resolver/ohpm-package-resolver.js"),dependency_interface_js_1=require("./core/dependency-interface.js"),module_dependency_info_js_1=require("./module-dependency-info.js"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),fse=__importStar(require("fs-extra")),common_util_js_1=require("../../common/common-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),dependency_builder_js_1=require("./core/dependency-builder.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),log=ohos_logger_js_1.OhosLogger.getLogger("ohos-dependency-manager"),solution=`The OpenHarmony npm package or module is not compatible with the current model. Use a compatible OpenHarmony npm package or module. For details about the stage and FA models, see ${error_url_js_1.ErrorUrl.ERROR_URL.modelDiff}.`,json5Map=new Map;function getJson5Obj(e){var t;const o=fs_extra_1.default.statSync(e).mtime.getTime();return(null===(t=json5Map.get(e))||void 0===t?void 0:t.timeStamp)!==o&&json5Map.set(e,{timeStamp:o,fileContent:hvigor_1.Json5Reader.getJson5Obj(e)}),json5Map.get(e).fileContent}class DependencyManager{constructor(e,t,o){this._allDependency=new Set,this._model=t,this._projectModel=o,this._moduleName=t.getName(),this._isFaMode=e,this._isOhpmDependency=this.isOhpmDependency()}isOhpmDependency(){return this._projectModel?this._projectModel.isOhpmProject():this._model.isOhpmProject()}createModelDependencyInfo(){this._allDependency.clear();const e=[],t=new Map,o=this._isOhpmDependency?this._model.getOhPackageJson5Path():this._model.getPackageJsonPath(),n={moduleName:this._moduleName,modulePkgJsonPath:o};return this.collectHarDependency(n,t,e),this.collectProjectHarDependencyForHap(t,e),log.debug(`Module ${this._moduleName} Collected Dependency: ${e.map((e=>e.getDependencyRootPath()))}`),log.debug(`Module ${this._moduleName}'s total dependency: ${e.length}`),new module_dependency_info_js_1.ModuleDependencyInfo(this.buildSelfDependency(n),t,e)}buildSelfDependency(e){return(new dependency_builder_js_1.DependencyBuilder).setDependencyName(this._moduleName).setLastDependencyName(this._moduleName).setDependencyRootPath(this._model.getProjectDir()).setPkgJsonPath(e.modulePkgJsonPath).setPkgJsonObj(getJson5Obj(e.modulePkgJsonPath)).setIsLocal(!0).buildDefaultModuleDependency()}collectAllDependencies(){const e=[],t=new Map,o=this._isOhpmDependency?this._model.getOhPackageJson5Path():this._model.getPackageJsonPath(),n={moduleName:this._moduleName,modulePkgJsonPath:o};return this.collectHarDependency(n,t,e,!0,!0),this.collectProjectHarDependencyForHap(t,e,!0),{npmDependencies:e,moduleDependencyMap:t}}collectAllDependenciesForPkgInfo(){const e=[],t=new Map,o=this._isOhpmDependency?this._model.getOhPackageJson5Path():this._model.getPackageJsonPath(),n={moduleName:this._moduleName,modulePkgJsonPath:o};return this.collectHarDependency(n,t,e,!0,!1,!0),this.collectProjectHarDependencyForHap(t,e,!0,!0),{npmDependencies:e,moduleDependencyMap:t}}collectAllHspDependencies(){const{moduleDependencyMap:e}=this.collectAllDependencies();return[...e.entries()].filter((([,e])=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP))}collectProjectHarDependencyForHap(e,t,o=!1,n=!1){if(this._projectModel){const s=this._isOhpmDependency?this._projectModel.getOhPackageJson5Path():this._projectModel.getPackageJsonPath(),d={moduleName:this._moduleName,modulePkgJsonPath:s};this.collectHarDependency(d,e,t,this._model.isHapModule(),o,n)}}collectHarDependency(e,t,o,n=!0,s=!1,d=!1){const r=[e],l=new Map;for(;r.length>0;){const e=r.shift();if(void 0===e||!fs_extra_1.default.existsSync(e.modulePkgJsonPath))continue;const a=getJson5Obj(e.modulePkgJsonPath);if(null!==a){for(const d in null==a?void 0:a.dependencies){this._allDependency.add(`${e.modulePkgJsonPath}@${d}`);const i=null==a?void 0:a.dependencies[d];Object.prototype.hasOwnProperty.call(null==a?void 0:a.dependencies,d)&&this.collectDependency(d,i,a.name,e,t,o,r,dependency_interface_js_1.DependencyEnum.DEPENDENCIES,n,s,l)}for(const d in null==a?void 0:a.dynamicDependencies){this._allDependency.add(`${e.modulePkgJsonPath}@${d}`);const i=null==a?void 0:a.dynamicDependencies[d];Object.prototype.hasOwnProperty.call(null==a?void 0:a.dynamicDependencies,d)&&this.collectDependency(d,i,a.name,e,t,o,r,dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES,n,s,l)}if(d){for(const d in null==a?void 0:a.devDependencies){this._allDependency.add(`${e.modulePkgJsonPath}@${d}`);const i=null==a?void 0:a.devDependencies[d];Object.prototype.hasOwnProperty.call(null==a?void 0:a.devDependencies,d)&&this.collectDependency(d,i,a.name,e,t,o,r,dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES,n,s,l)}d=!1}}}}collectDependency(e,t,o,n,s,d,r,l,a,i,c){var _,u,p,m;c.set(e,null!=o?o:"project");const h=(this._isOhpmDependency?new ohpm_package_resolver_js_1.OhpmPackageResolver:new npm_package_resolver_js_1.NpmPackageResolver).resolvePackagePath(e,path_1.default.dirname(n.modulePkgJsonPath),log),y=new base_package_resolver_js_1.BasePackageResolver("src/main/module.json",common_const_js_1.CommonConst.OH_MODULES).resolvePackagePath(e,path_1.default.dirname(n.modulePkgJsonPath),log),g=new base_package_resolver_js_1.BasePackageResolver("src/main/module.json5",common_const_js_1.CommonConst.OH_MODULES).resolvePackagePath(e,path_1.default.dirname(n.modulePkgJsonPath),log),D=path_1.default.resolve(this._model.getProjectDir(),common_const_js_1.CommonConst.OH_MODULES);if(void 0===h||!fs_extra_1.default.existsSync(h))return void(fs_extra_1.default.pathExistsSync(D)&&log.warn(`The current module '${this._moduleName}' has dependency which is not installed at its ${this._isOhpmDependency?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON}.`));const P=getJson5Obj(h),f=null!==(u=null!==(_=this.getHarmonyDependencyType(h,P,n.modulePkgJsonPath,e))&&void 0!==_?_:this.getSODependencyType(P.name))&&void 0!==u?u:this._allDependency.has(`${h}@${e}`)?void 0:dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER;if(void 0===f||f===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAP)return;const j=null!==(p=this.getModuleJsonObj(g))&&void 0!==p?p:this.getModuleJsonObj(y),v=path_1.default.dirname(h);this.checkHarStatusIsCompatibleForHap(v,P),this._allDependency.add(`${h}@${e}`);const O=null===(m=hvigor_1.hvigorCore.getProject())||void 0===m?void 0:m.getAllSubModules();if(!O)return;let E=h;const M={moduleName:"",modulePkgJsonPath:h};let N=!1;for(const o of O){const d=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.join(o.getNodeDir(),this._isOhpmDependency?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON));if(o.getNodeDir()!==v)continue;if(!a){const e=this.getDependencyPath(o.getName(),c),t=0!==e.length?`(${e})`:"";return void log.warn(`module '${this._moduleName}' depends on another module '${o.getName()}'${t}.This dependency will not be collected because of the potential issue of circular dependenciesbetween hsp/har modules.`)}E=d;const r=(new dependency_builder_js_1.DependencyBuilder).setModule(o).setDependencyName(e).setDependedVersion(t).setLastDependencyName(n.moduleName).setDependencyRootPath(o.getNodeDir()).setPkgJsonPath(E).setPkgJsonObj(P).setDependencyType(f).setDependencyEnum(l).setIsLocal(!0).setModuleJsonObj(j).buildDefaultModuleDependency();s.set(o.getName(),r),N=!0,M.moduleName=o.getName();break}const b=oh_package_loader_1.ohPackageLoader.getOriginPathFromUpdatePath([E])[0],k=(new dependency_builder_js_1.DependencyBuilder).setDependencyName(e).setDependedVersion(t).setDependencyRootPath(b).setPkgJsonPath(E).setPkgJsonObj(P).setDependencyType(f).setDependencyEnum(l).setModuleJsonObj(j).setIsLocal(N).buildDefaultNpmDependency();d.push(k),(f===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR||f===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER||i)&&r.push(M)}getDependencyPath(e,t){const o=[e];let n=e;const s=new Set;for(s.add(n);t.has(n)&&(n=t.get(n),o.push(n),!s.has(n)););return o.length>1?o.reverse().join(" -> "):""}getModuleJsonObj(e){if(void 0!==e&&fs_extra_1.default.existsSync(e))return getJson5Obj(e)}getDependencyTypeByProfile(e){const t=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),o=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON),n=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.CONFIG_JSON);return this.checkHarOrHspStatus(t,!1)||this.checkHarOrHspStatus(o,!1)||this.checkHarOrHspStatus(n,!0)}checkHarOrHspStatus(e,t){var o,n,s,d,r,l,a,i,c,_;if(!fs_extra_1.default.existsSync(e))return;const u=getJson5Obj(e),p=(null===(o=u.module)||void 0===o?void 0:o.type)===module_type_enum_js_1.ModuleType.Shared,m=(null===(n=u.module)||void 0===n?void 0:n.type)===module_type_enum_js_1.ModuleType.Har||(null===(d=null===(s=u.module)||void 0===s?void 0:s.distro)||void 0===d?void 0:d.moduleType)===module_type_enum_js_1.ModuleType.Har,h=(null===(r=u.module)||void 0===r?void 0:r.type)===module_type_enum_js_1.ModuleType.Entry||(null===(l=u.module)||void 0===l?void 0:l.type)===module_type_enum_js_1.ModuleType.Feature||(null===(i=null===(a=u.module)||void 0===a?void 0:a.distro)||void 0===i?void 0:i.moduleType)===module_type_enum_js_1.ModuleType.Entry||(null===(_=null===(c=u.module)||void 0===c?void 0:c.distro)||void 0===_?void 0:_.moduleType)===module_type_enum_js_1.ModuleType.Feature,y=this._isFaMode?"FA model":"Stage model",g=this._isFaMode?"Stage model":"FA model";return(m||p)&&this._isFaMode!==t&&log._buildError(`${y} module ${this._moduleName} does not allow Harmony library packages or modules in ${g}. Build tasks will not be executed, and resources will not be packed.`)._detail(solution)._file(e)._printErrorAndExit(this._moduleName),p?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP:m?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR:h?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAP:void 0}getHarmonyDependencyType(e,t,o,n){if(!e||null===t)return;const s=path_1.default.dirname(e),d=this.isHarForDiffPackManagement(s,t),r=this.getDependencyTypeByProfile(s);return d&&this._allDependency.has(`${e}@${n}`)&&e===o&&r===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&log._buildError("Shared Library cannot depend on shared module self.")._detail("Remove the dependency on the shared module.")._file(s)._printErrorAndExit(this._moduleName),d&&t.name&&!this._allDependency.has(`${e}@${n}`)?r:void 0}isHarForDiffPackManagement(e,t){return this._isOhpmDependency?fs_extra_1.default.existsSync(e):fs_extra_1.default.existsSync(e)&&void 0!==t.ohos}checkHarStatusIsCompatibleForHap(e,t){var o;if(this._model instanceof core_project_model_impl_js_1.CoreProjectModelImpl)return;const n=this._model;if(n.isHarModule())return;const s=this._isOhpmDependency?t.artifactType:null===(o=t.ohos)||void 0===o?void 0:o.artifactType;void 0!==s&&s!==har_extend_info_js_1.ArtifactType.ORIGINAL&&n instanceof legacy_module_model_impl_js_1.LegacyModuleModelImpl&&log._buildError(`Fa module ${this._moduleName} does not allow OpenHarmony npm packages,\n      which artifactType is not original.`)._solution(solution)._file(e)._printErrorAndExit(this._moduleName)}static isLocalDependencyForSo(e){return!e.includes("oh_modules")}static isLocalDependency(e,t){return t.has(e.getDependencyRootPath())}static getModuleNameFromOhPkgJson(e){var t;const o=oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(e,common_const_js_1.CommonConst.OH_PACKAGE_JSON5));if(!fs_extra_1.default.existsSync(o))return"";const n=getJson5Obj(o);return null!==(t=null==n?void 0:n.name)&&void 0!==t?t:""}static getRemoteDependencyRouterMapObjList(e){var t,o;const n=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),s=this.getModuleObjByDependency(e),d=null!==(t=(0,common_util_js_1.parsingProfileName)(null==s?void 0:s.module.routerMap))&&void 0!==t?t:void 0;if(!d)return;const r=getJson5Obj(path_1.default.resolve(n,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${d}.json`));return r.routerMap.forEach((t=>{Object.assign(t,{moduleNodeDir:e.getDependencyRootPath()})})),null!==(o=r.routerMap)&&void 0!==o?o:void 0}static getLocalDependencyRouterMapObjList(e,t){const o=this.getModuleModelByDependency(e,t);return o?this.getDependencyModuleRouterMapObjList(o):void 0}static getDependencyModuleRouterMapObjList(e){var t;const o=this.getDependencyModuleRouterMapJsonPath(e);if(!o||!fse.existsSync(o))return;const n=getJson5Obj(o);return n.routerMap.forEach((t=>{Object.assign(t,{moduleNodeDir:e.getModule().getNodeDir()})})),null!==(t=n.routerMap)&&void 0!==t?t:void 0}static getDependencyModuleRouterMapJsonPath(e){if(!e)return;const t=this.getRouterMapJsonFileName(e);return t?path_1.default.resolve(e.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${t}.json`):void 0}static getRouterMapJsonFileName(e){if(!e)return;const t=getJson5Obj(path_1.default.resolve(e.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,common_const_js_1.CommonConst.MODULE_JSON5)).module.routerMap;return(0,common_util_js_1.parsingProfileName)(t)}static getModuleModelByDependency(e,t){const o=t.getAllModules().find((o=>(t.isOhpmProject()?o.getOhPackageJson5Path():o.getPackageJsonPath())===e.getPackageFilePath()));return null!=o?o:void 0}static getModuleObjByDependency(e){const t=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),o=path_1.default.resolve(t,common_const_js_1.CommonConst.MODULE_JSON),n=path_1.default.resolve(t,common_const_js_1.CommonConst.MODULE_JSON5);return getJson5Obj(fse.existsSync(o)?o:fse.existsSync(n)?n:"")}getSODependencyType(e){return(null==e?void 0:e.includes(".so"))?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_SO:void 0}}function getEntryMainFilePath(e,t){const o=path_1.default.resolve(e,(0,hvigor_arkts_compose_1.findNodeEntryFiles)(t)[0]);if(fse.existsSync(o))return o;{const o=getEntryPath(t.main,t.types),n=path_1.default.resolve(e,o);return fse.existsSync(n)?n:""}}function getEntryPath(e,t){return e&&""!==e?e:t&&""!==t?t:build_directory_const_js_1.BuildArtifactConst.INDEX_ETS}exports.DependencyManager=DependencyManager,exports.getEntryMainFilePath=getEntryMainFilePath,exports.getEntryPath=getEntryPath;