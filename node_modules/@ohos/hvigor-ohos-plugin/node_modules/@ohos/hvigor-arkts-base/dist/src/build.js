"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,r)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.build=exports.writeWatchCache=void 0;const fs_1=__importDefault(require("fs")),fse=__importStar(require("fs-extra")),os_1=__importDefault(require("os")),path=__importStar(require("path")),rollup_1=require("rollup"),arkts_base_log_js_1=require("./log/arkts-base-log.js"),build_event_js_1=require("./util/build-event.js"),constants_js_1=require("./util/constants.js"),pack_js_1=require("./util/msgpack/pack.js"),struct_js_1=require("./util/msgpack/struct.js"),utils_js_1=require("./util/utils.js");(0,struct_js_1.updateReadStruct)();const logger=arkts_base_log_js_1.ArktsBaseLogger.getLogger("build"),extensionSet=new Set([".ets",".ts","js",".mjs",".cjs"]);let triggerTsWatch,watchParentPort,watchCache,watchEnableFileSystemCache,watchCacheDirectory,lastWatchRes,tsWatchEnd=!1,rollupWatchEnd=!1,isWatchFirst=!0;const lastReUsedFiles=new Set;function readWatchLogs(e){let t=[];const s=path.resolve(e??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);if(fs_1.default.existsSync(s))try{t=JSON.parse(fs_1.default.readFileSync(s).toString())}catch(e){logger.debug(`read watch logs failed ${e.message}`)}return t}function writeWatchLogs(){const e=path.resolve(watchCacheDirectory??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);try{fse.ensureFileSync(e),fs_1.default.writeFileSync(e,JSON.stringify(arkts_base_log_js_1.ArktsBaseLogger.getLastLogEvents()))}catch(e){logger.debug(`write watch logs failed ${e.message}`)}}function removeWatchLogs(){const e=path.resolve(watchCacheDirectory??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);fs_1.default.rmSync(e,{force:!0})}function writeWatchCache(e){lastWatchRes?(writeCache(watchEnableFileSystemCache,watchCache,watchCacheDirectory,e,void 0,void 0,!1),writeWatchLogs()):(removeCache(watchCacheDirectory),removeWatchLogs()),watchCache=void 0,watchEnableFileSystemCache=void 0,watchCacheDirectory=void 0}async function build(e,t,s,a,r,c,o){const n=e.startEvent("read build package cache");readCache(e,o),e.endEvent(n.getId()),removeUncacheableModules(e);const i=e.compileEnv,l=!!e.disableGenerateBundle,h=void 0===e.writeBundle||e.writeBundle,u=e.enableFileSystemCache,_=e.cacheDirectory,d=e.watchMode??"false",g=e.unsupportedChangedFiles??[],p=e.isPreview,f=e.pkgName2SourceRoots;if(deleteOptions(e),"true"===d){const o=e.startEvent(constants_js_1.ROLLUP_EVENT_NAME),n=await startWatch(e,p??!1,t,s,a,r,u,_,g,c);return e.endEvent(o.getId()),n}const E=e.startEvent(constants_js_1.ROLLUP_EVENT_NAME),m=await(0,rollup_1.rollup)(e);if(e.endEvent(E.getId()),!l)for(const t of e.output)h?await m.write(t):await m.generate(t);const v=e.startEvent("write build package cache");writeCache(u,m.cache,_,f,i,o,!0,v),e.endEvent(v.getId());const w=e.startEvent("wait for plug-in registration asynchronous task to complete");return await m.close(),await m.triggerBundleEnd(),e.endEvent(w.getId()),arkts_base_log_js_1.ArktsBaseLogger.reset(),{timing:m.getTimings&&m.getTimings(),callback:e=>{const t=getCacheTempFile(_),s=getCacheFile(_);e?(fse.existsSync(t)&&fse.renameSync(t,s),i&&o?.mount(i).setCache(s,getFinalCache(m.cache,f),!0)):fse.existsSync(t)&&fse.rmSync(t)}}}function deleteOptions(e){delete e.disableGenerateBundle,delete e.writeBundle,delete e.enableFileSystemCache,delete e.cacheDirectory,delete e.watchMode,delete e.unsupportedChangedFiles,delete e.isPreview,delete e.compileEnv,delete e.extensions,delete e.pkgName2SourceRoots,delete e.resolveConflictMode,delete e.depName2RootPath}function clearWatchData(){triggerTsWatch=!1,tsWatchEnd=!1,rollupWatchEnd=!1,arkts_base_log_js_1.ArktsBaseLogger.clearLogEvents(),lastReUsedFiles.clear()}function sendWatchResult(){isWatchFirst=!1,arkts_base_log_js_1.ArktsBaseLogger.sendLastLogEvents(lastReUsedFiles),lastWatchRes=!arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo(),watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_RESULT,content:lastWatchRes}),clearWatchData()}function processTsWatchEnd(){tsWatchEnd=!0,rollupWatchEnd&&sendWatchResult()}function processRollupWatchEnd(){rollupWatchEnd=!0,!tsWatchEnd&&triggerTsWatch||sendWatchResult()}function updateLastReUsedFiles(e){e.forEach((e=>lastReUsedFiles.add("Windows_NT"===os_1.default.type()?path.posix.join(...e.split(path.sep)):e)))}async function startWatch(e,t,s,a,r,c,o,n,i,l){arkts_base_log_js_1.ArktsBaseLogger.addLastLogEvents(readWatchLogs(n)),arkts_base_log_js_1.ArktsBaseLogger.setLogCallback(s,processTsWatchEnd),watchParentPort=a;const h=new Set;return new Promise(((s,a)=>{const u=(0,rollup_1.watch)(e);c(u),u.on("event",(e=>{switch(e.code){case"BUNDLE_START":watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_START}),validateUnsupportedChangedFiles(e.lastChangedFiles,i),updateTriggerTsWatchWithLastChangedFiles(e.lastChangedFiles);break;case"BUNDLE_END":if(isWatchFirst&&arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()){const e=arkts_base_log_js_1.ArktsBaseLogger.getLogEvents().filter((e=>"error"===e.level)).map((e=>e.msg)).join("");a(e)}r(),updateCache(o,e.result.cache,n),hotReload(t,e.result.watchFiles,h),e.result.getTimings?s({timing:e.result.getTimings()}):s({}),updateLastReUsedFiles(e.lastReUsedFiles),processRollupWatchEnd();break;case"ERROR":a(),arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:e.error.message,type:constants_js_1.PLUGIN_LOG_TYPE}),l&&l(e.error),processRollupWatchEnd()}}))}))}function hotReload(e,t,s){e||(isWatchFirst?(t.forEach((e=>s.add(e))),sendHotReloadWatchFileList(t)):validateWatchScope(t,s))}function validateUnsupportedChangedFiles(e,t){for(const s of t)if(e.has(s))throw arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:`${s} has been changed, which is not supported in watch mode. Please rebuild this module manually.`,type:constants_js_1.PLUGIN_LOG_TYPE}),new Error}function validateWatchScope(e,t){const s=(e="new files")=>{arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:`Importing ${e} is not supported in hot reload mode. Please rebuild this module manually.`,type:constants_js_1.PLUGIN_LOG_TYPE})};if(e.length>t.size)s();else for(const a of e)if(!t.has(a))return void s(a)}function updateTriggerTsWatchWithLastChangedFiles(e){for(const t of e.keys())if(willTriggerTsWatch(t)){triggerTsWatch=!0;break}triggerTsWatch=void 0===triggerTsWatch||triggerTsWatch,process.env.triggerTsWatch=String(triggerTsWatch)}function readCache(e,t){if(!e.enableFileSystemCache)return;const s=getCacheFile(e.cacheDirectory);if(fs_1.default.existsSync(s)){if(t&&e.cacheDirectory){const a=t.mount(e.compileEnv).getCache(s);if(a)return void(e.cache=a)}try{e.cache=(new pack_js_1.Packr).unpack(fs_1.default.readFileSync(s))}catch(e){logger.debug(`read cache file failed ${e.message}`)}(0,pack_js_1.resetPack)()}else t?.mount(e.compileEnv).delete(s)}function isBackupSourceRootExists(e,t=[]){return e.some((e=>!!(0,utils_js_1.findSuitableFilePath)(e,t)))}function removeUncacheableModules(e){const t=e.cache;if(!t||!t?.modules)return;const s=e.startEvent("remove uncacheable modules"),a=e.extensions,r=e.pkgName2SourceRoots;t.modules=t.modules.filter((e=>{const s=Object.values(e.resolvedIds||{}),c=e.meta.pkgName,o=r?.[c],n=t.pkgName2SourceRoots?.[c];return(n||[]).join(",")!==(o||[]).join(",")?!s.some((e=>!!e.meta?.resolvedBySourceRoot)):s.every((e=>{const t=e.meta;return!t?.resolvedBySourceRoot||!t?.backupSourceRoots?.length||!isBackupSourceRootExists(t.backupSourceRoots,a)}))})),e.endEvent(s.getId())}function updateCache(e,t,s){watchEnableFileSystemCache=e,watchCache=t,watchCacheDirectory=s}function getFinalCache(e,t){return e&&t?{...e,pkgName2SourceRoots:t}:e}function writeCache(e,t,s,a,r,c,o=!0,n){if(e&&t){const e=o?getCacheTempFile(s):getCacheFile(s);try{const s=n?.createSubEvent("get final cache").start(),i=getFinalCache(t,a);s?.stop();const l=n?.createSubEvent("pack cache").start(),h=(new pack_js_1.Packr).pack(i);l?.stop();const u=n?.createSubEvent("write cache").start();fse.ensureDirSync(path.resolve(e,"..")),fs_1.default.writeFileSync(e,h),c&&r&&!o&&c.mount(r).setCache(e,i,!0),u?.stop()}catch(e){logger.debug(`write cache file failed ${e.message}`)}(0,pack_js_1.resetPack)()}}function removeCache(e){const t=getCacheFile(e);fs_1.default.rmSync(t,{force:!0})}function getCacheFile(e){return e?path.join(e,constants_js_1.MSGPACK_COMPILE_CACHE_FILE_NAME):constants_js_1.MSGPACK_COMPILE_CACHE_FILE_NAME}function getCacheTempFile(e){return e?path.join(e,constants_js_1.MSGPACK_COMPILE_CACHE_FILE_NAME_TEMP):constants_js_1.MSGPACK_COMPILE_CACHE_FILE_NAME_TEMP}function willTriggerTsWatch(e){return extensionSet.has(path.extname(e))}function sendHotReloadWatchFileList(e){e&&watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_RESULT,content:JSON.stringify({isSuccess:!arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo(),watchFiles:e})})}exports.writeWatchCache=writeWatchCache,exports.build=build;