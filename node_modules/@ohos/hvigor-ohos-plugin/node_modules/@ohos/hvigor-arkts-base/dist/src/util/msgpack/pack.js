"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.resetPack=exports.addExtension=exports.Packr=exports.RECORD_SYMBOL=void 0;const unpack_1=require("./unpack");let textEncoder;try{textEncoder=new TextEncoder}catch(t){}const hasNodeBuffer="undefined"!=typeof Buffer,ByteArrayAllocate=hasNodeBuffer?function(t){return Buffer.allocUnsafeSlow(t)}:Uint8Array,ByteArray=hasNodeBuffer?Buffer:Uint8Array,MAX_BUFFER_SIZE=hasNodeBuffer?4294967296:2144337920;let target,targetView,safeEnd,position=0,packEnv={};exports.RECORD_SYMBOL=Symbol("record-id");const packArray=t=>{const e=t.length;e<16?target[position++]=144|e:e<65536?(target[position++]=220,target[position++]=e>>8,target[position++]=255&e):(target[position++]=221,targetView.setUint32(position,e),position+=4);for(let n=0;n<e;n++)pack(t[n])},getHeaderSize=t=>{let e;return e=t<32?1:t<256?2:t<65536?3:5,e},getLength=(t,e,n)=>{let r;if(t<64||!packEnv.encodeUtf8){let i,o,a,s=position+e;for(i=0;i<t;i++)o=n.charCodeAt(i),o<128?target[s++]=o:o<2048?(target[s++]=o>>6|192,target[s++]=63&o|128):55296==(64512&o)&&56320==(64512&(a=n.charCodeAt(i+1)))?(o=65536+((1023&o)<<10)+(1023&a),i++,target[s++]=o>>18|240,target[s++]=o>>12&63|128,target[s++]=o>>6&63|128,target[s++]=63&o|128):(target[s++]=o>>12|224,target[s++]=o>>6&63|128,target[s++]=63&o|128);r=s-position-e}else r=packEnv.encodeUtf8(n,position+e);return r},stringHandler=t=>{const e=t.length,n=getHeaderSize(e),r=3*e;position+r>safeEnd&&(target=makeRoom(position+r));const i=getLength(e,n,t);i<32?target[position++]=160|i:i<256?(n<2&&target.copyWithin(position+2,position+1,position+1+i),target[position++]=217,target[position++]=i):i<65536?(n<3&&target.copyWithin(position+3,position+2,position+2+i),target[position++]=218,target[position++]=i>>8,target[position++]=255&i):(n<5&&target.copyWithin(position+5,position+3,position+3+i),target[position++]=219,targetView.setUint32(position,i),position+=4),position+=i},numberHandler=t=>{t>>>0===t?t<64?target[position++]=t:t<256?(target[position++]=204,target[position++]=t):t<65536?(target[position++]=205,target[position++]=t>>8,target[position++]=255&t):(target[position++]=206,targetView.setUint32(position,t),position+=4):(t|0)===t?t>=-32?target[position++]=256+t:t>=-128?(target[position++]=208,target[position++]=t+256):t>=-32768?(target[position++]=209,targetView.setInt16(position,t),position+=2):(target[position++]=210,targetView.setInt32(position,t),position+=4):(target[position++]=203,targetView.setFloat64(position,t),position+=8)},mapHandler=t=>{const e=t.size;e<16?target[position++]=128|e:e<65536?(target[position++]=222,target[position++]=e>>8,target[position++]=255&e):(target[position++]=223,targetView.setUint32(position,e),position+=4);for(const[e,n]of t)pack(e),pack(n)},afterExtension=(t,e)=>{if(Array.isArray(t))packArray(t);else{if(t.toJSON){const e=t.toJSON();if(e!==t)return pack(e)}if("function"===e)return pack(void 0);writeObject(t,!t.hasOwnProperty)}},useExtension=(t,e)=>{for(let e=0,n=extensions.length;e<n;e++){if(!(t instanceof extensionClasses[e]))continue;const n=extensions[e];if(n.write){n.type&&(target[position++]=212,target[position++]=n.type,target[position++]=0);const e=n.write.call(this,t);return void(e===t?Array.isArray(t)?packArray(t):writeObject(t):pack(e))}let r=target;const i=targetView,o=position;let a;target=null;try{a=n.pack.call(this,t,(t=>(target=r,r=null,position+=t,position>safeEnd&&makeRoom(position),{target:target,targetView:targetView,position:position-t})),pack)}finally{r&&(position=o,target=r,targetView=i,safeEnd=target.length-10)}return void(a&&(a.length+position>safeEnd&&makeRoom(a.length+position),position=writeExtensionData(a,target,position,n.type)))}return afterExtension(t,e)},objOrFuncHandler=(t,e)=>{if(t){const n=t.constructor;if(n===Object)writeObject(t,!0);else if(n===Array)packArray(t);else{if(n!==Map)return useExtension(t,e);mapHandler(t)}}else target[position++]=192},pack=t=>{position>safeEnd&&(target=makeRoom(position));const e=typeof t;if("string"===e)stringHandler(t);else if("number"===e)numberHandler(t);else{if("object"===e||"function"===e)return objOrFuncHandler(t,e);if("boolean"===e)target[position++]=t?195:194;else if("bigint"===e){if(t<BigInt(1)<<BigInt(63)&&t>=-(BigInt(1)<<BigInt(63)))target[position++]=211,targetView.setBigInt64(position,t);else{if(!(t<BigInt(1)<<BigInt(64)&&t>0))throw new RangeError(`${t} was too large to fit in MessagePack 64-bit integer format, set largeBigIntToFloat to convert to float-64`);target[position++]=207,targetView.setBigUint64(position,t)}position+=8}else{if("undefined"!==e)throw new Error(`Unknown type: ${e}`);target[position++]=212,target[position++]=0,target[position++]=0}}},writeObject=(t,e)=>{let n,r=packEnv.structures.transitions||(packEnv.structures.transitions=Object.create(null)),i=0;for(const o in t)(e||Object.prototype.hasOwnProperty.call(t,o))&&(n=r[o],n||(n=r[o]=Object.create(null),i++),r=n);const o=r[exports.RECORD_SYMBOL];o?target[position++]=o:newRecord(r,r.__keys__||Object.keys(t),i);for(const n in t)(e||Object.prototype.hasOwnProperty.call(t,n))&&pack(t[n])},makeRoom=t=>{let e;if(t>16777216){if(t-packEnv.start>MAX_BUFFER_SIZE)throw new Error("Packed buffer would be larger than maximum buffer size");e=Math.min(MAX_BUFFER_SIZE,4096*Math.round(Math.max((t-packEnv.start)*(t>67108864?1.25:2),4194304)/4096))}else e=1+(Math.max(t-packEnv.start<<2,target.length-1)>>12)<<12;const n=new ByteArrayAllocate(e);return targetView=n.dataView||(n.dataView=new DataView(n.buffer,0,e)),t=Math.min(t,target.length),target.copy?target.copy(n,0,packEnv.start,t):n.set(target.slice(packEnv.start,t)),position-=packEnv.start,packEnv.start=0,safeEnd=n.length-10,target=n},newRecord=(t,e,n)=>{let r=packEnv.structures.nextId;r||(r=64),r>=packEnv.maxStructureId&&(r=packEnv.sharedLimitId),packEnv.structures.nextId=r+1;const i=e.highByte=-1;t[exports.RECORD_SYMBOL]=r,t.__keys__=e,packEnv.structures[r-64]=e,r<packEnv.sharedLimitId?(e.isShared=!0,packEnv.structures.sharedLength=r-63,packEnv.hasSharedUpdate=!0,i>=0?(target[position++]=96+(31&r),target[position++]=i):target[position++]=r):(i>=0?(target[position++]=213,target[position++]=114,target[position++]=96+(31&r),target[position++]=i):(target[position++]=212,target[position++]=114,target[position++]=r),n&&(packEnv.transitionsCount+=packEnv.serializationsSinceTransitionRebuild*n),packEnv.recordIdsToRemove.length>=packEnv.maxOwnStructures&&(packEnv.recordIdsToRemove.shift()[exports.RECORD_SYMBOL]=0),packEnv.recordIdsToRemove.push(t),pack(e))},noTarget=()=>{target||(target=new ByteArrayAllocate(8192),targetView=target.dataView||(target.dataView=new DataView(target.buffer,0,8192)),position=0)},checkSharedLength=t=>{if(t>packEnv.maxSharedStructures)throw new Error(`Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to ${packEnv.structures.sharedLength}`)},updatePosition=()=>{safeEnd=target.length-10,safeEnd-position<2048?(target=new ByteArrayAllocate(target.length),targetView=target.dataView||(target.dataView=new DataView(target.buffer,0,target.length)),safeEnd=target.length-10,position=0):position=position+7&2147483640};class Packr extends unpack_1.Unpackr{constructor(){super(),this.offset=0,this.structures=[],this.initPackEnv()}pack(t){if(noTarget(),updatePosition(),packEnv.start=position,packEnv.structures=packEnv.packr.structures,packEnv.structures){const t=packEnv.structures.sharedLength||0;checkSharedLength(t),packEnv.structures.transitions||(packEnv.structures.transitions=Object.create(null),this.lastNamedStructuresLength=t),packEnv.structures.nextId=t+64}packEnv.hasSharedUpdate&&(packEnv.hasSharedUpdate=!1);try{return pack(t),packEnv.packr.offset=position,target.subarray(packEnv.start,position)}finally{this.finalHandler()}}finalHandler(){if(packEnv.structures){packEnv.serializationsSinceTransitionRebuild<10&&packEnv.serializationsSinceTransitionRebuild++;const t=packEnv.structures.sharedLength||0;if(packEnv.structures.length>t&&(packEnv.structures.length=t),packEnv.transitionsCount>1e4)packEnv.structures.transitions=null,packEnv.serializationsSinceTransitionRebuild=0,packEnv.transitionsCount=0,packEnv.recordIdsToRemove.length>0&&(packEnv.recordIdsToRemove=[]);else if(packEnv.recordIdsToRemove.length>0){for(let t=0,e=packEnv.recordIdsToRemove.length;t<e;t++)packEnv.recordIdsToRemove[t][exports.RECORD_SYMBOL]=0;packEnv.recordIdsToRemove=[]}}}initPackEnv(){packEnv.start=0,packEnv.hasSharedUpdate=!1,packEnv.structures=[],packEnv.encodeUtf8=ByteArray.prototype.utf8Write?function(t,e){return target.utf8Write(t,e,4294967295)}:!(!textEncoder||!textEncoder.encodeInto)&&function(t,e){return textEncoder.encodeInto(t,target.subarray(e)).written},packEnv.packr=this,packEnv.maxSharedStructures=0,packEnv.maxOwnStructures=64,packEnv.sharedLimitId=64,packEnv.maxStructureId=packEnv.maxOwnStructures+64,packEnv.recordIdsToRemove=[],packEnv.transitionsCount=0,packEnv.serializationsSinceTransitionRebuild=0}}exports.Packr=Packr;const extensionClasses=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,unpack_1.C1Type],dataExtension={pack(t,e){const n=t.getTime()/1e3;if(0===t.getMilliseconds()&&n>=0&&n<4294967296){let{target:t,targetView:r,position:i}=e(6);t[i++]=214,t[i++]=255,r.setUint32(i,n)}else if(n>0&&n<4294967296){let{target:r,targetView:i,position:o}=e(10);r[o++]=215,r[o++]=255,i.setUint32(o,4e6*t.getMilliseconds()+(n/1e3/4294967296|0)),i.setUint32(o+4,n)}else if(isNaN(n)){let{target:t,position:n}=e(3);t[n++]=212,t[n++]=255,t[n++]=255}else{let{target:r,targetView:i,position:o}=e(15);r[o++]=199,r[o++]=12,r[o++]=255,i.setUint32(o,1e6*t.getMilliseconds()),i.setBigInt64(o+4,BigInt(Math.floor(n)))}}},extensions=[dataExtension,{pack(t,e,n){e(0),n(Array.from(t))}},{pack(t,e,n){e(0),n([t.name,t.message])}},{pack(t,e,n){e(0),n([t.source,t.flags])}},{pack(t,e){writeBuffer(hasNodeBuffer?Buffer.from(t):new Uint8Array(t),e)}},{pack(t,e){writeBuffer(t,e)}},{pack(t,e){const{target:n,position:r}=e(1);n[r]=193}}];function writeBuffer(t,e){const n=t.byteLength;if(n<256){let{target:r,position:i}=e(n+2);r[i++]=196,r[i++]=n,r.set(t,i)}else if(n<65536){let{target:r,position:i}=e(n+3);r[i++]=197,r[i++]=n>>8,r[i++]=255&n,r.set(t,i)}else{let{target:r,position:i,targetView:o}=e(n+5);r[i++]=198,o.setUint32(i,n),i+=4,r.set(t,i)}}function writeExtensionData(t,e,n,r){const i=t.length;switch(i){case 1:e[n++]=212;break;case 2:e[n++]=213;break;case 4:e[n++]=214;break;case 8:e[n++]=215;break;case 16:e[n++]=216;break;default:i<256?(e[n++]=199,e[n++]=i):i<65536?(e[n++]=200,e[n++]=i>>8,e[n++]=255&i):(e[n++]=201,e[n++]=i>>24,e[n++]=i>>16&255,e[n++]=i>>8&255,e[n++]=255&i)}return e[n++]=r,e.set(t,n),n+=i}function addExtension(t){if(t.Class){if(!t.pack&&!t.write)throw new Error("Extension has no pack or write function.");if(t.pack&&!t.type)throw new Error("Extension has no type (numeric code to identify the extension).");extensionClasses.unshift(t.Class),extensions.unshift(t)}(0,unpack_1.addExtension)(t)}function resetPack(){target=void 0,targetView=void 0,position=0,safeEnd=void 0,packEnv={},(0,unpack_1.resetUnpack)()}exports.addExtension=addExtension,exports.resetPack=resetPack;