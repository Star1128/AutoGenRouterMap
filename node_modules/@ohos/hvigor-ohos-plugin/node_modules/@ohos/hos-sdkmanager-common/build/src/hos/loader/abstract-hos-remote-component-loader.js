"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(n,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractHosRemoteComponentLoader=void 0;const sdkmanager_common_1=require("@ohos/sdkmanager-common"),hos_biz_util_1=require("../util/hos-biz-util"),hos_component_dto_1=require("../dto/hos-component-dto"),hos_archive_dto_1=require("../dto/hos-archive-dto"),loader_util_1=require("./loader-util");class AbstractHosRemoteComponentLoader extends sdkmanager_common_1.AbstractComponentLoader{constructor(e,t,o){super(o),this.settings=e,this.netClient=t}load(){return __awaiter(this,void 0,void 0,(function*(){try{const e=yield this.settings.getGrsService();if(!e)return this.progress.warn("Failed to request remote HarmonyOS SDK, grsService is undefined"),[];const t=(0,hos_biz_util_1.getQueryMetaUrl)(e),o=yield this.netClient.doPost(t,this.progress,this.createReqParam(),this._createHeader());if(!o)return this.progress.warn("Failed to request remote HarmonyOS SDK, result is empty"),[];const r=[];for(const e of o){if(!this._shouldShow(e))continue;const t=this.convertComponent(e);this.isValidComponent(t)&&this.addComponent(r,t)}return r}catch(e){this.progress.warn(e)}return[]}))}_createHeader(){return{AppId:"DevEcoStudio_Lib",Version:"0.0.0.1"}}_shouldShow(e){return e.experimentalFlag===Experimental.NO}convertComponent(e){const t=new hos_component_dto_1.HosComponentDto;Object.assign(t,e);const o=Number(e.apiVersion);return Number.isNaN(o)||(t.apiVersion=o),this._configArchive(e,t),t.displayName=this.convertDisplayName(t),(0,loader_util_1.configHosSdkVersion)(t),this._replaceStageSpace(t),t.location=this.getLocation(t,this.settings.getLocation()),t}_replaceStageSpace(e){e.stage&&(e.stage=e.getStage().replace("-"," "))}_configArchive(e,t){var o,r,n,i;const s=new hos_archive_dto_1.HosArchiveDto;let a=Number(null===(r=null===(o=null==e?void 0:e.archive)||void 0===o?void 0:o.complete)||void 0===r?void 0:r.size);Number.isNaN(a)&&(a=0),s.complete={size:a,checksum:null===(i=null===(n=null==e?void 0:e.archive)||void 0===n?void 0:n.complete)||void 0===i?void 0:i.checksum},t.archive=s}addComponent(e,t){e.push(t)}}var Experimental;exports.AbstractHosRemoteComponentLoader=AbstractHosRemoteComponentLoader,function(e){e.YES="1",e.NO="0"}(Experimental||(Experimental={}));