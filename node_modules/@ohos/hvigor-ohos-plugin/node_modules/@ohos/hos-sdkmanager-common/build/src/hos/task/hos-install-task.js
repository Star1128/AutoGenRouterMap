"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,r)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function a(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}l((n=n.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HosInstallTask=void 0;const sdkmanager_common_1=require("@ohos/sdkmanager-common"),hos_biz_util_1=require("../util/hos-biz-util"),os=__importStar(require("os")),path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),hos_component_constants_1=require("../const/hos-component-constants");class HosInstallTask extends sdkmanager_common_1.AbstractInstallTask{constructor(e,t,o){super(e,t,o),this._throwDownloadUrlNotFoundException=()=>{throw new sdkmanager_common_1.SdkException("",new sdkmanager_common_1.ErrorTip("Could not found download url.","The network or server is abnormal.",`${os.EOL}1. Check the network connection and download the file again.\n          ${os.EOL}2. If the issue persists, choose Help > Show Log in Explorer to obtain logs, \n          and then choose Help > Contact Support for technical assistance.`))},this._throwDownloadFailedException=()=>{throw new sdkmanager_common_1.SdkException("",new sdkmanager_common_1.ErrorTip("Failed to download sdk","The network or server is abnormal",`${os.EOL}1. Check the network connection and download the file again.            ${os.EOL}2. If the issue persists, choose Help > Show Log in Explorer to obtain logs,           and then choose Help > Contact Support for technical assistance.`))}}download(e){return __awaiter(this,void 0,void 0,(function*(){e.debug("start to download SDK");const t=yield this._reqDownloadMeta(e),o=path_1.default.resolve(this.getWorkDir(),this._getFileName(t.url));return yield this._downloadComponent(o,t,e),o}))}getWorkDir(){return path_1.default.resolve(this.getRootWorkDir(),this.getComponent().getPath(),"install")}getTempComponentPath(){const e=path_1.default.resolve(this.getWorkDir(),"unzip");if(!fs_1.default.existsSync(path_1.default.resolve(e,this.getUniPackageName())))throw new sdkmanager_common_1.SdkException("",new sdkmanager_common_1.ErrorTip("",`Illegal component ${this.getComponent().getFullName()}, \n        failed to find meta data.`,"Choose Help > Show Log in Explorer to obtain logs, and then choose Help > Contact Support for technical assistance."));return e}_reqDownloadMeta(e){return __awaiter(this,void 0,void 0,(function*(){try{const t=yield this.sdkSettings.getGrsService(),o=(0,hos_biz_util_1.getSdkDownloadUrl)(t),n=yield this.netClient.doPost(o,e,this.createReqDto(e),this._configHeader());return((0,sdkmanager_common_1.isEmpty)(n.versionType)||(0,sdkmanager_common_1.isEmpty)(n.url))&&this._throwDownloadUrlNotFoundException(),{versionType:n.versionType,url:n.url}}catch(e){if(e instanceof sdkmanager_common_1.SdkException)throw e;this._throwDownloadUrlNotFoundException()}return{versionType:"",url:""}}))}createReqDto(e){return{osType:(0,hos_biz_util_1.convertOsType)(this.sdkSettings.getOsType()),osArch:(0,sdkmanager_common_1.getOsArch)(e),path:{path:this.component.getPath(),version:this.component.getVersion()},imei:"",country:"CN",deviceName:"DevEcoStudio"}}_configHeader(){return{AppId:"DevEcoStudio_Lib",Version:"0.0.0.1"}}_getFileName(e){(0,sdkmanager_common_1.isEmpty)(e)&&this._throwDownloadUrlNotFoundException();const t=e.lastIndexOf("/");return-1===t?e:e.substring(t+1)}_downloadComponent(e,t,o){return __awaiter(this,void 0,void 0,(function*(){o.info(`Downloading ${t.url}...`),(0,sdkmanager_common_1.ensureParentDir)(e);try{fs_1.default.rmSync(e,{force:!0,recursive:!0})}catch(t){throw new sdkmanager_common_1.SdkException(null==t?void 0:t.message,new sdkmanager_common_1.ErrorTip("",`Unable to delete ${e}. A file may be open by another program.`,"Close the open file, delete the folder, and then download the SDK again."))}let n;n=t.versionType===VersionType.GRAY?yield this._downloadGray(t,e,o):yield this._downloadCommercial(t,e,o),n||this._throwDownloadFailedException()}))}_downloadGray(e,t,o){return __awaiter(this,void 0,void 0,(function*(){if("CN"!==this.sdkSettings.getCountry())throw new sdkmanager_common_1.SdkException("",new sdkmanager_common_1.ErrorTip("",`Unable to find sdk, country code is ${this.sdkSettings.getCountry()}`,"Check the network and try again or contact official support."));return this.netClient.doPostDownload(e.url,t,o,{rules:{IMEI:""}})}))}_downloadCommercial(e,t,o){return __awaiter(this,void 0,void 0,(function*(){return this.netClient.doGetDownload(e.url,t,o)}))}getUniPackageName(){return hos_component_constants_1.HOS_UNI_PACKAGE_NAME}}var VersionType;exports.HosInstallTask=HosInstallTask,function(e){e.COMMERCIAL="1",e.GRAY="2"}(VersionType||(VersionType={}));