"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HosLocalComponentLoader=void 0;const hos_component_constants_1=require("../const/hos-component-constants"),path_1=__importDefault(require("path")),sdkmanager_common_1=require("@ohos/sdkmanager-common"),fs_1=__importDefault(require("fs")),hos_component_dto_1=require("../dto/hos-component-dto"),loader_util_1=require("./loader-util"),hos_location_mapper_1=require("./hos-location-mapper"),hos_version_mapper_1=require("../api/hos-version-mapper"),path_and_hos_sdk_version_1=require("../dto/path-and-hos-sdk-version"),object_unique_map_1=require("../util/object-unique-map");class HosLocalComponentLoader extends sdkmanager_common_1.AbstractLocalComponentLoader{constructor(o,e){super(HosLocalComponentLoader.MAX_SCAN_DEPTH,o,e),this._inCompatibleComponents=new Array}parseSdks(o){const e=new object_unique_map_1.ObjectUniqueMap;for(const t of o)try{const o=fs_1.default.readFileSync(t,{encoding:"utf-8"}),n=JSON.parse(o),s=this._convertComponent(n,t);if(!this.isValidComponent(s))continue;if(!this._isCompatibleMetaVersion(s))continue;if(this._isIncompatibleComponent(s))continue;if(!this._isComponentInRightPlace(s)){this.progress.debug(`Component ${s.getFullName()} has been placed in the wrong place,\n             expect ${this._getExpectedLocation(s)}, actual ${s.getLocation()}`);continue}this._addToMap(e,s)}catch(o){this.progress.warn(`Failed to get uni-package info, ${o.message}`)}const t=[];return e.forEach((o=>t.push(o))),t}_addToMap(o,e){const t=new path_and_hos_sdk_version_1.PathAndHosSdkVersion(e.getPath(),e.getHosSdkVersion()),n=o.get(t);(null==n||n.compareTo(e)<0)&&o.set(t,e)}getUniPackageName(){return hos_component_constants_1.HOS_UNI_PACKAGE_NAME}_convertComponent(o,e){const t=new hos_component_dto_1.HosComponentDto,n=o.data;t.path=n.path,t.version=n.version,t.releaseType=n.releaseType,t.displayName=n.displayName,t.stage=n.stage,t.platformVersion=n.platformVersion;const s=Number(n.apiVersion);return Number.isNaN(s)||(t.apiVersion=s),this._configMeta(o,t),t.displayName=this.convertDisplayName(t),t.location=path_1.default.resolve(e,".."),(0,loader_util_1.configHosSdkVersion)(t),t}_configMeta(o,e){var t;const n=new hos_component_dto_1.HosMetaDto,s=null===(t=o.meta)||void 0===t?void 0:t.version;if(!(0,sdkmanager_common_1.isEmpty)(s))return n.version=s,void(e.meta=n);n.version=hos_component_constants_1.VERSION_1_0_0,e.meta=n}_isCompatibleMetaVersion(o){var e;const t=null===(e=o.getMeta())||void 0===e?void 0:e.getMetaVersion();if((0,sdkmanager_common_1.isEmpty)(t)||!sdkmanager_common_1.META_VERSION_PATTERN.test(t))return this.progress.debug(`Illegal component ${o.displayName}:${o.version}, Incorrect meta version ${t}`),!1;return 0===(0,sdkmanager_common_1.compareVersion)(t,hos_component_constants_1.SUPPORT_META_VERSION)||(hos_component_constants_1.HOS_REQUIRE_COMPATIBLE_META_VERSION===t||(this._inCompatibleComponents.push(o),!1))}_isComponentInRightPlace(o){return o.getLocation()===this._getExpectedLocation(o)||(this._inCompatibleComponents.push(o),!1)}_getExpectedLocation(o){const e=(0,hos_location_mapper_1.generatePath)(o);return(0,sdkmanager_common_1.isEmpty)(e)?"":path_1.default.resolve(this.getSdkRoot(),e)}getSdkRoot(){return this.sdkRoot}getInCompatibleComponents(){return this._inCompatibleComponents}_isIncompatibleComponent(o){if(sdkmanager_common_1.ComponentPath.EMULATOR===o.path&&(0,sdkmanager_common_1.compareVersion)(o.version,hos_component_constants_1.EMULATOR_INCOMPATIBLE_VERSION)<=0)return this._inCompatibleComponents.push(o),!0;if(o.hasApiVersion()){const e=hos_version_mapper_1.HosVersionMapper.INSTANCE.getBaseApi(o.getHosSdkVersion().getPlatformVersion().getVersion());if(0===e.length)return!0;if(!e.some((e=>e===o.getHosSdkVersion().getBaseApi())))return this._inCompatibleComponents.push(o),!0}return!1}}exports.HosLocalComponentLoader=HosLocalComponentLoader,HosLocalComponentLoader.MAX_SCAN_DEPTH=5;