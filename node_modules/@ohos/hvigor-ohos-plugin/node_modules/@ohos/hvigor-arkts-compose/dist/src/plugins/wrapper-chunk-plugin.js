"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.wrapperChunkPlugin=void 0;const magic_string_1=__importDefault(require("magic-string")),VARIABLE_DECLARATION="VariableDeclaration",CALL_EXPRESSION="CallExpression",EXPRESSION_STATEMENT="ExpressionStatement",REQUIRE_NAME="require",VAR_NAME="var";function wrapperChunkPlugin(){return{name:"wrapperChunkPlugin",renderChunk:renderChunk}}function renderChunk(e,n,t,{chunks:r}){const o=new magic_string_1.default(e);return(this.share.projectConfig.supportChunks??!1)&&analyzeImportAndExport(this.parse,n,e,o,r),o.appendLeft(0,"(function () {\n"),o.append("\n})()"),{code:o.toString(),map:t.sourcemap?o.generateMap({hires:!0}):null}}function analyzeImportAndExport(e,n,t,r,o){0!==n.imports.length&&analyzeImport(e(t),n,r,o);0!==n.exports.length&&analyzeExport(n,r)}function analyzeImport(e,n,t,r){const o=new Set;for(const e of n.imports)0===n.importedBindings[e].length&&o.add(e);for(const a of e.body)a.type===VARIABLE_DECLARATION&&a.kind===VAR_NAME&&replaceRequireVariable(a,n,t,r),a.type===EXPRESSION_STATEMENT&&0!==o.size&&a.expression.type===CALL_EXPRESSION&&a.expression.callee.name===REQUIRE_NAME&&removeEmptyRequire(a,n,o,t)}function replaceRequireVariable(e,n,t,r){for(const o of e.declarations){const e=o.init;if(!e||e.type!==CALL_EXPRESSION||e.callee?.name!==REQUIRE_NAME)continue;let a;for(const e of o.init.arguments){const t=e.value;if(n.importsPathMap.get(t)){a=n.importsPathMap.get(t);break}}a&&t.overwrite(e.start,e.end,`globalThis['${a}_${r[a]?.chunkHash}']`)}}function removeEmptyRequire(e,n,t,r){for(const o of e.expression.arguments){const a=o.value,i=n.importsPathMap.get(a);if(t.has(i)){r.remove(e.start,e.end);break}}}function analyzeExport(e,n){const t=[];for(const[n]of e.exportsByName)t.push(`${n}: exports.${n}`);n.append(`\nglobalThis['${e.fileName}_${e?.chunkHash}'] \n        = globalThis['${e.fileName}_${e?.chunkHash}'] || {\n  ${t.join(",\n  ")}\n}`)}exports.wrapperChunkPlugin=wrapperChunkPlugin;