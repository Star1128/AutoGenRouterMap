"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.watch=exports.compileCodeSnippet=exports.loadAceBuildJson=exports.getResolveModules=exports.runArkPack=void 0;const hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),plugin_commonjs_1=__importDefault(require("@rollup/plugin-commonjs")),plugin_json_1=__importDefault(require("@rollup/plugin-json")),plugin_node_resolve_1=__importDefault(require("@rollup/plugin-node-resolve")),fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),index_js_1=__importDefault(require("../src/plugins/node-resolve/index.js")),compile_event_factory_js_1=require("./analyzer/compile-event-factory.js"),compile_perf_js_1=require("./analyzer/compile-perf.js"),compose_error_js_1=require("./data/compose-error.js"),collect_importers_plugin_js_1=require("./plugins/collect-importers-plugin.js"),common_plugin_js_1=require("./plugins/common-plugin.js"),copy_plugin_js_1=__importDefault(require("./plugins/copy-plugin.js")),delete_plugin_js_1=__importDefault(require("./plugins/delete-plugin.js")),gc_plugin_js_1=require("./plugins/gc-plugin.js"),ignore_plugin_js_1=require("./plugins/ignore-plugin.js"),importCheckPlugin_js_1=require("./plugins/importCheckPlugin.js"),invalid_cache_plugin_js_1=require("./plugins/invalid-cache-plugin.js"),module_meta_info_plugin_js_1=require("./plugins/module-meta-info-plugin.js"),preview_resource_watcher_plugin_js_1=require("./plugins/preview-resource-watcher-plugin.js"),router_map_plugin_js_1=require("./plugins/router-map-plugin.js"),use_new_ohm_url_plugin_js_1=require("./plugins/use-new-ohm-url-plugin.js"),use_sensitive_check_plugin_js_1=require("./plugins/use-sensitive-check-plugin.js"),wait_async_plugin_js_1=require("./plugins/wait-async-plugin.js"),wrapper_chunk_plugin_js_1=require("./plugins/wrapper-chunk-plugin.js"),constants_js_1=require("./util/constants.js"),copy_resources_js_1=require("./util/copy-resources.js"),load_sdk_functions_js_1=require("./util/load-sdk-functions.js"),log_adaptor_js_1=require("./util/log-adaptor.js"),utils_js_1=require("./util/utils.js"),compile_code_snippet_js_1=require("./work-scripts/compile-code-snippet.js"),PROCESS_UN_HANDLED_REJECTION="unhandledRejection",PROCESS_UN_CAUGHT_EXCEPTION="uncaughtException",logger=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("arkts-pack"),defaultProjectConfig={watchMode:"false",isPreview:!1,buildMode:constants_js_1.RELEASE,compileMode:constants_js_1.JSBUNDLE},getMergedConfig=e=>{const t={...defaultProjectConfig},r=new Set([...Object.keys(defaultProjectConfig),...Object.keys(e)]);for(const s of r)void 0!==e[s]&&(t[s]=e[s]);return t.arkTSVersion=e.arkTSVersion,t};function addCompilerLogMsg(e,t){let r=`${e}${os_1.default.EOL}`,s=1,o=0,n=0,a="",i="",l="";const u="[31m",c="[39m";return hvigor_arkts_base_1.ArktsBaseLogger.getLogEvents().forEach((e=>{if("error"===e.level){const r=new log_adaptor_js_1.ArkTsLogAdaptor(String(e.msg),t).getLogMessage();a+=`${u}${s} ERROR: ${r.message}`,r.solutions&&(a+=`${os_1.default.EOL} ${os_1.default.EOL}* Try the following:`,r.solutions.forEach((e=>{a+=`${os_1.default.EOL}> ${e}`}))),r.moreInfo&&(a+=`${os_1.default.EOL}> More Info: ${r.moreInfo}${os_1.default.EOL}`),a+=`${os_1.default.EOL}${c}${os_1.default.EOL}`,s++}"warn"===e.level&&(o++,i+=`[33m${o} WARN: ${e.msg}${c}${os_1.default.EOL}`),"info"===e.level&&(n++,l+=`[34m${n} INFO: ${e.msg}${c}${os_1.default.EOL}`)})),r=`${r}${l}${i}${a}${u}COMPILE RESULT:FAIL {ERROR:${s}`+(0===o?"":` WARN:${o}`)+`${0===n?"":` INFO:${n}`}}${c}`,r}let watcher,isWatchFirst=!0;const setWatcher=e=>{watcher=e};function registerCatchUnhandleError(e,t,r,s){process.on(PROCESS_UN_HANDLED_REJECTION,(e=>{throw e})),process.on(PROCESS_UN_CAUGHT_EXCEPTION,(o=>{if("true"===e.watchMode)return watcher?.resolveDonePromise(),s?.error(o),void r?.postMessage(isWatchFirst?{event:hvigor_arkts_base_1.WatchEvent.WATCH_WORK_ERROR}:{type:hvigor_arkts_base_1.WatchEvent.WATCH_RESULT,content:!1});if(o.name===compose_error_js_1.ARKTS_COMPILER_ERROR_NAME){const r=o,s=new Error(addCompilerLogMsg(o.message,e.buildId));throw r.stack&&s.stack&&(s.stack=s.stack.concat(os_1.default.EOL).concat(r.stack)),t(s),s}throw o}))}function getRollupErrorMessage(e){return e.loc&&e.loc.file?`${e.message+os_1.default.EOL+e.loc.file}:${e.loc.line}`:e.message}function noop(){}async function runArkPack(e,t,r,s,o,n){e.startEvent=e=>compile_event_factory_js_1.CompileEventFactory.createEvent(e,0,0).start(),e.endEvent=e=>compile_event_factory_js_1.CompileEventFactory.getEventById(e)?.stop();const a=new compile_perf_js_1.CompilePerf(e.perf).clear();let i;hvigor_arkts_base_1.ArktsBaseLogger.clearLogEvents(),isWatchFirst=!0,registerCatchUnhandleError(e,t,s,o);let l=noop;try{l=await collectCompilePerf(e,a,r,s,o,n)}catch(e){if(e instanceof Error){const t="RollupError"===e.name?getRollupErrorMessage(e):e.message;i=new compose_error_js_1.ArkTsCompilerError(t,e.stack)}else i="string"==typeof e?new Error(e):e}if(isWatchFirst=!1,hvigor_arkts_base_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()&&"true"!==e.watchMode&&!i&&(i=new compose_error_js_1.ArkTsCompilerError("ArkTS Compiler Error")),"true"!==e.watchMode&&clearWorkerProcessContext(),i){if(i.name===compose_error_js_1.ARKTS_COMPILER_ERROR_NAME){const t=new Error(addCompilerLogMsg(i.message,e.buildId));i.stack&&t.stack&&(t.stack=t.stack.concat(os_1.default.EOL).concat(i.stack)),i=t}return l(!1),{compileLogEvents:[],compileEvents:[],isSuccess:!1,error:i}}return l(!0),{compileLogEvents:hvigor_arkts_base_1.ArktsBaseLogger.getLogEvents(),compileEvents:updateEventNames(Array.from(a.transform())),isSuccess:!0}}async function collectCompilePerf(e,t,r,s,o,n){const a=e.startEvent("generate configuration information"),i=generateConfig(e,o,n);if(validComposedOhPackagePathMap(e),e.endEvent(a.getId()),i.input&&Object.keys(i.input).length>0){const a=()=>e.isPreview&&s&&(0,compile_code_snippet_js_1.initServer)(e.cachePath,e.aceModuleBuild,e.etsLoaderPath,s),l=e=>{o?.error(e)},u=await(0,hvigor_arkts_base_1.runHvigorCompile)(i,r,s,a,setWatcher,l,n);return collectTimers(u.timing,t),u.callback??noop}return noop}function collectTimers(e,t){if(e)for(const[r,[s,o,n,a,i,l,u]]of Object.entries(e))t.collect({name:r,time:s,startTime:o,endTime:n,frequency:a,memory:i,totalMemory:u,startMemory:l})}function clearProcessListeners(){process.removeAllListeners(PROCESS_UN_CAUGHT_EXCEPTION),process.removeAllListeners(PROCESS_UN_HANDLED_REJECTION)}function clearWorkerProcessContext(){(0,load_sdk_functions_js_1.clearSdkContext)(),clearProcessListeners()}function getResolveModules(e){const t=e.packageManagerType===constants_js_1.OHPM?constants_js_1.OH_NODE_MODULES:constants_js_1.NODE_MODULES,r=path_1.default.resolve(e.projectTopDir),s=path_1.default.resolve(e.modulePath),o=e.buildGeneratedProfilePath;return e.resolveModulePaths=[path_1.default.resolve(s,"src/main"),o,path_1.default.resolve(s,t),path_1.default.resolve(r,t)],e.resolveModulePaths}function loadAceBuildJson(e){if(e&&fs_1.default.existsSync(e))try{return JSON.parse(fs_1.default.readFileSync(e).toString())}catch(e){logger.error(`parse loader.json failed: ${e.message}`)}return{}}function getPlugins(e,t,r){const s=[...getBuiltInPlugins(e,r)];return loadCustomCompilePlugins(e.hvigorPluginFile,t).forEach((r=>{const o=r.order??"last";if("first"===o&&s.unshift(doWrapper(r,e)),"last"===o&&s.push(doWrapper(r,e)),"function"==typeof o){const n={};s.forEach(((e,t)=>{let r=e.name,s=1;for(;n[r];)r=`${r}_${s}`,s++;n[r]=t}));const a=o(n);"number"!=typeof a&&t?._buildError(`'${e.hvigorPluginFile}' exports an invalid plugin '${r.name}' with invalid order return '${a}'. Must return a number value.`)._printErrorAndExit(),s.splice(a<0?0:a,0,doWrapper(r,e))}})),s}function getSupportExtensions(){return[...new Set(constants_js_1.SUPPORT_EXTENSIONS.concat(load_sdk_functions_js_1.sdkSupportExtensions))]}function getBuiltInPlugins(e,t){const r=getSupportExtensions();return[e.isPreview&&e.appResource&&(0,preview_resource_watcher_plugin_js_1.previewResourceWatcherPlugin)(generatePreviewResourceFiles(e)),(e.isFaMode||"true"===e.watchMode)&&(0,copy_plugin_js_1.default)({targets:(0,copy_resources_js_1.getCopyPluginConfig)(e,e.appResource)}),(0,common_plugin_js_1.commonPlugin)(e,t),(0,invalid_cache_plugin_js_1.invalidCachePlugin)(),getResolvePlugin(e,r),(0,importCheckPlugin_js_1.importCheckPlugin)(),(0,router_map_plugin_js_1.routerMapPlugin)(),(0,use_new_ohm_url_plugin_js_1.newOhmUrlPlugin)(),(0,use_sensitive_check_plugin_js_1.sensitiveCheckPlugin)(),e.compileMode===constants_js_1.ESMODULE&&(0,module_meta_info_plugin_js_1.moduleMetaInfoPlugin)(r),(0,plugin_commonjs_1.default)(),(0,gc_plugin_js_1.gcPlugin)(),(0,plugin_json_1.default)(),(0,ignore_plugin_js_1.ignorePlugin)(/\.d$|\.d\.e?ts$|^lib\S+\.so/,e),(0,wrapper_chunk_plugin_js_1.wrapperChunkPlugin)(),(0,wait_async_plugin_js_1.waitAsyncPlugin)(),(0,collect_importers_plugin_js_1.collectImportersPlugin)(e),...load_sdk_functions_js_1.sdkPlugins,!e.isPreview&&(0,delete_plugin_js_1.default)({targets:load_sdk_functions_js_1.cleanConfig,runOnce:!0})].filter((e=>"object"==typeof e))}function getResolvePlugin(e,t){const r=getResolveModules(e),s=e.globalModulePaths??[];return s.push(path_1.default.resolve(e.etsLoaderPath,"../../api")),e.packageManagerType===constants_js_1.OHPM?(0,index_js_1.default)({extensions:t,modulePaths:Array.from(new Set([...s,path_1.default.resolve(constants_js_1.OH_NODE_MODULES),...r])),useRealpathCache:!0,preferBuiltins:!1,pkgNameToPkgInfo:e.pkgNameToPkgBriefInfo,caseSensitiveCheck:e.caseSensitiveCheck,sdkModulesPath:s}):(0,plugin_node_resolve_1.default)({extensions:t,modulePaths:Array.from(new Set([...s,path_1.default.resolve(constants_js_1.NODE_MODULES),path_1.default.resolve(e.etsLoaderPath,constants_js_1.NODE_MODULES),...r])),preferBuiltins:!1})}function generatePreviewResourceFiles(e){return[path_1.default.resolve(__dirname,e.appResource),(0,utils_js_1.getOhPackageJsonPath)(path_1.default.resolve(e.modulePath,e.packageManagerType===constants_js_1.OHPM?constants_js_1.OH_PACKAGE_JSON5:constants_js_1.PACKAGE_JSON))]}function loadCustomCompilePlugins(e,t){const r=[];if(!e)return r;let s;delete require.cache[require.resolve(e)];try{s=require(e).default}catch(t){throw t.message=`${t.message} ${e}`,t}s||t?._buildError(`'${e}' has no default export.`)._printErrorAndExit();return(Array.isArray(s)?s:[s]).forEach((s=>{validatePlugin(s,e,t),s||t?._buildError(`'${e}' exports an undefined plugin.`)._printErrorAndExit(),r.push(s)})),r}function validatePlugin(e,t,r){"object"!=typeof e&&r?._buildError(`'${t}' exports an invalid plugin with type '${typeof e}'.`)._printErrorAndExit();const s=e.name;s||r?._buildError(`'${t}' exports an invalid plugin without a name.`)._printErrorAndExit(),"string"!=typeof s&&r?._buildError(`'${t}' exports an invalid plugin whose name is not a string.`)._printErrorAndExit(),Object.keys(e).forEach((o=>{const n=e[o];switch(o){case"name":break;case"order":n&&"last"!==n&&"first"!==n&&"function"!=typeof n&&r?._buildError(`'${t}' exports an invalid plugin '${s}' with unknown order '${n}'.`)._printErrorAndExit();break;case"buildStart":case"resolveId":case"load":case"transform":case"shouldInvalidCache":case"moduleParsed":case"buildEnd":n&&"function"!=typeof n&&r?._buildError(`'${t}' exports an invalid plugin '${s}' whose hook '${o}' is not a function.`)._printErrorAndExit();break;default:r?.warn(`'${t}' exports an invalid plugin '${s}' with unknown property: '${o}'.`)}}))}function manualChunks(e,{getModuleInfo:t}){if(e.includes(constants_js_1.NODE_MODULES)||e.includes(constants_js_1.OH_NODE_MODULES))return"commons";const r=t(e);return r&&!r.isEntry?"vendors":void 0}function getCompileInputObject(e){const t={};return Object.entries(e).forEach((([e,r])=>{if(!r.endsWith(".d.ts")&&!r.endsWith(".d.ets")){const s=e.startsWith("../")?`relative/../${e}`:e;t[s]=r}})),t}function processMockConfigModuleInfos(e){const t=e.mockParams?.mockConfigKey2ModuleInfo;if(!t||!Object.keys(t).length)return;const r=getSupportExtensions();Object.keys(t).forEach((e=>{const s=t[e],o=(0,hvigor_arkts_base_1.findSuitableFilePath)(s.filePath,r);o?s.filePath=o:delete t[e]}))}function generateConfig(e,t,r){const s=getMergedConfig(e);(0,load_sdk_functions_js_1.loadSdkFunctions)(s);const o=s.compileMode?.toLowerCase(),n=s.buildMode?.toLowerCase(),a=s.cachePath,i=n===constants_js_1.DEBUG?path_1.default.resolve(__dirname,s.aceModuleBuild):path_1.default.join(a,"releaseAssets",path_1.default.basename(s.aceModuleBuild)),l=[e.compileSdkVersion,e.compatibleSdkVersion,e.runtimeOS,e.etsLoaderPath,!!e.obfuscationOptions?.selfConfig?.ruleOptions?.enable,s.moduleType,path_1.default.resolve(a,hvigor_arkts_base_1.MSGPACK_COMPILE_CACHE_FILE_NAME)].join("#"),u=r?.mount("KeyManager"),c=u?.getCache(`${e.modulePath}:${e.targetName}`);return c&&c!==l&&r?.unmount(c),u?.setCache(`${e.modulePath}:${e.targetName}`,l,!0),s.compileEnv=l,processMockConfigModuleInfos(s),{perf:e.perf===constants_js_1.AnalyzeMode.VERBOSE,unsupportedChangedFiles:[(0,utils_js_1.getOhPackageJsonPath)(path_1.default.resolve(e.modulePath,e.packageManagerType===constants_js_1.OHPM?constants_js_1.OH_PACKAGE_JSON5:constants_js_1.PACKAGE_JSON))],generateModuleGraphOnly:o===constants_js_1.ESMODULE,input:getCompileInputObject("true"===e.widgetCompile?load_sdk_functions_js_1.widgetEntryObj:load_sdk_functions_js_1.entryObj),output:getOutputConfig(i,o,e),shimMissingExports:!0,preserveSymlinks:!1,context:"globalThis",treeshake:n===constants_js_1.RELEASE,disableGenerateBundle:o===constants_js_1.ESMODULE,plugins:getPlugins(s,t,r),watch:getWatchConfig(o),watchMode:e.watchMode,enableFileSystemCache:!0,cacheDirectory:a,onwarn(e){onRollupWarn(e.message,e.code)},startEvent:e.startEvent,endEvent:e.endEvent,isPreview:e.isPreview,skipBuildEnd:e.skipBuildEnd,compileEnv:l,pkgName2SourceRoots:(0,utils_js_1.getPkgName2SourceRootsMap)(e),extensions:getSupportExtensions(),depName2RootPath:e.depName2RootPath}}function getOutputConfig(e,t,r){return[{dir:e,chunkFileNames:"[name].js",format:"cjs",sourcemap:t===constants_js_1.JSBUNDLE&&!r.isPreview,sourcemapPathTransform:(e,t)=>{if(r.buildMode===constants_js_1.RELEASE){const s=loadAceBuildJson(r.aceBuildJson);return path_1.default.resolve(path_1.default.dirname(t),e).replace(s.projectRootPath,"")}return path_1.default.resolve(path_1.default.dirname(t),e)},exports:"named",sanitizeFileName:!1,bundleMode:t===constants_js_1.JSBUNDLE,manualChunks:r.supportChunks?manualChunks:void 0}]}function getWatchConfig(e){return{chokidar:{useFsEvents:!1},skipWrite:e===constants_js_1.ESMODULE,buildDelay:100}}exports.runArkPack=runArkPack,exports.getResolveModules=getResolveModules,exports.loadAceBuildJson=loadAceBuildJson;var compile_code_snippet_js_2=require("./work-scripts/compile-code-snippet.js");function watch(e,t,r,s,o){return e.watchMode="true",runArkPack(e,t,r,s,o)}function wrapperBuildEnd(e,t){return function(r){const s=getCompilePluginContext(this);try{e.buildEnd.apply(s,[r])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}}}function wrapperModuleParsed(e,t){return function(r){const s=getCompilePluginContext(this);try{e.moduleParsed.apply(s,[r])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}}}function wrapperShouldInvalidCache(e,t){return function(r){const s=getCompilePluginContext(this);let o;try{o=e.shouldInvalidCache.apply(s,[r])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return o}}function wrapperTransform(e,t){return function(r,s){const o=getCompilePluginContext(this);let n;try{n=e.transform.apply(o,[r,s])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return n}}function wrapperLoad(e,t){return function(r){const s=getCompilePluginContext(this);let o;try{o=e.load.apply(s,[r])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return o}}function wrapperResolveId(e,t){return function(r,s,o){const n=getCompilePluginContext(this);let a;try{a=e.resolveId.apply(n,[r,s])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return a}}function validComposedOhPackagePathMap(e){e.ohPackagePathMap&&e.ohPackagePathMap.forEach(((e,t)=>{utils_js_1.composeOhPackagePathMap.set(t,e)}))}function wrapperBuildStart(e,t){return function(r){const s=getCompilePluginContext(this);try{e.buildStart.apply(s)}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}}}function doWrapper(e,t){const r={name:e.name};return e.buildStart&&(r.buildStart=wrapperBuildStart(e,t)),e.resolveId&&(r.resolveId=wrapperResolveId(e,t)),e.load&&(r.load=wrapperLoad(e,t)),e.transform&&(r.transform=wrapperTransform(e,t)),e.shouldInvalidCache&&(r.shouldInvalidCache=wrapperShouldInvalidCache(e,t)),e.moduleParsed&&(r.moduleParsed=wrapperModuleParsed(e,t)),e.buildEnd&&(r.buildEnd=wrapperBuildEnd(e,t)),r}function getCompilePluginContext(e){return{getFileName:t=>e.getFileName(t),getModuleIds:()=>e.getModuleIds(),getModuleInfo:t=>e.getModuleInfo(t),parse:(t,r)=>e.parse(t,r),share:e.share}}function updateEventNames(e){const[t,r]=initUpdateEventNameHandler(),s=["beforeBuildEnd","buildEnd","afterBuildEnd","beforeBuild","buildStart","afterBuildStart","resolveId","load","resolveDynamicImport","shouldTransformCachedModule","transform","moduleParsed"];return e.forEach((e=>{const o=e.getName(),n=o.lastIndexOf("-");if(t.has(o))t.get(o)(e);else for(const t of s)if(o.endsWith(t)){const s=r.get(t);s&&s(e,o,n);break}})),e}function onRollupWarn(e,t){"SHIMMED_EXPORT"!==t&&console.warn("[33m",e,"[39m")}function getCallback(e){return t=>t.setName(e)}function initUpdateEventNameHandler(){const e=new Map;e.set("# BUILD",getCallback("generate build graph for source files")),e.set("## initialize",getCallback("initialize compiler input")),e.set("## generate module graph",getCallback("generate module graph")),e.set("## sort and bind modules",getCallback("sort and bind modules")),e.set("## mark included statements",getCallback("mark included statements")),e.set("## before build end",getCallback("before build end")),e.set("## build end",getCallback("build end")),e.set("## after build end",getCallback("after build end"));const t=new Map;return t.set("beforeBuildEnd",((e,t,r)=>e.setName(`${t.substring(0,r)}- execute hook function before build ends`))),t.set("buildEnd",((e,t,r)=>e.setName(`${t.substring(0,r)}- execute hook function when build ends`))),t.set("afterBuildEnd",((e,t,r)=>e.setName(`${t.substring(0,r)}- execute hook function after build ends`))),t.set("beforeBuild",((e,t,r)=>e.setName(`${t.substring(0,r)}- execute hook function before build starts`))),t.set("buildStart",((e,t,r)=>e.setName(`${t.substring(0,r)}- execute hook function when build starts`))),t.set("afterBuildStart",((e,t,r)=>e.setName(`${t.substring(0,r)}- execute hook function after build starts`))),t.set("resolveId",((e,t,r)=>e.setName(`${t.substring(0,r)}- resolve file ID`))),t.set("load",((e,t,r)=>e.setName(`${t.substring(0,r)}- load file content`))),t.set("resolveDynamicImport",((e,t,r)=>e.setName(`${t.substring(0,r)}- resolve dynamic import`))),t.set("shouldTransformCachedModule",((e,t,r)=>e.setName(`${t.substring(0,r)}- decide whether to transform cached module`))),t.set("transform",((e,t,r)=>e.setName(`${t.substring(0,r)}- transform file content`))),t.set("moduleParsed",((e,t,r)=>e.setName(`${t.substring(0,r)}- execute hook function when module parsed`))),[e,t]}Object.defineProperty(exports,"compileCodeSnippet",{enumerable:!0,get:function(){return compile_code_snippet_js_2.compileCodeSnippet}}),exports.watch=watch;