"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveAllOhModules=void 0;const fs_1=__importDefault(require("fs")),json5_1=__importDefault(require("json5")),path_1=__importDefault(require("path")),OH_MODULES="oh_modules",DOT_OHPM=".ohpm",symlinkMap={};function updateSymlinkMap(e){const t=fs_1.default.realpathSync(e);if(t===e||!t)return;const s=symlinkMap[t]||[];s.push(e),symlinkMap[t]=s}function resolveAllOhModules(e){resolveProjectOhModules(e);const t=path_1.default.join(e,"build-profile.json5");if(fs_1.default.existsSync(t)){const s=fs_1.default.readFileSync(t,"utf-8"),o=json5_1.default.parse(s).modules;for(const t of o){resolveProjectOhModules(path_1.default.join(e,t.srcPath))}}else{const t=fs_1.default.readdirSync(e);for(const s of t){resolveProjectOhModules(path_1.default.join(e,s))}}return symlinkMap}function resolveProjectOhModules(e){const t=path_1.default.join(e,OH_MODULES);if(!isExistDir(t))return;resolveOhModules(t);const s=path_1.default.join(t,DOT_OHPM);if(!isExistDir(s))return;const o=fs_1.default.readdirSync(s);for(const e of o){const t=path_1.default.join(s,e,OH_MODULES);isExistDir(t)&&resolveOhModules(t)}}function isExistDir(e){try{if(fs_1.default.statSync(e).isDirectory())return!0}catch(e){return!1}return!1}function resolveOhModules(e){const t=fs_1.default.readdirSync(e);for(const s of t){if(s===DOT_OHPM)continue;const t=path_1.default.join(e,s);if(fs_1.default.statSync(t).isDirectory())if(s.startsWith("@")){const e=fs_1.default.readdirSync(t);for(const s of e){const e=path_1.default.join(t,s);fs_1.default.statSync(e).isDirectory()&&updateSymlinkMap(e)}}else updateSymlinkMap(t)}}exports.resolveAllOhModules=resolveAllOhModules;