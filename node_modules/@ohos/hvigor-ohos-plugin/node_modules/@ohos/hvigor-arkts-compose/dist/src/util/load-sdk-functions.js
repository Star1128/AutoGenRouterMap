"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateObfuscationFile=exports.runEtsStandaloneChecker=exports.clearSdkContext=exports.loadSdkFunctions=exports.sdkSupportExtensions=exports.sdkPlugins=exports.cleanConfig=exports.widgetEntryObj=exports.entryObj=void 0;const buildInstrument_1=require("@ohos/coverage/lib/src/plugin/buildInstrument"),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),plugin_babel_1=require("@rollup/plugin-babel"),plugin_terser_1=__importDefault(require("@rollup/plugin-terser")),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),arkts_pack_js_1=require("../arkts-pack.js"),constants_js_1=require("./constants.js"),GEN_ABC_PLUGIN_NAME="genAbc",logger=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("load_sdk");exports.cleanConfig=[],exports.sdkPlugins=[],exports.sdkSupportExtensions=[];let sdkCache=[];const hijackTscCompilerOptionsPaths=(e,t)=>{const s=path_1.default.join(e,"lib","ets_checker.js");if(!fs_1.default.existsSync(s))throw new Error("load etsChecker Error.Cause: file not exists");const o=require(s).compilerOptions;if(!o)return;const r=Object.getOwnPropertyDescriptor(o,"paths");if(!r||r.configurable){let e=t;Object.defineProperty(o,"paths",{enumerable:!0,configurable:!0,get:()=>e,set(t){e&&Object.prototype.hasOwnProperty.call(e,"*")&&t&&Object.prototype.hasOwnProperty.call(t,"*")&&(e["*"]=Array.from(new Set([...e["*"],...t["*"]])),delete t["*"]),e={...e,...t}}})}};function loadSdkFunctions(e){const t=loadScript(e.etsLoaderPath,e.apiVersion,e.etsLoaderVersion,e.isFaMode);hijackTscCompilerOptionsPaths(e.etsLoaderPath,e.otherPaths);const s=t.initConfig();exports.entryObj=s.entryObj,e.globalModulePaths=s.globalModulePaths??[],e.obfuscationOptions&&(e.obfuscationOptions.sdkApis=e.globalModulePaths);let o=e.obfuscationOptions?.selfConfig?.ruleOptions?.enable;const r=e.compileSdkVersion;r&&r>9&&o&&void 0===t.generateConsumerObConfigFile&&(logger.warn("The SDK does not support obfuscation. Please upgrade the SDK."),o=void 0);const n=void 0===o&&e.buildMode?.toLowerCase()===constants_js_1.RELEASE,a=s.cardEntryObj;if(exports.widgetEntryObj=void 0===a?exports.entryObj:a,exports.cleanConfig.push(...t.getCleanConfig(s.workerFile)),exports.sdkSupportExtensions.push(...t.resolveFileExtensions??[]),t.sdkPlugins){const s=t.sdkPlugins(e);if(t.sdkPluginsMap&&t.sdkPluginsMap.genAbc){const e=t.sdkPluginsMap.genAbc;s.splice(e,0,(0,buildInstrument_1.buildInstrument)())}else s.push((0,buildInstrument_1.buildInstrument)());exports.sdkPlugins.push(...s)}else exports.sdkPlugins.push(t.watchChangeFiles(),t.etsChecker(),t.visualTransform(),t.etsTransform(),t.apiTransform(),(0,buildInstrument_1.buildInstrument)(),t.genAbc(),n&&terserPlugin(),e.compileMode===constants_js_1.JSBUNDLE&&babelPlugin(e))}function removeSdkCache(){sdkCache.forEach((e=>delete require.cache[e]))}function updateSdkCache(e){sdkCache=[],Object.keys(require.cache).forEach((t=>{e.has(t)||sdkCache.push(t)}))}function clearSdkContext(){exports.entryObj={},exports.widgetEntryObj={},exports.sdkPlugins=[],exports.cleanConfig=[],exports.sdkSupportExtensions=[]}async function runEtsStandaloneChecker(e){hvigor_arkts_base_1.ArktsBaseLogger.clearLogEvents();const t=loadScript(e.config.etsLoaderPath,e.config.apiVersion,e.config.etsLoaderVersion,e.config.isFaMode);if(t.etsStandaloneChecker&&"function"==typeof t.etsStandaloneChecker){e.config.resolveModulePaths=(0,arkts_pack_js_1.getResolveModules)(e.config);const s=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("lint");return t.etsStandaloneChecker(e.entry,s,e.config),hvigor_arkts_base_1.ArktsBaseLogger.getLogEvents()}return[]}function loadScript(e,t,s,o){const r=path_1.default.join(e,"compile_plugin.js");if(!fs_1.default.existsSync(r))throw new Error("load Sdk Functions Error.Cause: plugin export entry file not exists");const n=new Set,a=o||t<constants_js_1.API_VERSION_11;a&&(removeSdkCache(),Object.keys(require.cache).forEach((e=>n.add(e))));const i=require(r);return a&&updateSdkCache(n),i}async function generateObfuscationFile(e,t,s,o,r,n){const a=loadScript(t,s,o,r);a.generateConsumerObConfigFile&&"function"==typeof a.generateConsumerObConfigFile&&a.generateConsumerObConfigFile(e,n)}exports.loadSdkFunctions=loadSdkFunctions,exports.clearSdkContext=clearSdkContext,exports.runEtsStandaloneChecker=runEtsStandaloneChecker,exports.generateObfuscationFile=generateObfuscationFile;const babelPlugin=e=>(0,plugin_babel_1.getBabelInputPlugin)({extensions:[".js"],exclude:[e.packageManagerType===constants_js_1.OHPM?constants_js_1.OH_NODE_MODULES:constants_js_1.NODE_MODULES],skipPreflightCheck:!0,babelHelpers:"runtime",plugins:[require("@babel/plugin-proposal-class-properties")],compact:!1}),terserPlugin=()=>(0,plugin_terser_1.default)({compress:{defaults:!1,dead_code:!0,collapse_vars:!0,unused:!0,drop_debugger:!0,if_return:!0,reduce_vars:!0,join_vars:!1,sequences:0},format:{semicolons:!1,beautify:!0,braces:!0,indent_level:2}});