"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveImportSpecifiers=void 0;const fs_1=__importDefault(require("fs")),json5_1=__importDefault(require("json5")),path_1=require("path"),url_1=require("url"),util_1=require("util"),fs_js_1=require("../../util/fs.js"),index_js_1=require("../resolve/index.js"),resolvePackageExports_js_1=require("./package/resolvePackageExports.js"),resolvePackageImports_js_1=require("./package/resolvePackageImports.js"),utils_js_1=require("./package/utils.js"),cache_js_1=require("./cache.js"),util_js_1=require("./util.js"),readFile=(0,util_1.promisify)(fs_1.default.readFile);async function getPackageJson(e,r,s,i){if(e){const s=await(0,utils_js_1.findPackageJson)(e,i);if(s&&s.pkgJson.name===r)return s}try{const e=await(0,index_js_1.resolve)(`${r}/oh-package.json5`,s);return{pkgJsonPath:e,pkgJson:json5_1.default.parse(await readFile(e,"utf-8")),pkgPath:(0,path_1.dirname)(e)}}catch(e){return null}}async function resolveWithExportMap({baseDir:e,exportConditions:r,extensions:s,ignoreSideEffectsForRoot:i,importer:o,importSpecifier:t,moduleDirectories:a,modulePaths:n,mainFields:c,packageInfoCache:l,preserveSymlinks:d,rootDir:p,useBrowserOverrides:u,caseSensitiveCheck:f,sdkModulesPath:h}){if(t.startsWith("#"))return numberHandler(t,o,a,r,l,s,c,d,u,e,n,p,f,h);const k=(0,util_js_1.getPackageName)(t);if(k){let m,g=()=>null,_=!0,v=!1;const S=async(e,r)=>{const o=await(0,util_js_1.getPackageInfo)({cache:l,extensions:s,ignoreSideEffectsForRoot:i,mainFields:c,pkg:e,pkgPath:r,preserveSymlinks:d,rootDir:p,useBrowserOverrides:u});return({packageInfo:m,hasModuleSideEffects:g,hasPackageEntry:_,packageBrowserField:v}=o),o.cachedPkg},P={basedir:e,extensions:s,includeCoreModules:!1,isDirectory:cache_js_1.isDirCached,isFile:cache_js_1.isFileCached,moduleDirectory:a,packageFilter:S,paths:n,preserveSymlinks:d,readFile:cache_js_1.readCachedFile},D=await getPackageJson(o,k,{...P,rootDir:p,caseSensitiveCheck:f,sdkModulesPath:h,importer:o,originImportPath:`${k}/oh-package.json5`,joinPackageJson:!0},a);if(D&&D.pkgJson.exports){const{pkgJson:e,pkgJsonPath:s}=D,i=k===t?".":`.${t.substring(k.length)}`,n=s.replace("oh-package.json5",""),c={conditions:r,importer:o,importSpecifier:t,moduleDirs:a,pkgJsonPath:s,pkgURL:(0,url_1.pathToFileURL)(n)},l=await(0,resolvePackageExports_js_1.resolvePackageExports)(c,i,e.exports),p=(0,url_1.fileURLToPath)(l);if(p)return{location:d?p:await(0,fs_js_1.resolveSymlink)(p),hasModuleSideEffects:g,hasPackageEntry:_,packageBrowserField:v,packageInfo:m}}}return null}async function numberHandler(e,r,s,i,o,t,a,n,c,l,d,p,u,f){const h=await(0,resolvePackageImports_js_1.resolvePackageImports)({importSpecifier:e,importer:r,moduleDirs:s,conditions:i,resolveId:e=>resolveIdClassic({baseDir:l,extensions:t,importSpecifier:e,mainFields:a,moduleDirectories:s,modulePaths:d,packageInfoCache:o,preserveSymlinks:n,useBrowserOverrides:c,rootDir:p,caseSensitiveCheck:u,sdkModulesPath:f})}),k=(0,url_1.fileURLToPath)(h);return{location:n?k:await(0,fs_js_1.resolveSymlink)(k),hasModuleSideEffects:()=>null,hasPackageEntry:!0,packageBrowserField:!1,packageInfo:void 0}}async function resolveImportSpecifiers({baseDir:e,exportConditions:r,extensions:s,ignoreSideEffectsForRoot:i,importer:o,importSpecifierList:t,mainFields:a,moduleDirectories:n,modulePaths:c,packageInfoCache:l,preserveSymlinks:d,rootDir:p,useBrowserOverrides:u,warn:f,caseSensitiveCheck:h,sdkModulesPath:k}){try{const f=await resolveWithExportMap({baseDir:e,exportConditions:r,extensions:s,ignoreSideEffectsForRoot:i,importer:o,importSpecifier:t[0],mainFields:a,moduleDirectories:n,modulePaths:c,packageInfoCache:l,preserveSymlinks:d,rootDir:p,useBrowserOverrides:u,caseSensitiveCheck:h,sdkModulesPath:k});if(f)return f}catch(e){if(e instanceof utils_js_1.ResolveError)return f(e),null;throw e}return resolveWithClassic({baseDir:e,exportConditions:r,extensions:s,ignoreSideEffectsForRoot:i,importer:o,importSpecifierList:t,mainFields:a,moduleDirectories:n,modulePaths:c,packageInfoCache:l,preserveSymlinks:d,rootDir:p,useBrowserOverrides:u,warn:f,caseSensitiveCheck:h,sdkModulesPath:k})}async function resolveIdClassic({baseDir:e,extensions:r,ignoreSideEffectsForRoot:s,importSpecifier:i,mainFields:o,moduleDirectories:t,modulePaths:a,packageInfoCache:n,preserveSymlinks:c,rootDir:l,useBrowserOverrides:d,caseSensitiveCheck:p,sdkModulesPath:u,importer:f}){let h,k=()=>null,m=!0,g=!1;const _={basedir:e,extensions:r,includeCoreModules:!1,isDirectory:cache_js_1.isDirCached,isFile:cache_js_1.isFileCached,moduleDirectory:t,packageFilter:async(e,i)=>{const t=await(0,util_js_1.getPackageInfo)({cache:n,extensions:r,ignoreSideEffectsForRoot:s,mainFields:o,pkg:e,pkgPath:i,preserveSymlinks:c,rootDir:l,useBrowserOverrides:d});return({packageInfo:h,hasModuleSideEffects:k,hasPackageEntry:m,packageBrowserField:g}=t),t.cachedPkg},paths:a,preserveSymlinks:c,readFile:cache_js_1.readCachedFile},v=await(0,index_js_1.resolve)(i,{..._,rootDir:l,caseSensitiveCheck:p,sdkModulesPath:u,importer:f,originImportPath:i});if(v instanceof Error){if("MODULE_NOT_FOUND"!==v.code)throw v;return null}return{location:c?v:await(0,fs_js_1.resolveSymlink)(v),hasModuleSideEffects:k,hasPackageEntry:m,packageBrowserField:g,packageInfo:h}}async function resolveWithClassic({baseDir:e,exportConditions:r,extensions:s,ignoreSideEffectsForRoot:i,importer:o,importSpecifierList:t,mainFields:a,moduleDirectories:n,modulePaths:c,packageInfoCache:l,preserveSymlinks:d,rootDir:p,useBrowserOverrides:u,warn:f,caseSensitiveCheck:h,sdkModulesPath:k}){for(let m=0;m<t.length;m++){const g=await resolveIdClassic({baseDir:e,exportConditions:r,extensions:s,ignoreSideEffectsForRoot:i,importer:o,importSpecifier:t[m],mainFields:a,moduleDirectories:n,modulePaths:c,packageInfoCache:l,preserveSymlinks:d,rootDir:p,useBrowserOverrides:u,warn:f,caseSensitiveCheck:h,sdkModulesPath:k});if(g)return{...g,resolvedSpecifierIndex:m}}return null}exports.resolveImportSpecifiers=resolveImportSpecifiers;