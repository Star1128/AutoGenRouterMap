"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.normalizeInput=exports.getPackageInfo=exports.getMainFields=exports.getPackageName=void 0;const pluginutils_1=require("@rollup/pluginutils"),path_1=require("path"),fs_js_1=require("../../util/fs.js");function getPackageName(e){if(e.startsWith(".")||e.startsWith("/"))return null;const t=e.split("/");return"@"===t[0][0]?`${t[0]}/${t[1]}`:t[0]}function getMainFields(e){let t=["module","jsnext:main","main"];if(e.mainFields&&({mainFields:t}=e),e.browser&&-1===t.indexOf("browser"))return["browser"].concat(t);if(!t.length)throw new Error("Please ensure at least one `mainFields` value is specified.");return t}function initPackageInfo(e,t,r){return{packageJson:{...e},packageJsonPath:t,root:r,resolvedMainField:"main",browserMappedMain:!1,resolvedEntryPoint:""}}function initInternalPkgInfo(e,t,r,n,a,o,i){return{cachedPkg:e,hasModuleSideEffects:()=>null,hasPackageEntry:t||-1!==r.indexOf("main"),packageBrowserField:n&&"object"==typeof e.browser&&Object.keys(e.browser).reduce(((t,r)=>{let n=e.browser[r];if(n&&"."===n[0]&&(n=(0,path_1.resolve)(a,n)),t[r]=n,"."===r[0]){const e=(0,path_1.resolve)(a,r);t[e]=n,(0,path_1.extname)(r)||o.reduce(((t,n)=>(t[e+n]=t[r],t)),t)}return t}),{}),packageInfo:i}}function updatePackageInfo(e,t,r,n,a){const o=e.packageBrowserField;t&&"object"==typeof r.browser&&Object.prototype.hasOwnProperty.call(o,r.main)?(n.resolvedEntryPoint=o[r.main],n.browserMappedMain=!0):(n.resolvedEntryPoint=(0,path_1.resolve)(a,r.main||"index.js"),n.browserMappedMain=!1)}async function getPackageInfo(e){const{cache:t,extensions:r,pkg:n,mainFields:a,preserveSymlinks:o,useBrowserOverrides:i,rootDir:s,ignoreSideEffectsForRoot:l}=e;let{pkgPath:c}=e;if(t.has(c))return t.get(c);o||(c=await(0,fs_js_1.realpathFS)(c));const p=(0,path_1.dirname)(c),f=initPackageInfo(n,c,p);let u=!1;for(const e of a)if("string"==typeof n[e]){f.resolvedMainField=e,n.main=n[e],u=!0;break}const d=initInternalPkgInfo(n,u,a,i,p,r,f);if(updatePackageInfo(d,i,n,f,p),!l||s!==p){const e=n.sideEffects;if("boolean"==typeof e)d.hasModuleSideEffects=()=>e;else if(Array.isArray(e)){const t=e.map((e=>e.includes("/")?e:`**/${e}`));d.hasModuleSideEffects=(0,pluginutils_1.createFilter)(t,null,{resolve:p})}}return t.set(c,d),d}function normalizeInput(e){return Array.isArray(e)?e:"object"==typeof e?Object.values(e):[e]}exports.getPackageName=getPackageName,exports.getMainFields=getMainFields,exports.getPackageInfo=getPackageInfo,exports.normalizeInput=normalizeInput;