"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.invalidCachePlugin=void 0;const arkts_pack_js_1=require("../arkts-pack.js");let allPlugins;const OLD_HAR_NAME_OHM_MAP="oldHarNameOhmMap",CUR_HAR_NAME_OHM_MAP="curHarNameOhmMap",PKG_JSON_FILE_HASH="pkgJsonFileHash",NEW_OHM_URL_HASH="newOhmUrlHash",ROUTER_MAP_HASH="routerMapHash",CASE_SENSITIVE_CHECK="caseSensitiveCheck",MODULE_DEPS="moduleDeps",PROJECT_ARK_OPTION="projectArkOption",depCache=new Map;let inCIEnv=!1;function invalidCachePlugin(){return{name:"invalidCachePlugin",buildStart:buildStart,shouldTransformCachedModule:shouldTransformCachedModule,buildEnd:buildEnd,cleanup(){depCache.clear()}}}function setProjectConfigCache(e){e.cache.set(OLD_HAR_NAME_OHM_MAP,e.cache.get(CUR_HAR_NAME_OHM_MAP)),e.cache.delete(CUR_HAR_NAME_OHM_MAP);const s=e.share?.projectConfig?.projectArkOption?.tscConfig?.targetESVersion;s&&e.cache.set(PROJECT_ARK_OPTION,s),e.share?.projectConfig?.pkgJsonFileHash&&e.cache.set(PKG_JSON_FILE_HASH,e.share?.projectConfig?.pkgJsonFileHash),e.cache.set(NEW_OHM_URL_HASH,!!e.share?.projectConfig?.useNormalizedOHMUrl),e.share?.projectConfig?.routerMap&&e.cache.set(ROUTER_MAP_HASH,e.share?.projectConfig?.routerMap),e.cache.set(CASE_SENSITIVE_CHECK,e.share?.projectConfig?.caseSensitiveCheck)}function buildEnd(){setProjectConfigCache(this);const e=new Map;for(const s of this.getModuleIds()){const t=this.getModuleInfo(s);e.set(s,t?t.importedIds.concat(t.dynamicallyImportedIds):[])}this.cache.set(MODULE_DEPS,e)}function buildStart({plugins:e}){inCIEnv=isCI();const s=(0,arkts_pack_js_1.loadAceBuildJson)(this.share?.projectConfig?.aceBuildJson).harNameOhmMap;this.cache.set(CUR_HAR_NAME_OHM_MAP,s),allPlugins=[],allPlugins.push(...e),allPlugins=allPlugins.filter((e=>"object"==typeof e&&(e.shouldInvalidCache??!1)))}async function shouldTransformCachedModule(e){const s=this.share?.projectConfig?.pkgJsonFileHash!==this.cache.get(PKG_JSON_FILE_HASH);if(s&&inCIEnv)return!0;if(this.share?.projectConfig?.projectArkOption?.tscConfig?.targetESVersion!==this.cache.get(PROJECT_ARK_OPTION))return!0;const t=await Promise.all(allPlugins.map((s=>s.shouldInvalidCache.apply(this,[e]))));let a=!1;t.forEach((e=>{e&&"boolean"==typeof e&&(a||(a=e))}));const n=this.cache.get(OLD_HAR_NAME_OHM_MAP),o=this.cache.get(CUR_HAR_NAME_OHM_MAP);if(n&&o)for(const e of Object.keys(o))if(n[e]&&o[e]!==n[e])return!0;if(a||!s)return a;const c=this.share.getHookEventFactory("invalidCachePlugin","shouldTransformCachedModule"),r=c.createEvent("hasChangedDeps")?.start(),i=hasChangedDeps(this.cache.get(MODULE_DEPS)?.get(e.id),this.share.depInfo.changedDeps.map((e=>e.lastRootPath)));return r?.stop(),i}function hasChangedDeps(e,s){if(!e)return!1;for(const t of e){if(!depCache.has(t)){const e=depChanged(t,s);depCache.set(t,e)}if(depCache.get(t))return!0}return!1}function depChanged(e,s){let t=!1;for(const a of s)if(e.startsWith(a)){t=!0;break}return t}function isCI(){return!(!(process.env.BUILD_ID||process.env.BUILD_NUMBER||process.env.CI||process.env.CI_APP_ID||process.env.CI_BUILD_ID||process.env.CI_BUILD_NUMBER||process.env.CI_NAME||process.env.CONTINUOUS_INTEGRATION||process.env.RUN_ID||exports.name)||"false"===process.env.CI)}exports.invalidCachePlugin=invalidCachePlugin;