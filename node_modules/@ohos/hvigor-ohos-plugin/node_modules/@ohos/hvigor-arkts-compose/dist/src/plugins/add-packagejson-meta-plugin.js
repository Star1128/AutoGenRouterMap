"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.addPackageJsonMetaPlugin=void 0;const fs_1=__importDefault(require("fs")),json5_1=__importDefault(require("json5")),path_1=__importDefault(require("path")),constants_js_1=require("../util/constants.js"),utils_1=require("../util/utils");let packageJsonCache,entryFileCache;function findPackageJson(e,t){const{root:n}=path_1.default.parse(e);let a=e;for(;a!==n;){const e=(0,utils_1.getOhPackageJsonPath)(path_1.default.join(a,t));if(fs_1.default.existsSync(e)){if(packageJsonCache[e])return packageJsonCache[e];const t=fs_1.default.readFileSync(e,"utf-8");try{return packageJsonCache[e]={pkgJson:json5_1.default.parse(t),pkgPath:a,pkgJsonPath:e},packageJsonCache[e]}catch(e){return}}a=path_1.default.resolve(a,"..")}}function findEntryFile(e,t){if(entryFileCache[t])return entryFileCache[t];let n;return e.exports?"string"==typeof e.exports?n=e.exports:"object"==typeof e.exports&&(n=function e(t){if(t.import)return t.import;if(t["."]){const n=t["."];if("string"==typeof n)return n;if("object"==typeof n)return e(n)}else if(t.default)return t.default}(e.exports)):e.module?n=e.module:e.main&&(n=e.main),entryFileCache[t]=n??"index.js",entryFileCache[t]}function resolveId(e,t,n){if(!t)return null;if(n&&n.custom&&n.custom["node-resolve"]){const{resolved:e}=n.custom["node-resolve"];if(!e)return null;const t=e.id,a=this.share.projectConfig?.packageManagerType===constants_js_1.OHPM,s=findPackageJson(t,a?constants_js_1.OH_PACKAGE_JSON5:constants_js_1.PACKAGE_JSON);if(s&&s.pkgJson&&s.pkgJsonPath&&-1!==t.indexOf(a?constants_js_1.OH_NODE_MODULES:constants_js_1.NODE_MODULES)){const e=findEntryFile(s.pkgJson,s.pkgJsonPath);let n=!1;if(s.pkgJson.name){const a=path_1.default.join(s.pkgJson.name,e);n=t.endsWith(a)}return{meta:{packageJson:s,isNodeModuleEntryFile:n},id:t}}}return null}function buildStart(){packageJsonCache={},entryFileCache={}}function addPackageJsonMetaPlugin(){return{name:"addPackageJsonMetaPlugin",buildStart:buildStart,resolveId:resolveId}}exports.addPackageJsonMetaPlugin=addPackageJsonMetaPlugin;