"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.commonPlugin=void 0;const hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),fs_1=__importDefault(require("fs")),compile_event_factory_js_1=require("../analyzer/compile-event-factory.js"),compose_error_js_1=require("../data/compose-error.js"),constants_js_1=require("../util/constants.js"),utils_js_1=require("../util/utils.js");function commonPlugin(e,r){let o=!0;return{name:"commonPlugin",options(){this.share.projectConfig=e,this.share.getLogger=hvigor_arkts_base_1.ArktsBaseLogger.getPluginLogger,this.share.throwArkTsCompilerError=compose_error_js_1.throwArkTsCompilerError,this.share.getHookEventFactory=e.perf===constants_js_1.AnalyzeMode.VERBOSE?compile_event_factory_js_1.CompileEventFactory.getHookEventFactory:getBogusHookEventFactory,(0,utils_js_1.isLinux)()||e.runtimeOS===constants_js_1.OPEN_HARMONY||e.isFaMode||(e.apiVersion>=constants_js_1.API_VERSION_11&&(this.share.cacheStoreManager=r,this.share.cache=e.compileEnv?r?.mount(e.compileEnv):void 0),this.share.commonCache=r?.mount(constants_js_1.TSC_COMMON_CACHE_KEY,!0))},beforeBuild(){(!o||e.isPreview&&!fs_1.default.existsSync(e.buildDir))&&(o=!1,(0,compose_error_js_1.throwArkTsCompilerError)("Please restart previewer.")),this.share.depInfo=getDepInfo(e.resolveConflictMode,this.cache.get("resolveConflictMode"),this.share.projectConfig.depName2RootPath,this.cache.get("depName2RootPath"))},afterBuildStart(){throwErrorIfHasErrorInfo(e.watchMode)},beforeBuildEnd:{order:"post",async handler(){throwErrorIfHasErrorInfo(e.watchMode)}},buildEnd(){this.cache.set("resolveConflictMode",this.share.projectConfig.resolveConflictMode),this.cache.set("depName2RootPath",this.share.projectConfig.depName2RootPath)}}}function getDepInfo(e,r,o,t){if(void 0===r)return{enableIncre:!1,changedDeps:[]};if(e&&r){const e=[];return o.forEach(((r,o)=>{t?.get(o)&&t?.get(o)!==r&&e.push({name:o,lastRootPath:t?.get(o)})})),t?.forEach(((r,t)=>{o.has(t)||e.push({name:t,lastRootPath:r})})),{enableIncre:!0,changedDeps:e}}return{enableIncre:!1,changedDeps:[]}}function getBogusHookEventFactory(){const e=()=>{},r=()=>({start:e,stop:e,startAsyncEvent:e,stopAsyncEvent:e,createSubEvent:r});return{createEvent:r}}function throwErrorIfHasErrorInfo(e){hvigor_arkts_base_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()&&"true"!==e&&(0,compose_error_js_1.throwArkTsCompilerError)("ArkTS Compiler Error")}exports.commonPlugin=commonPlugin;