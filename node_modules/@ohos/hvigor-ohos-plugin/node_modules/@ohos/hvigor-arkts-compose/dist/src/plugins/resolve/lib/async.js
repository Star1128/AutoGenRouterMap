"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolve=void 0;const fs_1=__importDefault(require("fs")),json5_1=__importDefault(require("json5")),path_1=__importDefault(require("path")),fs_js_1=require("../../../util/fs.js"),caller_js_1=require("./caller.js"),homedir_js_1=require("./homedir.js"),is_core_js_1=require("./is-core.js"),node_modules_paths_js_1=require("./node-modules-paths.js"),normalize_options_js_1=require("./normalize-options.js"),homedir=(0,homedir_js_1.getHomedir)(),defaultPaths=function(){return[path_1.default.join(homedir,".oh_modules"),path_1.default.join(homedir,".node_libraries")]},defaultIsFile=async function(t,e){try{const s=fs_1.default.statSync(t);return await e(null,s.isFile()||s.isFIFO())}catch(t){return"ENOENT"===t.code||"ENOTDIR"===t.code?e(null,!1):e(t)}},defaultIsDir=async function(t,e){try{const s=fs_1.default.statSync(t);return await e(null,s.isDirectory())}catch(t){return"ENOENT"===t.code||"ENOTDIR"===t.code?e(null,!1):e(t)}},defaultRealpath=async function(t,e){let s;try{return s=await(0,fs_js_1.realpathFS)(t),await e(null,s)}catch(i){return i&&"ENOENT"!==i.code?e(i):e(null,i?t:s)}},maybeRealpath=async function(t,e,s,i){return s&&!1===s.preserveSymlinks?t(e,i):i(null,e)},defaultReadPackage=async function(t,e,s){return await t(e,(async(t,e)=>{if(t)return s(t);try{const t=json5_1.default.parse(e);return await s(null,t)}catch(t){return s(null)}}))},getPackageCandidates=function(t,e,s){const i=(0,node_modules_paths_js_1.nodeModulesPaths)(e,s,t);for(let e=0;e<i.length;e++)i[e]=path_1.default.join(i[e],t);return i};async function resolve(t,e){return new Resolver(t,e).resolve()}exports.resolve=resolve;class Resolver{constructor(t,e){this.onfile=async(t,e,s)=>t||(e||this.loadAsDirectory(this.res,(async(t,e,s)=>{if(t)return t;if(e)return maybeRealpath(this.realpath,e,this.opts,((t,e)=>t||e));{const t=new Error(`Cannot find module '${this.x}' from '${this.parent}'`);return t.code="MODULE_NOT_FOUND",t}}))),this.loadAsFile=async(t,e,s,i)=>{let a=e,r=s;"function"==typeof a&&(r=a,a=void 0);const o=[""].concat(this.extensions),n=async(t,e,s)=>{if(0===t.length)return r(null,void 0,s);const a=e+t[0],o=async(s,i)=>s?r(s):i?r(null,a,l):n(t.slice(1),e,l),h=async(s,h,c)=>{if(l=h,s)return r(s);if(c&&l&&this.opts.pathFilter){const s=path_1.default.relative(c,a),i=s.slice(0,s.length-t[0].length),r=this.opts.pathFilter(l,e,i);if(r)return n([""].concat(this.extensions.slice()),path_1.default.resolve(c,r),l)}return this.isFile(a,o,{rootDir:this.rootDir,caseSensitiveCheck:this.caseSensitiveCheck,sdkModulesPath:this.sdkModulesPath,importer:this.importer,originImportPath:this.originImportPath,joinPackageJson:this.joinPackageJson,joinIndex:i?.joinIndex})};let l=s;return l?h(null,l):this.loadpkg(path_1.default.dirname(a),h)};return n(o,t,a)},this.loadpkg=async(t,e)=>""===t||"/"===t||"win32"===process.platform&&/^\w:[/\\]*$/.test(t)||/[/\\]oh_modules[/\\]*$/.test(t)?e(null):maybeRealpath(this.realpath,t,this.opts,(async(s,i)=>{if(s)return this.loadpkg(path_1.default.dirname(t),e);const a=path_1.default.join(i,"oh-package.json5");return this.isFile(a,(async(s,i)=>i?this.readPackage(this.readFile,a,(async(s,i)=>{if(s)return e(s);let r=i;return r&&this.opts.packageFilter&&(r=await this.opts.packageFilter(r,a)),e(null,r,t)})):this.loadpkg(path_1.default.dirname(t),e)),{rootDir:this.rootDir,caseSensitiveCheck:this.caseSensitiveCheck,sdkModulesPath:this.sdkModulesPath,importer:this.importer,originImportPath:this.originImportPath,joinPackageJson:this.joinPackageJson})})),this.loadAsDirectory=async(t,e,s)=>{let i=s,a=e;return"function"==typeof a&&(i=a,a=this.opts.package),maybeRealpath(this.realpath,t,this.opts,(async(e,s)=>{if(e)return i(e);const r=path_1.default.join(s,"oh-package.json5");return this.isFile(r,(async(e,s)=>e?i(e):s?this.readPackage(this.readFile,r,(async(e,s)=>{if(e)return i(e);let a=s;if(a&&this.opts.packageFilter&&(a=await this.opts.packageFilter(a,r)),a&&a.main){if("string"!=typeof a.main){const t=new TypeError(`package “${a.name}” \`main\` must be a string`);return t.code="INVALID_PACKAGE_MAIN",i(t)}return"."!==a.main&&"./"!==a.main||(a.main="index"),this.loadAsFile(path_1.default.resolve(t,a.main),a,(async(e,s,a)=>{if(e)return i(e);if(s)return i(null,s,a);if(!a)return this.loadAsFile(path_1.default.join(t,"index"),a,i,{joinIndex:!0});const r=path_1.default.resolve(t,a.main);return this.loadAsDirectory(r,a,(async(e,s,a)=>e?i(e):s?i(null,s,a):this.loadAsFile(path_1.default.join(t,"index"),a,i,{joinIndex:!0})))}))}return this.loadAsFile(path_1.default.join(t,"/index"),a,i,{joinIndex:!0})})):this.loadAsFile(path_1.default.join(t,"index"),a,i,{joinIndex:!0})),{rootDir:this.rootDir,caseSensitiveCheck:this.caseSensitiveCheck,sdkModulesPath:this.sdkModulesPath,importer:this.importer,originImportPath:this.originImportPath,joinPackageJson:this.joinPackageJson})}))},this.processDirs=async(t,e)=>{if(0===e.length)return t(null,void 0);const s=e[0],i=async(s,i,a)=>s?t(s):i?t(null,i,a):this.processDirs(t,e.slice(1)),a=async(e,a,r)=>e?t(e):a?t(null,a,r):this.loadAsDirectory(s,this.opts.package,i);return this.isDirectory(path_1.default.dirname(s),(async(i,r)=>i?t(i):r?this.loadAsFile(s,this.opts.package,a):this.processDirs(t,e.slice(1))),{rootDir:this.rootDir,caseSensitiveCheck:this.caseSensitiveCheck,sdkModulesPath:this.sdkModulesPath,importer:this.importer,originImportPath:this.originImportPath,joinPackageJson:this.joinPackageJson})},this.loadNodeModules=async(t,e,s)=>{const i=()=>getPackageCandidates(t,e,this.opts);return this.processDirs(s,this.packageIterator?this.packageIterator(t,e,i,this.opts):i())},this.x=t,this.opts=e??{}}async resolve(){if("string"!=typeof this.x)return new TypeError("Path must be a string.");if(this.opts=(0,normalize_options_js_1.normalizeOptions)(this.x,this.opts),this.isFile=this.opts.isFile||defaultIsFile,this.isDirectory=this.opts.isDirectory||defaultIsDir,this.readFile=this.opts.readFile,this.realpath=this.opts.realpath||defaultRealpath,this.readPackage=this.opts.readPackage||defaultReadPackage,this.opts.readFile&&this.opts.readPackage)return new TypeError("`readFile` and `readPackage` are mutually exclusive.");this.packageIterator=this.opts.packageIterator,this.extensions=this.opts.extensions||[".js"],this.includeCoreModules=!1!==this.opts.includeCoreModules,this.basedir=this.opts.basedir||path_1.default.dirname((0,caller_js_1.caller)()),this.parent=this.opts.filename||this.basedir,this.rootDir=this.opts.rootDir,this.caseSensitiveCheck=this.opts.caseSensitiveCheck??!1,this.sdkModulesPath=this.opts.sdkModulesPath||[],this.importer=this.opts.importer,this.originImportPath=this.opts.originImportPath,this.joinPackageJson=this.opts.joinPackageJson??!1,this.opts.paths=this.opts.paths||defaultPaths();const t=path_1.default.resolve(this.basedir);return maybeRealpath(this.realpath,t,this.opts,(async(t,e)=>t||this.init(e)))}async init(t){return/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/\\])/.test(this.x)?(this.res=path_1.default.resolve(t,this.x),"."!==this.x&&".."!==this.x&&"/"!==this.x.slice(-1)||(this.res+="/"),/\/$/.test(this.x)&&this.res===t?this.loadAsDirectory(this.res,this.opts.package,this.onfile):this.loadAsFile(this.res,this.opts.package,this.onfile)):this.includeCoreModules&&(0,is_core_js_1.isCore)(this.x)?this.x:this.loadNodeModules(this.x,t,(async(t,e,s)=>{if(t)return t;if(e)return maybeRealpath(this.realpath,e,this.opts,(async(t,e)=>t||e));{const t=new Error(`Cannot find module '${this.x}' from '${this.parent}'`);return t.code="MODULE_NOT_FOUND",t}}))}}