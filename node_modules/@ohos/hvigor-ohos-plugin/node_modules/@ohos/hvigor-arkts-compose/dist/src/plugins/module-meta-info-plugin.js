"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,n){void 0===n&&(n=t);var r=Object.getOwnPropertyDescriptor(o,t);r&&!("get"in r?!o.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,n,r)}:function(e,o,t,n){void 0===n&&(n=t),e[n]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.findNodeEntryFiles=exports.moduleMetaInfoPlugin=void 0;const fs=__importStar(require("fs-extra")),json5_1=__importDefault(require("json5")),path_1=__importDefault(require("path")),constants_js_1=require("../util/constants.js"),utils_js_1=require("../util/utils.js"),LOCAL_MODULE_INFO_CACHE_KEY="localModuleInfoCache",CACHE_KEYS=["allModuleNameHash","pkgJsonFileHash"],OBJECT_ENTRY_KEYS=["import",".","default","require","node"],NODE_ENTRY_FILE_KEYS=["exports","module","jsnext:main","main"],COMMONJS_ES_IMPORT_SUFFIX="?commonjs-es-import";let packageInfoCache,localModuleInfoCache,currentModuleMetaMap,throwErrorFunction,supportExtensions,projectModel,projectTopDir;function moduleMetaInfoPlugin(e){return supportExtensions=e,{name:"moduleInfoMetaPlugin",beforeBuild:beforeBuild,buildStart:buildStart,load:load,moduleParsed:moduleParsed,beforeBuildEnd:beforeBuildEnd}}function buildStart(){packageInfoCache={},currentModuleMetaMap={};const e=shouldLoadCache(this.share?.projectConfig,this.cache);localModuleInfoCache=e?this.cache.get(LOCAL_MODULE_INFO_CACHE_KEY)??{}:{},throwErrorFunction=this.share?.throwArkTsCompilerError,projectModel=this.share?.projectConfig?.projectModel,projectModel||throwError("parsed module meta info error: current projectModel is undefined"),projectTopDir=this.share?.projectConfig?.projectTopDir,projectTopDir||throwError("parsed module meta info error: projectTopDir is undefined")}function beforeBuild(){this.share?.projectConfig?.sourceMapDir&&("har"===this.share?.projectConfig?.moduleType&&"Release"===this.share?.projectConfig?.buildMode||"har"!==this.share?.projectConfig?.moduleType&&"Debug"===this.share?.projectConfig?.buildMode)&&fs.ensureDirSync(this.share?.projectConfig?.sourceMapDir)}function load(e){let o=!1;if((0,utils_js_1.isVirtualFile)(e)){if(-1===e.indexOf(COMMONJS_ES_IMPORT_SUFFIX))return;o=!0}const t=this.getModuleInfo(e);if(!t)return;const n=e.includes(constants_js_1.OH_NODE_MODULES)||e.includes(constants_js_1.NODE_MODULES)?loadRemoteDependencyInfo(e):loadLocalDependencyInfo(e,o);let r;e.startsWith(`${this.share.projectConfig.modulePath}${path_1.default.sep}`)||(r={pkgName:n.pkgName,pkgVersion:n.pkgVersion}),t.meta?Object.assign(t.meta,n,{dependencyPkgInfo:r}):t.meta={...n,dependencyPkgInfo:r}}function moduleParsed(e){e.meta.hostModulesInfo=[]}function beforeBuildEnd(){for(const e of this.getModuleIds()){const o=this.getModuleInfo(e);o&&dealHostModuleInfo(o.meta.moduleName,o,this.getModuleInfo)}this.cache.set(LOCAL_MODULE_INFO_CACHE_KEY,localModuleInfoCache);for(const e of CACHE_KEYS)this.cache.set(e,this.share?.projectConfig[e])}function loadRemoteDependencyInfo(e){const o=getPackageJsonInfo(path_1.default.resolve(e,".."));return o?{isLocalDependency:!1,isNodeEntryFile:isNodeEntryFile(e,o.nodeEntryFiles),pkgPath:o.pkgPath,pkgName:o.pkgName,pkgVersion:o.pkgVersion}:(throwError(`parsed module meta info error: can not parsed remote dependency ${e} package.json info`),{})}function loadLocalDependencyInfo(e,o=!1){let t=e;if(o&&(t=e.substring(1,e.indexOf(COMMONJS_ES_IMPORT_SUFFIX))),localModuleInfoCache[e])return localModuleInfoCache[e];for(const[o,{moduleName:n,modulePkgPath:r}]of Object.entries(projectModel))if(t.startsWith(o+path_1.default.sep)||t===o){const o=getPackageJsonInfo(r);return localModuleInfoCache[e]={moduleName:n,isLocalDependency:!0,isNodeEntryFile:!!o&&isNodeEntryFile(e,o.nodeEntryFiles),pkgPath:r},o&&Object.assign(localModuleInfoCache[e],{pkgName:o.pkgName,pkgVersion:o.pkgVersion}),localModuleInfoCache[e]}const n=getPackageJsonInfo(projectTopDir);return localModuleInfoCache[e]={moduleName:path_1.default.basename(projectTopDir),isLocalDependency:!0,isNodeEntryFile:!!n&&isNodeEntryFile(e,n.nodeEntryFiles),pkgPath:projectTopDir},localModuleInfoCache[e]}function shouldLoadCache(e,o){if(!e||!o)return!1;let t=!0;for(const n of CACHE_KEYS){if((e[n]??"")!==(o.get(n)??"")){t=!1;break}}return t}function getPackageJsonInfo(e){if(e===path_1.default.dirname(projectTopDir))return;if(packageInfoCache[e])return packageInfoCache[e];const o=findPackageJsonFile(e);if(o){const t=getNodeEntryFiles(o),n=getJsonObject(o);return packageInfoCache[e]=t?{pkgPath:e,nodeEntryFiles:t,pkgName:n.name,pkgVersion:n.version}:void 0,packageInfoCache[e]}return packageInfoCache[e]=getPackageJsonInfo(path_1.default.dirname(e)),packageInfoCache[e]}function dealHostModuleInfo(e,o,t){if(e)for(const[n,r]of Object.entries(o.importedIdMaps)){const o=t(r);o&&(o.meta.hostModulesInfo||(o.meta.hostModulesInfo=[]),o.meta.hostModulesInfo.push({hostDependencyName:n,hostModuleName:e}))}}function getNodeEntryFiles(e){const o=getJsonObject(e);if(!o)return;return findNodeEntryFiles(o).map((o=>path_1.default.resolve(e,`../${o}`)))}function findNodeEntryFiles(e){const o=[];for(const t of NODE_ENTRY_FILE_KEYS){const n=parseEntryFiles(e[t]);if(n){o.push(...n);break}}return o.push("index.js"),o}function isNodeEntryFile(e,o){if(-1!==o.indexOf(e))return!0;for(const t of supportExtensions)if(o+t===e)return!0;return!1}function parseEntryFiles(e){if(!e)return;if("string"==typeof e)return[e];const o=[];if(Array.isArray(e))for(const t of e){const e=parseEntryFiles(t);e&&o.push(...e)}if(o.length>0)return o;if("object"==typeof e)for(const t of OBJECT_ENTRY_KEYS){const n=parseEntryFiles(e[t]);n&&o.push(...n)}return o}function getJsonObject(e){try{const o=fs.readFileSync(e,"utf-8");return json5_1.default.parse(o)}catch(e){return}}function findPackageJsonFile(e){return findFile((0,utils_js_1.getOhPackageJsonPath)(path_1.default.join(e,constants_js_1.OH_PACKAGE_JSON5)))??findFile(path_1.default.join(e,constants_js_1.PACKAGE_JSON))}function findFile(e){return fs.existsSync(e)?e:void 0}function throwError(e){if(!throwErrorFunction)throw new Error(e);throwErrorFunction(e)}exports.moduleMetaInfoPlugin=moduleMetaInfoPlugin,exports.findNodeEntryFiles=findNodeEntryFiles;