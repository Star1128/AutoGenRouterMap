"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.clearStepAddressingCache=exports.readCachedFile=exports.isFileCached=exports.isDirCached=exports.caseErrorSet=void 0;const fs_1=__importDefault(require("fs")),fs_js_1=require("../../util/fs.js"),path_1=__importDefault(require("path"));exports.caseErrorSet=new Set;const onError=e=>{if("ENOENT"===e.code)return!1;throw e},makeCache=e=>{const r=new Map,t=async(t,a,i)=>{r.has(t)||r.set(t,e(t).catch((e=>{throw r.delete(t),e})));try{const e=await r.get(t);return addCaseSensitiveErrorLog(t,e,i),await a(null,e)}catch(e){return a(e)}};return t.clear=()=>r.clear(),t};exports.isDirCached=makeCache((async e=>{try{const r=await(0,fs_js_1.stat)(e);return r.isDirectory()}catch(e){return onError(e)}})),exports.isFileCached=makeCache((async e=>{try{const r=await(0,fs_js_1.stat)(e);return r.isFile()}catch(e){return onError(e)}})),exports.readCachedFile=makeCache(fs_js_1.readFile);const legalDirectorySet=new Set,notLegalDirectorySet=new Set;let dirFileMap={};function clearStepAddressingCache(){legalDirectorySet.clear(),notLegalDirectorySet.clear(),dirFileMap={},exports.caseErrorSet.clear()}function checkFileWithCase(e,r,t){if(legalDirectorySet.has(e)||[...t,r].includes(e))return!0;if(notLegalDirectorySet.has(e))return!1;const a=path_1.default.dirname(e),i=path_1.default.basename(e);let s;if(dirFileMap[a]?s=dirFileMap[a]:(s=fs_1.default.readdirSync(a),dirFileMap[a]=s),!s.includes(i))return notLegalDirectorySet.add(e),!1;const c=checkFileWithCase(a,r,t);return c&&legalDirectorySet.add(e),c}function addCaseSensitiveErrorLog(e,r,t){if(t?.caseSensitiveCheck&&r){const r=checkFileWithCase(e.toString(),t.rootDir,t.sdkModulesPath),a=t.originImportPath??e;if(a.endsWith("oh-package.json5")&&t.joinPackageJson)return;if(!r){const e=`ERROR File: ${t.importer} \n        Cannot resolved import statement ${t?.joinIndex?`${a}/index`:a}. Please check the case.`;exports.caseErrorSet.add(e)}}}exports.clearStepAddressingCache=clearStepAddressingCache;