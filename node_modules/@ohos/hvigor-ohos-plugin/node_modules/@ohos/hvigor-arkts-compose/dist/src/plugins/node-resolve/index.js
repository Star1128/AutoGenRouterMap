"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,o)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.nodeResolve=exports.DEFAULTS=void 0;const deepmerge_1=__importDefault(require("deepmerge")),fs_1=__importDefault(require("fs")),is_builtin_module_1=__importDefault(require("is-builtin-module")),path_1=__importStar(require("path")),constants_js_1=require("../../util/constants.js"),fs_js_1=require("../../util/fs.js"),cache_js_1=require("./cache.js"),deprecated_options_js_1=__importDefault(require("./deprecated-options.js")),resolveImportSpecifiers_js_1=require("./resolveImportSpecifiers.js"),resolveOhModules_js_1=require("./resolveOhModules.js"),util_js_1=require("./util.js"),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),ES6ImportExportRegExp=/(?:^\s*|[}{\(\);,\n]\s*)(import[\s+|{]['"]|(import|module)[\s+|*|{][^"'\(\)\n;]+[\s|}]+from\s*['"]|export[\s+|{](\*|\{|default|function|var|const|let|[_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*))/,ES6AliasRegExp=/(?:^\s*|[}{\(\);,\n]\s*)(export\s*\*\s*from\s*(?:'([^']+)'|"([^"]+)"))/,logger=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("caseSensitiveCheck");function isModule(e){return ES6ImportExportRegExp.test(e)||ES6AliasRegExp.test(e)}const deepFreeze=e=>{Object.freeze(e);for(const t of Object.values(e))"object"!=typeof t||Object.isFrozen(t)||deepFreeze(t);return e},baseConditions=["default","module"],baseConditionsEsm=[...baseConditions,"import"],baseConditionsCjs=[...baseConditions,"require"],defaults={dedupe:[],extensions:[".mjs",".js",".json",".node"],resolveOnly:[],moduleDirectories:["oh_modules"],ignoreSideEffectsForRoot:!1};exports.DEFAULTS=deepFreeze((0,deepmerge_1.default)({},defaults));const allowPatterns=e=>{const t=e.map((e=>{if(e instanceof RegExp)return e;const t=e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&");return new RegExp(`^${t}$`)}));return e=>!t.length||t.some((t=>t.test(e)))};async function updateLocation(e,t,r,s,o){if(e&&!s){await(0,fs_js_1.fileExists)(t)&&(t=await(0,fs_js_1.realpathFS)(t))}return o.set(t,r),t}function initData(e){const t=(0,util_js_1.getMainFields)(e),r=!0===e.preferBuiltins||!1===e.preferBuiltins;return{conditionsEsm:[...baseConditionsEsm,...e.exportConditions||[]],conditionsCjs:[...baseConditionsCjs,...e.exportConditions||[]],packageInfoCache:new Map,idToPackageInfo:new Map,mainFields:t,useBrowserOverrides:-1!==t.indexOf("browser"),isPreferBuiltinsSet:r,preferBuiltins:!r||e.preferBuiltins,rootDir:(0,path_1.resolve)(e.rootDir||process.cwd()),dedupe:e.dedupe}}function reject(e,t){return!!(0,util_js_1.normalizeInput)(t.input).includes(e)&&null}function getImportSpecifierList(e,t,r){const s=[e];if(void 0!==t||e[0].match(/^\.?\.?\//)||s.push(`./${e}`),t&&e.endsWith(".js"))for(const o of[".ts",".tsx"])t.endsWith(o)&&r.includes(o)&&s.push(e.replace(/.js$/,o));return s}function addSourceRootsIntoImportSpecifiers(e,t,r,s,o,i,n,a){if(e||!o||!n)return;const l=t.getModuleInfo(o)?.meta,u=l?.pkgName,c=l?.pkgPath,d=n[u]?.sourceRoots;u&&c&&r===u&&d?.length&&d.forEach((e=>{const t=path_1.default.resolve(c,e,s.join("/"));let r=path_1.default.relative(i,t).replace(/\\/g,"/");"."!==r.charAt(0)&&(r=`./${r}`),a.push(r)}))}function addResolvedMeta(e,t,r,s,o){if(e&&s&&s>o){const i=r.slice(o+1,s).map((e=>path_1.default.resolve(t,e)));e.meta={backupSourceRoots:i,resolvedBySourceRoot:!0}}return e}async function getRes(e,t,r,s,o,i,n,a,l,u,c,d,p){if(e){if(t&&u)return!c&&r&&s!==o&&i.warn(`preferring built-in module '${o}' over local alternative at '${r.location}', pass 'preferBuiltins: false' to disable this behavior or 'preferBuiltins: true' to disable this warning`),!1;if(d&&0!==n.indexOf((0,path_1.normalize)(d.trim(path_1.sep))))return null}if(p.modulesOnly&&await(0,fs_js_1.fileExists)(n)){return isModule(await(0,fs_js_1.readFile)(n,"utf-8"))?{id:`${n}${a}`,moduleSideEffects:l(n)}:null}return{id:`${n}${a}`,moduleSideEffects:l(n)}}function updateBrowserMapCache(e,t,r){if(e){if(Object.prototype.hasOwnProperty.call(e,t)){if(!e[t])return r.set(t,e),[{id:constants_js_1.ES6_BROWSER_EMPTY},null];t=e[t]}r.set(t,e)}return[null,t]}function getResolveLikeNode(e,t,r,s,o,i,n,a,l,u,c,d,p,f,_,h,m,g,v,j){return async(S,E,b,w)=>{const[R,C]=E.split("?"),y=""+(C?`?${C}`:"");E=R;const M=!b||e(E)?t:(0,path_1.dirname)(b),k=r.get(b);if(s&&k){const e=(0,path_1.resolve)(M,E);if(!1===k[E]||!1===k[e])return{id:constants_js_1.ES6_BROWSER_EMPTY};E=("."!==E[0]&&k[E]||k[e]||k[`${e}.js`]||k[`${e}.json`])??E}const O=E.split(/[/\\]/);let x=O.shift(),D=!1;if("@"===x[0]&&O.length>0?x+=`/${O.shift()}`:"."===x[0]&&(x=(0,path_1.resolve)(M,E),D=!0),!D&&!o(x))return reject(E,i);const F=getImportSpecifierList(E,b,n),P=F.length-1;addSourceRootsIntoImportSpecifiers(D,S,x,O,b,M,j.pkgNameToPkgInfo,F);const I=w&&w["node-resolve"]&&w["node-resolve"].isRequire?a:l;s&&!I.includes("browser")&&I.push("browser");const B=await(0,resolveImportSpecifiers_js_1.resolveImportSpecifiers)({importer:b,importSpecifierList:F,exportConditions:I,warn:(...e)=>S.warn(...e),packageInfoCache:u,extensions:n,mainFields:c,preserveSymlinks:d,useBrowserOverrides:s,baseDir:M,moduleDirectories:p,modulePaths:f,rootDir:t,ignoreSideEffectsForRoot:_,caseSensitiveCheck:j.caseSensitiveCheck,sdkModulesPath:j.sdkModulesPath}),$=(0,is_builtin_module_1.default)(E),q=$&&h?{packageInfo:void 0,hasModuleSideEffects:()=>null,hasPackageEntry:!0,packageBrowserField:!1}:B;if(!q)return null;const{packageInfo:A,hasModuleSideEffects:L,hasPackageEntry:T,packageBrowserField:z}=q;let{location:W}=q;const N=updateBrowserMapCache(z,W,r);if(N[0])return N[0];W=N[1],W=await updateLocation(T,W,A,d,m);return addResolvedMeta(await getRes(T,$,B,q,E,S,W,y,L,h,g,v,j),M,F,q.resolvedSpecifierIndex,P)}}function checkModuleDirectories(e){if(e.some((e=>e.includes("/"))))throw new Error("`moduleDirectories` option must only contain directory names. If you want to load modules from somewhere not supported by the default module resolution algorithm, see `modulePaths`.")}function updateDedupe(e,t){return"function"!=typeof e&&(e=e=>t.dedupe.includes(e)||t.dedupe.includes((0,util_js_1.getPackageName)(e))),e}function getResolveOnly(e){return"function"==typeof e.resolveOnly?e.resolveOnly:allowPatterns(e.resolveOnly)}function readSystemApi(e){const t=new Map;return e.forEach((e=>{fs_1.default.readdirSync(e).forEach((r=>{t.set(r.replace(".d.ts","").replace(".d.ets",""),path_1.default.join(e,r))}))})),t}function nodeResolve(e={}){const{warnings:t}=(0,deprecated_options_js_1.default)(e),r={...defaults,...e},{extensions:s,jail:o,moduleDirectories:i,modulePaths:n,ignoreSideEffectsForRoot:a}=r;let l,u,c,{conditionsEsm:d,conditionsCjs:p,packageInfoCache:f,idToPackageInfo:_,mainFields:h,useBrowserOverrides:m,isPreferBuiltinsSet:g,preferBuiltins:v,rootDir:j,dedupe:S}=initData(r);checkModuleDirectories(i),S=updateDedupe(S,r);const E=getResolveOnly(r),b=new Map,w={order:"post",async handler(e,t,w){if(e===constants_js_1.ES6_BROWSER_EMPTY)return e;if(/\0/.test(e))return null;const{custom:R={}}=w,{"node-resolve":{resolved:C}={}}=R;if(C)return C;let y;if(/\0/.test(t)&&(t=void 0),"."!==e[0]&&c.has(e)&&(y={id:c.get(e)}),y||(y=await getResolveLikeNode(S,j,b,m,E,l,s,p,d,f,h,u,i,n,a,v,_,g,o,r)(this,e,t,R)),y){const r=await this.resolve(y.id,t,{...w,custom:{...R,"node-resolve":{...R["node-resolve"],resolved:y,oriImportee:e}}});if(r)return r.meta={...r.meta,...y.meta},!r.external&&(r.id!==y.id?r:{...y,meta:r.meta})}return y}};return{name:"oh-resolve",buildStart(e){l=e,t.forEach((e=>this.warn(e))),({preserveSymlinks:u}=e);const s=this.share?.projectConfig?.projectTopDir||process.cwd();this.share.symlinkMap=(0,resolveOhModules_js_1.resolveAllOhModules)(s),updateRealpathCache(r.useRealpathCache);const o=new Set([...this.share.projectConfig.globalModulePaths??[],path_1.default.resolve(this.share.projectConfig.etsLoaderPath,"../../api")]);c=readSystemApi(o)},generateBundle:clearCache,beforeBuildEnd(){cache_js_1.caseErrorSet.forEach((e=>{logger.error(e)}))},resolveId:w,load:load,getPackageInfoForId:e=>_.get(e),cleanUp:()=>{c.clear(),clearCache()}}}function updateRealpathCache(e){e?(0,fs_js_1.enableRealpathCache)():(0,fs_js_1.disableRealpathCache)()}function clearCache(){(0,fs_js_1.clearRealpathCache)(),(0,fs_js_1.clearFileCache)(),(0,cache_js_1.clearStepAddressingCache)(),cache_js_1.readCachedFile.clear(),cache_js_1.isFileCached.clear(),cache_js_1.isDirCached.clear()}function load(e){return e===constants_js_1.ES6_BROWSER_EMPTY?"export default {};":null}exports.nodeResolve=nodeResolve,exports.default=nodeResolve;